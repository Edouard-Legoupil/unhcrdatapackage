---
title: "Mapping IDP Location"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Mapping IDP Location}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)


```

## Mapping IDP Location
 

```{r ,fig.height=7, fig.width=7, message = FALSE,echo = TRUE , warning = FALSE}

# Select a font already installed on your system !!
par(family="Lato")
# set a theme
mapsf::mf_theme(bg = "#E2E7EB",  ## background color --> Used country 
                # bg = "#cdd2d4", "#faebd7ff",  "#cdd2d4",
                mar = c(0, 0, 2, 0), ## margins
                tab = FALSE,  # if TRUE the title is displayed as a 'tab'
                fg = "#0072BC",  ## foreground color --> for the top title - use UNHCR Blue..
                pos = "left", # position, one of 'left', 'center', 'right'
                inner = FALSE, # if TRUE the title is displayed inside the plot area.
                line = 2, #number of lines used for the title
                cex = 1.5, #cex of the title
                #font = "Lato",
                font = 1 ) #font of the title


## Getting world map for mapping
world <- rnaturalearth::ne_countries(scale = "small", returnclass = "sf") %>% 
  # this is the crs from d, which has no EPSG code:
  sf::st_transform(., '+init=epsg:4326')

world2 <- rnaturalearth::ne_countries(scale = "small", returnclass = "sf") %>% 
  # this is the crs from d, which has no EPSG code:
  sf::st_transform(., '+init=epsg:4326')
  #sf::st_transform(., '+proj=bertin1953 +R=1 0.72 0.73')
  #sf::st_transform(., '+proj=bertin1953 +x_0=1000')

#centroids <- sf::st_centroid(world$geometry)
centroids <- sf::st_transform(world$geometry, '+init=epsg:3857') %>%  
  ## Reprojected in order to get centroid
  sf::st_centroid()  %>%
  sf::st_geometry()%>% 
  # this is the crs from d, which has no EPSG code:
  sf::st_transform(., '+init=epsg:4326')%>%
  #sf::st_transform(., '+proj=bertin1953 +R=1 0.72 0.73') %>%
  #sf::st_transform(., '+proj=bertin1953 +x_0=1000') %>% 
  # since we want the centroids in long lat:
  as.data.frame()
world_points <- world  %>%  
  sf::st_drop_geometry() %>%
  cbind(., centroids)

## Loading the stat tables
lastyear <- max(unhcrdatapackage::end_year_population_totals_long$Year)




wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL",  ## Population total https://data.worldbank.org/indicator/SP.POP.TOTL
                                      "NY.GDP.MKTP.CD", ## GDP current https://data.worldbank.org/indicator/NY.GDP.MKTP.CD
                                      "NY.GDP.PCAP.CD", ## GDP per capita https://data.worldbank.org/indicator/NY.GDP.PCAP.CD 
                                      "NY.GNP.PCAP.CD" ## GNI per capita, Atlas method (current US$) https://data.worldbank.org/indicator/NY.GNP.PCAP.CD
                                      ),
                startdate = 1951, enddate = lastyear, return_wide = TRUE)
# # Renaming variables for further matching
names(wb_data)[1] <- "CountryAsylumCode"
names(wb_data)[2] <- "Year"


data <- dplyr::left_join( x= unhcrdatapackage::end_year_population_totals_long, 
                                                     y= unhcrdatapackage::reference, 
                                                     by = c("CountryAsylumCode" = "iso_3")) %>%
  filter(Population.type  == "IDP" &
           Year == lastyear & !(is.na(UNHCRBureau))) %>%
  group_by(Year, CountryAsylumName, CountryAsylumCode, UNHCRBureau ) %>%
  summarise(Value2 = sum(Value) )



# Merge data with geographic coordinates
#world <- merge(x = world , y = data, by.y = "CountryAsylumCode" , by.x = "iso_a3")


df3 <- merge(x = data , y = world_points, 
             by.x = "CountryAsylumCode" , by.y = "iso_a3") %>%
      sf::st_as_sf()



df4 <- df3 %>%
    ## Now merge with WB Data 
  left_join(wb_data %>% select("SP.POP.TOTL","NY.GDP.PCAP.CD","CountryAsylumCode", "Year") %>%
              filter(Year == lastyear), 
            by = c( "CountryAsylumCode"    )) %>%  
  mutate(idp.gdp = round( NY.GDP.PCAP.CD / Value2, 4)  )  %>%
  arrange(desc(idp.gdp)) 

# Discretize the variable

df4$quint2 <- Hmisc::cut2(df4$idp.gdp, g = 6) 


df3$quint2 <- Hmisc::cut2(df3$Value, g = 6)

## Color scale - https://developer.r-project.org/Blog/public/2019/04/01/hcl-based-color-palettes-in-grdevices/


mapsf::mf_init(world2) 
mapsf::mf_map(world2, 
              add = TRUE, 
              lwd = 0.5, 
              border = "#93A3AB", 
              col = "#FFFFFF")
mapsf::mf_prop_typo( 
  x = df4, 
  var = c("Value2", "quint2"),
  inches = .005, 
  border = "tomato4",
  alpha = .8,
  val_max = 90000, 
  symbol = "circle", 
  col_na = "grey", 
  pal = "Inferno",
  lwd = 1,
  leg_pos = c("bottomright", "bottomleft"),
  leg_title = c("IDP", "Ratio"),
  leg_title_cex = c(0.9, 0.9),
  leg_val_cex = c(.7, .7),
  leg_no_data = "No dada",
  leg_frame = c(TRUE, TRUE),
  add = TRUE
)

# Set a layout
mapsf::mf_title(txt = "IDP in relation with GDP per Capita", 
                fg = "#FFFFFF")
mapsf::mf_credits(txt = "Source: UNHCR.org/refugee-statistics",
                   bg = "#ffffff80") 




```