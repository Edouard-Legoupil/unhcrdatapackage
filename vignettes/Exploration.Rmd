---
title: "Initial Exploration of Refugee Statistics"
output: 
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Initial Exploration of Refugee Statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

You can find the source code for all the chart below in the [Repository](https://github.com/unhcr/unhcrdatapackage/tree/master/vignettes).

```{r setup, include=FALSE, echo=TRUE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      collapse = FALSE,
                      comment = "#>",
                      fig.align = "center")
knitr::opts_chunk$set(fig.width = 9, fig.height = 7)
set.seed(1)
extrafont::loadfonts(quiet=TRUE)
options(scipen = 999) # turn-off scientific notation like 1e+48

using <- function(...) {
    libs <- unlist(list(...))
    req <- unlist(lapply(libs,require,character.only = TRUE))
    need <- libs[req == FALSE]
    if (length(need) > 0) { 
        install.packages(need)
        lapply(need,require,character.only = TRUE)
    }
}

using('tidyverse','gganimate','gghighlight','ggpubr', 'dplyr', 'tidyr', 'gapminder', 'ggplot2',  'ggalt', 'forcats', 'R.utils', 'png', 'grid', 'ggpubr', 'scales',  'markdown', 'pander', 'ISOcodes', 'wbstats', 'sf', 'rnaturalearth', 'rnaturalearthdata', 'ggspatial', 'unhcrdatapackage', 'unhcRstyle')

options(scipen = 999) # turn-off scientific notation like 1e+48
```






```{r preparedata, cache = TRUE, message=FALSE, warning=FALSE}
# Time series

time_series <-  unhcrdatapackage::end_year_population_totals

lastyear <- max(time_series$Year)

reference <- unhcrdatapackage::reference

time_series2 <- reshape2::melt(time_series,
                                           # ID variables - all the variables to keep but not split apart on
                                           id.vars=c("Year", "CountryOriginCode",
                                                     "CountryAsylumCode",
                                                     "CountryOriginName","CountryAsylumName" ),
                                           # The source columns
                                           measure.vars=c("REF","IDP", "ASY","OOC","STA","VDA"),
                                           # Name of the destination column that will identify the original
                                           # column that the measurement came from
                                           variable.name="Population.type",
                                           value.name="Value") 

time_series2 <- merge(x = time_series2, by.x="CountryOriginCode", y = reference, by.y= "iso_3", all.x = TRUE)

# Population, GDP & GNP per Capita from WorldBank
wb_data <- wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
               startdate = 1951, enddate = 2020, return_wide = TRUE)
# Renaming variables for further matching
names(wb_data)[1] <- "CountryAsylumCode"
names(wb_data)[2] <- "Year"

## Getting world map for mapping
world <- ne_countries(scale = "small", returnclass = "sf")
centroids <- st_transform(world$geometry, '+init=epsg:3857') %>%  
  ## Reprojected in order to get centroid
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+init=epsg:4326') %>%
  # since we want the centroids in long lat:
  st_geometry()
world_points <- cbind(world, st_coordinates(centroids))

```

## How many refugees in the world?

```{r ,message = FALSE, warning = FALSE}
#Prepare data
line_df <- time_series2 %>%
  filter(Population.type  == "REF") %>%
  group_by(Year) %>%
  summarise(Value2 = sum(Value) ) 


#Make plot
ggplot(line_df, aes(x = Year, y = Value2)) +
  geom_line(colour = "#0072bc", size = 1) + # Here we mention that it will be a line chart
 # geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  scale_y_continuous(label = format_si()) + ## Format axis number
  ## and the chart labels
  labs(title = "More and More refugees",
       x = "",
       y = "",
       subtitle = "World wide refugee population 1951-2017", 
       caption = "UNHCR https://www.unhcr.org/refugee-statistics/")

```

## Comparison over time by Region

```{r ,message = FALSE, warning = FALSE}
lastyear <- max(time_series2$Year)
#Prepare data
multiple_line_df <- time_series2 %>%
  filter(#Population.type  == "REF" &
           !(is.na(UNHCRBureau))) %>%
  group_by(Year, UNHCRBureau ) %>%
  summarise(Value2 = sum(Value) ) 

#Make plot
ggplot(multiple_line_df, aes(x = Year, y = Value2, 
                                              colour = UNHCRBureau)) + # Adding reference to color
  geom_line(size = 1) + # Here we mention that it will be a line chart
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_y_continuous( label = format_si()) + ## Format axis number
  
  xlim(c(1960, lastyear + 8)) +
  
  #scale_colour_viridis_d() + ## Add color for each lines based on color-blind friendly palette
  #scale_fill_manual(name = 'UNHCRBureau', values = c("#b2df8a", "#fb9a99", "#1f78b4", "#33a02c", "#a6cee3")) +
  #   "WestAfrica" 
  scale_fill_manual(name = 'UNHCRBureau', values = c( "Americas" = "#a6cee3",
                                                      "Asia"  = "#1f78b4", 
                                                     "EastAfrica" = "#b2df8a",  
                                                     "Europe" = "#33a02c",
                                                      "MENA" = "#fb9a99", 
                                                      "SouthAfrica" = "#e31a1c", 
                                                     "WestAfrica"= "#fdbf6f")) +  
  geom_label(aes(x = lastyear + .5 , 
                 y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "Americas" & multiple_line_df$Year == lastyear , c("Value2")]), 
                 label = "Americas"), 
                             hjust = 0, 
                             vjust = 0.5, 
                             colour = "#a6cee3",  
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
   geom_label(aes(x = lastyear +.5, 
                  y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "Asia" & multiple_line_df$Year == lastyear , c("Value2")]), 
                  label = "Asia"), 
                             hjust = 0, 
                             vjust = 0.5,
                             colour = "#1f78b4",   
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
   geom_label(aes(x = lastyear + .5,  
                  y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "EastAfrica" & multiple_line_df$Year == lastyear , c("Value2")]), 
                   label = "Eastern Africa"), 
                             hjust = 0, 
                             vjust = 0.5, 
                             colour = "#b2df8a",  
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
    geom_label(aes(x = lastyear + .5,  
                  y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "Europe" & multiple_line_df$Year == lastyear , c("Value2")]), 
                    label = "Europe"), 
                             hjust = 0, 
                             vjust = 0.5, 
                             colour = "#33a02c",  
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
    geom_label(aes(x = lastyear + .5,  
                  y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "MENA" & multiple_line_df$Year == lastyear , c("Value2")]), 
                    label = "Middle East / North Africa"), 
                             hjust = 0, 
                             vjust = 0.5,  
                             colour = "#fb9a99", 
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
    geom_label(aes(x = lastyear + .5,  
                  y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "SouthAfrica" & multiple_line_df$Year == lastyear , c("Value2")]), 
                    label = "Southern Africa"), 
                             hjust = 0, 
                             vjust = 0.5, 
                             colour = "#e31a1c",  
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
    geom_label(aes(x = lastyear + .5,  
                  y = as.numeric(multiple_line_df[multiple_line_df$UNHCRBureau == "WestAfrica" & multiple_line_df$Year == lastyear , c("Value2")]), 
                    label = "Western Africa"), 
                             hjust = 0, 
                             vjust = 0.5, 
                             colour = "#fdbf6f",  
                             fill = "white", 
                             label.size = NA, 
                             family = "Lato", 
                             size = 6) +
  
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  ## and the chart labels
  labs(title = "Refugees Population are not equally spread",
       subtitle = "World wide refugee population 1951-2017",
       x = "",
       y = "",
       caption = "UNHCR https://www.unhcr.org/refugee-statistics/")

```

## Top Refugee hosting Countries

```{r ,message = FALSE, warning = FALSE}
#Prepare data2
bar_df <- time_series2 %>%
  filter(Population.type  == "REF" & Year == lastyear) %>%
  group_by( CountryAsylumName, SUBREGION) %>%
  summarise(Value2 = sum(Value) )  %>%
  #mutate( value3 =  format_si(Value2)) %>%
  arrange(desc(Value2)) %>%
  head(10)


#Make plot
ggplot(bar_df, aes(x = reorder(CountryAsylumName, Value2), ## Reordering country by Value
                           y = Value2)) +
  geom_bar(stat = "identity", 
           position = "identity", 
           fill = "#0072bc") + # here we configure that it will be bar chart+
  geom_label(aes(x = CountryAsylumName, y = Value2, 
                label =  format(round(Value2, -3),  big.mark=",")), 
             hjust = 1, 
             vjust = 0.5, 
             colour = "white", 
             fill = NA, 
             label.size = NA, 
             family = "Lato", 
             size = 6) +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  coord_flip() + # Add `coord_flip()` to make your vertical bars horizontal:
  ## and the chart labels
  labs(title = "Turkey is by the far the biggest Refugee hosting country",
       subtitle = paste0("Top 10 Refugee Population per country in ",lastyear), 
       x = "",
       y = "",
       caption = "UNHCR https://www.unhcr.org/refugee-statistics/") +
  scale_y_continuous( label = format_si()) + ## Format axis number
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
        panel.grid.major.y = element_blank()) ### changing grid line that should appear

```


## Where do go Refugees go?

```{r ,message = FALSE, warning = FALSE}
#prepare data
df1 <- time_series2 %>%
  filter(Population.type  == "REF" & Year == lastyear & !(is.na(UNHCRBureau))) %>%
  group_by(Year, CountryAsylumName, CountryAsylumCode, UNHCRBureau ) %>%
  summarise(Value2 = sum(Value) )

df2 <- merge(x = df1, y = wb_data, by = c("CountryAsylumCode" ,"Year"), all.x = TRUE)
df2 <- df2[ !(is.na(df2$UNHCRBureau)) & !(is.na(df2$NY.GNP.PCAP.CD)) , ]
df2$prop <- df2$Value2 / df2$SP.POP.TOTL

stacked_df1 <- df2 %>%
  mutate(CountryClass = cut(NY.GNP.PCAP.CD, 
                              breaks = c(0, 1005, 3955, 12235, 150000),
                              labels = c("Low-income", "Lower-middle income", "Upper-middle income", "High-income"))) %>%
  group_by(UNHCRBureau, CountryClass) %>%
  summarise(Value3 = sum(as.numeric(Value2)))

#create plot
ggplot(data = stacked_df1, 
                     aes(x = UNHCRBureau,
                         y = Value3,
                         fill = CountryClass)) +
                geom_bar(stat = "identity", 
                         position = "fill") +
                scale_y_continuous(labels = scales::percent) +
                scale_fill_viridis_d(direction = -1) +
                geom_hline(yintercept = 0, size = 1, colour = "#333333") +
                labs(title = "Refugees often remain in low-income countries",
                     subtitle = paste0("% of population by Country classification per Region, ", lastyear), 
                     caption = "UNHCR https://www.unhcr.org/refugee-statistics/ - World Bank") +
                unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
                theme(legend.position = "top", 
                      legend.justification = "left") +
                guides(fill = guide_legend(reverse = TRUE))
 
```

## Biggest increase in Refugee Population in the last 10 years

```{r ,message = FALSE, warning = FALSE}
#Prepare data

tenyears <- lastyear -10

grouped_bar_df <- time_series2 %>%
    filter(Population.type  == "REF")  %>%
    filter(Year == tenyears | Year == lastyear) %>%
    group_by( CountryAsylumName, Year) %>%
    summarise(Value2 = sum(Value) )  %>%
    select(CountryAsylumName, Year, Value2) %>%
    spread(Year, Value2) %>%
    mutate(gap = tenyears - lastyear) %>%
    arrange(desc(gap)) %>%
    head(10) %>%
    gather(key = Year, 
           value = Value2,
           -CountryAsylumName,
           -gap) 
  
#Make plot
ggplot(grouped_bar_df, 
                       aes(x = CountryAsylumName, 
                           y = Value2, 
                           fill = as.factor(Year))) +
  
  coord_flip() +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_fill_manual(values = c("#0072bc", "#FAAB18")) +
  labs(title = "Biggest Increase Population",
       subtitle = paste0("10 Biggest change in Refugee Population, ", tenyears," - ",lastyear), 
       caption = "UNHCR https://www.unhcr.org/refugee-statistics/") +
  scale_y_continuous( label = format_si()) + ## Format axis number
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
        panel.grid.major.y = element_blank()) ### changing grid line that should appear


```


## Biggest decrease in Refugee Population in the last 10 years

```{r ,message = FALSE, warning = FALSE}

#Prepare data
dumbbell_df <- time_series2 %>%
    filter(Population.type  == "REF")  %>%
    filter(Year == tenyears | Year == lastyear) %>%
    group_by( CountryAsylumCode, Year) %>%
    summarise(Value2 = sum(Value) )  %>%
    select(CountryAsylumCode, Year, Value2) %>%
    spread(Year, Value2) %>%
    mutate(gap = tenyears - lastyear) %>%
    arrange(desc(gap)) %>%
    head(10) 

# Make plot
ggplot(dumbbell_df, aes(x = tenyears, xend = lastyear,
                                   y = reorder(CountryAsylumCode, gap),
                                   group = CountryAsylumCode)) + 
  geom_dumbbell(colour = "#dddddd",
                size = 3,
                colour_x = "#0072bc",
                colour_xend = "#FAAB18") + 
  labs(title = "Where did Refugee Population decreased in the past 10 years?",
       subtitle = paste0("Biggest decrease in Refugee Population, ", tenyears," - ",lastyear),  
       caption = "UNHCR https://www.unhcr.org/refugee-statistics/") +
  scale_x_continuous( label = format_si()) + ## Format axis number
  
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
        panel.grid.major.y = element_blank()) ### changing grid line that should appear


```


## Ratio Refugee / Host population 

```{r message = FALSE, warning = FALSE}
# Prepare Data
 hist_df <-  df2 %>%
    mutate(ref.per.local = (Value2 / SP.POP.TOTL) * 100) %>%
    arrange(desc(Value2)) %>%
    head(50)
  
# Chart
ggplot(hist_df, aes(ref.per.local)) +
    geom_histogram( colour = "white", fill = "#0072bc") +
    geom_hline(yintercept = 0, size = 1, colour = "#333333") +
    scale_x_continuous(limits = c(0, 20)) +
    unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
    labs(ylab = "Count of countries",
         title = "Only 2 countries have more than 5 refugees per 100 locals",
         subtitle = "Distribution of refugee to local ratio for top 50 refugee hosting countries", 
         caption = "UNHCR https://www.unhcr.org/refugee-statistics/ - World Bank")

 
```


## Relation between Refugee Population & GDP

```{r message = FALSE, warning = FALSE}
## Chart
ggplot(df2, aes(y = Value2, x = NY.GDP.MKTP.CD)) + 
  geom_point(aes(col = UNHCRBureau)) + 
  #geom_smooth(method = "loess", se = F) +  
  scale_x_continuous( label = format_si(), ) + ## Format axis number
  scale_y_continuous( label = format_si(), 
                      limits = c(0, 1000000)) + ## Format axis number
  scale_color_viridis_d(direction = -1) +
  labs(title = "Refugee hosting is not correlated with Economic Wealth", 
       subtitle = "Refugee population Vs GDP", 
       y = "Refugee", 
       x = "Gross domestic product (GDP)", 
       caption = "2016 Figures, UNHCR https://www.unhcr.org/refugee-statistics/, World bank") +
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  theme(axis.title = element_text(size = 12))


```

## Mapping Refugee Location

```{r , message = FALSE, warning = FALSE}

# Merge data with geographic coordinates
world <- merge(x = world , y = df2, by.y = "CountryAsylumCode" , by.x = "iso_a3")
df3 <- merge(x = df2 , y = world_points, by.x = "CountryAsylumCode" , by.y = "iso_a3")


# plot
ggplot(data = world) + 
  geom_sf(fill = "antiquewhite", colour = "#7f7f7f", size = 0.2) + 
  coord_sf(xlim = c(-25, 65), ylim = c(25, 75), expand = FALSE) + ## Clipping on Mediterranean Sea
  geom_point(data = df3, aes(x = X, y = Y , size = Value2 ), 
             alpha = 0.6, colour = "red") +
  scale_size_area( max_size = 20) +
  xlab("") +
  ylab("") + 
  ggtitle("Refugee Distribution") + 
  
  unhcRstyle::unhcr_theme() + ## Insert UNHCR Style
  theme(panel.grid.major = element_line(color = gray(.5), 
                                        linetype = "dashed", size = 0.5),
        panel.background = element_rect(fill = "aliceblue"),
        axis.text.x  = element_blank(),
        axis.text.y  = element_blank(),
        legend.position = "none"
        )


```

