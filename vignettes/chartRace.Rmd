---
title: "Building a Chart Race for Refugees"
output: 
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Building a Chart Race for Refugees}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


Note that you can find the source code for all the chart below in the [Repository](https://github.com/unhcr/unhcrdatapackage/tree/master/vignettes).

```{r setup, include = FALSE, echo = FALSE, warning = FALSE}
using <- function(...) {
    libs <- unlist(list(...))
    req <- unlist(lapply(libs,require,character.only = TRUE))
    need <- libs[req == FALSE]
    if (length(need) > 0) { 
        install.packages(need)
        lapply(need,require,character.only = TRUE)
    }
}

using('tidyverse','gganimate','gghighlight','ggpubr', 'dplyr', 'tidyr', 'gapminder', 'ggplot2',  'ggalt', 'forcats', 'R.utils', 'png', 'grid', 'ggpubr', 'scales', 'bbplot', 'markdown', 'pander', 'ISOcodes', 'wbstats', 'sf', 'rnaturalearth', 'rnaturalearthdata', 'ggspatial', 'hrbrthemes')

library(unhcrdatapackage)
library(unhcRstyle)
options(scipen = 999) # turn-off scientific notation like 1e+48
```

"Bar Chart Race" are a specific type of bar chart that moves to show rankings over time. It became recently a quite popular approach to bring a storytelling elements within a longitudinal dataset. Readers are suggested to connect and combine what they see on the chart with other qualitative elements that they know about (elements of history). By using the allegory of  F1 Race, it gives a very dynamic dimension. 

With R, it's fairly easy to reproduce such visualization - We will show here how to use `gganimate` R packages to display evolution of refugees & IDP's number over time based on UNHCR statistics

The visualization below uses data from UNHCR popstat and data.worldbank API

```{r getdata, message=FALSE, warning=FALSE, echo = FALSE}
time_series <-  unhcrdatapackage::end_year_population_totals
reference <- unhcrdatapackage::reference

lastyear <- max(time_series$Year)

# Population, GDP & GNP per Capita from WorldBank
wb_data <- wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
                startdate = 1951, enddate = lastyear, return_wide = TRUE)
# # Renaming variables for further matching
names(wb_data)[1] <- "CountryAsylumCode"
names(wb_data)[2] <- "Year"
# 
# write.csv(wb_data, "wb_data.csv", row.names = FALSE)

```

Reshape the data to get the top 10 for each year using tidyverse


```{r reshapedata, message=FALSE, warning=FALSE}

time_series2 <- reshape2::melt(time_series,
                                           # ID variables - all the variables to keep but not split apart on
                                           id.vars=c("Year", "CountryOriginCode","CountryAsylumCode","CountryOriginName","CountryAsylumName" ),
                                           # The source columns
                                           measure.vars=c("REF","IDP",
                                                          "ASY","OOC","STA",
                                                          "VDA"),
                                           # Name of the destination column that will identify the original
                                           # column that the measurement came from
                                           variable.name="Population.type",
                                           value.name="Value") 

## Now get the rank from high to low for all countries per  year and population type
rank_data <- time_series2 %>%
  group_by(Year, Population.type, CountryAsylumName, CountryAsylumCode) %>%
  summarise(Value2 = sum(Value) ) 


#str(as.data.frame(rank_data))
rank_data <- as.data.frame(rank_data)


rank_data1 <- merge(x = rank_data, y = wb_data, by = c("CountryAsylumCode", "Year"), all.x = TRUE)
rank_data1$Ref.per.pop <- round(rank_data1$Value2 / rank_data1$SP.POP.TOTL *100 , 2)
rank_data1$Ref.per.gdp <- round(rank_data1$NY.GDP.MKTP.CD / rank_data1$Value2 , 2)
rank_data1$Ref.per.gdp.cap <-  round(rank_data1$NY.GDP.PCAP.CD / rank_data1$Value2 , 2)



rank_data.ref <- rank_data1 %>%
  group_by(Year, Population.type) %>%
  
  ## Tried first rank but did not provided ranks as integer... 
  # mutate(ordering = rank(-Value), ties.method = "min") %>%
  
  mutate(ordering = rank(-Value2)) %>%
  ungroup() 

## check our value for rank -- Note that there are different tie method
#levels(as.factor(rank_data$ordering))

## need to fix manually issue when ex-aequo rank rank = 8.5 

## In 1962
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1962" &
                      rank_data.ref$Population.type %in% c("REF")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1962" &
                      rank_data.ref$CountryAsylumName == "Burundi" &
                      rank_data.ref$Population.type %in% c("REF")] <- 9

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1962" &
                      rank_data.ref$CountryAsylumName == "Austria" &
                      rank_data.ref$Population.type %in% c("REF")] <- 10


## In 1978
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1978" &
                      rank_data.ref$Population.type %in% c("REF")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1978" &
                      rank_data.ref$CountryAsylumName == "Viet Nam" &
                      rank_data.ref$Population.type %in% c("REF")] <- 9

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1978" &
                      rank_data.ref$CountryAsylumName == "United Kingdom" & 
                      rank_data.ref$Population.type %in% c("REF")] <- 10


## and for IPDs

rank_data.ref$CountryAsylumName <- as.character(rank_data.ref$CountryAsylumName)

## In 1996
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$CountryAsylumName == "Somalia" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11


rank_data.ref$CountryAsylumName[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- "Sri Lanka / Somalia"

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka / Somalia" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- 10

## in 1997
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$CountryAsylumName == "Somalia" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11


rank_data.ref$CountryAsylumName[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- "Sri Lanka / Somalia"

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka / Somalia" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- 10


rank_data.ref$CountryAsylumName <- as.factor(rank_data.ref$CountryAsylumName)

# Filter only top 10 
rank_data.ref <- rank_data.ref[rank_data.ref$ordering <= 10, ]
#rank_data$Year = as.Date(as.character(rank_data$Year), format = "%Y")


## Regnerate facors modality - 
rank_data.ref$CountryAsylumName <- as.factor(as.character(rank_data.ref$CountryAsylumName))
# levels(as.factor(rank_data.ref$CountryAsylumName))
## Double checking country name
#table(time_series2$Country, useNA = "ifany")
reference$CountryAsylumCode <- reference$iso_3
rank_data.ref <- dplyr::left_join(x = rank_data.ref, y = reference, by = ("CountryAsylumCode") )
rank_data.ref$REGION_UN <- as.factor(as.character(rank_data.ref$REGION_UN))
```



# Displaced Population Race



```{r chart1951, message=FALSE, warning=FALSE, echo = FALSE}
## In 1951
# ggplot(rank_data.ref[ rank_data.ref$Year == 1951 & rank_data.ref$Population.type %in% c("REF"), ]) +
#   geom_bar(aes(y = Value2,  
#                x =   reorder(ordering, desc(ordering)),
#                group = CountryAsylumName,
#                color = UNHCRBureau, 
#                fill = UNHCRBureau), 
#            alpha = 0.75, stat = "identity") +
#   geom_label(aes(y = 0 ,
#                  x =  reorder(ordering, desc(ordering)), 
#                  label = CountryAsylumName),
#              hjust = 0,
#              vjust = 0.5,
#              fill = NA,
#              label.size = NA,
#              family = "Helvetica",
#              size = 6) +
#   coord_flip(clip = "off", expand = FALSE) +
#   scale_color_viridis_d(option = "plasma" ) +
#   scale_fill_viridis_d(option = "plasma") +
#   scale_y_continuous(labels = format_si()) +
#   guides(color = F, fill = F) +
#   labs(title =  "Top 10 Hosting Countries",
#        subtitle = 'Year 1951',
#        y = "Population Size",
#        x = "",
#        caption =  "Source: UNHCR Population Statistics -http://popstats.unhcr.org ") +
#   unhcRstyle::unhcr_theme() +
#   theme(#plot.title = element_text(hjust = 1, size = 22),
#         axis.ticks.y = element_blank(),
#         axis.text.y  = element_blank(), 
#         panel.background  = element_blank(), 
#         panel.grid = element_blank(),
#         plot.background = element_blank(),
#         legend.position = "bottom",
#         panel.grid.major.x = element_line(color = "#cbcbcb"), 
#         panel.grid.major.y = element_blank()) 

```



```{r chart2017facet, message=FALSE, warning=FALSE, echo = FALSE}
# ## by Population Group for 2017
# 
# ggplot(rank_data.ref[ rank_data.ref$Year == 2017, ]) +
#   geom_bar(aes(y = Value2,  x =   reorder(ordering, desc(ordering)),
#                group = CountryAsylumName ,color = CountryAsylumName, fill = CountryAsylumName), alpha = 0.75, stat = "identity") +
#   
#   geom_label(aes(y = 0 , x =  reorder(ordering, desc(ordering)), label = CountryAsylumName),
#              hjust = 0,
#              vjust = 0.5,
#              fill = NA,
#              label.size = NA,
#              family = "Helvetica",
#              size = 6) +
#   
#   #facet_wrap( ~ Population.type) +
#   facet_grid(. ~ Population.type) +
#   coord_flip(clip = "off", expand = FALSE) +
#   scale_color_viridis_d(option = "plasma" ) +
#   scale_fill_viridis_d(option = "plasma") +
#   scale_y_continuous(labels = format_si()) +
#   theme_minimal(14, "Avenir") +
#   
#   guides(color = F, fill = F) +
#   labs(title =  "Top 10 Countries",
#        subtitle = 'Year 2017',
#        y = "Population Size",
#        x = "",
#        caption =  "Source: UNHCR Population Statistics -http://popstats.unhcr.org ") +
#   theme(plot.title = element_text(hjust = 1, size = 22),
#         axis.ticks.y = element_blank(),
#         axis.text.y  = element_blank(), 
#         panel.background  = element_blank(), 
#         panel.grid = element_blank(),
#         plot.background = element_blank(),
#         legend.position = "bottom",
#         panel.grid.major.x = element_line(color = "#cbcbcb"), 
#         panel.grid.major.y = element_blank()) 

```




## Animate

For animation, the main challenge is to tune parameters. 


 * use geom_tile, not geom_bar as this allows for better transitions within gganimate
 * gganimate functions transition_time and ease_aes handle the animation and transition between bars. The settings here worked well for my purposes, but dig into these functions to get an overview of different options
 * nframes and fps parameters to the animate function control the speed of transitions. One mistake I made here initially was to set nframes equal to the number of years in the dataset. This works, but because there is only 1 frame per year, you don't get the smooth transitions that I wanted in this graph. Increasing the number of frames fixed that issue.

nframes	: The number of frames to render (default 100)

fps	: The framerate of the animation in frames/sec (default 10)

and animate.... the bar chart race... 

```{r barchartrace , message=FALSE, warning=FALSE, echo = FALSE}

p <- rank_data.ref[rank_data.ref$Population.type %in% c("REF"), ] %>%
  ggplot(aes(y = Value2,  
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Value2 / 2, 
                height = Value2, 
                fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), 
            hjust = "right", colour = "black", 
            fontface = "bold", nudge_y = -100000) +
  geom_text(aes(label = scales::comma(Value2)), 
            hjust = "left", nudge_y = 100000, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("",labels = format_si()) +
  
  unhcRstyle::unhcr_theme() +
#  hrbrthemes::theme_ipsum(plot_title_size = 32, subtitle_size = 24, caption_size = 12, base_size = 22) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Refugee Hosting Countries',
       subtitle = 'Refugee Population in {round(frame_time,0)}',
       caption = 'Source: UNHCR http://popstats.unhcr.org')


#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_ref_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```

## Animate IDPs..

```{r barchartrace2 , message=FALSE, warning=FALSE, echo = FALSE}

p <- rank_data.ref[rank_data.ref$Population.type %in% c("IDP"), ] %>%
  ggplot(aes(y = Value2,  
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Value2 / 2, 
                height = Value2, 
                fill = REGION_UN), 
            width = 0.9) +
  geom_text(aes(label = CountryAsylumName), 
            hjust = "right", colour = "black", fontface = "bold", nudge_y = -100000) +
  geom_text(aes(label = scales::comma(Value2)), 
            hjust = "left", nudge_y = 100000, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("",labels = format_si()) +
  unhcRstyle::unhcr_theme() +
#  hrbrthemes::theme_ipsum(plot_title_size = 32, subtitle_size = 24, caption_size = 12, base_size = 22) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Countries hosting Internally Displaced Persons',
       subtitle = 'Displaced Population in {round(frame_time,0)}',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_idp_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```


# Race Weighted by Refugee Ratio


```{r preparedata2, message=FALSE, warning=FALSE, echo = FALSE}


rank_data.pop <- rank_data.ref %>%
    filter( !(is.na(Ref.per.pop))) %>%
    group_by(Year, Population.type) %>%
    mutate(ordering = rank(-Ref.per.pop)) %>%
    ungroup() %>%
    select(CountryAsylumName, Year, Ref.per.pop, ordering, Value2, Population.type, REGION_UN)

rank_data.pop$CountryAsylumName <- as.factor(as.character(rank_data.pop$CountryAsylumName))
rank_data.pop <- rank_data.pop[rank_data.pop$ordering <= 10, ]

rank_data.pop$REGION_UN <- as.factor(as.character(rank_data.pop$REGION_UN))
#rank_data.pop$ordering <- as.integer(rank_data.pop$ordering)


rank_data.pop$CountryAsylumName <- as.character(rank_data.pop$CountryAsylumName)

# levels(as.factor(rank_data.pop$ordering))
# View(rank_data.pop[ rank_data.pop$ordering == "9.5" &
#                       rank_data.pop$Population.type %in% c("REF"), ])
# 
# View(rank_data.pop[  rank_data.pop$Year == "1972"&
#                        rank_data.pop$Population.type %in% c("REF"), ])

## Need to fix manually issue when ex-aequo rank 


## In 1964
rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1964" &
                         rank_data.pop$CountryAsylumName == "Austria" &
                         rank_data.pop$Population.type %in% c("REF")] <- 9

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1964" &
                         rank_data.pop$CountryAsylumName == "Switzerland" &
                         rank_data.pop$Population.type %in% c("REF")] <- 10


## In 1967
rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1967" &
                         rank_data.pop$CountryAsylumName == "France" &
                         rank_data.pop$Population.type %in% c("REF")] <- 8

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1967" &
                         rank_data.pop$CountryAsylumName == "Belgium" &
                         rank_data.pop$Population.type %in% c("REF")] <- 9

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1967" &
                         rank_data.pop$CountryAsylumName == "Sudan" &
                         rank_data.pop$Population.type %in% c("REF")] <- 10

# rank_data.pop[rank_data.pop$ordering == 9.5 &
#                          rank_data.pop$Year == "1967" &
#                          rank_data.pop$CountryAsylumName == "	Switzerland" &
#                          rank_data.pop$Population.type %in% c("REF")] <- NULL

## In 1972
rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1972" &
                         rank_data.pop$CountryAsylumName == "Switzerland" &
                         rank_data.pop$Population.type %in% c("REF")] <- 9

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1972" &
                         rank_data.pop$CountryAsylumName == "	Zambia" &
                         rank_data.pop$Population.type %in% c("REF")] <- 10



## In 1973
rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "1973" &
                         rank_data.pop$CountryAsylumName == "Zambia" &
                         rank_data.pop$Population.type %in% c("REF")] <- 6

rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "1973" &
                         rank_data.pop$CountryAsylumName == "United Arab Emirates" &
                         rank_data.pop$Population.type %in% c("REF")] <- 7


## In 2003
rank_data.pop$ordering[rank_data.pop$ordering == 5.5 &
                         rank_data.pop$Year == "2003" &
                         rank_data.pop$CountryAsylumName == "Guinea" &
                         rank_data.pop$Population.type %in% c("REF")] <- 6

rank_data.pop$ordering[rank_data.pop$ordering == 5.5 &
                         rank_data.pop$Year == "2003" &
                         rank_data.pop$CountryAsylumName == "Zambia" &
                         rank_data.pop$Population.type %in% c("REF")] <- 5


## In 2009
rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "2009" &
                         rank_data.pop$CountryAsylumName == "Iran (Islamic Rep. of)" &
                         rank_data.pop$Population.type %in% c("REF")] <- 6

rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "2009" &
                         rank_data.pop$CountryAsylumName == "Djibouti" &
                         rank_data.pop$Population.type %in% c("REF")] <- 7

## Regenerate factors modality - 
rank_data.pop$CountryAsylumName <- as.factor(as.character(rank_data.pop$CountryAsylumName))

rank_data.pop$ordering <- as.integer(as.character(rank_data.pop$ordering))

```


```{r chart2017facet2, message=FALSE, warning=FALSE, echo = FALSE}

# ggplot(rank_data.pop[ rank_data.pop$Year == 2017, ]) +
#   geom_bar(aes(y = Ref.per.pop,  x =   reorder(ordering, desc(ordering)),
#                group = CountryAsylumName ,color = CountryAsylumName, fill = CountryAsylumName), alpha = 0.75, stat = "identity") +
#   
#   geom_label(aes(y = 0 , 
#                  x =  reorder(ordering, desc(ordering)), 
#                  label = CountryAsylumName),
#              hjust = 0,
#              vjust = 0.5,
#              fill = NA,
#              label.size = NA,
#              family = "Helvetica",
#              size = 6) +
#   
#   #facet_wrap( ~ Population.type) +
#     facet_grid(. ~ Population.type) +
#   coord_flip(clip = "off", expand = FALSE) +
#   scale_color_viridis_d(option = "plasma" ) +
#   scale_fill_viridis_d(option = "plasma") +
#   scale_y_continuous(labels = format_si()) +
#   guides(color = F, fill = F) +
#   labs(title =  "Top 10 Countries Displaced Vs Population",
#        subtitle = 'Year 2017',
#        y = "Refugee to Population Ratio",
#        x = "",
#        caption =  "Source: UNHCR Population Statistics -http://popstats.unhcr.org - World Bank ") +
#   unhcRstyle::unhcr_theme() +
# # theme_minimal(14, "Avenir") +
#   theme(#plot.title = element_text(hjust = 1, size = 22),
#         axis.ticks.y = element_blank(),
#         axis.text.y  = element_blank(), 
#         panel.background  = element_blank(), 
#         panel.grid = element_blank(),
#         plot.background = element_blank(),
#         legend.position = "bottom",
#         panel.grid.major.x = element_line(color = "#cbcbcb"), 
#         panel.grid.major.y = element_blank()) 

```


```{r chart2017pop, message=FALSE, warning=FALSE, echo = FALSE}

# ggplot(rank_data.pop[ rank_data.pop$Year == lastyear & 
#                         rank_data.pop$Population.type %in% c("REF)"), ]) +
#   geom_bar(aes(y = Ref.per.pop,  x =   reorder(ordering, desc(ordering)),
#                group = CountryAsylumName ,color = CountryAsylumName, fill = CountryAsylumName), alpha = 0.75, stat = "identity") +
#   
#   geom_label(aes(y = 0 , x =  reorder(ordering, desc(ordering)), label = CountryAsylumName),
#              hjust = 0,
#              vjust = 0.5,
#              fill = NA,
#              label.size = NA,
#              family = "Helvetica",
#              size = 6) +
#   
#   #facet_wrap( ~ Population.type) +
#   #facet_grid(. ~ Population.type) +
#   coord_flip(clip = "off", expand = FALSE) +
#   scale_color_viridis_d(option = "plasma" ) +
#   scale_fill_viridis_d(option = "plasma") +
#   scale_y_continuous(labels = format_si()) +
#   theme_minimal(14, "Avenir") +
#   
#   guides(color = F, fill = F) +
#   labs(title =  "Top 10 Countries Refugee per Population",
#        subtitle = paste0('Year ',lastyear),
#        y = "Refugee to Population Ratio",
#        x = "",
#        caption =  "Source: UNHCR Population Statistics -http://popstats.unhcr.org - World Bank ") +
#   theme(plot.title = element_text(hjust = 1, size = 22),
#         axis.ticks.y = element_blank(),
#         axis.text.y  = element_blank(), 
#         panel.background  = element_blank(), 
#         panel.grid = element_blank(),
#         plot.background = element_blank(),
#         legend.position = "bottom",
#         panel.grid.major.x = element_line(color = "#cbcbcb"), 
#         panel.grid.major.y = element_blank()) 

```




```{r barchartrace31 , message=FALSE, warning=FALSE, echo = FALSE}


p <- rank_data.pop[rank_data.pop$Population.type %in% c("REF"), ] %>%
  ggplot(aes(y = Ref.per.pop, 
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Ref.per.pop / 2, height = Ref.per.pop, fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), hjust = "right", colour = "black", fontface = "bold", nudge_y = -1) +
  geom_text(aes(label = scales::comma(Ref.per.pop)), hjust = "left", nudge_y = 1, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("", labels = format_si()) +
  unhcRstyle::unhcr_theme()+
  #hrbrthemes::theme_ipsum(plot_title_size = 32, subtitle_size = 24, caption_size = 12, base_size = 22) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Refugee Hosting Countries',
       subtitle = 'Ratio 1 in Refugee / 100 in Population in {round(frame_time,0)} ',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700, 
        end_pause = 50,
        renderer = gifski_renderer("anim_ref_ratio_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```


# Race Weighted by GDP

```{r preparedata3, message=FALSE, warning=FALSE, echo = FALSE}
rank_data.gdp <- rank_data.ref %>%
    filter( !(is.na(Ref.per.gdp))) %>%
  group_by(Year, Population.type) %>%
  mutate(ordering = rank(-Ref.per.gdp)) %>%
  ungroup() %>%
  select(CountryAsylumName, Year, Ref.per.gdp, ordering, Value2, Population.type, REGION_UN)

rank_data.gdp <- rank_data.gdp[rank_data.gdp$ordering <= 10, ]

## Check exaequo
# levels(as.factor(rank_data.gdp$ordering))

```

```{r chart2017facet3, message=FALSE, warning=FALSE, echo = FALSE}
# ggplot(rank_data.gdp[ rank_data.gdp$Year == lastyear, ]) +
#   geom_bar(aes(y = Ref.per.gdp,  x =   reorder(ordering, desc(ordering)),
#                group = CountryAsylumName ,
#                color = CountryAsylumName, 
#                fill = CountryAsylumName), 
#            alpha = 0.75, stat = "identity") +
#   geom_label(aes(y = 0 , x =  reorder(ordering, desc(ordering)), label = CountryAsylumName),
#              hjust = 0,
#              vjust = 0.5,
#              fill = NA,
#              label.size = NA,
#              family = "Helvetica",
#              size = 6) +
#   
#   #facet_wrap( ~ Population.type) +
#   facet_grid(. ~ Population.type) +
#   coord_flip(clip = "off", expand = FALSE) +
#   scale_color_viridis_d(option = "plasma" ) +
#   scale_fill_viridis_d(option = "plasma") +
#   scale_y_continuous(labels = format_si()) +
#   guides(color = F, fill = F) +
#   labs(title =  "Top 10 Countries Refugee per GGP",
#        subtitle = paste0('Year ',lastyear),
#        y = "Refugee to GDP Ratio",
#        x = "",
#        caption =  "Source: UNHCR Population Statistics -http://popstats.unhcr.org - World Bank ") +
#   
#   unhcRstyle::unhcr_theme()+
#   theme(plot.title = element_text(hjust = 1, size = 22),
#         axis.ticks.y = element_blank(),
#         axis.text.y  = element_blank(), 
#         panel.background  = element_blank(), 
#         panel.grid = element_blank(),
#         plot.background = element_blank(),
#         legend.position = "bottom",
#         panel.grid.major.x = element_line(color = "#cbcbcb"), 
#         panel.grid.major.y = element_blank()) 

```



```{r barchartrace4 , message=FALSE, warning=FALSE, echo = FALSE}
p <- rank_data.gdp[rank_data.gdp$Population.type %in% c("REF"), ] %>%
  ggplot(aes(y = Ref.per.gdp,  
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Ref.per.gdp / 2, 
                height = Ref.per.gdp, 
                fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), hjust = "right", colour = "black", fontface = "bold", nudge_y = -1) +
  geom_text(aes(label = scales::comma(Ref.per.gdp)), hjust = "left", nudge_y = 1, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("", labels = format_si()) +
  unhcRstyle::unhcr_theme()+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Refugee Hosting Countries in relation to GDP',
       subtitle = 'Ratio  GDP USD / Refugee in {round(frame_time,0)} ',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_ref_gdp_race.gif"))

```


```{r barchartrace41 , message=FALSE, warning=FALSE, echo = FALSE}
p <- rank_data.gdp[rank_data.gdp$Population.type %in% c("IDP"), ] %>%
  ggplot(aes(y = Ref.per.gdp,  x =   reorder(ordering, desc(ordering)), group = CountryAsylumName ,)) +
  geom_tile(aes(y = Ref.per.gdp / 2, height = Ref.per.gdp, fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), hjust = "right", colour = "black", fontface = "bold", nudge_y = -1) +
  geom_text(aes(label = scales::comma(Ref.per.gdp)), hjust = "left", nudge_y = 1, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("", labels = format_si()) +
  unhcRstyle::unhcr_theme()+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Countries with Internally displaced persons in relation to GDP',
       subtitle = 'Ratio  GDP USD / Internally displaced persons in {round(frame_time,0)} ',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_idp_gdp_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```




