---
title: "Building a Chart Race for Refugees"
output: 
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Building a Chart Race for Refugees}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


Note that you can find the source code for all the chart below in the [Repository](https://github.com/unhcr/unhcrdatapackage/tree/master/vignettes).

```{r setup, include = FALSE, echo = FALSE, warning = FALSE}
using <- function(...) {
    libs <- unlist(list(...))
    req <- unlist(lapply(libs,require,character.only = TRUE))
    need <- libs[req == FALSE]
    if (length(need) > 0) { 
        install.packages(need)
        lapply(need,require,character.only = TRUE)
    }
}

using('tidyverse','gganimate','gghighlight','ggpubr', 'dplyr', 'tidyr', 'gapminder', 'ggplot2',  'ggalt', 'forcats', 'R.utils', 'png', 'grid', 'ggpubr', 'scales',  'markdown', 'pander', 'ISOcodes', 'wbstats', 'sf', 'rnaturalearth', 'rnaturalearthdata', 'ggspatial')

library(unhcrdatapackage)
library(unhcRstyle)
options(scipen = 999) # turn-off scientific notation like 1e+48
```

"Bar Chart Race" are a specific type of bar chart that moves to show rankings over time. It became recently a quite popular approach to bring a storytelling elements within a longitudinal dataset. Readers are suggested to connect and combine what they see on the chart with other qualitative elements that they know about (elements of history). By using the allegory of  F1 Race, it gives a very dynamic visualisation dimension. 

With R, it's fairly easy to reproduce such visualization - We will show here how to use `gganimate` R packages to display evolution of refugees & IDP's number over time based on UNHCR statistics

The visualization below uses data from UNHCR and data.worldbank API

```{r getdata, message=FALSE, warning=FALSE, echo = FALSE, , include=FALSE} 
end_year_population_totals_long <-  unhcrdatapackage::end_year_population_totals_long  
reference <- unhcrdatapackage::reference
lastyear <- max(end_year_population_totals_long$Year)
```



```{r reshapedata, message=FALSE, warning=FALSE, include=FALSE}
## Now get the rank from high to low for all countries per  year and population type
rank_data <- end_year_population_totals_long %>%
  group_by(Year, Population.type, CountryAsylumName, CountryAsylumCode) %>%
  summarise(Value2 = sum(Value) ) 


#str(as.data.frame(rank_data))
rank_data <- as.data.frame(rank_data)

rank_data.ref <- rank_data %>%
  group_by(Year, Population.type) %>%
  
  ## Tried first rank but did not provided ranks as integer... 
  # mutate(ordering = rank(-Value), ties.method = "min") %>%
  
  mutate(ordering = rank(-Value2)) %>%
  ungroup() 

## check our value for rank -- Note that there are different tie method
#levels(as.factor(rank_data.ref$ordering))

## need to fix manually issue when ex-aequo rank rank = 8.5 

## In 1962
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1962" &
                      rank_data.ref$Population.type %in% c("REF")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1962" &
                      rank_data.ref$CountryAsylumName == "Burundi" &
                      rank_data.ref$Population.type %in% c("REF")] <- 9

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1962" &
                      rank_data.ref$CountryAsylumName == "Austria" &
                      rank_data.ref$Population.type %in% c("REF")] <- 10


## In 1978
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1978" &
                      rank_data.ref$Population.type %in% c("REF")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1978" &
                      rank_data.ref$CountryAsylumName == "Viet Nam" &
                      rank_data.ref$Population.type %in% c("REF")] <- 9

rank_data.ref$ordering[rank_data.ref$ordering == 8.5 &
                      rank_data.ref$Year == "1978" &
                      rank_data.ref$CountryAsylumName == "United Kingdom" & 
                      rank_data.ref$Population.type %in% c("REF")] <- 10


## and for IPDs

rank_data.ref$CountryAsylumName <- as.character(rank_data.ref$CountryAsylumName)

## In 1996
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$CountryAsylumName == "Somalia" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11


rank_data.ref$CountryAsylumName[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- "Sri Lanka / Somalia"

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1996" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka / Somalia" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- 10

## in 1997
rank_data.ref$ordering[rank_data.ref$ordering == 10 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$CountryAsylumName == "Somalia" &
                      rank_data.ref$Population.type %in% c("IDP")] <- 11


rank_data.ref$CountryAsylumName[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- "Sri Lanka / Somalia"

rank_data.ref$ordering[rank_data.ref$ordering == 9.5 &
                      rank_data.ref$Year == "1997" &
                      rank_data.ref$CountryAsylumName == "Sri Lanka / Somalia" & 
                      rank_data.ref$Population.type %in% c("IDP")] <- 10


rank_data.ref$CountryAsylumName <- as.factor(rank_data.ref$CountryAsylumName)

# Filter only top 10 
rank_data.ref <- rank_data.ref[rank_data.ref$ordering <= 10, ]
#rank_data$Year = as.Date(as.character(rank_data$Year), format = "%Y")

## check our value for rank -- Note that there are different tie method
#levels(as.factor(rank_data.ref$ordering))

## Regnerate factors modality - 
rank_data.ref$CountryAsylumName <- as.factor(as.character(rank_data.ref$CountryAsylumName))
# levels(as.factor(rank_data.ref$CountryAsylumName))
## Double checking country name
#table(end_year_population_totals_long$Country, useNA = "ifany")

```

```{r getdatawb, message=FALSE, warning=FALSE, echo = FALSE, cache=TRUE, include=FALSE}
# Population, GDP & GNP per Capita from WorldBank
wb_data <- wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
                startdate = 1951, enddate = lastyear, return_wide = TRUE)
# # Renaming variables for further matching
names(wb_data)[1] <- "CountryAsylumCode"
names(wb_data)[2] <- "Year"
# write.csv(wb_data, "wb_data.csv", row.names = FALSE)
```


```{r mergedata, message=FALSE, warning=FALSE, include=FALSE}
## Merge with Reference
reference$CountryAsylumCode <- reference$iso_3
rank_data.ref <- dplyr::left_join(x = rank_data.ref, y = reference, by = ("CountryAsylumCode") )
rank_data.ref$REGION_UN <- as.factor(as.character(rank_data.ref$REGION_UN))

## Merge with World Bank API data
rank_data.ref <- merge(x = rank_data.ref, y = wb_data, by = c("CountryAsylumCode", "Year"), all.x = TRUE)
rank_data.ref$Ref.per.pop <- round(rank_data.ref$Value2 / rank_data.ref$SP.POP.TOTL *100 , 2)
rank_data.ref$Ref.per.gdp <- round(rank_data.ref$NY.GDP.MKTP.CD / rank_data.ref$Value2 , 2)
rank_data.ref$Ref.per.gdp.cap <-  round(rank_data.ref$NY.GDP.PCAP.CD / rank_data.ref$Value2 , 2)

```

```{r preparedata2, message=FALSE, warning=FALSE, echo = FALSE}
rank_data.pop <- rank_data.ref %>%
    filter( !(is.na(Ref.per.pop))) %>%
    group_by(Year, Population.type) %>%
    mutate(ordering = rank(-Ref.per.pop)) %>%
    ungroup() %>%
    select(CountryAsylumName, Year, Ref.per.pop, ordering, Value2, Population.type, REGION_UN)

rank_data.pop$CountryAsylumName <- as.factor(as.character(rank_data.pop$CountryAsylumName))
rank_data.pop <- rank_data.pop[rank_data.pop$ordering <= 10, ]

rank_data.pop$REGION_UN <- as.factor(as.character(rank_data.pop$REGION_UN))
#rank_data.pop$ordering <- as.integer(rank_data.pop$ordering)


rank_data.pop$CountryAsylumName <- as.character(rank_data.pop$CountryAsylumName)

# levels(as.factor(rank_data.pop$ordering))
# View(rank_data.pop[ rank_data.pop$ordering == "9.5" &
#                       rank_data.pop$Population.type %in% c("REF"), ])
# 
# View(rank_data.pop[  rank_data.pop$Year == "1972"&
#                        rank_data.pop$Population.type %in% c("REF"), ])

## Need to fix manually issue when ex-aequo rank 


## In 1964
rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1964" &
                         rank_data.pop$CountryAsylumName == "Austria" &
                         rank_data.pop$Population.type %in% c("REF")] <- 9

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1964" &
                         rank_data.pop$CountryAsylumName == "Switzerland" &
                         rank_data.pop$Population.type %in% c("REF")] <- 10


## In 1967
rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1967" &
                         rank_data.pop$CountryAsylumName == "France" &
                         rank_data.pop$Population.type %in% c("REF")] <- 8

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1967" &
                         rank_data.pop$CountryAsylumName == "Belgium" &
                         rank_data.pop$Population.type %in% c("REF")] <- 9

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1967" &
                         rank_data.pop$CountryAsylumName == "Sudan" &
                         rank_data.pop$Population.type %in% c("REF")] <- 10

# rank_data.pop[rank_data.pop$ordering == 9.5 &
#                          rank_data.pop$Year == "1967" &
#                          rank_data.pop$CountryAsylumName == "	Switzerland" &
#                          rank_data.pop$Population.type %in% c("REF")] <- NULL

## In 1972
rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1972" &
                         rank_data.pop$CountryAsylumName == "Switzerland" &
                         rank_data.pop$Population.type %in% c("REF")] <- 9

rank_data.pop$ordering[rank_data.pop$ordering == 9.5 &
                         rank_data.pop$Year == "1972" &
                         rank_data.pop$CountryAsylumName == "	Zambia" &
                         rank_data.pop$Population.type %in% c("REF")] <- 10



## In 1973
rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "1973" &
                         rank_data.pop$CountryAsylumName == "Zambia" &
                         rank_data.pop$Population.type %in% c("REF")] <- 6

rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "1973" &
                         rank_data.pop$CountryAsylumName == "United Arab Emirates" &
                         rank_data.pop$Population.type %in% c("REF")] <- 7


## In 2003
rank_data.pop$ordering[rank_data.pop$ordering == 5.5 &
                         rank_data.pop$Year == "2003" &
                         rank_data.pop$CountryAsylumName == "Guinea" &
                         rank_data.pop$Population.type %in% c("REF")] <- 6

rank_data.pop$ordering[rank_data.pop$ordering == 5.5 &
                         rank_data.pop$Year == "2003" &
                         rank_data.pop$CountryAsylumName == "Zambia" &
                         rank_data.pop$Population.type %in% c("REF")] <- 5


## In 2009
rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "2009" &
                         rank_data.pop$CountryAsylumName == "Iran (Islamic Rep. of)" &
                         rank_data.pop$Population.type %in% c("REF")] <- 6

rank_data.pop$ordering[rank_data.pop$ordering == 6.5 &
                         rank_data.pop$Year == "2009" &
                         rank_data.pop$CountryAsylumName == "Djibouti" &
                         rank_data.pop$Population.type %in% c("REF")] <- 7

## Regenerate factors modality - 
rank_data.pop$CountryAsylumName <- as.factor(as.character(rank_data.pop$CountryAsylumName))

rank_data.pop$ordering <- as.integer(as.character(rank_data.pop$ordering))

```

```{r preparedata3, message=FALSE, warning=FALSE, echo = FALSE}
rank_data.gdp <- rank_data.ref %>%
    filter( !(is.na(Ref.per.gdp))) %>%
  group_by(Year, Population.type) %>%
  mutate(ordering = rank(-Ref.per.gdp)) %>%
  ungroup() %>%
  select(CountryAsylumName, Year, Ref.per.gdp, ordering, Value2, Population.type, REGION_UN)

rank_data.gdp <- rank_data.gdp[rank_data.gdp$ordering <= 10, ]

## Check exaequo
# levels(as.factor(rank_data.gdp$ordering))

```


# Top Countries for each statistical categories

UNHCR's populations of concern status includes:

 *  __Refugees (REF)__ include individuals recognized under the 1951 Convention relating to the Status of Refugees; its 1967 Protocol; the 1969 OAU Convention Governing the Specific Aspects of Refugee Problems in Africa; those recognised in accordance with the UNHCR Statute; individuals granted complementary forms of protection; or those enjoying temporary protection. Since 2007, the refugee population also includes people in a refugee-like situation.

 *  __Asylum-seekers (ASY)__ are individuals who have sought international protection and whose claims for refugee status have not yet been determined, irrespective of when they may have been lodged.

 *  __Internally displaced persons (IDP)__ are people or groups of individuals who have been forced to leave their homes or places of habitual residence, in particular as a result of, or in order to avoid the effects of armed conflict, situations of generalised violence, violations of human rights, or natural or man-made disasters, and who have not crossed an international border. For the purposes of UNHCR's statistics, this population only includes conflict-generated IDPs to whom the Office extends protection and/or assistance. Since 2007, the IDP population also includes people in an IDP-like situation. For global IDP estimates, see www.internal-displacement.org.

 *  __Stateless persons (STA)__ are defined under international law as persons who are not considered as nationals by any State under the operation of its law. In other words, they do not possess the nationality of any State. UNHCR statistics refer to persons who fall under the agencyâ€™s statelessness mandate because they are stateless according to this international definition, but data from some countries may also include persons with undetermined nationality.

 *  __Others of concern (OOC)__ refers to individuals who do not necessarily fall directly into any of the groups above, but to whom UNHCR extends its protection and/or assistance services, based on humanitarian or other special grounds.
 
 *  __Venezuelan Displaced Abroad (VDA)__: People displaced across borders: According to interviews and protection monitoring exercises conducted by UNHCR and partners, Venezuelans claim that they are leaving the country for a variety of reasons, including persecution on account of their individual profiles, insecurity and violence, lack of access to food, medicine and essential services, as well as loss of income as a result of the current human rights, political and socioeconomic situation in Venezuela. Based on these reports, as well as reliable information in the public domain from a wide range of sources about the situation in Venezuela, UNHCR considers that for a number of profiles, international protection considerations are likely to arise under the 1951 Convention/1967 Protocol relating to the Status of Refugees depending on the circumstances of the individual case.  While individual circumstances and reasons for departure from Venezuela vary, UNHCR considers that the majority of Venezuelan nationals, or stateless persons who were habitually resident in Venezuela, are in need of international protection under the criteria contained in the Cartagena Declaration on the basis of threats to their lives, security or freedom resulting from the events that are currently seriously disturbing public order in Venezuela.


```{r chart2017facet2, message=FALSE, warning=FALSE, echo = FALSE}

ggplot(rank_data.ref[ rank_data.ref$Year == lastyear, ]) +
  geom_bar(aes(y = Value2,  x =   reorder(ordering, desc(ordering)),
               group = CountryAsylumName ,
               color = CountryAsylumName, 
               fill = CountryAsylumName), 
           alpha = 0.75, stat = "identity") +
  geom_label(aes(y = 0 ,
                 x =  reorder(ordering, desc(ordering)),
                 label = CountryAsylumName),
             hjust = 0,
             vjust = 0.5,
             fill = NA,
             label.size = NA,
             family = "Helvetica",
             size = 6) +
  facet_wrap( ~ Population.type, ncol = 3) +
  #  facet_grid(. ~ Population.type) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_color_viridis_d(option = "plasma" ) +
  scale_fill_viridis_d(option = "plasma") +
  scale_y_continuous(labels = format_si()) +
  guides(color = F, fill = F) +
  labs(title =  "Top 10 Countries Displaced Vs Population",
       subtitle = 'Year 2017',
       y = "Refugee to Population Ratio",
       x = "",
       caption =  "Source: UNHCR Population Statistics -http://popstats.unhcr.org - World Bank ") +
  unhcRstyle::unhcr_theme() +
  theme(#plot.title = element_text(hjust = 1, size = 22),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_blank(),
        panel.background  = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank(),
        legend.position = "bottom",
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.major.y = element_blank())

```


# Visualising evolution of refugee population over time.

## By Country of Asylum

```{r barchartrace , message=FALSE, warning=FALSE, echo = FALSE}

p <- rank_data.ref[rank_data.ref$Population.type %in% c("REF"), ] %>%
  ggplot(aes(y = Value2,  
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Value2 / 2, 
                height = Value2, 
                fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), 
            hjust = "right", colour = "black", 
            fontface = "bold", nudge_y = -100000) +
  geom_text(aes(label = scales::comma(Value2)), 
            hjust = "left", nudge_y = 100000, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("",labels = format_si()) +
  
  unhcRstyle::unhcr_theme() +
#  hrbrthemes::theme_ipsum(plot_title_size = 32, subtitle_size = 24, caption_size = 12, base_size = 22) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Refugee Hosting Countries',
       subtitle = 'Refugee Population in {round(frame_time,0)}',
       caption = 'Source: UNHCR http://popstats.unhcr.org')


#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_ref_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```


## By Country of Origin

# Visualising evoluation of IDPs population over time.

```{r barchartrace2 , message=FALSE, warning=FALSE, echo = FALSE}

p <- rank_data.ref[rank_data.ref$Population.type %in% c("IDP"), ] %>%
  ggplot(aes(y = Value2,  
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Value2 / 2, 
                height = Value2, 
                fill = REGION_UN), 
            width = 0.9) +
  geom_text(aes(label = CountryAsylumName), 
            hjust = "right", colour = "black", fontface = "bold", nudge_y = -100000) +
  geom_text(aes(label = scales::comma(Value2)), 
            hjust = "left", nudge_y = 100000, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("",labels = format_si()) +
  unhcRstyle::unhcr_theme() +
#  hrbrthemes::theme_ipsum(plot_title_size = 32, subtitle_size = 24, caption_size = 12, base_size = 22) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'Top 10 Countries hosting Internally Displaced Persons',
       subtitle = 'Displaced Population in {round(frame_time,0)}',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_idp_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```


# How many refugees in relation with the size of host population?

```{r barchartrace31 , message=FALSE, warning=FALSE, echo = FALSE}


p <- rank_data.pop[rank_data.pop$Population.type %in% c("REF"), ] %>%
  ggplot(aes(y = Ref.per.pop, 
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Ref.per.pop / 2, height = Ref.per.pop, fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), hjust = "right", colour = "black", fontface = "bold", nudge_y = -1) +
  geom_text(aes(label = scales::comma(Ref.per.pop)), hjust = "left", nudge_y = 1, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("", labels = format_si()) +
  unhcRstyle::unhcr_theme()+
  #hrbrthemes::theme_ipsum(plot_title_size = 32, subtitle_size = 24, caption_size = 12, base_size = 22) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'How many refugees in relation with the size of host population?',
       subtitle = 'Ratio 1 in Refugee / 100 in Population - Top 10 Countries in {round(frame_time,0)} ',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700, 
        end_pause = 50,
        renderer = gifski_renderer("anim_ref_ratio_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```


# How many refugees in relation with the wealth of host population?


```{r barchartrace4 , message=FALSE, warning=FALSE, echo = FALSE}
p <- rank_data.gdp[rank_data.gdp$Population.type %in% c("REF"), ] %>%
  ggplot(aes(y = Ref.per.gdp,  
             x =   reorder(ordering, desc(ordering)), 
             group = CountryAsylumName ,)) +
  geom_tile(aes(y = Ref.per.gdp / 2, 
                height = Ref.per.gdp, 
                fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), hjust = "right", colour = "black", fontface = "bold", nudge_y = -1) +
  geom_text(aes(label = scales::comma(Ref.per.gdp)), hjust = "left", nudge_y = 1, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("", labels = format_si()) +
  unhcRstyle::unhcr_theme()+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'How many refugees in relation with the wealth of host population?',
       subtitle = 'Ratio  GDP USD / Refugee - Top 10 Countries in {round(frame_time,0)} ',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_ref_gdp_race.gif"))

```



# How many IDPs in relation with the wealth of host population?

```{r barchartrace41 , message=FALSE, warning=FALSE, echo = FALSE}
p <- rank_data.gdp[rank_data.gdp$Population.type %in% c("IDP"), ] %>%
  ggplot(aes(y = Ref.per.gdp,  x =   reorder(ordering, desc(ordering)), group = CountryAsylumName ,)) +
  geom_tile(aes(y = Ref.per.gdp / 2, height = Ref.per.gdp, fill = REGION_UN), width = 0.9) +
  geom_text(aes(label = CountryAsylumName), hjust = "right", colour = "black", fontface = "bold", nudge_y = -1) +
  geom_text(aes(label = scales::comma(Ref.per.gdp)), hjust = "left", nudge_y = 1, colour = "grey30") +
  coord_flip(clip = "off") +
  scale_fill_manual(name = 'REGION_UN', values = c("#7fc97f", "#beaed4", "#fdc086", "#ffff99", "#386cb0")) +
  scale_x_discrete("") +
  scale_y_continuous("", labels = format_si()) +
  unhcRstyle::unhcr_theme()+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.title = element_blank(),
        plot.margin = margin(1,1,1,3,"cm"),
        axis.text.y = element_blank()) +
  # gganimate code to transition by year:
  transition_time(Year) +
  ease_aes('cubic-in-out') +
  labs(title = 'How many Internally displaced persons in relation with the wealth of host population?',
       subtitle = 'Ratio  GDP USD / Internally displaced persons - Top 10 Countries in {round(frame_time,0)} ',
       caption = 'Source: UNHCR http://popstats.unhcr.org')

#For GIF File Format:c
animate(p, #plot
        nframes = 1000, # The number of frames to render (default 100)
        fps = 20,   # The framerate of the animation in frames/sec (default 10)
        width = 1000,
        height = 700,
        end_pause = 50,
        renderer = gifski_renderer("anim_idp_gdp_race.gif"))
# renderer = ffmpeg_renderer("anim.mp4"))

```


## Annexes


For animation, the main challenge is to tune parameters. 


 * use geom_tile, not geom_bar as this allows for better transitions within gganimate
 * gganimate functions transition_time and ease_aes handle the animation and transition between bars. The settings here worked well for my purposes, but dig into these functions to get an overview of different options
 * nframes and fps parameters to the animate function control the speed of transitions. One mistake I made here initially was to set nframes equal to the number of years in the dataset. This works, but because there is only 1 frame per year, you don't get the smooth transitions that I wanted in this graph. Increasing the number of frames fixed that issue.

nframes	: The number of frames to render (default 100)

fps	: The framerate of the animation in frames/sec (default 10)

and animate.... the bar chart race... 
