---
title: "All Plotting functions"
output: html_document
editor_options: 
  chunk_output_type: console
---

<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->

```{r development, include=FALSE}
knitr::opts_chunk$set(
                      comment = "#>",
                      message=FALSE, 
                      warning=FALSE,
                      #fig.retina = 2, 
                      fig.width = 8,
                      fig.asp = 0.718,
                     # fig.align = "center",
                     # dev = "ragg_png",
                      out.width = "90%"
)
unlink(".RData")
library(testthat)
library(ggplot2)
library(tidyverse)
library(scales)
library(unhcrthemes)
# library(extrafont) 
# font_import()
# loadfonts()
# font_install('fontcm')
```

<!--
 You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.

If it is the first time you use {fusen}, after 'description', you can directly run the last chunk of the present file with inflate() inside.
--> 

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```




# Country Questions

# Population Data

## Key Figures
    
```{r function-plot_ctr_keyfig}
#' Summary Key Figures
#' 
#'  Key figures can be highlighted with humanitarian icons
#'   https://fontawesome.com/icons/categories/humanitarian  
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @return ggplot2#'
#' 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom ggtext geom_textbox
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom extrafont fonttable font_import
#' @importFrom sysfonts font_add
#' @importFrom utils download.file
#' 
#' @export

plot_ctr_keyfig <- function(country_asylum_iso3c, year){

    ## FontAwesome6  includes humanitarian icon... 
    fontcheck <- extrafont::fonttable() |>
              dplyr::as_tibble() |>
              dplyr::filter(grepl("Awesom", FamilyName)) 

    if( ! ("FontAwesome6Free-Solid" %in% fontcheck$FontName) ) {
      fa_font <- here::here("",  "fa-solid-900-6.ttf")
      download.file("https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/webfonts/fa-solid-900.ttf",
                    destfile = fa_font, method = "curl")
      extrafont::font_import(paths = dirname(fa_font), prompt = FALSE)
      sysfonts::font_add(family =  "Font Awesome 6 Free Solid", regular = fa_font)
    } else {
    
    sysfonts::font_add(family = "Font Awesome 6 Free Solid" , 
                       regular = as.character(fontcheck |> 
                                                dplyr::filter( FamilyName == "Font Awesome 6 Free Solid") |>
                                                dplyr::pull(fontfile)) )
    }
 
CountryAsylum_name_text <-  ForcedDisplacementStat::reference |> 
  dplyr::filter(iso_3 == country_asylum_iso3c ) |> 
  dplyr::distinct(ctryname) |> 
  dplyr::pull()

total_poc <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

total_poc_last_year <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == as.numeric(year)-1,
                CountryAsylumCode == country_asylum_iso3c) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

perc_change_poc <- ((total_poc - total_poc_last_year)/total_poc_last_year)*100

total_ref <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c,
                Population.type == "REF"
  ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

total_asy <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c,
                Population.type == "ASY"
  ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

total_oip <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c,
                Population.type == "OIP"
  ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

total_idp <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c,
                Population.type == "IDP"
  ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

total_sta <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c,
                Population.type == "STA"
  ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

total_ooc <- ForcedDisplacementStat::end_year_population_totals_long |> 
  dplyr::filter(Year == year,
                CountryAsylumCode == country_asylum_iso3c,
                Population.type == "OOC"
  ) |> 
  dplyr::summarise(sum(Value, na.rm = TRUE)) |> 
  dplyr::pull()

## Create the frame to be displayed with a facetted ggplot  
keyfig <- data.frame(
  ## order the factor for correct display
  fig = factor( c("Refugees", "Asylum-seekers", "Other in Need in International Protection",
               "Internally Displaced People", "Stateless People", "Others of Concerns"),
               levels = c("Refugees",
                          "Asylum-seekers",
                          "Other in Need in International Protection",
                          "Internally Displaced People",
                          "Stateless People",
                          "Others of Concerns")),  
  pal = c("REF", "ASY",  "OIP", "IDP",  "STA", "OOC"),
  icon = c("\ue4fb", # "Refugees" fa-hands-holding-circle
           "\ue553", # "Asylum-seekers" fa-person-walking-dashed-line-arrow-right
           "\ue54d", # "Other in Need in International Protection"fa-person-rays
           "\ue552", #  "Internally displaced people" fa-person-walking-arrow-right
           "\ue4b9", # "Stateless People" fa-arrows-down-to-people
           "\ue539" #  "Others of Concerns"  fa-person-arrow-up-from-line
           ),
  label = c(
  paste0( format(round(total_ref, 0), scientific = FALSE, big.mark=",") ),
  paste0( format(round(total_asy, 0),scientific = FALSE,  big.mark=",") ),
  paste0( format(round(total_oip, 0), scientific = FALSE, big.mark=",")), 
  paste0( format(round(total_idp, 0), scientific = FALSE, big.mark=",")),
  paste0( format(round(total_sta, 0),scientific = FALSE,  big.mark=",")), 
  paste0( format(round(total_ooc, 0), scientific = FALSE, big.mark=",") ) ) 
  )
  
 
 p <- ggplot(keyfig) +  
  ggtext::geom_textbox(aes(x = 0.3, 
                           y = 1,  
                 label = icon ,
                 color =  pal), 
                family = "Font Awesome 6 Free Solid",
                box.colour = NA , 
                hjust = 0, 
                vjust = 0,
               size = 16) +
  ggtext::geom_textbox(aes(x =  0.3, 
                           y =  1, 
                           label = label ,
                           color =  pal), 
                       family = "Lato", 
                       hjust = -0.5, 
                       vjust = 0,
                       size = 16,
                      # width = unit(25, "cm"), 
                       box.colour = NA) +
  scale_color_manual( values = c(   "IDP" = "#00B398",
                                   "OIP"="#EF4A60",
                                   "ASY" = "#18375F",
                                   "REF" = "#0072BC",
                                   "OOC" ="#8395b9",
                                   "STA"="#E1CC0D")) +
  xlim(c(0, 2)) +
  ylim(c(0, 3)) +
  facet_wrap(vars(fig), ncol = 2)  +
  labs(title = paste0("Key Figures for ", CountryAsylum_name_text, " as of ", year), 
       subtitle = paste0("A total of ",
                         format(round(total_poc, 0), scientific = FALSE, big.mark=","),
                         " people, ",
                        ifelse(perc_change_poc>0,"increasing", "decreasing" ) , 
                         " by ",  round(abs(perc_change_poc), 1), 
                         "% compared to the previous year"),
       caption = "Source: UNHCR.org/refugee-statistics") +
  unhcrthemes::theme_unhcr_map(  ) +
  theme(strip.text.x = element_text(size = 15),
        legend.position = "none"
        )  
  return(p)
  
}
```
  
```{r example-plot_ctr_keyfig}
plot_ctr_keyfig(year = 2022,
                country_asylum_iso3c = "COL")
```
  
```{r tests-plot_ctr_keyfig}
#test_that("plot_ctr_keyfig works", {  expect_true(inherits(plot_ctr_keyfig, "function")) })
```
  

## Plot Tree Map of Categories

```{r function-plot_ctr_treemap}
#' Tree map of Population Groups within a country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line 
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_ctr_treemap <- function(year = 2021,
                     country_asylum_iso3c = country_asylum_iso3c,
                     pop_type = pop_type) {


   ctrylabel <- ForcedDisplacementStat::reference |> 
                 filter(iso_3 == country_asylum_iso3c ) |> 
               select(ctryname) |> 
                pull()

  datatree <-  ForcedDisplacementStat::end_year_population_totals_long  |> 
    filter(Year == year,  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c #### Parameter
    ) |> 
    select(-c(Year)) |> 
    group_by(CountryAsylumName,  Population.type, 
                    Population.type.label, Population.type.label.short) |> 
    summarise(across(where(is.numeric), sum)) |> 
    ungroup() 
  
  p <- ggplot() +
         treemapify::geom_treemap( data = datatree, 
                 aes(area = Value, 
                     fill = Population.type) ) +
         treemapify::geom_treemap_text(data = datatree, 
                     aes(area = Value, 
                         fill = Population.type,
                         label = paste0(round(100 * Value / sum(Value),1), 
                          "%\n", 
                          Population.type.label) ),
                     colour = "white",
                           place = "centre", size = 25) +
         scale_fill_manual( values = c(   "IDP" = "#00B398",
                                         # "VDA"="#EF4A60",
                                          "OIP"="#EF4A60",
                                          "ASY" = "#18375F",
                                          "REF" = "#0072BC",
                                          "OOC" ="#8395b9",
                                          "STA"="#E1CC0D")) +
         
      theme_unhcr(font_size = 14,
                  grid = "Y", 
                  axis = "x", 
                  axis_title = "y", 
                  legend = FALSE) +
         theme(legend.position = "none") +
         ## and the chart labels
         labs(title = paste0("Population of Concern in ",  ctrylabel),
              subtitle = paste0("As of ", year, ", a total of ", format(round(sum(datatree$Value), -3),  big.mark=","), " Individuals"),
              x = "",
              y = "",
              caption = "Source: UNHCR.org/refugee-statistics")  

   return(p)
}

```
    
```{r examples-plot_ctr_treemap, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_treemap(year = 2021,
                            country_asylum_iso3c = "USA",
                            pop_type = c("REF", "ASY")
         )

```    
    



## Plot Population type per year

<!--
Create a chunk for the core of the function

- The chunk needs to be named `function` at least
- It contains the code of a documented function
- The chunk can also be named `function-my_median` to make it easily
findable in your Rmd
- Let the `@examples` part empty, and use the next `examples` chunk instead to present reproducible examples

After inflating the template

-  This function code will automatically be added in a new file in the "R/" directory
-->

```{r function-plot_ctr_population_type_per_year}
#' Graph of population type per year
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type 
#'                  (e.g.: REF, IDP, ASY, OIP, OIP, OOC, STA)
#' 
#' @import ggplot2              
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#'
#' @export
#'
#'

plot_ctr_population_type_per_year <- function(year = 2022,
                                              lag = 5, 
                                     country_asylum_iso3c = country_asylum_iso3c,
                                     pop_type = Population.type
                                     ) {
  



  cols_poptype <- c("Asylum seekers" = "#18375F",
                    "Refugees" = "#0072BC",
                    #"Venezuelans Displaced Abroad" = "#EF4A60", 
                    "Other people in need of international protection" = "#EF4A60", 
                    "Others of Concern to UNHCR" = "#999999",
                    "Internally displaced persons" = "#00B398",
                    "Stateless Persons" = "#E1CC0D")
  
  
  df <- ForcedDisplacementStat::end_year_population_totals_long  |> 
    filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  Year >= (year - lag),  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c, #### Parameter
                  Population.type %in% pop_type #### Parameter
    )  |>  
    group_by(Year, CountryAsylumName, Population.type.label)  |> 
    summarise(Value = sum(Value, na.rm = TRUE)) |> 
    ungroup()
  
  ## need to sort with so that the small value are on the top for better legibility 
  # levels(as.factor(df$Population.type.label)) is alpha... 
  # let's sort based on value from this year
  df$Population.type.label <- factor(df$Population.type.label,
          levels =  unique(df$Population.type.label[order(df$Value)])
                                     )
  
  
  
  CountryAsylum_name_text <- df |> 
    distinct(CountryAsylumName) |> 
    pull()
  
  year_breaks <- diff(range(df$Year)) + 1 
  
  p <- ggplot() +
    geom_col( data = df, 
             aes(x = Year, 
                 y = Value, 
                 fill = Population.type.label),
             width = 0.7) +
    
    ## Need some conditions to put labels or not o the chart - to avoid cluttered
    # chart.. 
    
    geom_text(data = df |> filter(Value > mean(df$Value) *0.1), 
             aes(x = Year, 
                  y = Value, 
                  color = Population.type.label, 
                  label = label_number(accuracy = 1,
                                   scale_cut = cut_short_scale())(Value)),
              position = position_stack(vjust = 0.5),
              show.legend = FALSE,
              size = 5) +
    ## This add the total on the top of the chart..
    stat_summary(data = df, 
                  fun = sum, 
                 aes(x = Year,
                     y = Value, 
                     label = scales::label_number(accuracy = 1,
                                          scale_cut = cut_short_scale())(after_stat(y)),
                     group = Year), 
                 geom = "text", size = 5,    vjust = -0.5) +
    scale_color_manual(values = c("#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF")) +
    scale_fill_manual(values = cols_poptype,
                      drop = TRUE,
                      limits = force) +
    scale_x_continuous(breaks = scales::breaks_pretty(n = year_breaks)) +
    scale_y_continuous(expand = expansion(c(0, 0.1))) +
    labs(title = paste0(CountryAsylum_name_text, ": Population Type per Year"), 
         subtitle = "Number of people (thousand)",
         caption = "Source: UNHCR.org/refugee-statistics") +
    theme_unhcr(grid = FALSE, axis = "x", 
                axis_title = FALSE, axis_text = "x",
              font_size = 14) +
    
    theme(legend.direction = "horizontal",
          legend.position = "bottom",
          legend.text=element_text(size = rel(0.5)),
          legend.key.size = unit(0.8, 'cm'),
          text = element_text(size = 20),
          plot.subtitle=element_text(size=19),
          plot.title = element_text(size=23),
          plot.caption = element_text(size=13))
  
  return(p) # print(p)
  }

 


```

<!--
Create a chunk with an example of use for your function

- The chunk needs to be named `examples` at least
- It contains working examples of your function
- The chunk is better be named `examples-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This example will automatically be added in the '@examples' part of our function above in the "R/" directory
- This example will automatically be added in the vignette created from this Rmd template
-->

```{r examples-plot_ctr_population_type_per_year, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}

p <- plot_ctr_population_type_per_year(
                         year = 2022,
                         lag = 5,
                         country_asylum_iso3c = "PAN",
                         pop_type = c("REF", 
                                       "ASY", 
                                       "OIP", 
                                       "OOC",
                                       "STA",
                                       "IDP" )
                  )
p
## Raw data can always be accessed with 
#knitr::kable(ggplot2::ggplot_build(p)$plot$data )
```

<!--
Create a chunk with a test of use for your function

- The chunk needs to be named `tests` at least
- It contains working tests of your function
- The chunk is better be named `tests-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This test code will automatically be added in the "tests/testthat/" directory
-->

```{r tests-plot_ctr_population_type_per_year}

# test_that("The function creates a plot", {
#   expect_true(is.ggplot(plot_ctr_population_type_per_year()))
# })

# test_that("The function takes the correct parameters", {
#   expect_equal(plot_ctr_population_type_per_year(year = 2022,
#                                                 lag = 5, 
#                                                 country_asylum_iso3c = country_asylum_iso3c,
#                                                 pop_type = Population.type),
#                plot_ctr_population_type_per_year())
# })
```



## Plot Main country of origin  in one specific country - Absolute value


```{r function-plot_ctr_population_type_abs}
#' Main country of origin - Absolute value
#'
#' @param year Numeric value of the year (for instance 2020)
#' 
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' 
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' 
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY,   OIP, OOC, STA)
#' 
#' @param show_diff_label logical to indicate whether or not adding the the label displaying difference in percentage compared to the previous year
#' 
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_ctr_population_type_abs <- function(year = 2021,
                                         country_asylum_iso3c = country_asylum_iso3c,
                                         top_n_countries = 9,
                                         pop_type = "REF",
                                         show_diff_label = TRUE
) {
  
  
  
  cols_poptype <- list(ASY = c("Asylum seekers", "#18375F"),
                       REF = c("Refugees", "#0072BC"),
                       #VDA = c("Venezuelans Displaced Abroad", "#EF4A60"), 
                       OIP = c("Other people in need of international protection", "#EF4A60"), 
                       OOC = c("Others of Concern to UNHCR", "#999999"),
                       IDP = c("Internally displaced persons", "#00B398"),
                       STA = c("Stateless Persons", "#E1CC0D")
  )
  
  
  df <- 
    ForcedDisplacementStat::end_year_population_totals  |> 
    filter(CountryAsylumCode != "UKN",
           !is.na(CountryAsylumCode),
           (Year == year | Year == year -1),  #### Parameter
           CountryAsylumCode == country_asylum_iso3c, #### Parameter
    )  |>  
    select(Year, CountryAsylumName, CountryOriginName,!!sym(pop_type)) |>
    group_by(Year, CountryAsylumName, CountryOriginName) |>
    filter(!!sym(pop_type) != 0) |>
    mutate(pop_type_value = sum(!!sym(pop_type), na.rm=TRUE)) |> 
    ungroup() |>
    group_by(CountryAsylumName, CountryOriginName) |> 
    arrange(Year) |>
    mutate(diff_pop_type_value = label_percent(accuracy = 0.1,
                                                trim = FALSE) (((pop_type_value-lag(pop_type_value))/lag(pop_type_value)))  ) |> 
    ungroup() |>
    filter(Year == year) |> 
    mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = CountryOriginName,
        n = top_n_countries,  #### Parameter
        w = pop_type_value,
        other_level = 'Other nationalities',
        ties.method = "last"
      )
    ) |>
    mutate(origin_data_prot = forcats::fct_explicit_na(origin_data_prot,
                                                       'Other nationalities'),
           diff_pop_type_value = case_when(origin_data_prot == 'Other nationalities' ~ "",
                                           TRUE ~ diff_pop_type_value)) |>
    group_by(CountryAsylumName, diff_pop_type_value, origin_data_prot) |>
    summarise(pop_type_value = sum(pop_type_value, na.rm = TRUE)) |>
    ungroup() |> 
    arrange(desc(pop_type_value)) |>
    filter(pop_type_value != 0L) |>
    mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(origin_data_prot)),
      origin_data_prot =  suppressWarnings(
        case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(origin_data_prot,
                                                                           "Other nationalities",
                                                                           after = 0),
          TRUE ~ origin_data_prot
        )
      ),
      perc = label_percent(
        accuracy = 1,
        trim = TRUE
      )(  pop_type_value / sum(pop_type_value))
    )
  
  CountryAsylum_name_text <- df |> 
    distinct(CountryAsylumName) |> 
    pull()
  
  
  p <- ggplot() +
    geom_col(data = df, 
             aes(x = pop_type_value, y = origin_data_prot),
             fill = cols_poptype[[pop_type]][2],
             width = 0.8) +
    ## Position label differently in the bar in white - outside bar in black
    geom_text(
      data = subset(df, pop_type_value < max(pop_type_value) / 1.5),
      aes(
        x = pop_type_value,
        y = origin_data_prot,
        label = label_number(accuracy = 1,
                             scale_cut = cut_short_scale())(pop_type_value)
      ),
      hjust = -0.1 ,
      vjust = 0.5,
      colour = "black",
      size = 6
    ) +
    geom_text(
      data = subset(df, pop_type_value >= max(pop_type_value) / 1.5),
      aes(
        x = pop_type_value,
        y = origin_data_prot,
        label = label_number(accuracy = 1,
                             scale_cut = cut_short_scale())(pop_type_value)),
      hjust = 1.1 ,
      vjust = 0.5,
      colour = "white",
      size = 6
    ) 
  
  # Add diff labels
  if(show_diff_label == TRUE) {
    # diff label positive general
    p <- p + geom_text( 
      data = subset(df, with(df, grepl('^[0-9]', diff_pop_type_value)) & (pop_type_value < max(pop_type_value) / 1.5)),
      aes(
        x = pop_type_value,
        y = origin_data_prot,
        label = paste(intToUtf8(9650), diff_pop_type_value)
      ),
      hjust = -1.2,
      vjust = 0.5,
      colour = "grey",
      size = 5
    ) +
    # diff label negative general
    geom_text(
      data = subset(df, with(df, grepl('-', diff_pop_type_value)) & (pop_type_value < max(pop_type_value) / 1.5)),
      aes(
        x = pop_type_value,
        y = origin_data_prot,
        label = paste(intToUtf8(9660), diff_pop_type_value)
      ),
      hjust = -1.2,
      vjust = 0.5,
      colour = "#0472bc",
      size = 5
    ) +
  # diff label positive max
    geom_text(
      data = subset(df, with(df, grepl('^[0-9]', diff_pop_type_value)) & (pop_type_value >= max(pop_type_value) / 1.5)),
      aes(
        x = pop_type_value,
        y = origin_data_prot,
        label = paste(intToUtf8(9650), diff_pop_type_value)
      ),
      hjust = -0.4,
      vjust = 0.5,
      colour = "grey",
      size = 5
    ) +
  # diff label negative max
    geom_text(
      data = subset(df, with(df, grepl('-', diff_pop_type_value)) & (pop_type_value >= max(pop_type_value) / 1.5)),
      aes(
        x = pop_type_value,
        y = origin_data_prot,
        label = paste(intToUtf8(9660), diff_pop_type_value)
      ),
      hjust = -0.4,
      vjust = 0.5,
      colour = "#0472bc",
      size = 5
    )} 
  p <- p + 
    labs(title = paste0(CountryAsylum_name_text, ": ", cols_poptype[[pop_type]][1], " | ",  year),
         subtitle = paste0("Top ",  top_n_countries, " Countries of Origin"),
         x = "Number of People",
         caption = "Source: UNHCR.org/refugee-statistics") +
    scale_x_continuous(expand = expansion(c(0, 0.1))) +
    theme_unhcr(grid = FALSE, axis = "y", 
                axis_title = FALSE, axis_text = "y",
                font_size = 14) +
    theme(legend.direction = "vertical",
          legend.key.size = unit(0.8, 'cm'),
          text = element_text(size = 20),
          plot.subtitle=element_text(size=19),
          plot.title = element_text(size=23),
          plot.caption = element_text(size=13))
  
  return(p) 
}
```

```{r examples-plot_ctr_population_type_abs, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
plot_ctr_population_type_abs(year = 2020,
                    country_asylum_iso3c = "USA",
                    top_n_countries = 4,
                    pop_type = "REF",
                    show_diff_label = FALSE
                    ) 

## Same with 9 top countries and asylum seekers included
plot_ctr_population_type_abs(year = 2020,
                    country_asylum_iso3c = "USA",
                    top_n_countries = 9,
                    pop_type = "ASY",
                    show_diff_label = TRUE
                    ) 

```

```{r tests-plot_ctr_population_type_abs}

```



## Plot Main country of origin in one specific country - Percentage


```{r function-plot_ctr_population_type_perc}
#' Main country of origin - Percentage
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_ctr_population_type_perc <- function(year = 2021,
                                country_asylum_iso3c = country_asylum_iso3c,
                                top_n_countries = 9,
                                pop_type = "REF"
                              ) {



  cols_poptype <- list(ASY = c("Asylum seekers", "#18375F"),
                       REF = c("Refugees", "#0072BC"),
                      # VDA = c("Venezuelans Displaced Abroad", "#EF4A60"), 
                       OIP = c("Other people in need of international protection", "#EF4A60"), 
                       OOC = c("Others of Concern to UNHCR", "#999999"),
                       IDP = c("Internally displaced persons", "#00B398"),
                       STA = c("Stateless Persons", "#E1CC0D")
  )
  
  
  df <-  
    ForcedDisplacementStat::end_year_population_totals  |> 
    filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  Year == year,  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c, #### Parameter
    )  |>  
    select(CountryAsylumName, CountryOriginName,!!sym(pop_type)) |>
    group_by(CountryAsylumName, CountryOriginName) |>
    filter(!!sym(pop_type) != 0) |>
    mutate(pop_type_value = sum(!!sym(pop_type), na.rm=TRUE)) |> 
    ungroup() |>
    mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = CountryOriginName,
        n = top_n_countries,  #### Parameter
        w = pop_type_value,
        other_level = 'Other nationalities',
        ties.method = "last"
      )
    ) |>
    mutate(origin_data_prot = forcats::fct_explicit_na(origin_data_prot,
                                                              'Other nationalities')) |>
    group_by(CountryAsylumName,origin_data_prot) |>
    summarise(pop_type_value = sum(pop_type_value, na.rm = TRUE)) |>
    ungroup() |> 
    arrange(desc(pop_type_value)) |>
    filter(pop_type_value != 0L) |>
    mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(origin_data_prot)),
      origin_data_prot =  suppressWarnings(
        case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(origin_data_prot,
                                                                           "Other nationalities",
                                                                           after = 0),
          TRUE ~ origin_data_prot
        )
      ),
      perc = label_percent(
        accuracy = 1,
        trim = FALSE )( pop_type_value / sum(pop_type_value))
    )
  
  CountryAsylum_name_text <- df |> 
    distinct(CountryAsylumName) |> 
    pull()



p <- 
  ggplot() +
  geom_col(data = df, 
           aes(x = pop_type_value, y = origin_data_prot),
           fill = cols_poptype[[pop_type]][2],
           width = 0.8) +
  ## Position label differently in the bar in white - outside bar in black
  geom_text(
    data = subset(df, pop_type_value < max(pop_type_value) / 1.5),
    aes(
      x = pop_type_value,
      y = origin_data_prot,
      label = perc
    ),
    hjust = -0.1 ,
    vjust = 0.5,
    colour = "black",
    size = 5
  ) +
  geom_text(
    data = subset(df, pop_type_value >= max(pop_type_value) / 1.5),
    aes(
      x = pop_type_value,
      y = origin_data_prot,
      label = perc
    ),
    hjust = 1.1 ,
    vjust = 0.5,
    colour = "white",
    size = 5
  ) +
  labs(title = paste0(CountryAsylum_name_text, ": (", cols_poptype[[pop_type]][1], ")", " | ",  year),
       subtitle = paste0("Top",  top_n_countries, " Countries of Origin"),
       x = "Percentage",
       caption = "Source: UNHCR.org/refugee-statistics") +
  scale_x_continuous(expand = expansion(c(0, 0.1))) +
 theme_unhcr(grid = FALSE, axis = "y", 
             axis_title = FALSE, axis_text = "y",
              font_size = 14) +
  theme(legend.direction = "vertical",
        legend.key.size = unit(0.8, 'cm'),
        text = element_text(size = 20),
        plot.subtitle=element_text(size=19),
        plot.title = element_text(size=23),
        plot.caption = element_text(size=13))
  return(p)
  }
```

```{r examples-plot_ctr_population_type_perc, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}

plot_ctr_population_type_perc(year = 2021,
                    country_asylum_iso3c = "BRA",
                    top_n_countries = 9,
                    pop_type = "REF"  ) 

plot_ctr_population_type_perc(year = 2021,
                    country_asylum_iso3c = "BRA",
                    top_n_countries = 9,
                    pop_type = "ASY"  ) 
```

```{r tests-plot_ctr_population_type_perc}

```


## Plot Increases and Decreases in Population Groups


```{r function-plot_ctr_diff_in_pop_groups}
#' Increases and Decreases in Population Groups
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer  gather separate spread
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_ctr_diff_in_pop_groups <- function(year = 2021,
                                        country_asylum_iso3c = country_asylum_iso3c,
                                        pop_type = pop_type
) {
  
  
  
  diff_perc <- function(x){
    x = as.numeric((x - lag(x))/lag(x)) + 0
    
  }
  
  
  df <- ForcedDisplacementStat::end_year_population_totals  |> 
    filter(CountryAsylumCode != "UKN",
           !is.na(CountryAsylumCode),
           (Year == year-1 | Year == year),  #### Parameter
           CountryAsylumCode == country_asylum_iso3c #### Parameter
    ) |> 
    group_by(Year, CountryAsylumName) |> 
    summarise(across(where(is.numeric), sum)) |> 
    ungroup() |> 
    arrange(Year) |> 
    select(-c(Year)) |> 
    group_by(CountryAsylumName) |> 
    summarise(across(where(is.numeric), 
                     list(diffabs = diff,
                          diffperc = diff_perc),
                     .names = "{.col}_{.fn}")) |> 
    ungroup() |> 
    slice(2) 
  
  df <- replace(df, is.na(df), 0)
  
  df <- df |> 
    tidyr::gather(v, value, REF_diffabs:OIP_diffperc) |> 
    tidyr::separate(v, c("population_type", "value_type"), sep = "\\_") |> 
    tidyr::spread(key = value_type, value = value) 
  
  
  df <- df |>         
    mutate(diffper = label_percent(accuracy = 1,  trim = FALSE) (diffperc))
  
  df <- df |> 
    filter(population_type %in% pop_type)
  
  p <- ggplot() +
    geom_col(data = df, 
           aes(x = population_type, 
                 y = diffabs,
                 fill = population_type),
             width = 0.8) +
    scale_fill_manual(
      values = c("ASY" = "#18375F",
                 "REF" = "#0072BC",
                 "OIP" = "#EF4A60", 
                 #"VDA" = "#EF4A60", 
                 "OOC" = "#999999",
                 "IDP" = "#00B398",
                 "STA" = "#E1CC0D"),
      drop= TRUE, limits = force, guide="none"    ) +
    scale_x_discrete(labels= c("ASY" = "Asylum seekers",
                               "REF" = "Refugees",
                               #"VDA" = "Venezuelans Displaced\nAbroad", ,
                               "OIP" = "Other people in need\n of international protection", 
                               "OOC" = "Others of Concern\nto UNHCR",
                               "IDP" = "Internally Displaced\nPersons",
                               "STA" = "Stateless Persons"),
                     drop = TRUE,
                     limits = force) +
    
    ## Adding labels with conditionned positions...
    
    geom_text(  data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
                aes(x = population_type,
                    y = diffabs,
                    label = label_number(accuracy = 1,
                                         scale_cut = cut_short_scale())(diffabs)),
                vjust = -0.5 , colour = "black", size = 5   ) +
    
    geom_text( data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
               aes(  x = population_type,
                     y = diffabs,
                     label = paste(intToUtf8(9650), diffper)),
               vjust = -2.0 , colour = "black", size = 5  ) +
    
    geom_text( data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
               aes(  x = population_type,
                     y = diffabs,
                     label = label_number(accuracy = 1,
                                          scale_cut = cut_short_scale())(diffabs) ),
               vjust = 2.7 ,   colour = "white",   size = 5  ) + 
    
    geom_text(  data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
                aes(x = population_type,
                    y = diffabs,
                    label = paste(intToUtf8(9650), diffper)),
                vjust = 1.2 ,   colour = "white",   size = 5    ) + 
    
    geom_text( data = subset(df, diffabs < 0/ 1.5),
               aes(  x = population_type,
                     y = diffabs,
                     label = label_number(accuracy = 1,
                                          scale_cut = cut_short_scale())(diffabs)),
               vjust =  1.2, colour = "black", size = 5  ) +
    
    geom_text( data = subset(df, diffabs < 0  / 1.5),
               aes( x = population_type,
                    y = diffabs,
                    label = paste(intToUtf8(9660), diffper)),
               vjust = 2.7,  colour = "black",  size = 5  ) +
    
    geom_hline(yintercept = 0, color = "black") +
    
    labs(title = paste0(df |> 
                          distinct(CountryAsylumName) |> 
                          pull(), 
                        ": Increases and Decreases in Population Groups | ",
                        year-1,
                        "-",
                        year),
         subtitle = "Number of people and percentage",
         caption = "Source: UNHCR.org/refugee-statistics")  + 
    theme_unhcr(grid = FALSE, axis = "x",
                axis_title = FALSE, axis_text = "x",
                font_size = 14) +
    theme(axis.line.x = element_line(color="white"),
          axis.text.x = element_text(size=10))
  
  # geom_text(
  #   data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #   aes(
  #     x = population_type,
  #     y = diffabs,
  #     label = label_number(accuracy = 1,
  #                                  scale_cut = cut_short_scale())(diffabs)
  #   ),
  #   vjust = -2.0 ,
  #   colour = "white",
  #   size = 5
  # )  +
  #   geom_text(
  #     data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #     aes(
  #       x = population_type,
  #       y = diffabs,
  #       label = diffper
  #     ),
  #     vjust = -0.5 ,
  #     colour = "white",
  #     size = 5
  #   ) +
  
  
  return(p) # print(p)
}
```

```{r examples-plot_ctr_diff_in_pop_groups, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_diff_in_pop_groups(year = 2022,
                            country_asylum_iso3c = "ARG",
                            pop_type = c("REF", "ASY")
         )

```

```{r tests-plot_ctr_diff_in_pop_groups}

```


## Plot Origin History
    
```{r function-plot_ctr_origin_history}
#' Plot Origin History
#' 
#' The functions gives a quick overview of the main source of displacement in terms of origin in the country
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OIP, OOC, STA)
#' @param otherprop value set by default to .02 - used to merge origin as "Other"
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text scale_fill_brewer scale_colour_brewer
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom ggalluvial geom_alluvium
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#'
#' @export

plot_ctr_origin_history <- function(year = 2022,
                                     lag = 5, 
                                     country_asylum_iso3c = country_asylum_iso3c,
                                     pop_type = Population.type,
                                     otherprop = .02
                                     ) {
  


  df <- ForcedDisplacementStat::end_year_population_totals_long  |> 
          filter(       Year >= (year - lag),  #### Parameter
                        CountryAsylumCode == country_asylum_iso3c, #### Parameter
                        Population.type %in% pop_type #### Parameter
          )  |>    
          dplyr::mutate(CountryOriginName = forcats::fct_lump_prop(CountryOriginName, prop = otherprop, w = Value)) |> 
          group_by(Year, CountryAsylumName, CountryOriginName)  |> 
          summarise(Value = sum(Value, na.rm = TRUE)) |> 
          ungroup()
  
  CountryAsylum_name_text <- df |> 
    distinct(CountryAsylumName) |> 
    pull()
  
  year_breaks <- diff(range(df$Year)) + 1 
  
  p <- ggplot() +
  ggalluvial::geom_alluvium(data = df,
       aes(x = Year, 
           y = Value, 
           alluvium = CountryOriginName,
           fill = CountryOriginName, 
           colour = CountryOriginName),
                            alpha = .75, 
                            decreasing = FALSE) +
  scale_x_continuous(breaks = seq(year-lag, year, 2)) +  
  scale_y_continuous(expand = expansion(c(0, 0.1)),
                     labels = label_number(scale_cut = cut_short_scale())) +
  theme_unhcr(grid = TRUE, axis = "x", 
              axis_title = TRUE, #axis_text = "x",
              font_size = 14) +
  theme(axis.text.x = element_text(angle = -30, hjust = 0)) +
  scale_fill_brewer(type = "qual", palette = "Set3") +
  scale_colour_brewer(type = "qual", palette = "Set3") +
  # facet_wrap(~ region, scales = "fixed") ++
  labs(title = paste0(CountryAsylum_name_text, ":  Evolution of Forcibly Displaced Population Origin"), 
       subtitle = "Number of people (thousand)",
       x = "", y = "",
       caption = "Source: UNHCR.org/refugee-statistics")
  
  return(p) # print(p)
  }


```
  
```{r example-plot_ctr_origin_history}
plot_ctr_origin_history(year = 2022,
                        lag = 5,
                        country_asylum_iso3c = "MEX",
                          pop_type = c("REF", 
                                       "ASY", 
                                       "OIP", 
                                       "IDP" ),
                        otherprop = .02)
```
  
```{r tests-plot_ctr_origin_history}
#test_that("plot_ctr_origin_history works", {   expect_true(inherits(plot_ctr_origin_history, "function")) })
```
  


## Plot Age Pyramid

```{r function-plot_ctr_pyramid}
#' Population Pyramid
#'
#' @param year Numeric value of the year (for instance 2022). 
#'             If the data is not yet available for that year (aka still in the mid year reporting stage),
#'              it will automatically fall back on the previous year
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text .pt theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head download.file
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_detect
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate  setNames
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer pivot_wider
#' @importFrom unhcrthemes theme_unhcr 
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_ctr_pyramid <- function(year ,
                             country_asylum_iso3c = country_asylum_iso3c,
                             pop_type = pop_type) {
  
  
    ## FontAwesome6  includes humanitarian icon... 
    fontcheck <- extrafont::fonttable() |>
              dplyr::as_tibble() |>
              dplyr::filter(grepl("Awesom", FamilyName)) 

    if( ! ("FontAwesome6Free-Solid" %in% fontcheck$FontName) ) {
      fa_font <- here::here("",  "fa-solid-900-6.ttf")
      download.file("https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/webfonts/fa-solid-900.ttf",
                    destfile = fa_font, method = "curl")
      extrafont::font_import(paths = dirname(fa_font), prompt = FALSE)
      sysfonts::font_add(family =  "Font Awesome 6 Free Solid", regular = fa_font)
    } else {
    
    sysfonts::font_add(family = "Font Awesome 6 Free Solid" , 
                       regular = as.character(fontcheck |> 
                                                dplyr::filter( FamilyName == "Font Awesome 6 Free Solid") |>
                                                dplyr::pull(fontfile)) )
    }
 
  
  ctrylabel <- ForcedDisplacementStat::reference |> 
    filter(iso_3 == country_asylum_iso3c ) |> 
    distinct(ctryname) |> 
    pull()
  
  poptype_label <- ForcedDisplacementStat::end_year_population_totals_long |> 
    filter(Population.type  %in% as.vector(pop_type)) |> 
    distinct(Population.type.label.short) |> 
    pull()
  
  demographics1 <- ForcedDisplacementStat::demographics |>
    left_join( ForcedDisplacementStat::reference |> 
                 select(UNHCRBureau, iso_3),  
               by = c("CountryAsylumCode" = "iso_3")) |> 
    filter(CountryAsylumCode  == country_asylum_iso3c &
             Year == year &
             Population.type  %in% as.vector(pop_type)) |>
    
    mutate ( totGen = FemaleTotal +MaleTotal,
             totbreak = Female04 + Female511 + Female1217 + 
               Female1859 + Female60ormore + FemaleUnknown +
               Male04 + Male511 + Male1217 + Male1859 +
               Male60ormore + MaleUnknown,
             
             hasbreak = ifelse(Total - totGen == 0, "yes", "no" ))
  
  ## Check if fall back is needed.. 
  if(nrow(demographics1) == 0) { 
    year <- year -1 
    demographics1 <- ForcedDisplacementStat::demographics |>
      left_join( ForcedDisplacementStat::reference |> 
                   select(UNHCRBureau, iso_3),  
                 by = c("CountryAsylumCode" = "iso_3")) |> 
      filter(CountryAsylumCode  == country_asylum_iso3c &
               Year == year &
               Population.type  %in% as.vector(pop_type)) |>
      
      mutate ( totGen = FemaleTotal +MaleTotal,
               totbreak = Female04 + Female511 + Female1217 + 
                 Female1859 + Female60ormore + FemaleUnknown +
                 Male04 + Male511 + Male1217 + Male1859 +
                 Male60ormore + MaleUnknown,
               
               hasbreak = ifelse(Total - totGen == 0, "yes", "no" ))
    
    }
  
  
  
  
  if ( nrow(demographics1) ==  0 ){
    info <-  paste0("There\'s no recorded Gender disaggregation for Forcibly Displaced People across Borders in ", ctrylabel, "as of", year )
    p <- ggplot() +  annotate("text",  x = 1, y = 1, size = 12,  
                              label = info ) +  theme_void() 
    
    
  } else {
    
    tot <- format( sum(demographics1$Total) ,  big.mark=",")
    totprop <-   format( round( sum(demographics1$totGen) / 
                                  sum(demographics1$Total )  *100,1),  big.mark=",")  
    
    if (totprop == 0 ) {
      info <- paste0("There\'s no recorded Gender disaggregation for \n all of the ",tot, " persons in ", ctrylabel  )
      p <- ggplot() +  annotate("text",  x = 1, y = 1, size = 12,  
                                label = info ) +  theme_void() 
      
      
    } else {
      #names(demographics)
      pyramid <-  demographics1[ demographics1$Year == max(demographics1$Year),
                                 c(
                                   "Female04",
                                   "Female511",
                                   "Female1217",
                                   "Female1859",
                                   "Female60ormore",
                                   "FemaleUnknown",
                                   # "FemaleTotal",
                                   "Male04",
                                   "Male511",
                                   "Male1217",
                                   "Male1859",
                                   "Male60ormore",
                                   "MaleUnknown"#,
                                   # "MaleTotal"       
                                 )]  
      
      pyramid2 <- data.frame(lapply(pyramid, function(x) { as.numeric( gsub("NA", "0", x)) })) |>
        pivot_longer(
          cols = Female04:MaleUnknown,
          names_to = "Class",
          values_to = "Sum",
          values_drop_na = TRUE
        ) 
      
      pyramid3 <- as.data.frame(aggregate(pyramid2$Sum,
                                          by = list(pyramid2$Class#, pyramid2$REGION_UN
                                          ),
                                          sum))
      names(pyramid3)[1] <- "Class"
      names(pyramid3)[2] <- "Count"
      
      pyramid3 <- pyramid3 |> 
        mutate(gender = case_when(str_detect(Class, "Male") ~ "Male",
                                  str_detect(Class, "Female") ~ "Female")) |> 
        mutate(age = case_when(str_detect(Class, "04") ~ "0-4",
                               str_detect(Class, "511") ~ "5-11",
                               str_detect(Class, "1217") ~ "12-17",
                               str_detect(Class, "1859") ~ "18-59",
                               str_detect(Class, "60") ~ "60+",
                               str_detect(Class, "Unknown") ~ "Unknown")) 
      
      pyramid3$pc <- pyramid3$Count / sum(pyramid3$Count)
      pyramid3$age <- factor(pyramid3$age, levels = c("0-4", "5-11",  "12-17",  "18-59", "60+", "Unknown"))
      
      pyramid4 <- pyramid3 |> 
        select(gender,age, pc) |> 
        mutate(gender = tolower(gender)) |> 
        pivot_wider(names_from = gender,
                    names_sort = TRUE,
                    values_from = pc
        ) 
      
      p <-  ggplot() +
        geom_col(data = pyramid4,
                 aes(-male, age,
                     fill = "Male"),  width = 0.7 ) +
        geom_col(data = pyramid4,
                 aes(female, age,
                     fill = "Female"),width = 0.7 ) +
        geom_text(data = pyramid4,
                  aes(-male, age,
                      label = percent(abs(male), accuracy = 1)),
                   hjust = 1.25,   size = 11.5 / ggplot2::.pt ) +
        geom_text(data = pyramid4,
                  aes(female,  age,                     
                      label = percent(abs(female), accuracy = 1)  ), 
                  hjust = -0.25,  size = 11.5 / ggplot2::.pt) +
        ## Now get the icon for male and female 
        ggtext::geom_textbox(aes(x = 0.25, 
                                  y = "60+",  
                        label = "\uf182" ), 
                       family = "Font Awesome 6 Free Solid",
                       color = "#18375F",# "#0072BC" "#8EBEFF"
                       box.colour = NA ,   hjust = 0,   vjust = 0,
                       width = unit(0.4, "npc"),
                      size = 11.5 ) +
        ggtext::geom_textbox(aes(x = as.numeric(-0.25), 
                                 y = "60+",  
                       label = "\uf183" ), 
                      family = "Font Awesome 6 Free Solid",
                       color = "#0072BC",# "#0072BC" "#8EBEFF"
                      box.colour = NA ,   hjust = 0,   vjust = 0,
                       width = unit(0.4, "npc"),
                     size = 11.5 ) +
        scale_x_continuous(expand = expansion(c(0.2, 0.2))) +
        scale_fill_manual(breaks=c('Male', 'Female'),
                          values = setNames(
                            unhcr_pal(n = 3, "pal_unhcr")[c(2, 1)],
                            c("Male" , "Female")  )) +
        labs(  title = paste0("Population Pyramid for ", 
                              sub(",\\s+([^,]+)$", " and \\1",  toString(poptype_label)), 
                              " | ", ctrylabel),
          subtitle = paste0("As of ", year, 
                            ", gender disaggregation is available for ", totprop, "% of the ",tot,
                            " individuals in ", ctrylabel),
          caption = "Note: figures do not add up to 100 per cent due to rounding\nSource: UNHCR.org/refugee-statistics."  ) +
        theme_unhcr(font_size = 14, grid = FALSE, axis = FALSE, axis_title = FALSE,  axis_text = "y") +
        theme(legend.position = "none")
    }
  }
  
  return(p)
}
```

    
```{r examples-plot_ctr_pyramid, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_pyramid(year = 2022,
                 country_asylum_iso3c = "COL",
                 pop_type = c("ASY", "REF")
                 )

``` 

# Maps

## Plot locations within countries


```{r function-plot_ctr_location}
#' Create a map with symbol proportional to population data by location within country
#'
#' @param year Numeric value of the year  (for instance 2022). 
#'             If the data is not yet available for that year (aka still in the mid year reporting stage),
#'              it will automatically fall back on the previous year
#'              
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' @param  mapbackground can be "osm" (default), "stamen-toner" , "stamen-terrain","stamen-watercolor". 
#'            Other mapbackground requires an API key and were not considered 
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  geom_point
#'             scale_color_manual scale_colour_manual 
#'             scale_size_continuous element_rect
#'             geom_text .pt theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_detect  str_glue
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate  setNames
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer pivot_wider
#' @importFrom ggspatial geom_sf coord_sf
#' @importFrom sf st_as_sf st_set_crs st_bbox
#' @importFrom rnaturalearth ne_countries
#' @import rnaturalearthdata
#' @importFrom ggrepel geom_label_repel
#' @importFrom grDevices hcl.colors
#' @importFrom OpenStreetMap openmap openproj autoplot.OpenStreetMap
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'
plot_ctr_location <- function( year  ,
                             country_asylum_iso3c  ,
                             pop_type  ,
                             mapbackground = "osm" #  could be "stamen-toner" , "stamen-terrain","stamen-watercolor"
                             ) {
  
  ctrylabel <- ForcedDisplacementStat::reference |> 
    dplyr::filter(iso_3 == country_asylum_iso3c ) |> 
    dplyr::distinct(ctryname) |> 
    dplyr::pull()
  
  poptype_label <- ForcedDisplacementStat::end_year_population_totals_long |> 
    dplyr::filter(Population.type  %in% as.vector(pop_type)) |> 
    dplyr::distinct(Population.type.label.short) |> 
    dplyr::pull()
  
  # names(ForcedDisplacementStat::demographics)
  mapped1 <- ForcedDisplacementStat::demographics |>
    dplyr::filter(Year == year,  #### Parameter
           CountryAsylumCode == country_asylum_iso3c, #### Parameter
           Population.type %in% pop_type  ) |> 
    dplyr::group_by ( CountryAsylumCode, location) |>
    dplyr::summarise( Total = sum(Total, na.rm = TRUE)) |>
    dplyr::ungroup() |>
    ## add geometry
    dplyr::left_join( ForcedDisplacementStat::locpcode ,
               by = c("location" = "location"))
  
  ## Check if fall back is needed.. 
  if(nrow(mapped1) == 0) { 
    year <- year -1 
    mapped1 <- ForcedDisplacementStat::demographics |>
    dplyr::filter(Year == year,  #### Parameter
           CountryAsylumCode == country_asylum_iso3c, #### Parameter
           Population.type %in% pop_type  ) |> 
    dplyr::group_by ( CountryAsylumCode, location) |>
    dplyr::summarise( Total = sum(Total, na.rm = TRUE)) |>
    dplyr::ungroup() |>
    ## add geometry
    dplyr::left_join( ForcedDisplacementStat::locpcode ,
               by = c("location" = "location"))
    
    }
  
  
  nonmapped <- mapped1 |>
    dplyr::filter(   is.na( latitude) & is.na(longitude)) 
  mapped <- mapped1 |>
    dplyr::filter( ! is.na( latitude) | ! is.na(longitude))  |>
    dplyr::mutate (latitude =  as.double( latitude),
                   longitude =  as.double( longitude),
                   level = paste0( "Geographic precision level: ",location_level ),
                   location =factor(location, unique(location)) ) |>
    # Center: reorder your dataset first! Big cities appear later = on top
    dplyr::arrange(desc(Total) )

    pal <- grDevices::hcl.colors(3, "Inferno", rev = TRUE, alpha = 0.7)
    
    
    # Get Bounding box
    # plot(rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")  |>  dplyr::filter(iso_a3 == country_asylum_iso3c) |> dplyr::pull(geometry))
    # ctr <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
    requireNamespace("rnaturalearthdata")
    box <- sf::st_bbox(rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")  |>  
                         dplyr::filter(iso_a3 == country_asylum_iso3c))
    LON1 <- as.numeric( box[1] - 0.1* (box[3]-box[1])) 
    LON2 <- as.numeric(box[3] + 0.1* (box[3]-box[1]))
    LAT1 <- as.numeric(box[2]  - 0.1* (box[4]-box[2]) )
    LAT2 <- as.numeric(box[4] + 0.1* (box[4]-box[2]) )
    
    # attempts to assign an object containing longlat to data extending beyond
    # longitude [-180, 180] or latitude [-90, 90] will be stopped.
    if(LON1 < -180){ LON1 <- -179}
    if(LON2 > 180){ LON2 <- 179}
    ## Need to trim a lot near the poles to get the webtiles
    if(LAT1 < -80){ LAT1 <- -70} 
    if(LAT2 > 80){ LAT2 <- 70}

    map <- OpenStreetMap::openmap(c(LAT2, LON1), c( LAT1, LON2), 
                                  zoom = NULL,
                                  type =  mapbackground, #"osm" , 
                                  #type =  "stamen-toner" , 
                                  # c("osm", "stamen-toner", "stamen-terrain","stamen-watercolor", "esri","esri-topo"),
                                  mergeTiles = TRUE)
    
    
    map.latlon <- OpenStreetMap::openproj(map, projection = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
    # Bubble choropleth map with SOM background
    p <- OpenStreetMap::autoplot.OpenStreetMap(map.latlon) +
         ggplot2::geom_point(  data = mapped ,
            pch = 21,  # , filled circle blue
            ggplot2::aes(x= longitude, y= latitude,
                size = Total,
                fill = level),
               col = "grey20",
              alpha=0.6   ) +
        ggplot2::scale_size_continuous(
          name="Population (in Th)",
          range = c(1, 9),
          breaks=  scales::breaks_pretty(5)) +
       ggplot2::scale_fill_manual(values = pal,
                    drop = FALSE,
                    na.value = "grey80") +
      ggrepel::geom_label_repel(   data = mapped |> head(5)  ,
                mapping = ggplot2::aes(x= longitude, y= latitude,
                          label = stringr::str_glue(  "{stringr::str_wrap(location,15)}\n{ scales::label_number(scale_cut = scales::cut_short_scale())(Total)} ")  # how label displays
                               ),
                          size = 2.5,   # text size in labels
                 min.segment.length = 0)+           # show all line segments  
        ggplot2::coord_sf(xlim = c(LON1 , LON2),   ylim = c(LAT1  ,LAT2 ), expand = FALSE) +
        ggplot2::labs(title = paste0( 
          
                                 format(round(sum(mapped1$Total), 0), scientific = FALSE, big.mark=","), " ",
                                # scales::label_number(scale_cut = scales::cut_short_scale())(sum(mapped1$Total)), 
                                 sub(",\\s+([^,]+)$", " and \\1",  toString(poptype_label)), 
                                " in ", ctrylabel, " as of ", year),
             subtitle = paste0( "This is disaggregated through ",
                                 nrow(mapped),
                                 " locations at different geographic levels, \n representing a total of ",
                                 format(round(sum(mapped$Total), 0), scientific = FALSE, big.mark=","), 
                                # scales::label_number(scale_cut = scales::cut_short_scale())(sum(mapped$Total)), 
                                 " people.\n ",  format(round(nonmapped$Total, 0), scientific = FALSE, big.mark=","), 
                                 " are dispersed in the country (i.e ",
                                 round(nonmapped$Total/sum(mapped1$Total)*100, 1), "%)" ),
             caption = "The boundaries and names shown on this map do not imply \n official endorsement or acceptance by the United Nations",
             size = "Displaced Population") +
        unhcrthemes::theme_unhcr_map() +
        ggplot2::theme(legend.position = "none")
  return(p)
}
```
  
```{r example-plot_ctr_location}
plot_ctr_location(year = 2022,
                 country_asylum_iso3c = "COL",
                 pop_type = c("ASY", "REF", "OIP"))

plot_ctr_location(year = 2021,
                 country_asylum_iso3c = "COL",
                 pop_type = c("IDP"))

plot_ctr_location(year = 2022,
                 country_asylum_iso3c = "CAN",
                 pop_type = c("ASY", "REF", "OIP"))

plot_ctr_location(year = 2021,
                 country_asylum_iso3c = "MEX",
                 pop_type = c("ASY", "REF", "OIP"))
```
  
```{r tests-plot_ctr_location}
## test_that("plot_ctr_location works", {   expect_true(inherits(plot_ctr_location, "function")) 
# })
```
  

# Refugee Status Determination
    
## Plot Refugee Recognition rate in Country
    
```{r function-plot_ctr_recognition}
#' Display a Chart with Refugee Recognition Rates 
#' 
#' In the absence of an internationally agreed methodology for calculating recognition rates,
#'  UNHCR uses two rates to compute the proportion of refugee claims accepted during the year: 
#'  
#'   * The Refugee Recognition Rate divides the number of asylum-seekers granted Convention refugee
#'   status by the total number of accepted (Convention and, where relevant, complementary 
#'   protection) and rejected cases (aka substantive decision). 
#'   
#'   * The Total Recognition Rate divides the number of asylum-seekers granted Convention
#'    refugee status and / or complementary form of protection by the total number
#'    of accepted (Convention and, where relevant, complementary protection) and
#'     rejected cases.
#'     
#' Non-substantive decisions are, to the extent possible, excluded from both 
#' calculations. For the purpose of international comparability,  UNHCR only 
#' uses these two recognition rates and does not report nationally calculated rates.
#'      
#'      See https://www.unhcr.org/4ce531e09.pdf
#' 
#' @param year Numeric value of the year  
#'              
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * RefugeeRecognitionRate 
#'            * TotalRecognitionRate
#' @param order_by this can be either:
#'            * Recognized  
#'            * ComplementaryProtection  
#'            * TotalDecided 
#'            
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr  scale_fill_unhcr_d
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_ctr_recognition <- function(year = 2022,
                                 country_asylum_iso3c  ,
                                 top_n_countries = 10, 
                                 measure = "RefugeeRecognitionRate",
                                 order_by = "TotalDecided" ){
   
   ctrylabel <- ForcedDisplacementStat::reference |> 
                 filter(iso_3 == country_asylum_iso3c ) |> 
               select(ctryname) |> 
                pull()
   
  
   measurelabel <-
     dplyr::case_when(
       measure == "RefugeeRecognitionRate"  ~ "Refugee Recognition Rate",
       measure == "TotalRecognitionRate"  ~ "Total Recognition Rate"
     )
   
   order_bylabel <-
     dplyr::case_when(
       order_by == "Recognized"  ~ "Recognized Refugee Status Decisions",
       order_by == "ComplementaryProtection"  ~ "Complementary Protection Decisions",
       order_by == "TotalDecided"  ~ "Total Decision (independently of the outcome)"
     )
   
   topOrigin <-  ForcedDisplacementStat::asylum_decisions |>
     filter(CountryAsylumCode == country_asylum_iso3c &
              Year == year) |>
     ## the below is change - DecisionsAveragePersonsPerCase- is just indicative... so no need to use it to m
     # mutate(DecisionsAveragePersonsPerCase = map_dbl(DecisionsAveragePersonsPerCase, ~replace_na(max(as.numeric(.), 1), 1))) |>
     mutate(DecisionsAveragePersonsPerCase = 1) |>
     group_by(CountryOriginName) |>
     summarize(
       Recognized = sum(Recognized * DecisionsAveragePersonsPerCase, na.rm = TRUE),
       ComplementaryProtection = sum(
         ComplementaryProtection * DecisionsAveragePersonsPerCase,
         na.rm = TRUE
       ),
       TotalDecided = sum(TotalDecided * DecisionsAveragePersonsPerCase, na.rm = TRUE)
     ) |>
     mutate(
       RefugeeRecognitionRate = (Recognized) / TotalDecided,
       TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided
     ) |>
     # filter(TotalDecided  != 0) |>
     # filter(TotalDecided  > 1000)  |>
     mutate(CountryOriginName = str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""))

   topOrigin1 <-  topOrigin  |>
     mutate(measured = .data[[measure]])  |>
     mutate(order_by = .data[[order_by]])  |>
     arrange(desc(order_by)) |>
     head(top_n_countries)   
 
 
  
 
   rsdorigin <- ggplot() +
     geom_bar(data = topOrigin1, 
              aes(y = measured ,
                  x = reorder(CountryOriginName, measured)),
              stat = "identity", fill = "#0072bc") +
     coord_flip() +
     #scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number
     scale_y_continuous( labels =   scales::label_percent(accuracy = 0.1, suffix = "%")) +
     
     #facet_grid(.~ ctry_asy) +
     #  geom_hline(yintercept = 0, size = 1.1, colour = "#333333")   +
     labs(
       title = paste0(measurelabel, " | ", year, " in ", ctrylabel),
       caption = 'Source: UNHCR.org/refugee-statistics ',
       subtitle = paste0(
         "For top ",
         top_n_countries,
         " Countries of Origin ordered by ",
         order_bylabel
       ),
       x = " ",  y = " " ) +
     theme_unhcr(
       grid = "Y",
       axis = "x",
       axis_title = "" ,
       font_size = 14
     ) +
     theme(#axis.text.x = element_blank(),
       # legend.position = "none",
       
       panel.grid.major.x = element_line(color = "#cbcbcb"),
       panel.grid.major.y = element_blank()) ### changing grid line that should appear) 


  return(rsdorigin)

    
}
```
  
```{r example-plot_ctr_recognition}
plot_ctr_recognition(year = 2022,
                     country_asylum_iso3c = "USA",
                     top_n_countries = 10, 
                     measure = "RefugeeRecognitionRate",
                     order_by = "TotalDecided" )
```
  
```{r tests-plot_ctr_recognition}
# test_that("plot_ctr_recognition works", {   expect_true(inherits(plot_ctr_recognition, "function")) })
```
  
    
## Asylum Applications & Decision over time


```{r function-plot_ctr_asylum}
#' Asylum Applications & Decision over time
#' 
#' This charts allow to visualize trends in terms of asylum applications, decision and refugee status recognition
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param lag Number of year to used as comparison base
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr  scale_fill_unhcr_d
#' 
#' @return a ggplot2 object
#' 
#' @export

plot_ctr_asylum <- function(year = 2022,
                            country_asylum_iso3c = country_asylum_iso3, 
                            lag = 10){
    
     ctrylabel <- ForcedDisplacementStat::reference |> 
                 filter(iso_3 == country_asylum_iso3c ) |> 
               select(ctryname) |> 
                pull()
  
    apps <- ForcedDisplacementStat::asylum_applications|>
          filter(CountryAsylumCode == country_asylum_iso3c )|>
          group_by(Year, CountryAsylumCode) |>
         summarize (NumberApplications = sum(NumberApplications , na.rm= TRUE) )

    decs <- ForcedDisplacementStat::asylum_decisions |>
          filter(CountryAsylumCode == country_asylum_iso3c ) |>
          group_by(Year, CountryAsylumCode) |>
         summarize (Recognized = sum(Recognized , na.rm= TRUE),
                  ComplementaryProtection = sum( ComplementaryProtection , na.rm= TRUE),
                  OtherwiseClosed = sum(OtherwiseClosed , na.rm= TRUE),
                  Rejected = sum(Rejected , na.rm= TRUE),
                  TotalDecided = sum(TotalDecided , na.rm= TRUE))

    
 data <- dplyr::inner_join(apps, decs) |>   # names(data)
         dplyr::filter( Year >= (year - lag)) |>
         dplyr::select( Year,  NumberApplications, Recognized, TotalDecided ) |>
         tidyr::pivot_longer( 
              cols = NumberApplications:TotalDecided,
              names_to = "AsylumStage",
              values_to = "Total",
              values_drop_na = TRUE
            )
 # levels(as.factor(data$AsylumStage))
 data$AsylumStage <- dplyr::recode (data$AsylumStage, "NumberApplications"= "Total Number of Applications",
                                            "TotalDecided" = "Total Number of Decisions",
                                             "Recognized" = "Number of Refugee Status Recognition Decisions")
  data$AsylumStage <- factor(data$AsylumStage, levels = c("Total Number of Applications",
                                                          "Total Number of Decisions",
                                                          "Number of Refugee Status Recognition Decisions"))
 
 p <- ggplot() +
     geom_bar(data = data,
             aes(x= Year, y = Total, fill = AsylumStage),
             stat = "identity", position = "dodge", width = 0.8 ) + 
     scale_fill_unhcr_d(palette = "pal_unhcr") +
    # scale_fill_manual(values = c( "#FAAB18", "#0072bc", "#FEEB18")) +  
     scale_x_continuous(breaks = pretty_breaks(10)) +
    # scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
     scale_y_continuous( labels = scales::label_number(accuracy = 1, scale_cut = cut_short_scale()))+ ## Format axis number
     labs(title = paste0( " Asylum Applications & Decisions | ", ctrylabel, " " ,  (year-lag) ," - ", year),
       subtitle = paste0( "Note that under certain circumstance, one person may have more than one applications "), 
       x="",
       y ="",
       caption = "Source: UNHCR.org/refugee-statistics") + 
     theme_unhcr(font_size = 14, ## Insert UNHCR Style
                 grid = "X" #, 
                #  axis = "Y", 
                #  axis_title = TRUE, 
                # axis_text = "Y" 
                )  +
     theme(panel.grid.major.y = element_line(color = "#cbcbcb"), 
           panel.grid.major.x = element_blank()) ### changing grid line that should appear
  
  return(p)

  
  
      
}
```
  
```{r example-plot_ctr_asylum}
plot_ctr_asylum(year = 2022,
                country_asylum_iso3c = "ECU", 
                            lag = 10)
```
  
```{r tests-plot_ctr_asylum}
#test_that("plot_ctr_asylum works", {   expect_true(inherits(plot_ctr_asylum, "function")) })
```
  

## Asylum Processing
    
```{r function-plot_ctr_process}
#' Asylum Processing
#' 
#' Displaying Asylum processing 
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param otherprop value set by default to .02 - used to merge origin as "Other"
#' 
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text guide_axis facet_wrap vars theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_wrap
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join rename count
#' @importFrom tidyr pivot_longer
#' @importFrom forcats fct_relevel
#' @importFrom  ggforce geom_parallel_sets geom_parallel_sets_axes  
#'                  geom_parallel_sets_labels gather_set_data
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export 
plot_ctr_process <- function(year = 2022,
                             country_asylum_iso3c,
                             otherprop = .02){
  

  #table(as.factor(ForcedDisplacementStat::asylum_decisions_long$CountryAsylumCode))
  
  links <- ForcedDisplacementStat::asylum_decisions_long |>
    filter(Year == year   & CountryAsylumCode  == country_asylum_iso3c ) |> 
    dplyr::mutate(CountryOriginName = forcats::fct_lump_prop(CountryOriginName,
                                                             prop = otherprop, 
                                                             w = Value)) |>
    ## Group small records under other
    ## Calculate grouped value for Origin to procedure..
    group_by(CountryOriginName, ProcedureName, DecisionTypeName,Decision.output ) |>
    summarise(n = sum(Value, na.rm = TRUE) )  
  # levels(links$Decision.output)
  
  ## Case no record outut a ggplot2 object with anotation
  if( nrow(links) == 0) {
    info <-  paste0("There\'s no recorded Asylum Decisions in ", ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_asylum_iso3c) |>
             dplyr::pull(ctryname) , " for ", year)
    p <- ggplot() +  annotate(stringr::str_wrap("text", 80), 
                              x = 1, y = 1, size = 11,  
                              label = info ) +  theme_void() 
    
  } else {

  ## summarize data
 flow_table <- links  |>
  ggforce::gather_set_data(x = c("CountryOriginName","ProcedureName","DecisionTypeName","Decision.output") ) 


  flow_table$Decision.output <- factor(flow_table$Decision.output,
                                  levels = c("Rejected",
                                             "ComplementaryProtection",
                                             "Recognized",    
                                             "OtherwiseClosed"))
## plot your dataset 
  ## on the x axis is the start and end causes
  ## gather_set_data generates an ID for each possible combination
  ## splitting by y gives the possible start/end combos
  ## value as n gives it as counts (could also be changed to proportion)
p <- ggplot(flow_table, 
       aes(x, 
          id = id, 
          split = y, 
          value = n)) +
  ## colour lines by sex 
  ggforce::geom_parallel_sets( aes(fill = Decision.output),
                     alpha = 0.5,
                     axis.width = 0.2) +
  ## fill in the label boxes grey
  ggforce::geom_parallel_sets_axes(axis.width = 0.15,
                          fill = "grey80", 
                          color = "grey80") +
  ## change text colour and angle (needs to be adjusted)
  ggforce::geom_parallel_sets_labels(color = "black",
                            angle = 0,
                            size = 5) +
  ## adjusted y and x axes (probably needs more vertical space)
  scale_x_discrete(name = NULL, 
                   expand = c(0, 0.2)) + 
   theme_unhcr(font_size = 14, 
               grid = FALSE ) +
  ## remove axis labels
  theme(  axis.line = element_blank(),
          axis.ticks = element_blank(),
         axis.text.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "none",                    # move legend to bottom
      legend.title = element_blank(),                # remove title
  ) +
  labs(title = "Refugee Status Determination Decisions",
       subtitle = glue::glue("{ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_asylum_iso3c) |>
             dplyr::pull(ctryname) }, {format(sum(links$n),  big.mark=\",\")} decisions recorded in {year}"),
       x = NULL,
       y = NULL,
       caption = "Source: UNHCR.org/refugee-statistics")
}
  return(p)
  
}
```
  
```{r example-plot_ctr_process}
plot_ctr_process(year = 2022,   country_asylum_iso3c = "BOL")

plot_ctr_process(year = 2022,   country_asylum_iso3c = "CHL")


plot_ctr_process(year = 2022,   country_asylum_iso3c = "USA",
                              otherprop = .02)

plot_ctr_process(year = 2022,   country_asylum_iso3c = "USA",
                              otherprop = .04)


```
  
```{r tests-plot_ctr_process}
# test_that("plot_ctr_process works", {   expect_true(inherits(plot_ctr_process, "function")) })
```
    
    
## Average Asylum Processing Time
    
```{r function-plot_ctr_processing_time}
#' Plot Average processing time from registration to first instance asylum decision
#' 
#' This indicator measures the average number of days from the date of completion of registration of the asylum application to the date of notification of first instance asylum decision for all persons who were notified of a first instance RSD/asylum decision during the reporting period. 
#' 
#' Status determination procedures are a core protection function and the principle mechanism through which international protection needs of Persons of Concern may be determined in accordance with the key provisions of the 1951 Convention and 1967 Protocol relating to the Status of Refugees, the 1954 Convention relating to the Status of Stateless Persons, or relevant regional refugee protection instruments. Status determination procedures are therefore central to the full and effective enjoyment of the universal right to seek and enjoy asylum and the specific rights guaranteed by the above instruments.
#' 
#' A prolonged waiting period during the status determination procedure is an important indicator of the state of efficiency, fairness, adaptability integrity and hence, overall quality of the national asylum or, depending on the context, UNHCR Mandate RSD procedure, including the timeliness and effectiveness of the overall protection response in the country.
#'  
#'  (RBM Outcome Indicator 2.1) - see [UNHCR Intranet](https://intranet.unhcr.org/content/dam/unhcr/intranet/protection-operations/compass/en/guidance/3/coreindicatorsmetadata/2.0%20Core%20Indicator%20Metadata%2004%2010%202021.pdf#page=67) - Credit to Hisham Galal for the chart initial idea and script
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' 
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Asylum - if NUL then all countries are included
#' 
#' @param procedureType indicates whether "G" (Government) "J" (Joint) "U" (UNHCR)
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual guides guide_legend
#'             geom_text guide_axis facet_wrap vars geom_area annotate
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  scale_fill_manual
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom tidyr pivot_longer 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join last transmute
#' @importFrom purrr detect_index
#' @importFrom lubridate date_decimal interval days make_date
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_ctr_processing_time <- function(year = 2022,
                              country_asylum_iso3c = country_asylum_iso3,
                              country_origin_iso3c = NULL,
                              procedureType = NULL){
    
  
#   library(tidyverse)
# library(lubridate)
# library(jsonlite)
#   country_asylum_iso3c <- "CHL" # iso3 code
  
  if( is.null(country_origin_iso3c)) {
        originfilter <-     c(ForcedDisplacementStat::asylum_applications |>
                                      dplyr::select(CountryOriginCode) |>
                                      unique() |>
                                    dplyr::pull() ) 
        originfilterlab <- ""
        } else { 
        originfilter <- c(country_origin_iso3c) 
        originfilterlab <- ForcedDisplacementStat::reference |>
                                   dplyr::filter( iso_3 == country_origin_iso3c) |>
                                   dplyr::pull(ctryname)}
  if( is.null(procedureType)) {
          procedurefilter <-     c(ForcedDisplacementStat::asylum_applications |>
                                      dplyr::select(ProcedureType) |>
                                      unique() |>
                                    dplyr::pull() )
          procedurefilterlab <- ""
          } else { 
          procedurefilter <- c(procedureType)
          procedurefilterlab <- ForcedDisplacementStat::asylum_applications |>
                                      dplyr::filter(ProcedureType == procedureType ) |>
                                     dplyr::select(ProcedureName)|>
                                      unique() |>
                                    dplyr::pull()}
   filterlab <- paste0( dplyr::if_else( originfilterlab == "",
                                        "",
                                        paste0( ", filtered for nationals from ",
                                                originfilterlab)),
                        dplyr::if_else( originfilterlab == "",
                                        "",
                                        paste0( " processed by ", 
                                                procedurefilterlab, " ")))
                        
      
  
  
    apps <- ForcedDisplacementStat::asylum_applications |>
          filter(CountryAsylumCode == country_asylum_iso3c )|>
      
          ## add conditional filter  if setup
          filter(CountryOriginCode %in% c(originfilter)  ) |>
          filter(ProcedureType %in% c(procedurefilter)  ) |>
      
      
          mutate ( DecisionTypeCode  = dplyr::case_when (
            (ApplicationTypeCode %in% c("N", "NR", "NA", "FA", "SP") ) ~ "FI",
             # | 
             #  (ApplicationTypeCode == "V" & 
             #    DecisionType %in% c("FI", "FA", "NA", "TR", "CA")) ) ~ "FI",
            TRUE ~ "Other"   )) |>
          group_by(Year, CountryAsylumCode,
                   CountryAsylumName, 
                   #ProcedureType,  ProcedureName,  ApplicationTypeCode, ApplicationType
                   DecisionTypeCode ) |>
         summarize (NumberApplications = sum(NumberApplications , na.rm= TRUE) )  |>
          dplyr::ungroup()
#     
#   # coa <-   "CHL"
#     
#   ## Equivalent to this API - call 
# # apps1 <- jsonlite::fromJSON(glue::glue("https://api.unhcr.org/population/v1/asylum-applications/?limit=100&dataset=asylum-applications&displayType=totals&yearFrom=1951&yearTo=2022&coa={coa}&columns%5B%5D=procedure_type&columns%5B%5D=app_type&columns%5B%5D=app_pc&columns%5B%5D=app_size&columns%5B%5D=dec_level&columns%5B%5D=applied"))$items |>  as_tibble()
    
  if( is.null(country_origin_iso3c)) {
        originfilter <-     c(ForcedDisplacementStat::asylum_decisions |>
                                      dplyr::select(CountryOriginCode) |>
                                      unique() |>
                                    dplyr::pull() ) } else { 
        originfilter <- c(country_origin_iso3c) }
  if( is.null(procedureType)) {
          procedurefilter <-     c(ForcedDisplacementStat::asylum_decisions |>
                                      dplyr::select(ProcedureType) |>
                                      unique() |>
                                    dplyr::pull() ) } else { 
          procedurefilter <- c(procedureType) }
# 
  decs <- ForcedDisplacementStat::asylum_decisions |>
          filter(CountryAsylumCode == country_asylum_iso3c ) |>
          ## add conditional filter  if setup
          filter(CountryOriginCode %in% c(originfilter)  ) |>
          filter(ProcedureType %in% c(procedurefilter)  ) |>
    
          group_by(Year, CountryAsylumCode,
                   CountryAsylumName, 
                   #ProcedureType,  ProcedureName,, DecisionTypeName
                   DecisionTypeCode) |>
         summarize (Recognized = sum(Recognized , na.rm= TRUE),
                  ComplementaryProtection = sum( ComplementaryProtection , na.rm= TRUE),
                  OtherwiseClosed = sum(OtherwiseClosed , na.rm= TRUE),
                  Rejected = sum(Rejected , na.rm= TRUE),
                  TotalDecided = sum(TotalDecided , na.rm= TRUE)) |>
          dplyr::ungroup()
  
  ## Equivalent to this API - call 
 # decs1 <- jsonlite::fromJSON(glue::glue("https://api.unhcr.org/population/v1/asylum-decisions/?limit=100&dataset=asylum-decisions&displayType=totals&yearFrom=1951&yearTo=2022&coa={coa}&columns%5B%5D=procedure_type&columns%5B%5D=dec_level&columns%5B%5D=dec_pc&columns%5B%5D=dec_recognized&columns%5B%5D=dec_other&columns%5B%5D=dec_rejected&columns%5B%5D=dec_closed&columns%5B%5D=dec_total"))$items |> as_tibble() 

data <-
  left_join(apps |> filter(DecisionTypeCode  == "FI") |> select(Year, CountryAsylumCode, NumberApplications),
            decs |> filter(DecisionTypeCode == "FI") |> select(Year, CountryAsylumCode, TotalDecided) ) |>
  arrange(Year) |>
  mutate(across(c(NumberApplications,
                  TotalDecided),
                replace_na, 0)) |>
  dplyr::transmute(Year = if_else(Year == last(Year),
                           Year+.5,
                           Year+1), # MYSR correction
            apps = cumsum(NumberApplications),
            decs = cumsum(TotalDecided))  
  
  idx <- purrr::detect_index(data$apps, ~.< dplyr::last(data$decs),
                                           .dir = "backward")
  
  t <- lubridate::date_decimal(data$Year[idx] + 
                                 (dplyr::last(data$decs) - data$apps[idx]) / 
                                 (data$apps[idx+1] - data$apps[idx]))
  
  stat <- lubridate::interval(t, lubridate::make_date(2022, 6, 30)) / lubridate::days()
  
  data2 <- data |>
      tidyr::pivot_longer(- Year, 
                          names_to = "flow",
                          values_to = "n")
  
  
  
  p <- data2 |>
    ggplot(aes(Year,
               n, 
               fill = flow)) +
    geom_area(position = "identity") +
    ## highlight the main indicator!
    annotate("segment",
             x = lubridate::decimal_date(t),
             y = dplyr::last(data$decs),
             xend = dplyr::last(data$Year),
             yend = dplyr::last(data$decs)) +
    annotate("text",
             x = 2020,
             y = last(data$decs),
             vjust = -.5,
             label = glue::glue("{round(stat)} days")) +
    scale_y_continuous(labels = scales::label_comma()) +
    scale_fill_manual(labels = c(decs = "Decisions",
                                 apps = "Applications"),
                      values = c(decs = "#0072BC",
                                 apps = "#FAEB00"),
                      name = NULL) +
    labs(title = stringr::str_wrap("Average Processing Time from Asylum Registration to First Instance Decision", 100),
         subtitle = glue::glue("In {ForcedDisplacementStat::reference |>
                                   dplyr::filter( iso_3 == country_asylum_iso3c) |>
                                   dplyr::pull(ctryname)}, comparative cumulative applications and decisions with gap measured in days as of {year} {filterlab}"),
         x = NULL,
         y = "Cumulative total",
         caption = "Source: UNHCR.org/refugee-statistics") +
    guides(fill = guide_legend(reverse = TRUE)) +
    theme_unhcr(font_size = 14, 
                grid = "Y")  + ## Insert UNHCR Style
    theme(legend.position = "top")
  
  return(p)
  
}
```
  
```{r example-plot_ctr_processing_time}
plot_ctr_processing_time(year = 2022,
                         country_asylum_iso3c = "ARG")


plot_ctr_processing_time(year = 2022,
                         country_asylum_iso3c = "USA")

## Display a filtered version of the chart for a specific country and procedure
plot_ctr_processing_time(year = 2022,
                         country_asylum_iso3c = "EGY",
                         country_origin_iso3c = "ERI",
                         procedureType = "U")

```
  
```{r tests-plot_ctr_processing_time}
#test_that("plot_ctr_processing_time works", { expect_true(inherits(plot_ctr_processing_time, "function")) })
```
 
 
# Solutions 

## Plot Solution Over time 
    
```{r function-plot_ctr_solution}
#' Plotting solutions within a country
#' 
#' As part of UNHCR standard approach, there are mostly 3 types of durable solutions for Refugees:
#'  - Voluntary Repatriation in origin country 
#'  - Naturalization in the host country
#'  - Resettlement in a third country 
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'
 
plot_ctr_solution <- function(year = 2021,
                              lag = 10,
                              country_asylum_iso3c = country_asylum_iso3c,
                              pop_type = pop_type){
  
    ctrylabel <- ForcedDisplacementStat::reference |> 
                 filter(iso_3 == country_asylum_iso3c ) |> 
               select(ctryname) |> 
                pull()
  
  
    Solution <- ForcedDisplacementStat::solutions_long  |>
                dplyr::left_join(y= ForcedDisplacementStat::reference, 
                               by = c("CountryAsylumCode" = "iso_3")) |>
      
              filter(CountryAsylumCode  == country_asylum_iso3c & 
                      Year > (year - lag) &
                      Solution.type.label != "IDP returns" ) |>
              mutate(Year = as.factor(Year) ) |>
              group_by(Year, Solution.type.label ) |>
              summarise(Value2 = sum(Value) )  |>
              mutate( valabel =  ifelse(Value2 > 1000, 
                                       paste(scales::label_number_si(accuracy = 0.1)(Value2)),
                                       as.character(Value2)) )   

    
    ncat <- ifelse( nlevels(as.factor(Solution$Solution.type.label)) %in% c(2,4), 2,3)
    #levels(as.factor(solutions_long.asy$Solution.type.label))
    Solution$Solution.type.label <- factor(Solution$Solution.type.label,
                                                     levels = c("Naturalisation", 
                                                                "Resettlement arrivals",
                                                                "Refugee returns",
                                                                "IDP returns" )) 



if( nrow(Solution) ==  0 ){
  
    info <-  paste0("There\'s no recorded solutions in ", ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_asylum_iso3c) |>
             dplyr::pull(ctryname) , " for ", year)
    p <- ggplot() +  annotate(stringr::str_wrap("text", 80), 
                              x = 1, y = 1, size = 11,  
                              label = info ) +  theme_void()  
  
} else {
  

#Make plot
p <- ggplot(Solution, aes(x = Year, y = Value2  )) + 
  geom_bar(stat = "identity", 
           position = "identity", 
           fill = "#0072bc" ) + # here we configure that it will be bar chart
 # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number
  
  scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale()))+

  scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+
  #xlim(c(year-lag, year +1)) +
  facet_wrap( vars(Solution.type.label ), ncol = ncat) +
  #geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
  theme_unhcr(font_size = 14)  + ## Insert UNHCR Style
  theme(panel.grid.major.y  = element_line(color = "#cbcbcb"), 
        panel.grid.major.x  = element_blank(), 
        panel.grid.minor = element_blank()) + ### changing grid line that should appear
  ## and the chart labels
  labs(title = "What are the trends in terms of Solutions?",
       subtitle = paste0("Data for Forcibly Displaced People across Borders as of ", year, " filtered for ", ctrylabel ), 
       x = "",
       y = "",
       caption = "Source: UNHCR.org/refugee-statistics.\n Forced Displacement includes Refugees, Asylum Seekers and Other in Need of International Protection.")

}
    
return(p)
}
```
  
```{r example-plot_ctr_solution}
plot_ctr_solution(year = 2021,
                  country_asylum_iso3c= "UGA",
                  pop_type = c("REF", "ASY"))
```
  
```{r tests-plot_ctr_solution}
#test_that("plot_ctr_solution works", {expect_true(inherits(plot_ctr_solution, "function")) })
```
  

#Forced Displacement and Migration 

## Plot Main Destination from  one specific country 


```{r function-plot_ctr_destination}
#' Tree map of Population Groups within a country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Origin
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_ctr_destination <- function(year = 2021,
                                 country_origin_iso3c = country_origin_iso3c,
                                 pop_type = pop_type) {

  ctrylabel <- ForcedDisplacementStat::reference |>
    filter(iso_3 == country_origin_iso3c) |>
    select(ctryname) |>
    pull()
  
  Destination <-
    left_join(
      x = ForcedDisplacementStat::end_year_population_totals_long,
      y = ForcedDisplacementStat::reference,
      by = c("CountryAsylumCode" = "iso_3")
    )  |>
    filter(
      CountryOriginCode  == country_origin_iso3c  &
        Year == year &
        Population.type  %in% as.vector(pop_type)
    )  |>
    mutate(
      CountryAsylumName = str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
      CountryAsylumName = str_replace(CountryAsylumName, "Iran \\(Islamic Republic of\\)", "Iran"),
      CountryAsylumName = str_replace(CountryAsylumName, "United States of America", "USA"),
      CountryAsylumName = str_replace(
        CountryAsylumName,
        "United Kingdom of Great Britain and Northern Ireland",
        "UK"
      )
    ) |>
    group_by(CountryAsylumName) |>
    summarise(DisplacedAcrossBorders = sum(Value))  |>
    mutate(DisplacedAcrossBordersRound =  ifelse(
      DisplacedAcrossBorders > 1000,
      paste(
        label_number(accuracy = .1,
                     scale_cut = cut_short_scale())(DisplacedAcrossBorders)
      ),
      as.character(DisplacedAcrossBorders)
    )) |>
    arrange(desc(DisplacedAcrossBorders)) |>
    head(10) |>
    filter(DisplacedAcrossBorders > 0)

  if(nrow(Destination) ==  0) {
    
    info <-  paste0("There\'s no recorded Countries of destination in ", ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_origin_iso3c) |>
             dplyr::pull(ctryname) , " for ", year)
    p <- ggplot() +  annotate(stringr::str_wrap("text", 80), 
                              x = 1, y = 1, size = 11,  
                              label = info ) +  theme_void() 
    
  } else {
    #Make plot
    p <-  ggplot() +
          geom_col(data = Destination, 
                aes(
                x = reorder(CountryAsylumName, DisplacedAcrossBorders),
                ## Reordering country by Value
                y = DisplacedAcrossBorders),
               fill = unhcr_pal(n = 1, "pal_blue")) + # here we configure that it will be bar chart+
        ## Format axis number
       scale_y_continuous(expand = expansion(c(0, 0.1)),
                     labels = label_number(scale_cut = cut_short_scale())) +
        ## Position label differently in the bar in white - outside bar in black
        geom_label(
          data = subset(
            Destination,
            DisplacedAcrossBorders < max(DisplacedAcrossBorders) / 1.5
          ),
        aes(
          x = reorder(CountryAsylumName, DisplacedAcrossBorders),
          y = DisplacedAcrossBorders,
          label = DisplacedAcrossBordersRound
        ),
        hjust = -0.1 ,
        vjust = 0.5,
        colour = "black",
        fill = NA,
        label.size = NA,
        #family = "Lato",
        size = 4
      ) +
      
      geom_label(
        data = subset(
          Destination,
          DisplacedAcrossBorders >= max(DisplacedAcrossBorders) / 1.5
        ),
        aes(
          x = reorder(CountryAsylumName, DisplacedAcrossBorders),
          y = DisplacedAcrossBorders,
          label = DisplacedAcrossBordersRound
        ),
        hjust = 1.1 ,
        vjust = 0.5,
        colour = "white",
        fill = NA,
        label.size = NA,
        # family = "Lato",
        size = 4
      ) +
      # Add `coord_flip()` to make your vertical bars horizontal:
      coord_flip() +
      
      ## and the chart labels
      labs(
        title = paste0("What are the main destinations for Forcibly Displaced People?"),
        
        subtitle = paste0(
          "Top Destination Countries | as of ",
          year,
          " for population from ",
          ctrylabel
        ),
        x = "",
        y = "",
        caption = "Source: UNHCR Population Statistics Database.\n Forced Displacement includes Refugees, Asylum Seekers and Other in Need of International Protection."
      ) +
    theme_unhcr(font_size = 14,
                  grid = FALSE,
                  axis = "y",
                  axis_title = FALSE,
                  axis_text = "y"
                )
    
    
  }
  return(p) # print(p)
}

```

```{r examples-plot_ctr_destination, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_destination(year = 2021,
                     country_origin_iso3c = "COL",
                     pop_type = c("REF", "ASY")
         )

```
    

## plot recognition rate for a nationality

    
```{r function-plot_ctr_origin_recognition}
#' Display A Chart with Refugee Recognition Rate for nationals from a specific country
#' 
#' In the absence of an internationally agreed methodology for calculating recognition rates,
#'  UNHCR uses two rates to compute the proportion of refugee claims accepted during the year: 
#'  
#'   * The Refugee Recognition Rate divides the number of asylum-seekers granted Convention refugee
#'   status by the total number of accepted (Convention and, where relevant, complementary 
#'   protection) and rejected cases (aka substantive decision). 
#'   
#'   * The Total Recognition Rate divides the number of asylum-seekers granted Convention
#'    refugee status and / or complementary form of protection by the total number
#'    of accepted (Convention and, where relevant, complementary protection) and
#'     rejected cases.
#'     
#' Non-substantive decisions are, to the extent possible, excluded from both 
#' calculations. For the purpose of international comparability,  UNHCR only 
#' uses these two recognition rates and does not report nationally calculated rates.
#'      
#'      See https://www.unhcr.org/4ce531e09.pdf
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Origin
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * RefugeeRecognitionRate 
#'            * TotalRecognitionRate
#' @param order_by this can be either:
#'            * Recognized  
#'            * ComplementaryProtection  
#'            * TotalDecided 
#'            
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr  scale_fill_unhcr_d
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_ctr_origin_recognition <- function(year = 2022,
                                 country_origin_iso3c  ,
                                 top_n_countries = 10, 
                                 measure = "RefugeeRecognitionRate",
                                 order_by = "TotalDecided" ){
   
   ctrylabel <- ForcedDisplacementStat::reference |> 
                 filter(iso_3 == country_origin_iso3c ) |> 
               select(ctryname) |> 
                pull()
   
  
   measurelabel <-
     dplyr::case_when(
       measure == "RefugeeRecognitionRate"  ~ "Refugee Recognition Rate",
       measure == "TotalRecognitionRate"  ~ "Total Recognition Rate"
     )
   
   order_bylabel <-
     dplyr::case_when(
       order_by == "Recognized"  ~ "Recognized Refugee Status Decisions",
       order_by == "ComplementaryProtection"  ~ "Complementary Protection Decisions",
       order_by == "TotalDecided"  ~ "Total Decision (independently of the outcome)"
     )
   
   topAsylum <-  ForcedDisplacementStat::asylum_decisions |>
     filter(CountryOriginCode == country_origin_iso3c &
              Year == year) |>
     ## the below is change - DecisionsAveragePersonsPerCase- is just indicative... so no need to use it to m
     # mutate(DecisionsAveragePersonsPerCase = map_dbl(DecisionsAveragePersonsPerCase, ~replace_na(max(as.numeric(.), 1), 1))) |>
     mutate(DecisionsAveragePersonsPerCase = 1) |>
     group_by(CountryAsylumName) |>
     summarize(
       Recognized = sum(Recognized * DecisionsAveragePersonsPerCase, na.rm = TRUE),
       ComplementaryProtection = sum(
         ComplementaryProtection * DecisionsAveragePersonsPerCase,
         na.rm = TRUE
       ),
       TotalDecided = sum(TotalDecided * DecisionsAveragePersonsPerCase, na.rm = TRUE)
     ) |>
     mutate(
       RefugeeRecognitionRate = (Recognized) / TotalDecided,
       TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided
     )   

   topAsylum1 <-  topAsylum  |>
     mutate(measured = .data[[measure]])  |>
     mutate(order_by = .data[[order_by]])  |>
     arrange(desc(order_by)) |>
     head(top_n_countries)   
 
 
  
 
   rsdAsylum <- ggplot() +
     geom_bar(data = topAsylum1, 
              aes(y = measured ,
                  x = reorder(CountryAsylumName, measured)),
              stat = "identity", fill = "#0072bc") +
     coord_flip() +
     #scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number
     scale_y_continuous( labels =   scales::label_percent(accuracy = 0.1, suffix = "%")) +
     
     #facet_grid(.~ ctry_asy) +
     #  geom_hline(yintercept = 0, size = 1.1, colour = "#333333")   +
     labs(
       title = paste0(measurelabel, " | ", year, " for Nationals from ", ctrylabel),
       caption = 'Source: UNHCR.org/refugee-statistics ',
       subtitle = paste0(
         "For top ",
         top_n_countries,
         " Countries of Asylum ordered by ",
         order_bylabel
       ),
       x = " ",  y = " " ) +
     theme_unhcr(
       grid = "Y",
       axis = "x",
       axis_title = "" ,
       font_size = 14
     ) +
     theme(#axis.text.x = element_blank(),
       # legend.position = "none",
       
       panel.grid.major.x = element_line(color = "#cbcbcb"),
       panel.grid.major.y = element_blank()) ### changing grid line that should appear) 


  return(rsdAsylum)

    
}
```
  
```{r example-plot_ctr_origin_recognition}
plot_ctr_origin_recognition(year = 2022,
                     country_origin_iso3c = "VEN",
                     top_n_countries = 10, 
                     measure = "RefugeeRecognitionRate",
                     order_by = "TotalDecided" )
```
  
```{r tests-plot_ctr_origin_recognition}
# test_that("plot_ctr_recognition works", {   expect_true(inherits(plot_ctr_recognition, "function")) })
```



## plot share displaced / migrant for world - region - subregion

bar with share

## Plot  share displaced / migrant for top countries
    
dumbel


    
## Plot Ratio Refugee Migrant
    
```{r function-plot_ctr_disp_migrant}
#' Plotting ratio Refugee/Asylum seekers vs Migrant within a country
#' 
#' This chart provides insights on the relative weight of Forced Displacement for countries generating such type of displacement.
#' First, the size of the circle represents the number of Refugees, Asylum Seekers and other in need of International Protection
#' The vertical axis represent the Share of immigrants from the country in relation with all immigrants within the country. 
#' The higher is country in this axis, the more people from this country are the host country independently of the reason why they migrated.   
#' The horizontal axis displays the share of migration generated by forced displacement within each country of origin. 
#' The more a country is right, the more people from that country cam because of Forced Displacement.
#'  
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text geom_point scale_size coord_cartesian theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom WDI WDI
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join across 
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom viridis scale_fill_viridis
#' 
#' @return a ggplot2 object
#' 
#' @export
#'
plot_ctr_disp_migrant <- function(year = 2021,
                              country_asylum_iso3c ){
  
  ctrylabel <- ForcedDisplacementStat::reference |> 
                 filter(iso_3 == country_asylum_iso3c ) |> 
               select(ctryname) |> 
                pull()
  
  thiscodeM49 <- ForcedDisplacementStat::reference |>
                filter(iso_3 == country_asylum_iso3c) |>
                 select(M49_code) |>
                 pull()
  
  ## World bank API to retrieve total population
  # wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
  #            
  #              country = c( country_asylum_iso3c )  ,         
  #              startdate = 1990, 
  #              enddate = year, 
  #              return_wide = TRUE)
  # 
  # # Renaming variables for further matching
  # names(wb_data)[1] <- "iso_3"
  # names(wb_data)[2] <- "Year"
  
  wb_data <- WDI::WDI(country = c(country_asylum_iso3c ) ,
                      indicator=c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
                      start = 1990, 
                      end = year,
                      extra = TRUE)   
  # Renaming variables for further matching
  names(wb_data)[3] <- "iso_3"
  names(wb_data)[4] <- "Year"
  wb_data$Year <- as.numeric(wb_data$Year)

  ## Getting summary of forcibly displaced   ##############
  displaced <- left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                               y= ForcedDisplacementStat::reference, 
                               by = c("CountryAsylumCode" = "iso_3")) |>
              filter(Population.type  %in% c("REF", "ASY", "OIP")) |>
              filter(CountryAsylumCode == country_asylum_iso3c) |>
              filter( Year == max(Year) ) |>
              mutate( iso_3 = CountryOriginCode) |> 
              group_by(Year, iso_3,CountryOriginName, UNHCRBureau, hcr_subregion, INCOME_GRP) |>
              summarise(Asylum_Refugee_in = sum(Value, na.rm = TRUE) )  |>
              filter( iso_3 != "UKN") |>
              arrange( desc(Asylum_Refugee_in)) |>
             # head(10)|>
              as.data.frame()
  
  
  ## Now getting migrant data  ##############
  migrant <-  left_join( x= ForcedDisplacementStat::migrants, 
                               y= ForcedDisplacementStat::reference, 
                               by = c("CountryOriginM49" = "M49_code")) |>
              filter(CountryDestinationM49 == thiscodeM49) |>
              filter( Year == 2020 ) |>
              as.data.frame() |>
              group_by(Year, iso_3,CountryOriginName, UNHCRBureau, hcr_subregion, INCOME_GRP) |>
              summarise(Immigrant = sum(Value) ) |>
              ungroup()#|>
              #mutate( shareOrgin = (Immigrant / sum(Immigrant, na.rm = TRUE))*100 ) |>
              #mutate( Year = as.numeric(Year) ) |>
              #mutate(  )


  ## Now merge everyting   #########
  thismigProfile <-  migrant  |>
    dplyr::full_join( displaced |> select(Asylum_Refugee_in, iso_3), by = c("iso_3")) |>
    dplyr::mutate(  SP.POP.TOTL = as.integer(wb_data |> filter( Year == 2020) |> pull(SP.POP.TOTL) ) ) |>
     #mutate_each(funs(replace(., which(is.na(.)), 0))) |>
        mutate(across( where(is.numeric), ~replace_na(.,0)))|>
    ## Calculate a few ration
    mutate(  totImmigrant =   Immigrant + Asylum_Refugee_in  ,
   # mutate(  totImmigrant =   rowSums(as.integer(Immigrant) , as.integer(Asylum_Refugee_in), na.rm = TRUE )  )
   #    ,
             ratioAsylum_Immigrant = round(Asylum_Refugee_in / totImmigrant, 4),
             shareOrgin =  round(totImmigrant / sum(totImmigrant, na.rm = TRUE),4),

             ratioAsylum_Refugee_in = Asylum_Refugee_in / SP.POP.TOTL,
            ratioImmigrant = Immigrant / SP.POP.TOTL )  |>
    arrange( desc(Asylum_Refugee_in)) |>
   head(10)


if( nrow(displaced) ==  0 ){
     info  <- paste0("There\'s no recorded Forcibly Displaced People across Borders in ",ctrylabel )
     p <- ggplot() +  annotate("text",  x = 1, y = 1, size = 12,  
                                        label = info ) +  theme_void() 
  
} else {

p <- ggplot(thismigProfile,
       aes(x= ratioAsylum_Immigrant, 
           y= shareOrgin, 
           size= Asylum_Refugee_in/100, 
           #fill= INCOME_GRP,
           label = iso_3)) +
  geom_point(alpha=0.5, 
             shape=21, 
             color="black",
             fill = "#0072BC") +
  scale_size(range = c(.1, 24), guide= "none", ## Do not show Legend
             name="# of Forcibly Displaced People") +
  #viridis::scale_fill_viridis(discrete=TRUE,  name="Country Income Classification") +
  scale_x_continuous(labels = scales::label_percent(accuracy = .1)) +
  scale_y_continuous(labels = scales::label_percent(accuracy = .1)) +
  # facet_wrap( vars(Year ), ncol = 2) +
  #coord_cartesian(clip = "off") +
  ggrepel::geom_label_repel(box.padding = 0.5,
                            size =4,
                            # max.overlaps = 2 
                            fill = "white", 
                            xlim = c(-Inf, Inf), 
                            ylim = c(-Inf, Inf)) + 
  labs(title = stringr::str_wrap( paste0("Share of Forcibly Displaced People within all Migrants in ", ctrylabel  ),90) ,
       subtitle = stringr::str_wrap("This chart provides insights on the relative weight of Forced Displacement for countries generating such type of displacement.
       First, the size of the circle represents the number of Refugees, Asylum Seekers and other in need of International Protection for the main origin of displacement.
       The vertical axis represent the Share of immigrants from each country in relation with all immigrants within the country. 
       The horizontal axis displays the share of migration generated by forced displacement.", 120), 
       y = "Share among all migrants",  #shareOrgin, 
       x ="Ratio Displaced / Immigrant",  # ratioAsylum_Immigrant, 
       caption = stringr::str_wrap("Source: UNHCR.org/refugee-statistics (includes REF +ASY+OIP in calculation) & UNDESA Migrant Stock as of 2020.\n Only main top 10 countries (or less depending on data availibility) linked to Forced Displaced across Borders are presented. Be cautious in the interepretation has the Migrant data may have some gaps and are produced only every 5 years.", 120) ) +
  theme_unhcr(font_size = 14)  + ## Insert UNHCR Style
  theme(legend.position="none", 
       # plot.subtitle = element_text(size = 12),
        panel.grid.major.y  = element_line(color = "#cbcbcb"), 
        panel.grid.major.x  = element_line(color = "#cbcbcb"), 
        panel.grid.minor = element_blank())   ### changing grid line that should appear
  
}
#    The higher is country in this axis, the more people from this country are the host country independently of the reason why they migrated. \n\n  
      #    The more a country is right, the more people from that country cam because of Forced Displacement.
return(p)
    
}
```
  
```{r example-plot_ctr_disp_migrant}
plot_ctr_disp_migrant(year = 2022,
                    country_asylum_iso3c = "MEX" )
# plot_ctr_disp_migrant(year = 2022,
#                     country_asylum_iso3c = "FRA" )
```
  
```{r tests-plot_ctr_disp_migrant}
#test_that("plot_ctr_disp_migrant works", {   expect_true(inherits(plot_ctr_disp_migrant, "function")) })
```
  


    
--- 

# Regional Questions




## Population group in the region  
    
```{r function-plot_reg_treemap}
#' Population group in the region  
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom scales label_percent
#' @importFrom treemapify geom_treemap geom_treemap_text
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return plot a ggplot2 object 
#' 
#' @export

plot_reg_treemap <- function(year = 2022,  
                             region = "Americas",
                             pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")){
  
  ## Comparison of Refugees
## Filter popdata for the country report

datatree <-   dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                                                     y= ForcedDisplacementStat::reference, 
                                                     by = c("CountryAsylumCode" = "iso_3")) |>
  dplyr::filter( Year == year  ) |>
  dplyr::filter( Population.type %in% pop_type  ) |>
 # dplyr::filter( Year == year | Year == (year -1) ) |>
  dplyr::select(Year, UNHCRBureau ,Population.type, Population.type.label, Value) |>
  dplyr::group_by( Year, UNHCRBureau, Population.type.label , Population.type ) |>
  dplyr::summarise(Value = sum( Value, na.rm = TRUE))  |>
  dplyr::ungroup(Year, UNHCRBureau ,Population.type, Population.type.label)  |>
  dplyr::mutate(  freq = scales::label_percent( accuracy= .1, suffix = "%")(Value / sum(Value)) ) |>
  dplyr::filter(UNHCRBureau  == region   )   |>
  dplyr::mutate(  freqinReg = scales::label_percent( accuracy= .1, suffix = "%") (Value / sum(Value)) )  
 
## Treemapify
p <- ggplot(datatree, 
       aes(area = Value, 
           fill = Population.type, 
           label = paste0(freqinReg, "\n", Population.type.label)  )) +
  treemapify::geom_treemap() +
  treemapify::geom_treemap_text(colour = "white",
                    place = "centre", size = 15) +
 # scale_fill_viridis_c() +
  scale_fill_manual( values = c(   "IDP" = "#00B398",
                                     "OIP"="#EF4A60",
                                     "ASY" = "#18375F",
                                     "REF" = "#0072BC",
                                     "OOC" ="#8395b9",
                                     "STA"="#E1CC0D",
                                     "HCO"="#1b9e77")) +
  unhcrthemes::theme_unhcr(font_size = 22)  + ## Insert UNHCR Style
  theme(legend.position = "none") +
  ## and the chart labels
  labs(title = paste0("Population of Concern & Affected Host Communities in ", region),
        subtitle = paste0("As of   ",  year, ", a total of ", format(round(sum(datatree$Value), -3),  big.mark=","), " Individuals"),
       x = "",
       y = "",
       caption = "Source: UNHCR.org/refugee-statistics")
 
 return(p)
    
}
```
  
```{r example-plot_reg_treemap}
plot_reg_treemap(year = 2022,  region = "Americas")
```
  
```{r tests-plot_reg_treemap}
#test_that("plot_reg_treemap works", {   expect_true(inherits(plot_reg_treemap, "function")) })
```
  

## Plot World Comparison

    
```{r function-plot_reg_share}
#' A simple chart to compare a population group between the Region and the rest of the world
#' 
#' Simple treemap charts to do the comparison
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom scales label_percent
#' @importFrom stringr str_wrap
#' @importFrom treemapify geom_treemap geom_treemap_text
#' @importFrom unhcrthemes theme_unhcr scale_fill_unhcr_d
#' 
#' @return plot a ggplot2 object 
#' 
#' @export

plot_reg_share <- function(year = 2022,  
                             region = "Americas",
                             pop_type = "REF"){
  
 pop_typelabel <-   dplyr::case_when( 
           pop_type == "REF"  ~  "Refugees",
            pop_type=="IDP"   ~ "Internally displaced persons",
            pop_type=="ASY"   ~ "Asylum seekers",
            pop_type=="OOC"   ~ "Others of concern to UNHCR",
            pop_type=="STA"   ~ "Stateless Persons",
            pop_type=="OIP"   ~ "Other people in need of international protection",
            pop_type=="HCO"   ~ "Host community" )
    
    

datatree <-   dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                                                     y= ForcedDisplacementStat::reference, 
                                                     by = c("CountryAsylumCode" = "iso_3")) |>
  dplyr::filter( Year == year  ) |>
  dplyr::filter( Population.type %in% pop_type  ) |>
 # dplyr::filter( Year == year | Year == (year -1) ) |>
  dplyr::select(Year, UNHCRBureau ,Population.type, Population.type.label, Value) |>
    dplyr::mutate(Compare = ifelse(UNHCRBureau == region, region, "Rest of the World")) |>
  dplyr::group_by( Year, Compare, Population.type.label , Population.type ) |>
  dplyr::summarise(Value = sum( Value, na.rm = TRUE))  |>
  dplyr::ungroup(Year, Compare ,Population.type, Population.type.label)  |>
  dplyr::mutate(  freq = scales::label_percent(accuracy= .1, suffix = "%")(Value / sum(Value)) ) 
 
## Treemapify
p <- ggplot(datatree, 
       aes(area = Value, 
           fill = Compare, 
           label = paste0(  format(round(datatree$Value, -3),  big.mark=",") , "\n in ", Compare )  )) +
  treemapify::geom_treemap() +
  treemapify::geom_treemap_text(colour = "white",
                    place = "centre", size = 15) +
  scale_fill_unhcr_d(palette = "pal_unhcr") +
  unhcrthemes::theme_unhcr(font_size = 22)  + ## Insert UNHCR Style
  theme(legend.position = "none") +
  ## and the chart labels
  labs(title = paste0("Share of ", pop_typelabel , " within ", region),
        subtitle = stringr::str_wrap(paste0("As of ",  year,
                          ", about ",
                          datatree |> filter( Compare == region) |> select(freq) |> pull(), 
                          " of that global population category are hosted in the region"), 80),
       x = "",
       y = "",
       caption = "Source: UNHCR.org/refugee-statistics")
 
 return(p)
    
}
```
  
```{r example-plot_reg_share}
plot_reg_share(year = 2022,  
                             region = "Americas",
                             pop_type = "REF")
plot_reg_share(year = 2022,  
                             region = "Americas",
                             pop_type = "ASY")
plot_reg_share(year = 2022,  
                             region = "Americas",
                             pop_type = "OIP")
plot_reg_share(year = 2022,  
                             region = "Americas",
                             pop_type = "IDP")
plot_reg_share(year = 2022,  
                             region = "Americas",
                             pop_type = "STA")
```
  
```{r tests-plot_reg_share}
# test_that("plot_reg_share works", {   expect_true(inherits(plot_reg_share, "function")) })
```
  

## Evolution Over Time  
    
```{r function-plot_reg_evolution}
#' Evolution over time 
#' 
#' Display evoluation over time for specific population group (one or many) and 
#' defined number of years (lag)
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param lag Number of year to used as comparison base 
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY,   OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual 
#'             geom_text geom_line
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace  
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_reg_evolution <- function(year = 2022,
                              lag = 5,
                              region,
                              pop_type =  c( "REF", "IDP", "ASY", "OOC", "STA", "OIP"
                                             #"HCO"
                                             ) ){
  
  allpop <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                              y= ForcedDisplacementStat::reference, 
                              by = c("CountryAsylumCode" = "iso_3")) |> 
              dplyr::filter(Population.type   %in%  pop_type & 
                              Year >=  (year - lag) &
                              UNHCRBureau  == region )|> 
              dplyr::group_by(Year) |> 
              dplyr::summarise(Value = sum(Value, na.rm = TRUE))
  
  p <-  ggplot(allpop) + 
    geom_line(aes(  x = Year, 
                    y = Value  ),
              size = 1,
              color = unhcr_pal(n = 1, "pal_blue")) +
  geom_text( aes(x = Year,
                 y = Value, 
                 label = label_number(scale_cut = cut_short_scale(), accuracy=1)(Value)),
             vjust = -1, 
             size = 4 ) +
  labs(
    title = paste0( region, ": People of Concern | ", (year - lag), "-", year),
    y = "Number of people",
    caption = "Source: UNHCR.org/refugee-statistics" ) +
  scale_x_continuous(breaks = pretty_breaks(n =7)) +
  scale_y_continuous(
    expand = expansion(c(0, 0.1)),
    breaks = pretty_breaks(n = 4),
    labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale()),
    limits = c(0, 20 * 1e6)
  ) +
  theme_unhcr( grid = "Y",
               axis = "x",  axis_title = "" ,
              font_size = 14 )
  
  return(p)
    
}
```
  
```{r example-plot_reg_evolution}
plot_reg_evolution(year = 2021,
                   lag = 5,
                   region = "Asia",
                   pop_type =  c( "REF", "IDP", "ASY", "OOC", "STA", "OIP"))
```
  
```{r tests-plot_reg_evolution}
t# est_that("plot_reg_evolution works", {  expect_true(inherits(plot_reg_evolution, "function")) })
```
  
 
## Plot Evolution of Population type per year
    
```{r function-plot_reg_population_type_per_year}
#' Display evolution of different population type over years
#' 
#' Summary of Evolution
#'  
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' 
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#'
#' @export
#'
#'

plot_reg_population_type_per_year <- function(year = 2022,
                                              lag = 5,
                                     region,
                                     pop_type =  c("REF", "ASY", "IDP", "OIP", "STA", "OOC") ) {
  

  df <- ForcedDisplacementStat::end_year_population_totals_long  |> 
        dplyr::left_join( ForcedDisplacementStat::reference |> 
                      dplyr::select(coa_region = `UNHCRBureau`, iso_3), 
                      by = c("CountryAsylumCode" = "iso_3")) |> 
  dplyr::filter(coa_region == region &
               Year >= (year - lag)  & 
              Population.type %in% pop_type ) |>
    
    
    group_by(Year, coa_region, Population.type, Population.type.label)  |> 
    summarise(Value = sum(Value, na.rm = TRUE)) |> 
    ungroup()
  

  
  year_breaks <- diff(range(df$Year)) + 1 
  
  p <- ggplot(df) +
    geom_col(aes(x = Year, y = Value, fill = Population.type.label ),
             width = 0.7) +
    # geom_text(aes(x = Year, 
    #               y = Value, 
    #               color = Population.type.label, 
    #               label = label_number(accuracy = 1,
    #                                scale_cut = cut_short_scale())(Value)),
    #           position = position_stack(vjust = 0.5),
    #           show.legend = FALSE,
    #           size = 5) +
    
     scale_fill_manual( values = c(   "Internally displaced persons" = "#00B398",
                                     "Other people in need of international protection"="#EF4A60",
                                     "Asylum seekers"= "#18375F",
                                     "Refugees" = "#0072BC",
                                     "Others of concern to UNHCR" ="#8395b9",
                                     "Stateless Persons"="#E1CC0D",
                                     "Host community"="#1b9e77")) +
    scale_x_continuous(breaks = scales::breaks_pretty(n = year_breaks)) +
     scale_y_continuous(expand = expansion(c(0, 0.1))) +
    labs(title = paste0(region, ": Population type per year"), 
         subtitle = "Number of people (thousand)",
         caption = "Source: UNHCR.org/refugee-statistics") +
    theme_unhcr(grid = FALSE, axis = "x", 
                axis_title = FALSE, axis_text = "x",
              font_size = 14) +
    stat_summary(fun = sum, aes(x = Year,
                                y = Value,
                                label = scales::label_number(accuracy = 1,
                                                       scale_cut = cut_short_scale())(..y..),
                                group = Year),
                 geom = "text", size = 5,
                 vjust = -0.5) +
    theme(legend.direction = "vertical",
          legend.key.size = unit(0.8, 'cm'),
          text = element_text(size = 20),
          plot.subtitle=element_text(size=19),
          plot.title = element_text(size=23),
          plot.caption = element_text(size=13))
  
  return(p) # print(p)    
}
```
  
```{r example-plot_reg_population_type_per_year}
plot_reg_population_type_per_year(year = 2022,
                                              lag = 5,
                                     region  = "Americas",
                                     pop_type =   c("REF", "ASY", "IDP", "OIP", "STA", "OOC") )
```
  
```{r tests-plot_reg_population_type_per_year}
# test_that("plot_reg_population_type_per_year works", {   expect_true(inherits(plot_reg_population_type_per_year, "function")) })
```
  

## Plot Population Origin-Destination within the region 
    
```{r function-plot_reg_origin_dest}
#' Plot Population Origin-Destination within the region 
#' 
#' Chord diagram showing Origin destination see - https://jokergoo.github.io/circlize_book/book/
#' 

#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join summarize
#'               
#' @importFrom tidyr replace_na
#' @importFrom graphics title 
#' @importFrom circlize chordDiagram circos.track circos.text CELL_META
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return plot a ggplot2 object 
#' 
#' @export
plot_reg_origin_dest <- function(year = 2022,  region = "Americas"){
   


chords <- ForcedDisplacementStat::end_year_population_totals |>
  dplyr::left_join( ForcedDisplacementStat::reference |> 
                      dplyr::select(coa_region = `UNHCRBureau`, iso_3),  by = c("CountryAsylumCode" = "iso_3")) |> 
  dplyr::filter(coa_region == region &
           Year == year) |> 
  dplyr::mutate(across(REF:OIP, ~ tidyr::replace_na(as.numeric(.), 0)),
         total = REF + ASY + OIP, #+ IDP  + STA + OOC,
         # Lump together factor levels into "other"
         CountryAsylumName = forcats::fct_lump_prop(CountryAsylumName, prop = .02, w = total),
         CountryOriginName = forcats::fct_lump_prop(CountryOriginName, prop = .02, w = total)) |> 
   dplyr::group_by(CountryOriginName, CountryAsylumName) |>
   dplyr::summarize(total = sum(total), .groups = "drop")  |>
# CountryOriginName = fct_recode(CountryOriginName, "Other" = "China")
  dplyr::mutate(CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""),
        CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
        CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Plurinational State of\\)", ""),
        CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Plurinational State of\\)", ""),
        CountryOriginName = stringr::str_replace(CountryOriginName, "United States of America", "USA"),
        CountryAsylumName = stringr::str_replace(CountryAsylumName, "United States of America", "USA"))

circlize::chordDiagram(chords,
                       self.link = 1,
                      # grid.col = colorRampPalette(RColorBrewer::brewer.pal(11, "Paired"))(15),
                       annotationTrack = "grid" ,
                     # preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(chords))))),
                      preAllocateTracks = 1.6
)

circlize::circos.track(track.index = 1,
                        panel.fun = function(x, y) {
                             circlize::circos.text(circlize::CELL_META$xcenter,
                                                   circlize::CELL_META$ylim[1],
                                                   circlize::CELL_META$sector.index,
                                                   facing = "clockwise",
                                                   niceFacing = TRUE,
                                                   adj = c(0, 0.5))
                           },
                           bg.border = NA) # here set bg.border to NA is important


title(main = "Movement of Forcibly Displaced Population", 
      sub = paste0("In ", region, " as of ", year),
      cex.main = 1.5)

  
     return(invisible(NULL))
  
    
}
```
  
```{r example-plot_reg_origin_dest}
plot_reg_origin_dest(year = 2022,  region = "Asia")
```
  
```{r tests-plot_reg_origin_dest}
#test_that("plot_reg_origin_dest works", {   expect_true(inherits(plot_reg_origin_dest, "function")) })
```
  


## Plot Main country of Asylum in the Region


```{r function-plot_reg_population_type_abs}
#' Main country of origin - Absolute value
#'
#' @param year Numeric value of the year (for instance 2020)
#' 
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' 
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' 
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY,   OIP, OOC, STA)
#' 
#' @param show_diff_label logical to indicate whether or not adding the the label displaying difference in percentage compared to the previous year
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

plot_reg_population_type_abs <- function(year = 2022,
                                         region = "Americas",
                                         top_n_countries = 9,
                                         pop_type = "REF",
                                         show_diff_label = TRUE) {
  
  
  
  cols_poptype <- list(ASY = c("Asylum seekers", "#18375F"),
                       REF = c("Refugees", "#0072BC"),
                       #VDA = c("Venezuelans Displaced Abroad", "#EF4A60"), 
                       OIP = c("Other people in need of international protection", "#EF4A60"), 
                       OOC = c("Others of Concern to UNHCR", "#999999"),
                       IDP = c("Internally displaced persons", "#00B398"),
                       STA = c("Stateless Persons", "#E1CC0D")
  )
  
  labelcat <- dplyr::case_when( pop_type == "ASY"  ~ "Asylum seekers", 
                                pop_type == "REF"  ~ "Refugees",
                                pop_type == "OIP"  ~ "Other people in need of international protection", 
                                pop_type == "OOC"  ~ "Others of Concern to UNHCR", 
                                pop_type == "IDP"  ~ "Internally displaced persons", 
                                pop_type == "STA"  ~ "Stateless Persons")
  
  
  colorlab <- dplyr::case_when( pop_type == "ASY"  ~ "#18375F", 
                                pop_type == "REF"  ~ "#0072BC",
                                pop_type == "OIP"  ~ "#EF4A60", 
                                pop_type == "OOC"  ~ "#999999", 
                                pop_type == "IDP"  ~ "#00B398", 
                                pop_type == "STA"  ~ "#E1CC0D")
  
  
  df <- ForcedDisplacementStat::end_year_population_totals_long |>
    dplyr::left_join(
      ForcedDisplacementStat::reference |>
        dplyr::select(coa_region = `UNHCRBureau`, iso_3),
      by = c("CountryAsylumCode" = "iso_3")
    ) |>
    dplyr::filter(coa_region == region &
                    (Year == year | Year == year - 1) &
                    Population.type %in% pop_type) |>
    dplyr::select(Year, CountryAsylumName, Value) |>
    dplyr::group_by(Year, CountryAsylumName) |>
    dplyr::summarise(Value = sum(Value, na.rm = TRUE)) |>
    dplyr::ungroup() |>
    dplyr::group_by(CountryAsylumName) |>
    dplyr::arrange(Year) |>
    dplyr::mutate(diff_pop_type_value = scales::label_percent(accuracy = 0.1,
                                                              trim = FALSE) (((Value - lag(
                                                                Value
                                                              )) / lag(Value)))) |>
    dplyr::ungroup() |>
    dplyr::filter(Year == year) |>
    dplyr::arrange(desc(Value))  |>
    head(top_n_countries)
  
  
  p <-  ggplot(df) +
    geom_col(aes(x = reorder(CountryAsylumName, Value),
                 y = Value),
             fill = colorlab ,
             width = 0.8) +
    coord_flip() +
    ## Position label differently in the bar in white - outside bar in black
    geom_text(
      data = subset(df, Value < max(Value) / 1.5),
      aes(
        y = Value,
        x = reorder(CountryAsylumName, Value),
        label = label_number(accuracy = 1,
                             scale_cut = cut_short_scale())(Value)
      ),
      hjust = -0.1 ,
      vjust = 0.5,
      colour = "black",
      size = 6
    ) +
    geom_text(
      data = subset(df, Value >= max(Value) / 1.5),
      aes(
        y = Value,
        x = reorder(CountryAsylumName, Value),
        label = label_number(accuracy = 1,
                             scale_cut = cut_short_scale())(Value)
      ),
      hjust = 1.1 ,
      vjust = 0.5,
      colour = "white",
      size = 6
    )
  
  
  # Add diff labels
  if(show_diff_label == TRUE) {
    # diff label positive general
    p <- p + geom_text( 
      data = subset(df, with(df, grepl('^[0-9]', diff_pop_type_value)) & 
                      (Value < max(Value) / 1.5)),
      aes(
        y = Value,
        x = reorder(CountryAsylumName, Value),
        label = paste(intToUtf8(9650), diff_pop_type_value)
      ),
      hjust = -1.2,
      vjust = 0.5,
      colour = "grey",
      size = 5
    ) +
      # diff label negative general
      geom_text(
        data = subset(df, with(df, grepl('-', diff_pop_type_value)) &
                        (Value < max(Value) / 1.5)),
        aes(
          y = Value,
          x = reorder(CountryAsylumName, Value),
          label = paste(intToUtf8(9660), diff_pop_type_value)
        ),
        hjust = -1.2,
        vjust = 0.5,
        colour = "#0472bc",
        size = 5
      ) +
      # diff label positive max
      geom_text(
        data = subset(df, with(df, grepl('^[0-9]', diff_pop_type_value)) & 
                        (Value >= max(Value) / 1.5)),
        aes(
          y = Value,
          x = reorder(CountryAsylumName, Value),
          label = paste(intToUtf8(9650), diff_pop_type_value)
        ),
        hjust = -0.4,
        vjust = 0.5,
        colour = "grey",
        size = 5
      ) +
      # diff label negative max
      geom_text(
        data = subset(df, with(df, grepl('-', diff_pop_type_value)) & 
                        (Value >= max(Value) / 1.5)),
        aes(
          y = Value,
          x = reorder(CountryAsylumName, Value),
          label = paste(intToUtf8(9660), diff_pop_type_value)
        ),
        hjust = -0.4,
        vjust = 0.5,
        colour = "#0472bc",
        size = 5
      )}
  
  p <- p +
    labs(
      title = paste0("Main Host Countries for ", labelcat ,
                     " | ",  year, " in ", region),
      subtitle = paste0(
        "Number of people for top ",
        top_n_countries,
        " countries in the region"
      ),
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    scale_y_continuous(expand = expansion(c(0, 0.1))) +
    theme_unhcr(
      font_size = 14,
      grid = FALSE,
      axis = "y",
      axis_title = FALSE,
      axis_text = "y"
    ) +
    theme(
      legend.direction = "vertical",
      legend.key.size = unit(0.8, 'cm'),
      text = element_text(size = 20),
      plot.subtitle = element_text(size = 19),
      plot.title = element_text(size = 23),
      plot.caption = element_text(size = 13)
    )
  
  return(p)
}
```

```{r examples-plot_reg_population_type_abs, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
plot_reg_population_type_abs(year = 2022,
                              region = "Americas",
                              top_n_countries = 5,
                              pop_type = "REF",
                              show_diff_label = TRUE
                              )

plot_reg_population_type_abs(year = 2022,
                              region = "Americas",
                              top_n_countries = 5,
                              pop_type = "ASY",
                              show_diff_label = FALSE
                              )

```



## Plot Biggest decrease in Refugee Population
 
    
```{r function-plot_reg_decrease}
#' Plot Biggest decrease in Refugee Population
#' 
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null,
#'                it will display the whole world
#' @param lag Number of year to used as comparison base
#' @param topn how many top countries to show..
#' @param pop_type Vector of character values. Possible population type 
#'                (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_reg_decrease <- function(year = 2021,
                              lag = 5,
                              topn = 5,
                              region = "Americas",
                              pop_type =  c("REF", "ASY", "OIP") ){
  
  # library(tidyverse)
  
  thisyear <- year
  baseline <- thisyear -lag
  data <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                                                     y= ForcedDisplacementStat::reference, 
                                                     by = c("CountryAsylumCode" = "iso_3")) |>
    filter(Population.type  %in% pop_type)  |>
    filter(Year == baseline | Year == thisyear) |>
    mutate( Year = case_when(
      Year == thisyear ~ paste("thisyear"),
      Year == baseline ~ paste("baseline") )) |>
    filter(UNHCRBureau == region) |>
    group_by( CountryAsylumName, Year) |>
    summarise(Value2 = sum(Value) )  |>
    select(CountryAsylumName, Year, Value2) |> 
  mutate(CountryAsylumName = str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
        CountryAsylumName = str_replace(CountryAsylumName, "Iran \\(Islamic Republic of\\)", "Iran"),
        CountryAsylumName = str_replace(CountryAsylumName, "United Kingdom of Great Britain and Northern Ireland", "UK")) |> 
   # mutate(Year = paste0("year_",Year )) |>
    spread(Year, Value2) |>
    mutate(gap =  baseline - thisyear   ) |>
    arrange(desc(gap)) |>
    head(topn) |>
    gather(key = Year, 
           value = Value2,
           -CountryAsylumName,
           -gap) |>
    mutate( Year = case_when(
                    Year == "thisyear" ~ paste(thisyear),
                    Year == "baseline" ~ paste(baseline) )  )
  
 p <- ggplot(data, 
       aes(x = reorder(CountryAsylumName, gap),
           y = Value2, 
          fill = as.factor(Year))) +
  
  coord_flip() +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_fill_manual(values = c("#0072bc", "#FAAB18")) +
  labs(title = "Biggest Decrease of Population",
       subtitle = paste0( topn, " Biggest change in Refugee Population, ",
                          region, " " ,  baseline," - ",thisyear), 
       x="", y ="",
       caption = "Source: UNHCR.org/refugee-statistics") + 
   ## Format axis number
  scale_y_continuous( labels = scales::label_number(accuracy = 1, 
                                                    scale_cut = cut_short_scale()))+
  theme_unhcr(font_size = 14)  + ## Insert UNHCR Style
  theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
        panel.grid.major.y = element_blank()) ### changing grid line that should appear
  
  return(p)
    
}
```
  
```{r example-plot_reg_decrease}
plot_reg_decrease(year = 2021,
                  lag = 5,
                  topn = 5,
                  region = "Americas",
                  pop_type = c("REF", "ASY", "OIP"))
```
  
```{r tests-plot_reg_decrease}
#test_that("plot_reg_decrease works", {   expect_true(inherits(plot_reg_decrease, "function")) })
```
  
    
## Plot Biggest increase in Refugee Population 
    
```{r function-plot_reg_increase}
#' Plot Biggest Increase in Refugee Population
#' 
#' 

#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param topn how many top countries to show..
#' @param region Character value with the related UNHCR bureau - when left null, 
#'              it will display the whole world
#' @param pop_type Vector of character values. Possible population type 
#'                  (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom ggalt geom_dumbbell
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_reg_increase <- function(  year = 2021,
                              lag = 5,
                              topn = 5,
                              region = "Americas",
                              pop_type =  c("REF", "ASY", "OIP") ){
  
  # library(tidyverse)
  
  thisyear <- year
  baseline <- thisyear -lag
  data <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                                                     y= ForcedDisplacementStat::reference, 
                                                     by = c("CountryAsylumCode" = "iso_3")) |>
    filter(Population.type  %in% pop_type)  |>
    filter(Year == baseline | Year == thisyear) |>
    mutate( Year = case_when(
      Year == thisyear ~ paste("thisyear"),
      Year == baseline ~ paste("baseline") )) |>
    filter(UNHCRBureau == region) |>
    group_by( CountryAsylumName, Year) |>
    summarise(Value2 = sum(Value) )  |>
    select(CountryAsylumName, Year, Value2) |> 
    mutate(CountryAsylumName = str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
        CountryAsylumName = str_replace(CountryAsylumName, "Iran \\(Islamic Republic of\\)", "Iran"),
        CountryAsylumName = str_replace(CountryAsylumName, "United Kingdom of Great Britain and Northern Ireland", "UK")) |> 
   # mutate(Year = paste0("year_",Year )) |>
    spread(Year, Value2) |>
    mutate(gap =   thisyear -baseline  ) |>
    arrange(desc(gap)) |>
    head(topn) 
  
 p <- ggplot(data, aes(x = baseline , 
                       xend = thisyear,
                       y = reorder(CountryAsylumName, gap),
                       group = CountryAsylumName)) + 
  ggalt::geom_dumbbell(colour = "#dddddd",
                size = 3,
                colour_x = "#0072bc",
                colour_xend = "#FAAB18") + 
  labs(title = paste0("Where did Refugee Population increased in ", region , "?"),
       subtitle = paste0("Biggest increase in Refugee Population, ", baseline," - ",thisyear),
       x="", y ="",
       caption = "Source: UNHCR.org/refugee-statistics") +
   ## Format axis number
  scale_x_continuous(labels = scales::label_number(accuracy = 1,   
                                                   scale_cut = cut_short_scale()))+ 
  theme_unhcr(font_size = 14)  + ## Insert UNHCR Style
  theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
        panel.grid.major.y = element_blank()) ### changing grid line that should appear
 
 return(p)
    
}
```
  
```{r example-plot_reg_increase}
plot_reg_increase(year = 2021,
                  lag = 5,
                  topn = 5,
                  region = "Americas",
                  pop_type = c("REF", "ASY", "OIP"))

plot_reg_increase(year = 2021,
                  lag = 5,
                  topn = 5,
                  region = "Asia",
                  pop_type = c("REF", "ASY", "OIP"))
```
  
```{r tests-plot_reg_increase}
#test_that("plot_reg_increase works", {   expect_true(inherits(plot_reg_increase, "function")) })
```
  

## Proportion of the population who are refugees, by country of origin  (SDG indicator 10.7.4 ) 

```{r function-plot_reg_prop_origin}
#' Proportion of the population who are refugees, by country of origin 
#' 
#' The proportion of a country???s population who become refugees is SDG indicator 10.7.4 
#' it consistutes is a useful way to identify the countries of origin producing the most refugees relative to their number of inhabitants.
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace               
#' @importFrom WDI WDI          
#' @importFrom forcats fct_reorder    
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
 
plot_reg_prop_origin <- function(year = 2022,  region = "Americas"){
  

  ## World bank API to retrieve total population
  # wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD",
  #                                     "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
  #              startdate = 1990, 
  #              enddate = year, 
  #              return_wide = TRUE)
  # 
  # # Renaming variables for further matching
  # names(wb_data)[1] <- "iso_3"
  # names(wb_data)[2] <- "Year"
  
  wb_data <- WDI::WDI(country='all' ,
                      indicator=c("SP.POP.TOTL", "NY.GDP.MKTP.CD",
                                  "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
                      start = 1990, 
                      end = year,
                      extra = TRUE)   
  # Renaming variables for further matching
  names(wb_data)[3] <- "iso3c"
  names(wb_data)[4] <- "Year"  
      
      
      wb_data$Year <- as.numeric(wb_data$Year)
  
  
  departed <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                                                     y= ForcedDisplacementStat::reference, 
                                                     by = c("CountryOriginCode" = "iso_3")) |> 
    dplyr::filter(Population.type  %in% c("REF","ASY","OIP") & 
           Year ==  year &
           UNHCRBureau  == region #&
           #!(is.na(UNHCRBureau))
           ) |>
    dplyr::group_by(CountryOriginName, CountryOriginCode) |>
    dplyr::summarise(Value2 = sum(Value) )  |>
    #mutate( value3 =  format_si(Value2))|>
    dplyr::mutate(CountryOriginName = stringr::str_replace(CountryOriginName, 
                                                           " \\(Bolivarian Republic of\\)", "")) |>
    
    ## Now merge with WB Data 
    dplyr::left_join(wb_data |> 
                       dplyr::select("SP.POP.TOTL","iso3c", "Year")|>
                       dplyr::filter(Year ==  year-1), 
                     by = c(  "CountryOriginCode" = "iso3c"    ))|>  
    dplyr::mutate(ref.part = round(Value2/(SP.POP.TOTL+Value2),4)  ) |>
    dplyr::arrange(desc(ref.part))|>
    head(10)  
  
p <- ggplot(departed,
                 aes( x= ref.part, forcats::fct_reorder(CountryOriginName, ref.part))) +
  
   geom_col(fill = "#0072BC") +
  
  # geom_col( fill = ifelse(departed$CountryOriginCode %in% c("VEN"), "#0072BC", "#CCCCCC")) +
  
  geom_label(aes(label = scales::label_percent(accuracy = .1)(ref.part) ),
             color = "black", hjust = "inward") +
  scale_x_continuous(labels = scales::label_percent(accuracy = .1)) +
  labs(x = NULL, 
       y = NULL,
       title = stringr::str_wrap(paste0("Number of refugees, asylum seekers & displaced across borders by country of origin in", region), 60),
       subtitle =    stringr::str_wrap( "Top 10 Countries, as a proportion of the national population of that country of origin (SDG indicator 10.7.4)", 80),
         caption = stringr::str_wrap("Source: UNHCR.org/refugee-statistics. \n Total count of population who have been recognized as refugees as a proportion of the total population of their country of origin, expressed per 100,000 population. Refugees refers to persons recognized by the Government and/or UNHCR, or those in a refugee-like situation.  Population refers to total resident population in a given country in a given year."), 100) +
  
     
  unhcrthemes::theme_unhcr(grid = "X", 
              axis = "y", 
              axis_title = "x",
              font_size = 14)  

return(p)
    
}
```
  
```{r example-plot_reg_prop_origin}
plot_reg_prop_origin(year = 2022,  region = "Americas")
```
  
```{r tests-plot_reg_prop_origin}
# test_that("plot_reg_prop_origin works", {   expect_true(inherits(plot_reg_prop_origin, "function")) })
```
  
 

## Decision on Refugee Status Determination

```{r function-plot_reg_rsd}
#' Plot Chart on Refugee Status Determination
#' 
#' Show the main host and origin countries based on number of decisions
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * Recognized  
#'            * ComplementaryProtection  
#'            * TotalDecided 
#'            * RefugeeRecognitionRate 
#'            * TotalRecognitionRate
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual 
#'             geom_text geom_line
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace  
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom patchwork plot_annotation
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#' 
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_reg_rsd <- function(year = 2022,
                        region,
                        top_n_countries = 10, 
                        measure = "Recognized"){
  
  measurelabel <- dplyr::case_when( measure == "Recognized"  ~ "Recognized Refugee Status Decisions", 
                       measure == "ComplementaryProtection"  ~ "Complementary Protection Decisions",
                       measure == "TotalDecided"  ~ "Total Decision (independently of the outcome)", 
                       measure == "RefugeeRecognitionRate"  ~ "Refugee Recognition Rate", 
                       measure == "TotalRecognitionRate"  ~ "Total Recognition Rate")

topasyl <-  ForcedDisplacementStat::asylum_decisions |>
  ## Add reference for the filters
  dplyr::left_join( ForcedDisplacementStat::reference |> 
                      select(coa_region = `UNHCRBureau`, iso_3),
                    by = c("CountryAsylumCode" = "iso_3")) |> 
  filter(coa_region == region & Year == year) |> 
  
  ## the below is change - DecisionsAveragePersonsPerCase- is just indicative... so no need to use it to m
 # mutate(DecisionsAveragePersonsPerCase = map_dbl(DecisionsAveragePersonsPerCase, ~replace_na(max(as.numeric(.), 1), 1))) |>
  mutate(DecisionsAveragePersonsPerCase = 1 ) |>
  group_by(CountryAsylumName) |> 
  summarize(Recognized = sum(Recognized * DecisionsAveragePersonsPerCase, na.rm = TRUE),
            ComplementaryProtection = sum(ComplementaryProtection * DecisionsAveragePersonsPerCase, na.rm = TRUE),
            TotalDecided = sum(TotalDecided * DecisionsAveragePersonsPerCase, na.rm = TRUE)) |>
  mutate(RefugeeRecognitionRate = (Recognized ) / TotalDecided,
         TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided ) |>
  # filter(TotalDecided  != 0) |>
  # filter(TotalDecided  > 1000)  |>
  mutate(CountryAsylumName = str_replace(CountryAsylumName, "United States of America", "USA"))
  
topasyl1 <-  topasyl  |>
  mutate( measured = .data[[measure]]) |>
  arrange(desc(measured)) |>
  head(top_n_countries)  
  
 
topOrigin <-  ForcedDisplacementStat::asylum_decisions |>
  ## Add reference for the filters
  dplyr::left_join( ForcedDisplacementStat::reference |> 
                      select(coa_region = `UNHCRBureau`, iso_3),  by = c("CountryOriginCode" = "iso_3")) |> 
  filter(coa_region == region & Year == year) |> 
  ## the below is change - DecisionsAveragePersonsPerCase- is just indicative... so no need to use it to m
 # mutate(DecisionsAveragePersonsPerCase = map_dbl(DecisionsAveragePersonsPerCase, ~replace_na(max(as.numeric(.), 1), 1))) |>
  mutate(DecisionsAveragePersonsPerCase = 1 ) |>
  group_by(CountryOriginName) |> 
  summarize(Recognized = sum(Recognized * DecisionsAveragePersonsPerCase, na.rm = TRUE),
            ComplementaryProtection = sum(ComplementaryProtection * DecisionsAveragePersonsPerCase, na.rm = TRUE),
            TotalDecided = sum(TotalDecided * DecisionsAveragePersonsPerCase, na.rm = TRUE)) |>
  mutate(RefugeeRecognitionRate = (Recognized ) / TotalDecided,
         TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided) |>
  # filter(TotalDecided  != 0) |>
  # filter(TotalDecided  > 1000)  |>
  mutate(CountryOriginName = str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""))

topOrigin1 <-  topOrigin  |>
  mutate( measured = .data[[measure]])  |>
  arrange(desc(measured)) |>
  head(top_n_countries)   
 

rsdasyl <-  ggplot(topasyl1, aes(y = measured, 
             x = reorder(CountryAsylumName, measured))) + 
  
  
  
  scale_y_continuous( labels =   scales::label_percent(accuracy = 0, suffix = "%") ) + 
  
  
  scale_y_continuous( labels =    ifelse( measure %in% c("RefugeeRecognitionRate", "TotalRecognitionRate"), 
                        scales::label_percent(accuracy = 0, suffix = "%"),
                        scales::label_number(accuracy = 1,   scale_cut = cut_short_scale()) )
                      ) + ## Format axis number
  #facet_grid(.~ ctry_asy) +  
  geom_bar( stat ="identity", fill = "#0072bc") +
  coord_flip() +
 # geom_hline(yintercept = 0, linewidth = 1.1, colour = "#333333") +
  labs(#title = "Number of RSD application  in 2020",
       subtitle = paste0( "For top ", top_n_countries, " Countries of Asylum"),
       x = " ", 
       y = " "  ) +
  theme_unhcr( grid = "Y",
               axis = "x",  axis_title = "" ,
              font_size = 10) +
  theme(#axis.text.x = element_blank(),
    # legend.position = "none",
    
    panel.grid.major.x = element_line(color = "#cbcbcb"), 
    panel.grid.major.y = element_blank()) ### changing grid line that should appear) 
  
 
rsdorigin <- ggplot(topOrigin1, aes(y = measured, 
             x = reorder(CountryOriginName, measured))) +
  
  
  scale_y_continuous( labels =   ifelse( measure %in% c("RefugeeRecognitionRate", "TotalRecognitionRate"), 
                        scales::label_percent(accuracy = 0, suffix = "%"),
                        scales::label_number(accuracy = 1,   scale_cut = cut_short_scale()) )
                      ) + ## Format axis number
  
 # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number
  #facet_grid(.~ ctry_asy) +  
  geom_bar( stat ="identity", fill = "#0072bc") +
  coord_flip() +
#  geom_hline(yintercept = 0, size = 1.1, colour = "#333333")   +
  labs(#title = "Number of RSD application per country of Origin in 2020",
       subtitle = paste0( "For top ", top_n_countries, " Countries of Origin"),
       x = " ", 
       y = " " ) +
  theme_unhcr( grid = "Y",
               axis = "x",  axis_title = "" ,
              font_size = 10 ) + 
  theme(#axis.text.x = element_blank(),
    # legend.position = "none",
    
    panel.grid.major.x = element_line(color = "#cbcbcb"), 
    panel.grid.major.y = element_blank()) ### changing grid line that should appear) 

 
#joining charts 
requireNamespace("patchwork")
patchworkRSDa <- rsdasyl + rsdorigin
patchworkRSDa1 <- patchworkRSDa +
  #unhcRstyle::unhcr_theme(base_size = 8)  +  ## Insert UNHCR Style
  theme(legend.position = "none") +
  patchwork::plot_annotation(
    title = paste0(measurelabel, " | ", year, ", in ",region),
   # subtitle = ' ',
    caption = 'Source: UNHCR.org/refugee-statistics '
   ## \n Because of different types of procedure, data from the US may \n includes multiple applications per applicants compared to other countries
  )  

  return(patchworkRSDa1)
}
```
  
```{r example-plot_reg_rsd}
plot_reg_rsd(year = 2022,
             region = "Americas" ,
                        top_n_countries = 10, 
                        measure = "Recognized")


plot_reg_rsd(year = 2022,
             region = "Americas" ,
                        top_n_countries = 5, 
                        measure = "ComplementaryProtection")


plot_reg_rsd(year = 2022,
             region = "Americas" ,
                        top_n_countries = 10, 
                        measure = "TotalDecided")


plot_reg_rsd(year = 2022,
             region = "Americas" ,
                        top_n_countries = 10, 
                        measure = "RefugeeRecognitionRate")


plot_reg_rsd(year = 2022,
             region = "Americas" ,
                        top_n_countries = 10, 
                        measure = "TotalRecognitionRate")


# plot_reg_rsd(year = 2022,
#              region = "Europe", 
#                         top_n_countries = 10, 
#                         measure = "Recognized")
```
  
```{r tests-plot_reg_rsd}
# test_that("plot_reg_rsd works", {   expect_true(inherits(plot_reg_rsd, "function")) })
```
  


    
## Plot Evolution of Solutions in the Region

    
```{r function-plot_reg_solution}
#' Plot Solution over time in the region
#' 
#' Description
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param lag Number of year to used as comparison base
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text geom_smooth
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  if_else desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join 
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom ggrepel geom_label_repel
#' 
#' @return a ggplot2 object
#' 
#' @export
#'  

plot_reg_solution <- function( year = 2022, 
                            region = "Americas",
                            lag = 10){
  
    solution <-  dplyr::left_join( x= ForcedDisplacementStat::solutions_long, 
                                                     y= ForcedDisplacementStat::reference, 
                                                     by = c("CountryOriginCode" = "iso_3")) |> 
                dplyr::filter(Solution.type %in% c("NAT","RST","RET" ) & 
                       UNHCRBureau  == region &
                       Year >= (year - lag) ) |>
                 dplyr::group_by(Year, Solution.type, Solution.type.label )|>
                 dplyr::summarise(Value = sum(Value) ) |>
                 dplyr::ungroup() |>
                 dplyr::group_by( Solution.type  )|>
                 dplyr::mutate(label = dplyr::if_else(Year == max(Year), 
                                               as.character(Solution.type.label),
                                               NA_character_))|>
                 dplyr::ungroup() 

#Make plot
p <- ggplot(solution, aes(x = Year, 
                          y = Value, 
                          colour = Solution.type)) + # Adding reference to color
    geom_smooth(se = FALSE, method = "loess", span = .2) +
    scale_x_continuous( breaks = seq(year - lag, year, by = 5) )+ 
    scale_y_continuous( labels = scales::label_number(accuracy = 1, 
                                                      scale_cut = cut_short_scale()))+
    #scale_colour_viridis_d() + 
     ## Add color for each lines based on color-blind friendly palette
    scale_colour_manual( values = c( "NAT" = "#a6cee3",
                                     "RST"  = "#1f78b4",
                                     "RET" = "#b2df8a" )) +
    ## and the chart labels
    labs(title = paste0("Solution for Displacement in ", region) ,
         subtitle = paste0("Evolution in the past ", lag," years"),
         x = "",
         y = "",
         caption = "Source: UNHCR.org/refugee-statistics ") +   
    ggrepel::geom_label_repel(aes(label = label),
                              nudge_x = 1,
                              na.rm = TRUE) +
    unhcrthemes::theme_unhcr(grid = "Y", 
              axis = "x", 
              axis_title = "y",
              font_size = 14,
              legend = FALSE)  
  

 return(p)  

}

```
  
```{r example-plot_reg_solution}
plot_reg_solution(year = 2022, 
                            region = "Americas",
                            lag = 10)
```
  
```{r tests-plot_reg_solution}
# test_that("plot_reg_solution works", {   expect_true(inherits(plot_reg_solution, "function")) })
```
  

## Mapping Population  

    
```{r function-plot_reg_map}
#' Plot a regional map
#' 
#' 
#' @param year Numeric value of the year (for instance 2020)
#' 
#' @param region Character value with the related UNHCR bureau - when left
#'                null, it will display the whole world
#'                
#' @param topn how many top countries to show..
#' @param pop_type Vector of character values. Possible population type 
#'                (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'                
#' @param projection use a projection system - default is "Mercator"
#'           for instance this can be Bertin 1953 projection - 
#'          https://visionscarto.net/bertin-projection-1953)
#'          
#' @param maxSymbolsize size in point to adjust for the maximum value
#'  to display on the map
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit
#'              stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  
#'             scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom sf st_transform st_as_sf st_drop_geometry
#' @importFrom rnaturalearth ne_countries
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter 
#'                summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom graphics par
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom WDI WDI 
#' @importFrom Hmisc cut2
#' 
#' @return a base plot
#' 
#' @export
#' 
plot_reg_map <- function(    year = 2022, 
                            region = "Americas",
                            topn = 5,
                            pop_type =  c("REF", "ASY", "OIP"),
                            projection = "Mercator",
                            maxSymbolsize = .25   ){
 
      
 
      
   ## World bank API to retrieve total population
  # wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
  #              startdate = 1990, 
  #              enddate = year, 
  #              return_wide = TRUE)
  # 
  # # Renaming variables for further matching
  # names(wb_data)[1] <- "CountryAsylumCode"
  # names(wb_data)[2] <- "Year"
  
  wb_data <- WDI::WDI(country='all', 
                                 ## Population total https://data.worldbank.org/indicator/SP.POP.TOTL
                      indicator=c("SP.POP.TOTL",
                                  ## GDP current
                                  # https://data.worldbank.org/indicator/NY.GDP.MKTP.CD
                                            "NY.GDP.MKTP.CD",
                                  ## GDP per capita 
                                  # https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
                                            "NY.GDP.PCAP.CD", 
                                  ## GNI per capita, Atlas method (current US$)
                                  # https://data.worldbank.org/indicator/NY.GNP.PCAP.CD
                                            "NY.GNP.PCAP.CD" 
                                  ),
                      start = year-1,
                      end = year,
                      extra = TRUE)   
  # Renaming variables for further matching
  names(wb_data)[3] <- "CountryAsylumCode"
  names(wb_data)[4] <- "Year"
      
      
      
      wb_data <- wb_data|>
        filter(Year == year-1) 
      
      ## Get spatial data to add ##########
      mapproject <- ""
      
      listctr <-  ForcedDisplacementStat::reference |>
        filter(UNHCRBureau == region) |>
        select(iso_3) |>
        pull()
      
      
      
      ## Loading the stat tables ######
      data <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long, 
                                y= ForcedDisplacementStat::reference, 
                                by = c("CountryAsylumCode" = "iso_3")) |>
        filter(Population.type  %in% pop_type &
                 Year == year & 
                 UNHCRBureau == region ) |>
        group_by(Year, CountryAsylumName, CountryAsylumCode, UNHCRBureau,Latitude, Longitude  ) |>
        summarise(Value = sum(Value) ) |>
        ungroup()
      
      
      ## Join ########
      data2 <- data |> 
        left_join(wb_data, 
                  by = c( "CountryAsylumCode")) |>  
        mutate(ratio_disp_gdp = round( (Value / NY.GDP.MKTP.CD)*100, 4)  )  |> 
        mutate(ratio_disp_gdpcap = round(  (Value/ NY.GDP.PCAP.CD)*100, 2)  )   |> 
        mutate(ratio_disp_host = round( (Value/  SP.POP.TOTL)*100 , 2)  )  
      
      ## Get Break https://riatelab.github.io/mapsf/reference/mf_get_breaks.html
      # Discretize the variable
      data2$quintDisp <- Hmisc::cut2(data2$Value, g = 4)
      data2$quintDispGGP <- Hmisc::cut2(data2$ratio_disp_gdp, g = 4) 
      data2$quintDispHost <- Hmisc::cut2(data2$ratio_disp_host, g = 4)
        
      
      #names(data2)
      data2 <- data2 |>
        sf::st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)
      
      
      ## Getting world map for mapping
      world <- rnaturalearth::ne_countries(scale = "small", returnclass = "sf") |> 
        filter(continent != "Antarctica")  |>  
        filter(adm0_a3 %in%  listctr) 
      
      ### Need to fix specific case for Asisa... where the proj disperse the country...
      ##  filter(adm0_a3 != "VUT") 
      
      ## Manage Projection... 
      data2 <- data2 |>  
        # this is the crs from d, which has no EPSG code:
        sf::st_transform( '+init=epsg:4326')
      
      world <- world |>  
        # this is the crs from d, which has no EPSG code:
        sf::st_transform('+init=epsg:4326')
      #   # this is the crs from d, which has no EPSG code:
      #   #sf::st_transform(., '+init=epsg:4326')
      #   #sf::st_transform(., '+proj=bertin1953 +R=1 0.72 0.73')
      #   #sf::st_transform(., '+proj=bertin1953 +x_0=1000')
      #   sf::st_transform(., '+proj=bertin1953')
      
      
      PopMap <- data2 |> 
                          sf::st_drop_geometry()|> 
                          ungroup() |>
                          arrange( desc (Value)) |> 
                          head(topn) |> 
                          select(Value) 
      
      minPopMap <- PopMap |>   min()
      maxPopMap <- PopMap |>  max()             
      
      
     regionname <- dplyr::case_when( region == "Americas"  ~  "Americas",
                                  region == "Asia"  ~  "Asia & the Pacific",
                                  region == "EastAfrica"  ~  "Eastern Africa",
                                  region =="Europe"  ~  "Europe",
                                  region == "MENA"  ~  "Middle East & North Africa",
                                  region == "SouthAfrica"  ~  "Southern Africa",
                                  region == "WestAfrica"  ~  "Western Africa")          
      
      ## Generate Map   ##################
      #Maps is created here with [MapSF package](https://riatelab.github.io/mapsf/index.html)
      # Select a font already installed on your system !!
      par(family="Lato")
      # set a theme
      mapsfunhcr <- mapsf::mf_theme(bg ="#d4dff2", #  "#E2E7EB",  ## background color --> Used country 
                      # bg = "#cdd2d4", "#faebd7ff",  "#cdd2d4",
                      mar = c(0, 0, 2, 0), ## margins
                      tab = FALSE,  # if TRUE the title is displayed as a 'tab'
                      fg = "#0072BC",  ## foreground color --> for the top title - use UNHCR Blue..
                      pos = "left", # position, one of 'left', 'center', 'right'
                      inner = FALSE, # if TRUE the title is displayed inside the plot area.
                      line = 2, #number of lines used for the title
                      cex = 2.5, #cex of the title
                      #font = "Lato",
                      font = 1 ) #font of the title
      
      
           # map_fun <- function(data, init, theme){
     #      # Initiate a base map
     #      mf_init(x = init, theme = theme)
     #      # always use add = TRUE after mf_init()
     #      mf_shadow(data, col = "grey50", cex = 0.2 , add = TRUE)
     #      mf_map(data, add = TRUE)
     #      mf_title(txt = "Martinique ", fg = "#FFFFFF")
     #      mf_credits(txt = "Credit", bg = "#ffffff80") 
     #      return(invisible(NULL)) 
     #      }
      
      
      ##Initialise the map with a background
      mapsf::mf_init( x = world, theme = mapsfunhcr) 
      # always use add = TRUE after mf_init()
      
      # Plot a shadow
      mapsf::mf_shadow(world, col = "grey50", cex = 0.2 , 
                       add = TRUE)
      
      mapsf::mf_map(world, 
                    lwd = 0.5, 
                    border = "#93A3AB", 
                    col = "#FFFFFF", 
                    add = TRUE)
      
      # Set a layout
      mapsf::mf_title(txt = paste0("Forced Displacement in ",
                                   regionname, " | ", year), fg = "#FFFFFF")
      mapsf::mf_credits(txt = "Source: UNHCR.org/refugee-statistics - A Country is name if it features among the five largest population.\n The boundaries and names shown and the designations used on this map do not imply official endorsment or acceptance by the inited nations", bg = "#ffffff80" ) 
      
      
      ## Proportional Symbol with color based on other
      mapsf::mf_prop_typo( 
        x = data2, # frame to use.. 
        var = c("Value", "quintDispHost"),  ## First value for size, second for color
        inches = maxSymbolsize, # size of the biggest symbol (radius for circles, half width for squares) in inches
        val_max = maxPopMap,  # maximum value used for proportional symbols
        symbol = "circle", ## type of symbol- 'circle' or 'square'
        border = "grey25", ## border color of symbol
        lwd = 1.5, #  border width of symbol
        pal = "Inferno",  ## Color palette  - https://developer.r-project.org/Blog/public/2019/04/01/hcl-based-color-palettes-in-grdevices/
        alpha = .8,  ## if pal is a hcl.colors palette name, the alpha-transparency level
        leg_no_data = "No data", ## When no data
        col_na = "grey",  ## When no data
        leg_pos = c("topright", "bottomright"),  # position of the legend
        leg_title = c("Number of Individuals", "Ratio with Host Community"), # title of the legend
        leg_title_cex = c(.7, .7),  # title font size of the legend
        leg_val_cex = c(.5, .5), # content font size of the legend
        leg_val_rnd = .2, # number of decimal places of the values in the legend
        leg_frame = c(FALSE, FALSE), # add frame around the legend
        add = TRUE
      )
    # labels for a few  countries - https://riatelab.github.io/mapsf/reference/mf_label.html
     mapsf::mf_label(x = data2[data2$Value >= minPopMap,], 
                      var = "CountryAsylumName",  # name(s) of the variable(s) to plot
                      cex = 0.9, #  labels cex
                      col = "black", 
                      font = 3.5,
                      halo = TRUE, # add halo
                      bg = "white",  # halo color
                      r = 0.2,  # width of the halo
                      overlap = FALSE,  # if FALSE, labels are moved so they do not overlap.
                      lines = TRUE) 
     
     return(invisible(NULL))
}
```
  
```{r example-plot_reg_map}
plot_reg_map(  year = 2022,
                            region = "Asia",
                            topn = 5,
                            pop_type =  c("REF", "ASY", "OIP"),
                            projection = "Mercator",
                            maxSymbolsize = .25)


# plot_reg_map(  year = 2022,
#                             region = "WestAfrica",
#                             topn = 5,
#                             pop_type =  c("REF", "ASY", "OIP"),
#                             projection = "Mercator",
#                             maxSymbolsize = .25)

```
  
```{r tests-plot_reg_map}
# test_that("plot_reg_map works", {   expect_true(inherits(plot_reg_map, "function")) })
```
  
 
    
     


--- 

# Report Templates

Templates are re-built notebook that includes all the plotting functions above and are integrated with report parameters. Templates are available both as html report (that can be converted to PDF) and as PowerPoint presentations, all defined from UNHCR standard brand (cf [unhcrdown](https://github.com/vidonne/unhcrdown). The templates are available either for countries or regions.

## Country Factsheet

```{r function-template_CtryFactsheet}
# usethis::use_rmarkdown_template(
#   template_name = "Country_Factsheet",
#   template_dir = NULL,
#   template_description = "Key Statistical Facts for each Country",
#   template_create_dir = TRUE
# )
#' Generate an html / pdf country factsheet 
#' 
#' This functions provides a quick access to a basic Statistical Fact sheet 
#' template that can be customised according to the needs
#' 
#' @param year Numeric value of the year (for instance 2022)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param folder folder within your project where to put the generated report. 
#' Folder will be created if it does not exist
#' 
#' @importFrom unhcrdown paged_simple
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'

template_CtryFactsheet <- function(year = 2022,
                                   country_asylum_iso3c,
                                   folder = "Report") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  ctrname <- ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_asylum_iso3c) |>
             dplyr::select(ctryname) |>
             dplyr::pull()
  
  rmarkdown::render(
    system.file("rmarkdown/templates/country_factsheet/skeleton/skeleton.Rmd", package = "unhcrdatapackage"),
    output_file = here::here(folder, paste0('StatFactsheetCtr-', country_asylum_iso3c, '-', year, '.html') ),
    params = list(countryname= ctrname,
                  country = country_asylum_iso3c, 
                  year = year)  )
}
  

```

```{r example-template_CtryFactsheet}
## generate for one country
# template_CtryFactsheet(year = 2022, country_asylum_iso3c = "USA",   folder = "Report")

# ## Generate for a specific region
# region <- "Americas"
# year <- 2022
# library(tidyverse)
# ## get all countries with more than 1000 Reported individuals
# ctr <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long,
#                                 y= ForcedDisplacementStat::reference,
#                                 by = c("CountryAsylumCode" = "iso_3")) |>
#         filter(Year == year &
#                 UNHCRBureau == region ) |>
#         group_by( CountryAsylumName, CountryAsylumCode   ) |>
#         summarise(Value = sum(Value) ) |>
#         ungroup() |>
#         filter( Value  > 1000 )
# 
# for ( i in (1:nrow(ctr))) {
#     # i <- 1
#     country_asylum_iso3ci = as.character(ctr[i ,2 ])
#     cat(paste0(country_asylum_iso3ci, "\n"))
#     unhcrdatapackage::template_CtryFactsheet(year = 2022, 
#               country_asylum_iso3c = country_asylum_iso3ci,  
#                folder = "Report")  }
```


## Country Presentation

```{r function-template_CtryPrez}
# usethis::use_rmarkdown_template(
#   template_name = "country_prez",
#   template_dir = NULL,
#   template_description = "Key Statistical Facts for each Country",
#   template_create_dir = TRUE
# )
#' Generate all country factsheet 
#' 
#' @param year Numeric value of the year (for instance 2022)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country 
#' @param folder folder within your project where to put the generated report. 
#'              Folder will be created if it does not exist
#' 
#' @importFrom unhcrdown pptx_slides
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'

template_CtryPrez <- function(year = 2022,
                                   country_asylum_iso3c,   
                              folder = "Report") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  ctrname <- ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_asylum_iso3c) |>
             dplyr::select(ctryname) |>
             dplyr::pull()
  
  rmarkdown::render(
    system.file("rmarkdown/templates/country_prez/skeleton/skeleton.Rmd", package = "unhcrdatapackage"),
    output_file = here::here(folder, paste0('StatFactsheet-', country_asylum_iso3c, '-', year, '.pptx') ),
    params = list(countryname= ctrname,
                  country = country_asylum_iso3c, 
                  year = year)  )
}

```

```{r example-template_CtryPrez} 
## generate for one country
# unhcrdatapackage::template_CtryPrez(year = 2022, 
#                             country_asylum_iso3c = "CHL",
#                             folder = "Report")

# ## Generate for a specific region
# region <- "Americas"
# year <- 2022
# library(tidyverse)
# ## get all countries with more than 1000 Reported individuals
# ctr <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long,
#                                 y= ForcedDisplacementStat::reference,
#                                 by = c("CountryAsylumCode" = "iso_3")) |>
#         filter(Year == year &
#                 UNHCRBureau == region ) |>
#         group_by( CountryAsylumName, CountryAsylumCode   ) |>
#         summarise(Value = sum(Value) ) |>
#         ungroup() |>
#         filter( Value  > 1000 )
# 
# for ( i in (1:nrow(ctr))) {
#     # i <- 1
#     country_asylum_iso3ci = as.character(ctr[i ,2 ])
#     cat(paste0(country_asylum_iso3ci, "\n"))
#     unhcrdatapackage::template_CtryFactsheet(year = 2022, 
#                                 country_asylum_iso3c = country_asylum_iso3ci,
#                                folder = "Report")  }
```


## Country Slides

```{r function-template_CtrySlides}
# usethis::use_rmarkdown_template(
#   template_name = "country_slides",
#   template_dir = NULL,
#   template_description = "Slide Deck - Statistical Facts",
#   template_create_dir = TRUE
# )
#' Generate all country factsheet 
#' 
#' Output is PDF slide deck that preserves well the humanitarian icons
#' 
#' @param year Numeric value of the year (for instance 2022)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country 
#' @param folder folder within your project where to put the generated report. 
#'              Folder will be created if it does not exist
#' 
#' @importFrom unhcrdown html_slides
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'

template_Ctryslides <- function(year = 2022,
                                   country_asylum_iso3c,   
                              folder = "Report") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  ctrname <- ForcedDisplacementStat::reference |>
             dplyr::filter( iso_3 == country_asylum_iso3c) |>
             dplyr::select(ctryname) |>
             dplyr::pull()
  
  rmarkdown::render(
    system.file("rmarkdown/templates/country_slides/skeleton/skeleton.Rmd", package = "unhcrdatapackage"),
    output_file = here::here(folder, paste0('StatFactsheet-', country_asylum_iso3c, '-', year, '.html') ),
    params = list(countryname= ctrname,
                  country = country_asylum_iso3c, 
                  year = year)  )
}

```

```{r example-template_Ctryslides} 
## generate for one country
# unhcrdatapackage::template_Ctryslides(year = 2022, 
#                             country_asylum_iso3c = "CHL",
#                             folder = "Report")

# ## Generate for a specific region
# region <- "Americas"
# year <- 2022
# library(tidyverse)
# ## get all countries with more than 1000 Reported individuals
# ctr <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long,
#                                 y= ForcedDisplacementStat::reference,
#                                 by = c("CountryAsylumCode" = "iso_3")) |>
#         filter(Year == year &
#                 UNHCRBureau == region ) |>
#         group_by( CountryAsylumName, CountryAsylumCode   ) |>
#         summarise(Value = sum(Value) ) |>
#         ungroup() |>
#         filter( Value  > 1000 )
# 
# for ( i in (1:nrow(ctr))) {
#     # i <- 1
#     country_asylum_iso3ci = as.character(ctr[i ,2 ])
#     cat(paste0(country_asylum_iso3ci, "\n"))
#     unhcrdatapackage::template_CtryFactsheet(year = 2022,
#                                 country_asylum_iso3c = country_asylum_iso3ci,
#                                folder = "docs/factsheet")  }
```



## Regional Factsheet

```{r function-template_RegFactsheet}
# usethis::use_rmarkdown_template(
#   template_name = "regional_factsheet",
#   template_dir = NULL,
#   template_description = "Key Statistical Facts for each Country",
#   template_create_dir = TRUE
# )
#' Generate all country factsheet 
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Bureau that covers all the countrie factsheet to generate
#' @param lag Number of year to used as comparison base
#' @param folder folder within your project where to put the generated report. 
#'           Folder will be created if it does not exist
#'           
#' @importFrom unhcrdown paged_simple
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'

template_RegFactsheet <- function(year = 2022,
                                 region = "Americas",
                                 lag = 10,   
                                 folder = "Report") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  regionname <- dplyr::case_when( region == "Americas"  ~  "Americas",
                                  region == "Asia"  ~  "Asia & the Pacific",
                                  region == "EastAfrica"  ~  "Eastern Africa",
                                  region =="Europe"  ~  "Europe",
                                  region == "MENA"  ~  "Middle East & North Africa",
                                  region == "SouthAfrica"  ~  "Southern Africa",
                                  region == "WestAfrica"  ~  "Western Africa")
  
  rmarkdown::render(
    system.file("rmarkdown/templates/regional_factsheet/skeleton/skeleton.Rmd", package = "unhcrdatapackage"),
    output_file = here::here(folder, paste0('StatFactsheet-',  region, '-', year, '.html') ),
    params = list(region=region,
                  regionname = regionname,
                  year = year,
                  lag = lag)  )
}

```

```{r example-template_RegFactsheet}

# template_RegFactsheet(year = 2022, 
#                       region = "Europe", lag = 10,  
#                       folder = "Report")

## We can also generate all factsheets in a loop for 2022

# region <-  ForcedDisplacementStat::reference |>
#   dplyr::distinct(UNHCRBureau) |>
#   dplyr::filter(!(is.na(UNHCRBureau))) |>
#   dplyr::pull()
# 
# for( reg in region) {
#   unhcrdatapackage::template_RegFactsheet(year = 2022, 
#                         region = reg, lag = 10, 
#                         folder = "Report")
# }



```

## Regional Presentation

```{r function-template_RegPrez}
# usethis::use_rmarkdown_template(
#   template_name = "regional_prez",
#   template_dir = NULL,
#   template_description = "Key Statistical Facts for each Region",
#   template_create_dir = TRUE
# )
#' Generate all country factsheet 
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Bureau that covers all the countrie factsheet to generate
#' @param lag Number of year to used as comparison base
#' 
#' @param folder folder within your project where to put the generated report. 
#' Folder will be created if it does not exist
#' 
#' @importFrom unhcrdown pptx_slides
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' 
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'

template_RegPrez <- function(year = 2022,
                             region = "Americas",
                             lag = 10,
                             folder = "Report") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  regionname <- dplyr::case_when( region == "Americas"  ~  "Americas",
                                  region == "Asia"  ~  "Asia & the Pacific",
                                  region == "EastAfrica"  ~  "Eastern Africa",
                                  region =="Europe"  ~  "Europe",
                                  region == "MENA"  ~  "Middle East & North Africa",
                                  region == "SouthAfrica"  ~  "Southern Africa",
                                  region == "WestAfrica"  ~  "Western Africa")
  rmarkdown::render(
    system.file("rmarkdown/templates/regional_prez/skeleton/skeleton.Rmd", package = "unhcrdatapackage"),
    output_file = here::here(folder, paste0('StatFactsheet-', region, '-', year, '.pptx') ),
    params = list(region=region, 
                  regionname = regionname,
                  year = year,
                  lag = lag)  )
 
}

```

```{r example-template_RegPrez}
# template_RegPrez(year = 2022, region = "Americas", lag = 10,   folder = "Report")

# # Generate for a specific region
# region <- "Americas"
# year <- 2022
# library(tidyverse)
# ## get all countries with more than 1000 Reported individuals
# ctr <- dplyr::left_join( x= ForcedDisplacementStat::end_year_population_totals_long,
#                                 y= ForcedDisplacementStat::reference,
#                                 by = c("CountryAsylumCode" = "iso_3")) |>
#         filter(Year == year &
#                 UNHCRBureau == region ) |>
#         group_by( CountryAsylumName, CountryAsylumCode   ) |>
#         summarise(Value = sum(Value) ) |>
#         ungroup() |>
#         filter( Value  > 1000 )
# 
#   for ( i in (1:nrow(ctr))) {
#     # i <- 1
#     country_asylum_iso3c = as.character(ctr[i ,2 ])
#     cat(paste0(country_asylum_iso3c, "\n"))
#     unhcrdatapackage::template_CtryPrez(year = 2022, 
#                                   country_asylum_iso3c = country_asylum_iso3c,  
#                                   folder = "Report")
#   }
```



# Refresh package

```{r development-inflate, eval=FALSE}
# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_full.Rmd", vignette_name = "Chart Library", overwrite = 'yes')
pkgdown::build_site()
```

