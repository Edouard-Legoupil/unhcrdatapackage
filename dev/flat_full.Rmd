---
title: "All Plotting functions"
output: html_document
editor_options: 
  chunk_output_type: console
---

<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->

```{r development, include=FALSE}
knitr::opts_chunk$set(
                      comment = "#>",
                      message=FALSE, 
                      warning=FALSE,
                      fig.retina = 2, 
                      fig.width = 8,
                      fig.asp = 0.618,
                      fig.align = "center",
                      dev = "ragg_png",
                      out.width = "90%"
)

library(testthat)
library(ggplot2)
library(unhcrthemes)
# library(extrafont) 
# font_import()
# loadfonts()
# font_install('fontcm')
```

<!--
 You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.

If it is the first time you use {fusen}, after 'description', you can directly run the last chunk of the present file with inflate() inside.
--> 

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```


<!-- 
 Store your dataset in a directory named "inst/" at the root of your project.
 Use it for your tests in this Rmd thanks to `pkgload::load_all()` to make it available
and `system.file()` to read it in your examples.

- There already is a dataset in the "inst/" directory to be used in the examples below
-->

```{r development-dataset}
# Run all this chunk in the console directly
# There already is a dataset in the "inst/" directory
# Make the dataset file available to the current Rmd during development
pkgload::load_all(path = here::here(), export_all = FALSE)

```



# Country Questions

## Plot Population type per year

<!--
Create a chunk for the core of the function

- The chunk needs to be named `function` at least
- It contains the code of a documented function
- The chunk can also be named `function-my_median` to make it easily
findable in your Rmd
- Let the `@examples` part empty, and use the next `examples` chunk instead to present reproducible examples

After inflating the template

-  This function code will automatically be added in a new file in the "R/" directory
-->

```{r function-plot_ctr_population_type_per_year}
#' Graph of population type per year
#'
#' @param start_year Numeric value of first year  
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#'
#' @return
#' Population type per year graph
#' @export
#'
#'

plot_ctr_population_type_per_year <- function(start_year = 2015,
                                     country_asylum_iso3c = country_asylum_iso3c,
                                     pop_type = Population.type
                                     ) {
  
  require(ggplot2)
  require(tidyverse)
  cols_poptype <- c("Asylum-seekers" = "#18375F",
                    "Refugees" = "#0072BC",
                    "Venezuelans Displaced Abroad" = "#EF4A60", 
                    "Others of Concern to UNHCR" = "#999999",
                    "Internally Displaced Persons" = "#00B398",
                    "Stateless Persons" = "#E1CC0D")
  
  
  df <- unhcrdatapackage::end_year_population_totals_long  |> 
    dplyr::filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  Year >= start_year,  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c, #### Parameter
                  Population.type %in% pop_type #### Parameter
    )  |>  
    dplyr::group_by(Year, CountryAsylumName, Population.type.label)  |> 
    dplyr::summarise(Value = sum(Value, na.rm = TRUE)) |> 
    dplyr::ungroup()
  
  CountryAsylum_name_text <- df |> 
    dplyr::distinct(CountryAsylumName) |> 
    dplyr::pull()
  
  year_breaks <- diff(range(df$Year)) + 1 
  
  p <- ggplot(df) +
    geom_col(aes(x = Year, y = Value, fill = Population.type.label),
             width = 0.7) +
    geom_text(aes(x = Year, 
                  y = Value, 
                  color = Population.type.label, 
                  label = scales::label_number_si(accuracy = 1)(Value)),
              position = position_stack(vjust = 0.5),
              show.legend = FALSE,
              size = 5) +
    scale_color_manual(values = c("#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF",
                                  "#FFFFFF")) +
    scale_fill_manual(values = cols_poptype,
                      drop = TRUE,
                      limits = force) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = year_breaks)) +
    scale_y_continuous(expand = expansion(c(0, 0.1))) +
    labs(title = paste0(CountryAsylum_name_text, ": Population type per year"), 
         subtitle = "Number of people (thousand)",
         caption = "Source: UNHCR Refugee Data Finder") +
    unhcrthemes::theme_unhcr(grid = FALSE, axis = "x",
                             axis_title = FALSE, axis_text = "x") +
    stat_summary(fun = sum, aes(x = Year, y = Value, label = scales::label_number_si(accuracy = 1)(..y..), group = Year), 
                 geom = "text", size = 5,
                 vjust = -0.5) +
    theme(legend.direction = "vertical",
          legend.key.size = unit(0.8, 'cm'),
          text = element_text(size = 20),
          plot.subtitle=element_text(size=19),
          plot.title = element_text(size=23),
          plot.caption = element_text(size=13))
  
  print(p)
  }
```

<!--
Create a chunk with an example of use for your function

- The chunk needs to be named `examples` at least
- It contains working examples of your function
- The chunk is better be named `examples-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This example will automatically be added in the '@examples' part of our function above in the "R/" directory
- This example will automatically be added in the vignette created from this Rmd template
-->

```{r examples-plot_ctr_population_type_per_year, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}

plot_ctr_population_type_per_year(start_year = 2016,
                         country_asylum_iso3c = "PAN",
                          pop_type = c("REF", 
                                       "ASY", 
                                       "VDA", 
                                       "OOC",
                                       "STA",
                                       "IDP" )
                  )
```

<!--
Create a chunk with a test of use for your function

- The chunk needs to be named `tests` at least
- It contains working tests of your function
- The chunk is better be named `tests-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This test code will automatically be added in the "tests/testthat/" directory
-->

```{r tests-plot_ctr_population_type_per_year}


```



## Plot Main country of origin - Absolute value


```{r function-plot_ctr_population_type_abs}
#' Main country of origin - Absolute value
#'
#' @param year Numeric value of the year (eg.: 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @return
#' Main country of origin - Absolute value Graph
#' @export
#'

plot_ctr_population_type_abs <- function(year = 2021,
                                country_asylum_iso3c = country_asylum_iso3c,
                                top_n_countries = 9,
                                pop_type = "REF"
                              ) {
  require(ggplot2)
  require(tidyverse)
  cols_poptype <- list(ASY = c("Asylum-seekers", "#18375F"),
                       REF = c("Refugees", "#0072BC"),
                       VDA = c("Venezuelans Displaced Abroad", "#EF4A60"), 
                       OOC = c("Others of Concern to UNHCR", "#999999"),
                       IDP = c("Internally Displaced Persons", "#00B398"),
                       STA = c("Stateless Persons", "#E1CC0D")
  )
  
  
  df <-  
    unhcrdatapackage::end_year_population_totals  |> 
    dplyr::filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  Year == year,  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c, #### Parameter
    )  |>  
    dplyr::select(CountryAsylumName, CountryOriginName,!!sym( pop_type )) |>
    dplyr::group_by(CountryAsylumName, CountryOriginName) |>
    dplyr::filter(!!sym(pop_type) != 0) |>
    dplyr::mutate(pop_type_value = sum(!!sym(pop_type), na.rm=TRUE)) |> 
    dplyr::ungroup() |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = CountryOriginName,
        n = top_n_countries,  #### Parameter
        w = pop_type_value,
        other_level = 'Other nationalities',
        ties.method = "last"
      )
    ) |>
    dplyr::mutate(origin_data_prot = forcats::fct_explicit_na(origin_data_prot,
                                                              'Other nationalities')) |>
    dplyr::group_by(CountryAsylumName,origin_data_prot) |>
    dplyr::summarise(pop_type_value = sum(pop_type_value, na.rm = TRUE)) |>
    dplyr::ungroup() |> 
    dplyr::arrange(desc(pop_type_value)) |>
    dplyr::filter(pop_type_value != 0L) |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(origin_data_prot)),
      origin_data_prot =  suppressWarnings(
        dplyr::case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(origin_data_prot,
                                                                           "Other nationalities",
                                                                           after = 0),
          TRUE ~ origin_data_prot
        )
      ),
      perc = scales::percent(
        pop_type_value / sum(pop_type_value),
        accuracy = 1,
        trim = FALSE
      )
    )
  
  CountryAsylum_name_text <- df |> 
    dplyr::distinct(CountryAsylumName) |> 
    dplyr::pull()



p <- 
  ggplot(df) +
  geom_col(aes(x = pop_type_value, y = origin_data_prot),
           fill = cols_poptype[[pop_type]][2],
           width = 0.8) +
  ## Position label differently in the bar in white - outside bar in black
  geom_text(
    data = subset(df, pop_type_value < max(pop_type_value) / 1.5),
    aes(
      x = pop_type_value,
      y = origin_data_prot,
      label = scales::label_number(accuracy = 1,
                                   scale_cut = scales::cut_short_scale())(pop_type_value)
    ),
    hjust = -0.1 ,
    vjust = 0.5,
    colour = "black",
    size = 5
  ) +
  geom_text(
    data = subset(df, pop_type_value >= max(pop_type_value) / 1.5),
    aes(
      x = pop_type_value,
      y = origin_data_prot,
      label = scales::label_number(accuracy = 1,
                                   scale_cut = scales::cut_short_scale())(pop_type_value)
    ),
    hjust = 1.1 ,
    vjust = 0.5,
    colour = "white",
    size = 5
  ) +
  labs(title = paste0(CountryAsylum_name_text, ": Main Countries of origin (", cols_poptype[[pop_type]][1], ")", " | ",  year),
       subtitle = "Number of people",
       caption = "Source: UNHCR Refugee Data Finder\n© UNHCR, The UN Refugee Agency") +
  scale_x_continuous(expand = expansion(c(0, 0.1))) +
  unhcrthemes::theme_unhcr(grid = FALSE, axis = "y", axis_title = FALSE, axis_text = "y") +
  theme(legend.direction = "vertical",
        legend.key.size = unit(0.8, 'cm'),
        text = element_text(size = 20),
        plot.subtitle=element_text(size=19),
        plot.title = element_text(size=23),
        plot.caption = element_text(size=13))
  print(p)
  }
```

```{r examples-plot_ctr_population_type_abs, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
plot_ctr_population_type_abs(year = 2020,
                    country_asylum_iso3c = "USA",
                    top_n_countries = 4,
                    pop_type = "REF"
                    ) 

## Same with 9 top countries and asylum seekers included
plot_ctr_population_type_abs(year = 2020,
                    country_asylum_iso3c = "USA",
                    top_n_countries = 9,
                    pop_type = "REF"
                    ) 

```

```{r tests-plot_ctr_population_type_abs}

```



## Plot Main country of origin - Percentage


```{r function-plot_ctr_population_type_perc}
#' Main country of origin - Percentage
#'
#' @param year Numeric value of the year (eg.: 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @return
#' Main country of origin - Percentage Graph
#' @export
#'

plot_ctr_population_type_perc <- function(year = 2021,
                                country_asylum_iso3c = country_asylum_iso3c,
                                top_n_countries = 9,
                                pop_type = "REF"
                              ) {
    require(ggplot2)
  require(tidyverse)
  cols_poptype <- list(ASY = c("Asylum-seekers", "#18375F"),
                       REF = c("Refugees", "#0072BC"),
                       VDA = c("Venezuelans Displaced Abroad", "#EF4A60"), 
                       OOC = c("Others of Concern to UNHCR", "#999999"),
                       IDP = c("Internally Displaced Persons", "#00B398"),
                       STA = c("Stateless Persons", "#E1CC0D")
  )
  
  
  df <-  
    unhcrdatapackage::end_year_population_totals  |> 
    dplyr::filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  Year == year,  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c, #### Parameter
    )  |>  
    dplyr::select(CountryAsylumName, CountryOriginName,!!sym(pop_type)) |>
    dplyr::group_by(CountryAsylumName, CountryOriginName) |>
    dplyr::filter(!!sym(pop_type) != 0) |>
    dplyr::mutate(pop_type_value = sum(!!sym(pop_type), na.rm=TRUE)) |> 
    dplyr::ungroup() |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = CountryOriginName,
        n = top_n_countries,  #### Parameter
        w = pop_type_value,
        other_level = 'Other nationalities',
        ties.method = "last"
      )
    ) |>
    dplyr::mutate(origin_data_prot = forcats::fct_explicit_na(origin_data_prot,
                                                              'Other nationalities')) |>
    dplyr::group_by(CountryAsylumName,origin_data_prot) |>
    dplyr::summarise(pop_type_value = sum(pop_type_value, na.rm = TRUE)) |>
    dplyr::ungroup() |> 
    dplyr::arrange(desc(pop_type_value)) |>
    dplyr::filter(pop_type_value != 0L) |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(origin_data_prot)),
      origin_data_prot =  suppressWarnings(
        dplyr::case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(origin_data_prot,
                                                                           "Other nationalities",
                                                                           after = 0),
          TRUE ~ origin_data_prot
        )
      ),
      perc = scales::percent(
        pop_type_value / sum(pop_type_value),
        accuracy = 1,
        trim = FALSE
      )
    )
  
  CountryAsylum_name_text <- df |> 
    dplyr::distinct(CountryAsylumName) |> 
    dplyr::pull()



p <- 
  ggplot(df) +
  geom_col(aes(x = pop_type_value, y = origin_data_prot),
           fill = cols_poptype[[pop_type]][2],
           width = 0.8) +
  ## Position label differently in the bar in white - outside bar in black
  geom_text(
    data = subset(df, pop_type_value < max(pop_type_value) / 1.5),
    aes(
      x = pop_type_value,
      y = origin_data_prot,
      label = perc
    ),
    hjust = -0.1 ,
    vjust = 0.5,
    colour = "black",
    size = 5
  ) +
  geom_text(
    data = subset(df, pop_type_value >= max(pop_type_value) / 1.5),
    aes(
      x = pop_type_value,
      y = origin_data_prot,
      label = perc
    ),
    hjust = 1.1 ,
    vjust = 0.5,
    colour = "white",
    size = 5
  ) +
  labs(title = paste0(CountryAsylum_name_text, ": Main Countries of origin (", cols_poptype[[pop_type]][1], ")", " | ",  year),
       subtitle = "Percentage",
       caption = "Source: UNHCR Refugee Data Finder\n© UNHCR, The UN Refugee Agency") +
  scale_x_continuous(expand = expansion(c(0, 0.1))) +
  unhcrthemes::theme_unhcr(grid = FALSE, axis = "y", axis_title = FALSE, axis_text = "y") +
  theme(legend.direction = "vertical",
        legend.key.size = unit(0.8, 'cm'),
        text = element_text(size = 20),
        plot.subtitle=element_text(size=19),
        plot.title = element_text(size=23),
        plot.caption = element_text(size=13))
  print(p)
  }
```

```{r examples-plot_ctr_population_type_perc, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}

plot_ctr_population_type_perc(year = 2021,
                    country_asylum_iso3c = "BRA",
                    top_n_countries = 9,
                    pop_type = "REF"  ) 
```

```{r tests-plot_ctr_population_type_perc}

```


## Plot Increases and Decreases in Population Groups


```{r function-plot_ctr_diff_in_pop_groups}
#' Increases and Decreases in Population Groups
#'
#' @param year Numeric value of the year (eg.: 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @return
#' Increases and Decreases in Population Groups Graph
#' @export
#'

plot_ctr_diff_in_pop_groups <- function(year = 2021,
                     country_asylum_iso3c = country_asylum_iso3c,
                     pop_type = pop_type
) {
    require(ggplot2)
  require(tidyverse)
  diff_perc <- function(x){
    x = as.numeric((x - dplyr::lag(x))/dplyr::lag(x)) + 0
    
  }
  
  
  df <- unhcrdatapackage::end_year_population_totals  |> 
    dplyr::filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  (Year == year-1 | Year == year),  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c #### Parameter
    ) |> 
    dplyr::group_by(Year, CountryAsylumName) |> 
    dplyr::summarise(dplyr::across(where(is.numeric), sum)) |> 
    dplyr::ungroup() |> 
    dplyr::arrange(Year) |> 
    dplyr::select(-c(Year)) |> 
    dplyr::group_by(CountryAsylumName) |> 
    dplyr::summarise(dplyr::across(where(is.numeric), 
                                   list(diffabs = diff,
                                        diffperc = diff_perc),
                                   .names = "{.col}_{.fn}")) |> 
    dplyr::ungroup() |> 
    dplyr::slice(2) 
  
  df <- replace(df, is.na(df), 0)
  
  df <- df |> 
    tidyr::gather(v, value, REF_diffabs:VDA_diffperc) |> 
    tidyr::separate(v, c("pop_type", "value_type"), sep = "\\_") |> 
    tidyr::spread(key = value_type, value = value) |> 
    dplyr::mutate(diffper =scales::percent(
      diffperc,
      accuracy = 1,
      trim = FALSE
    ))
  
  
  p <- df |> 
    dplyr::filter(pop_type %in% pop_type) |>
    ggplot() +
    geom_col(aes(x = pop_type, 
                 y = diffabs,
                 fill = pop_type),
             width = 0.8) +
    scale_fill_manual(
      values = c("ASY" = "#18375F",
                 "REF" = "#0072BC",
                 "VDA" = "#EF4A60", 
                 "OOC" = "#999999",
                 "IDP" = "#00B398",
                 "STA" = "#E1CC0D"),
      drop= TRUE,
      limits = force,
      guide="none"
    ) +
    scale_x_discrete(labels= c("ASY" = "Asylum-seekers",
                               "REF" = "Refugees",
                               "VDA" = "Venezuelans Displaced\nAbroad", 
                               "OOC" = "Others of Concern\nto UNHCR",
                               "IDP" = "Internally Displaced\nPersons",
                               "STA" = "Stateless Persons"),
                     drop = TRUE,
                     limits = force) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = scales::label_number(accuracy = 1,
                                     scale_cut = scales::cut_short_scale())(diffabs)
      ),
      vjust = -0.5 ,
      colour = "black",
      size = 5
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = diffper
      ),
      vjust = -2.0 ,
      colour = "black",
      size = 5
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = scales::label_number(accuracy = 1,
                                     scale_cut = scales::cut_short_scale())(diffabs)
      ),
      vjust = 2.7 ,
      colour = "white",
      size = 5
    ) + 
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = diffper
      ),
      vjust = 1.2 ,
      colour = "white",
      size = 5
    ) + #################################
  # geom_text(
  #   data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #   aes(
  #     x = pop_type,
  #     y = diffabs,
  #     label = scales::label_number(accuracy = 1,
  #                                  scale_cut = scales::cut_short_scale())(diffabs)
  #   ),
  #   vjust = -2.0 ,
  #   colour = "white",
  #   size = 5
  # )  +
  #   geom_text(
  #     data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #     aes(
  #       x = pop_type,
  #       y = diffabs,
  #       label = diffper
  #     ),
  #     vjust = -0.5 ,
  #     colour = "white",
  #     size = 5
  #   ) +
  geom_text(
    data = subset(df, diffabs < 0/ 1.5),
    aes(
      x = pop_type,
      y = diffabs,
      label = scales::label_number(accuracy = 1,
                                   scale_cut = scales::cut_short_scale())(diffabs)
    ),
    vjust =  1.2,
    colour = "black",
    size = 5
  ) + 
    geom_text(
      data = subset(df, diffabs < 0  / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = diffper
      ),
      vjust = 2.7,
      colour = "black",
      size = 5
    ) +
    geom_hline(yintercept = 0, color = "black") +
    labs(title = paste0(df |> 
                          dplyr::distinct(CountryAsylumName) |> 
                          dplyr::pull(), 
                        ": Increases and Decreases in Population Groups | ",
                        year-1,
                        "-",
                        year),
         subtitle = "Number of people and percentage",
         caption = "Source: UNHCR Refugee Data Finder\n© UNHCR, The UN Refugee Agency")  + 
    unhcrthemes::theme_unhcr(grid = FALSE, axis = "x", axis_title = FALSE, axis_text = "x") +
    theme(axis.line.x = element_line(color="white"),
          axis.text.x = element_text(size=10))
  
  print(p)
}
```

```{r examples-plot_ctr_diff_in_pop_groups, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_diff_in_pop_groups(year = 2021,
                            country_asylum_iso3c = "USA",
                            pop_type = c("REF", "ASY")
         )

```

```{r tests-plot_ctr_diff_in_pop_groups}

```



## Top Refugee hosting Countries


```{r function-plot_ctr_destination}
#' Tree map of Population Groups within a country
#'
#' @param year Numeric value of the year (eg.: 2020)
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @return
#' Increases and Decreases in Population Groups Graph
#' @export
#'

plot_ctr_destination <- function(year = 2021,
                                 country_origin_iso3c = country_origin_iso3c,
                                  pop_type = pop_type) {
  require(ggplot2)
  require(tidyverse)
  
  
Destination <- dplyr::left_join( x= unhcrdatapackage::end_year_population_totals_long, 
                                                     y= unhcrdatapackage::reference, 
                                                     by = c("CountryAsylumCode" = "iso_3"))  |>
  dplyr::filter(CountryOriginCode  == country_origin_iso3c  & 
                 Year == year &
                Population.type  %in% as.vector(pop_type)  )  |>  
   dplyr::mutate(CountryAsylumName = str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
         CountryAsylumName = str_replace(CountryAsylumName, "Iran \\(Islamic Republic of\\)", "Iran"),
         CountryAsylumName = str_replace(CountryAsylumName, "United States of America", "USA"),
         CountryAsylumName = str_replace(CountryAsylumName, "United Kingdom of Great Britain and Northern Ireland", "UK")) |> 
   
   dplyr::group_by( CountryAsylumName) |>
   dplyr::summarise(DisplacedAcrossBorders = sum(Value) )  |>
   dplyr::mutate( DisplacedAcrossBordersRound =  ifelse(DisplacedAcrossBorders > 1000, 
                            paste(scales::label_number_si(accuracy = 0.1)(DisplacedAcrossBorders)),
                            as.character(DisplacedAcrossBorders) ) ) |>
   dplyr::arrange(desc(DisplacedAcrossBorders)) |>
   head(10) |>
   dplyr::filter(DisplacedAcrossBorders >0)

if( nrow(Destination) ==  0 ){
  cat(paste0("There's no recorded countries of destination for ",country_origin_iso3c ))
  
} else {


#Make plot
ggplot(Destination, aes(x = reorder(CountryAsylumName, DisplacedAcrossBorders), ## Reordering country by Value
                           y = DisplacedAcrossBorders)) +
  geom_bar(stat = "identity", 
           position = "identity", 
           fill = "#0072bc") + # here we configure that it will be bar chart+
## Format axis number
  scale_y_continuous( label = scales::label_number_si()) + 
  
  ## Position label differently in the bar in white - outside bar in black
  geom_label( data = subset(Destination, DisplacedAcrossBorders < max(DisplacedAcrossBorders) / 1.5),
              aes(x = reorder(CountryAsylumName, DisplacedAcrossBorders), 
                  y = DisplacedAcrossBorders,
                  label= DisplacedAcrossBordersRound),
              hjust = -0.1 ,
              vjust = 0.5, 
              colour = "black", 
              fill = NA, 
              label.size = NA, 
              #family = "Lato", 
              size = 4   ) +  

  geom_label( data = subset(Destination, DisplacedAcrossBorders >= max(DisplacedAcrossBorders) / 1.5),
              aes(x = reorder(CountryAsylumName, DisplacedAcrossBorders), 
                  y = DisplacedAcrossBorders,
                  label= DisplacedAcrossBordersRound),
              hjust = 1.1 ,
              vjust = 0.5, 
              colour = "white", 
              fill = NA, 
              label.size = NA, 
              # family = "Lato", 
              size = 4   ) +   
  # Add `coord_flip()` to make your vertical bars horizontal:
  coord_flip() + 
  
  ## and the chart labels
  labs(title = paste0("What are the main destinations for Forcibly Displaced People?" ),
       
       subtitle = paste0("Top Destination Countries - Data as of ",year, " for population from ",country_origin_iso3c ), 
       x = "",
       y = "",
       caption = "Data: UNHCR Refugee Population Statistics Database; Visualisation: UnhcrDataPackage.\n Forced Displacement includes Refugees, Asylym Seekers and Venezuelan Displaced Abroad Population Group.") +
    
  # Style  
  geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
  unhcRstyle::unhcr_theme(base_size = 12)  + ## Insert UNHCR Style
  theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
        panel.grid.major.y = element_blank()) ### changing grid line that should appear
  
  }
}

```

```{r examples-plot_ctr_destination, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_destination(year = 2021,
                     country_origin_iso3c = "COL",
                     pop_type = c("REF", "ASY")
         )

```
    
## Tree Map of Categories

```{r function-plot_ctr_treemap}
#' Tree map of Population Groups within a country
#'
#' @param year Numeric value of the year (eg.: 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @return
#' Treemap with share of different groups
#' @export
#'

plot_ctr_treemap <- function(year = 2021,
                     country_asylum_iso3c = country_asylum_iso3c,
                     pop_type = pop_type) {
  require(ggplot2)
  require(tidyverse)

  datatree <-  unhcrdatapackage::end_year_population_totals_long  |> 
    dplyr::filter(Year == year,  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c #### Parameter
    ) |> 
    dplyr::select(-c(Year)) |> 
    dplyr::group_by(CountryAsylumName,  Population.type, 
                    Population.type.label, Population.type.label.short) |> 
    dplyr::summarise(dplyr::across(where(is.numeric), sum)) |> 
    dplyr::ungroup() 
  
  treemap <- ggplot(datatree, 
       aes(area = Value, 
           fill = Population.type,
           label = paste0(round(100*Value/sum(Value),1), 
                          "%\n", 
                          Population.type.label))) +
         treemapify::geom_treemap() +
         treemapify::geom_treemap_text(colour = "white",
                           place = "centre", size = 25) +
         scale_fill_manual( values = c(   "IDP" = "#00B398",
                                          "VDA"="#EF4A60",
                                          "ASY" = "#18375F",
                                          "REF" = "#0072BC",
                                          "OOC" ="#8395b9",
                                          "STA"="#E1CC0D")) +
         
       unhcrthemes::theme_unhcr(font_size = 12,
                           grid = "Y",
                           axis = "x", 
                           axis_title = "y", 
                           legend = FALSE) +
         theme(legend.position = "none") +
         ## and the chart labels
         labs(title = paste0("Population of Concern in ", country_asylum_iso3c),
              subtitle = paste0("As of ", year, ", a total of ", format(round(sum(datatree$Value), -3),  big.mark=","), " Individuals"),
              x = "",
              y = "",
              caption = "Source: UNHCR.org/refugee-statistics  ")  

print(treemap)
}

```
    
```{r examples-plot_ctr_treemap, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_treemap(year = 2021,
                            country_asylum_iso3c = "USA",
                            pop_type = c("REF", "ASY")
         )

```    
    


## Refugees Age Pyramid

```{r function-plot_ctr_pyramid}
#' Population Pyramid
#'
#' @param year Numeric value of the year (eg.: 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @return
#' Pyramid Chart
#' @export
#'

plot_ctr_pyramid <- function(year = 2021,
                     country_asylum_iso3c = country_asylum_iso3c,
                     pop_type = pop_type) {
  require(ggplot2)
  require(tidyverse)
  
  demographics1 <- unhcrdatapackage::demographics |>
                   dplyr::left_join( unhcrdatapackage::reference |> 
                                       select(UNHCRBureau, iso_3),  
                                     by = c("CountryAsylumCode" = "iso_3")) |> 
                   dplyr::filter(CountryAsylumCode  == country_asylum_iso3c &
                               Year == year-1 &
                               Population.type  %in% as.vector(pop_type) ) |>
    
                    dplyr::mutate ( totGen = FemaleTotal +MaleTotal,
                               totbreak = Female04 + Female511 + Female1217 + 
                                          Female1859 + Female60ormore + FemaleUnknown +
                                          Male04 + Male511 + Male1217 + Male1859 +
                                          Male60ormore + MaleUnknown,
                               
                               hasbreak = ifelse(Total - totGen == 0, "yes", "no" ))



if( nrow(demographics1) ==  0 ){
  cat(paste0("There's no recorded Gender disaggregation for Forcibly Displaced People across Borders in ",country_asylum_iso3c  ))
  
} else {

  tot <- format( sum(demographics1$Total) ,  big.mark=",")
  totprop <-   format( round( sum(demographics1$totGen) / 
      sum(demographics1$Total )  *100,1),  big.mark=",")  
  
  if (totprop == 0 ) {
    cat(paste0("There's no recorded Gender disaggregation for all of the ",tot, " persons in", country_asylum_iso3c  ))
    
  } else {
    #names(demographics)
    pyramid <-  demographics1[ demographics1$Year == max(demographics1$Year),
                              c(
                                  "Female04",
                                  "Female511",
                                  "Female1217",
                                  "Female1859",
                                  "Female60ormore",
                                  "FemaleUnknown",
                                 # "FemaleTotal",
                                  "Male04",
                                  "Male511",
                                  "Male1217",
                                  "Male1859",
                                  "Male60ormore",
                                  "MaleUnknown"#,
                                 # "MaleTotal"       
                                 )]  
    
    pyramid2 <- data.frame(lapply(pyramid, function(x) { as.numeric( gsub("NA", "0", x)) })) |>
      pivot_longer(
        cols = Female04:MaleUnknown,
        names_to = "Class",
        values_to = "Sum",
        values_drop_na = TRUE
      ) 
    
    pyramid3 <- as.data.frame(aggregate(pyramid2$Sum,
                                              by = list(pyramid2$Class#, pyramid2$REGION_UN
                                                        ),
                                              sum))
    names(pyramid3)[1] <- "Class"
    names(pyramid3)[2] <- "Count"
    
    pyramid3 <- pyramid3 |> 
      mutate(gender = case_when(str_detect(Class, "Male") ~ "Male",
                                str_detect(Class, "Female") ~ "Female")) |> 
      mutate(age = case_when(str_detect(Class, "04") ~ "0-4",
                             str_detect(Class, "511") ~ "5-11",
                             str_detect(Class, "1217") ~ "12-17",
                             str_detect(Class, "1859") ~ "18-59",
                             str_detect(Class, "60") ~ "60+",
                             str_detect(Class, "Unknown") ~ "Unknown")) 
    
    pyramid3$pc <- pyramid3$Count / sum(pyramid3$Count) * 100
    pyramid3$age <- factor(pyramid3$age, levels = c("0-4", "5-11",  "12-17",  "18-59", "60+", "Unknown"))
    
    pyramidplot <- ggplot(pyramid3, aes(x = age, 
                         fill = gender,
                          y = ifelse(test = gender == "Female",
                                yes = -pc, no = pc)) ) + 
      geom_bar(stat = "identity") +
      geom_label(aes(x = age,
                     y = ifelse(test = gender == "Female",
                                yes = -pc -5 , no = pc),
                    label =  paste0(format(round(pc, 1),  big.mark=","),"%") 
                    ),
                 hjust = 0,
                 vjust = 0.5,
                 colour = "black",
                 fill = NA,
                 label.size = NA,
                # family = "Lato",
                 size = 4) +
      scale_y_continuous(labels = abs, limits = max(pyramid3$pc) * c(-1,1)) +
      labs(title = paste0("Population Pyramid for Forcibly Displaced People" ),
           
           subtitle = paste0("As of ", year, 
                             ", gender disaggregation is available for ", totprop, " % of the ",tot,
                             " individuals in", country_asylum_iso3c),
           x = "", 
           y = "Percent of population",
           caption =  "Data: UNHCR Refugee Population Statistics Database; Visualisation: UnhcrDataPackage.\n Forced Displacement includes Refugees, Asylym Seekers and Venezuelan Displaced Abroad Population Groups.") +
      scale_colour_manual(values = c("#126db4","#01ab91"), # based on Asia Report
                          aesthetics = c("colour", "fill")) +
      coord_flip()+
      unhcRstyle::unhcr_theme(base_size = 12) +
       theme(panel.grid.major.x = element_line(color = "#cbcbcb"), 
                panel.grid.major.y = element_blank())
    
    print(pyramidplot)
 }
 }
}
```

    
```{r examples-plot_ctr_pyramid, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
# 
plot_ctr_pyramid(year = 2021,
                            country_asylum_iso3c = "VEN",
                            pop_type = c("REF", "ASY")
         )

``` 

 

## Asylum Processing
    Asylum_processing  
    
## Refugee Recognition rate
    Refugee_Recognition_rate 
    
## Refugee Status Determination Application
    Refugee_Status_Determination_Application   
    
## Refugees accessing durable solutions
    Refugee_accessing_durable_solution    

## Solution Evolution
    Solution_evolution    

## Resettlement Trend
    Resettlement_trend    

## Population origin-destination
    Origin_Destination    
    
## Proportion of the population who are refugees, by country of origin
    Proportion_Refugee_Country_Origin  
    
## Ratio Refugee / Host population
    Ratio_Refugee_Host_population  
    
## Ratio Refugee Migrant
    Migrant_and_Forcible_Displacement 
    
    
--- 

# Regional Questions

## Biggest decrease in Refugee Population
    Biggest_decrease_in_Refugee_Population 
    
## Biggest increase in Refugee Population
    Biggest_increase_in_Refugee_Population 
    
## Comparison over time by Region
    Comparison over_time_by_Region    
    
## Evolution over time of the different Population of Concern
    Evolution_Category    
    
## Evolution by Country of Origin
    Evolution_by_Country_of_Origin 
    
## Refugee Over time
    Refugee_Over_time    
    
## Smootheed Evolution over time
    Smootheed_Evolution_over_time  
    
## Mapping Refugee Location
    Mapping_Refugee_Location   
    
## Mapping IDP Location
    Mapping_IDP_Location    
    
## Map Venezuelan
    Map_Venezuelan    
    
## Refugee Chart Race
    Refugees_Chart_Race


--- 

# Template
```{r}
# usethis::use_rmarkdown_template(
#   template_name = "Country_Factsheet",
#   template_dir = NULL,
#   template_description = "Key Statistical Facts for each Country",
#   template_create_dir = TRUE
# )

```



<!--
# There can be development actions

Create a chunk with 'development' actions

- The chunk needs to be named `development` or `dev`
- It contains functions that are used for package development only
- Note that you may want to store most of these functions in the 0-dev_history.Rmd file

These are only included in the present flat template file, their content will not be part of the package anywhere else.
-->

```{r development-inflate, eval=FALSE}
# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_full.Rmd", vignette_name = "Chart Library")
```

