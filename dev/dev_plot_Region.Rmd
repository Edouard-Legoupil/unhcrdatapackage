---
title: "All Plotting functions for Region"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  # fig.retina = 2,
  fig.width = 8,
  fig.asp = 0.718,
  # fig.align = "center",
  # dev = "ragg_png",
  out.width = "90%"
)
unlink(".RData")
library(testthat)
library(ggplot2)
library(tidyverse)
library(scales)
library(unhcrthemes)
# library(extrafont)
# font_import()
# loadfonts()
# font_install('fontcm')
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```



## Population group in the region  
    
```{r function-plot_reg_treemap}
#' Population group in the region
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom scales label_percent
#' @importFrom treemapify geom_treemap geom_treemap_text
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return plot a ggplot2 object
#'
#' @export

plot_reg_treemap <- function(year = 2022,
                             region = "The Americas",
                             pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")) {
  ## Comparison of Refugees
  ## Filter popdata for the country report

  datatree <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::group_by(year, unhcr_region, population_type_label, population_type) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(freq = scales::label_percent(accuracy = .1, suffix = "%")(value / sum(value))) |>
    dplyr::mutate(freqinReg = scales::label_percent(accuracy = .1, suffix = "%")(value / sum(value)))

  ## Treemapify
  p <- ggplot2::ggplot(
    datatree,
    ggplot2::aes(
      area = value,
      fill = population_type_label,
      label = paste0(freqinReg, "\n", population_type_label)
    )
  ) +
    treemapify::geom_treemap() +
    treemapify::geom_treemap_text(
      colour = "white",
      place = "centre", size = 15
    ) +
    # scale_fill_viridis_c() +
    ggplot2::scale_fill_manual(values = c(
      "IDP" = "#00B398",
      "OIP" = "#EF4A60",
      "ASY" = "#18375F",
      "REF" = "#0072BC",
      "OOC" = "#8395b9",
      "STA" = "#E1CC0D",
      "HCO" = "#1b9e77"
    )) +
    unhcrthemes::theme_unhcr(font_size = 22) + ## Insert UNHCR Style
    ggplot2::theme(legend.position = "none") +
    ## and the chart labels
    ggplot2::labs(
      title = paste0("Population of Concern & Affected Host Communities in ", region),
      subtitle = paste0("As of   ", year, ", a total of ", format(round(sum(datatree$value), -3), big.mark = ","), " Individuals"),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )

  return(p)
}
```
  
```{r example-plot_reg_treemap}
plot_reg_treemap(year = 2022, region = "The Americas")
```
  
```{r tests-plot_reg_treemap}
# test_that("plot_reg_treemap works", {   expect_true(inherits(plot_reg_treemap, "function")) })
```
  

## Plot World Comparison

    
```{r function-plot_reg_share}
#' A simple chart to compare a population group between the Region and the rest of the world
#'
#' Simple treemap charts to do the comparison
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom scales label_percent
#' @importFrom stringr str_wrap
#' @importFrom treemapify geom_treemap geom_treemap_text
#' @importFrom unhcrthemes theme_unhcr scale_fill_unhcr_d
#'
#' @return plot a ggplot2 object
#'
#' @export

plot_reg_share <- function(year = 2022,
                           region = "The Americas",
                           pop_type = "REF") {
  pop_typelabel <- dplyr::case_when(
    pop_type == "REF" ~ "Refugees",
    pop_type == "IDP" ~ "Internally displaced persons",
    pop_type == "ASY" ~ "Asylum seekers",
    pop_type == "OOC" ~ "Others of concern to UNHCR",
    pop_type == "STA" ~ "Stateless Persons",
    pop_type == "OIP" ~ "Other people in need of international protection",
    pop_type == "HCO" ~ "Host community"
  )


  datatree <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::mutate(Compare = ifelse(unhcr_region == region, region, "Rest of the World")) |>
    dplyr::group_by(year, Compare, population_type_label, population_type) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(freq = scales::label_percent(accuracy = .1, suffix = "%")(value / sum(value)))

  ## Treemapify
  p <- ggplot2::ggplot(
    datatree,
    ggplot2::aes(
      area = value,
      fill = Compare,
      label = paste0(format(round(datatree$value, -3), big.mark = ","), "\n in ", Compare)
    )
  ) +
    treemapify::geom_treemap() +
    treemapify::geom_treemap_text(
      colour = "white",
      place = "centre", size = 15
    ) +
    unhcrthemes::scale_fill_unhcr_d(palette = "pal_unhcr") +
    unhcrthemes::theme_unhcr(font_size = 12) + ## Insert UNHCR Style
    ggplot2::theme(legend.position = "none") +
    ## and the chart labels
    ggplot2::labs(
      title = paste0("Share of ", pop_typelabel, " within ", region),
      subtitle = stringr::str_wrap(paste0(
        "As of ", year,
        ", about ",
        datatree |> dplyr::filter(Compare == region) |> dplyr::select(freq) |> dplyr::pull(),
        " of that global population category are hosted in the region"
      ), 80),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )

  return(p)
}
```
  
```{r example-plot_reg_share}
plot_reg_share(
  year = 2022,
  region = "The Americas",
  pop_type = "REF"
)
plot_reg_share(
  year = 2022,
  region = "The Americas",
  pop_type = "ASY"
)
plot_reg_share(
  year = 2022,
  region = "The Americas",
  pop_type = "OIP"
)
plot_reg_share(
  year = 2022,
  region = "The Americas",
  pop_type = "IDP"
)
plot_reg_share(
  year = 2022,
  region = "The Americas",
  pop_type = "STA"
)
```
  
```{r tests-plot_reg_share}
# test_that("plot_reg_share works", {   expect_true(inherits(plot_reg_share, "function")) })
```
  

## Evolution Over Time  
    
```{r function-plot_reg_evolution}
#' Evolution over time 
#' 
#' Display evoluation over time for specific population group (one or many) and 
#' defined number of years (lag)
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param lag Number of year to used as comparison base 
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY,   OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual 
#'             geom_text geom_line
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace  
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#' 
#' @return a ggplot2 object
#' 
#' @export
plot_reg_population_type_per_year <- function(year = 2022,
                                              region = "The Americas",
                                              lag = 5,
                                              pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")) {

  # Check if pop_type is a list or a single character
  if (length(pop_type) > 1) {
    pop_type_label <- pop_type
  } else {
    pop_type_label <- pop_type
  }

  pop_type_label_dict <- c(
    "REF" = "Refugees",
    "ASY" = "Asylum-seekers",
    "IDP" = "Internally displaced persons",
    "OIP" = "Other people in need of international protection",
    "STA" = "Stateless people",
    "OOC" = "Others of concern to UNHCR",
    "HST" = "Host community"
  )

  df <- refugees::population |>
    dplyr::filter(year >= (!!year - lag) & year <= !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type_label = dplyr::case_when(
        population_type == "refugees" ~ "REF",
        population_type == "asylum_seekers" ~ "ASY",
        population_type == "idps" ~ "IDP",
        population_type == "oip" ~ "OIP",
        population_type == "stateless" ~ "STA",
        population_type == "ooc" ~ "OOC",
        population_type == "hst" ~ "HST",
        TRUE ~ "Other"
      )
    ) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::group_by(year, population_type_label) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(population_type_name = dplyr::recode(population_type_label, !!!pop_type_label_dict))

  p <- ggplot2::ggplot(df, ggplot2::aes(x = year, y = value, colour = population_type_label)) +
    ggplot2::geom_line(size = 1) +
    ggplot2::geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
    ggplot2::scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    ggplot2::xlim(c(year - lag, year + 1)) +
    unhcrthemes::scale_color_unhcr_d(palette = "pal_unhcr") +
    ggplot2::geom_label(
      data = df |> dplyr::filter(year == max(year)),
      ggplot2::aes(
        x = year + .5,
        y = value,
        label = population_type_name,
        color = population_type_label
      ),
      hjust = 0,
      vjust = 0.5,
      fill = "white",
      label.size = NA,
      family = "Lato",
      size = 4
    ) +
    unhcrthemes::theme_unhcr(
      grid = "Y",
      axis = "x",
      axis_title = "y",
      font_size = 14
    ) +
    ggplot2::theme(
      legend.position = "none",
      panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.x = ggplot2::element_blank(),
      panel.grid.minor = ggplot2::element_blank()
    ) +
    ggplot2::labs(
      title = paste0("Evolution of Population of Concern in ", region),
      subtitle = paste0("Evolution in the past ", lag, " years"),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )

  return(p)
}
```{r example-plot_reg_population_type_per_year}
plot_reg_population_type_per_year(
  year = 2022,
  lag = 5,
  region = "The Americas",
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")
)
```
  
```{r tests-plot_reg_population_type_per_year}
# test_that("plot_reg_population_type_per_year works", {   expect_true(inherits(plot_reg_population_type_per_year, "function")) })
```
  

## Plot Population Origin-Destination within the region 
    
```{r function-plot_reg_origin_dest}
#' Plot Population Origin-Destination within the region
#'
#' Chord diagram showing Origin destination see - https://jokergoo.github.io/circlize_book/book/
#'

#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join summarize
#'
#' @importFrom tidyr replace_na
#' @importFrom graphics title
#' @importFrom circlize chordDiagram circos.track circos.text CELL_META
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return plot a ggplot2 object
#'
#' @export
plot_reg_origin_dest <- function(year = 2022, region = "The Americas"){

  chords <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    dplyr::mutate(
      refugees = tidyr::replace_na(refugees, 0),
      asylum_seekers = tidyr::replace_na(asylum_seekers, 0),
      oip = tidyr::replace_na(oip, 0),
      total = refugees + asylum_seekers + oip
    ) |>
    dplyr::group_by(coo_name, coa_name) |>
    dplyr::summarise(total = sum(total, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(
      CountryAsylumName = forcats::fct_lump_prop(coa_name, prop = .02, w = total),
      CountryOriginName = forcats::fct_lump_prop(coo_name, prop = .02, w = total)
    ) |>
    dplyr::group_by(CountryOriginName, CountryAsylumName) |>
    dplyr::summarize(total = sum(total), .groups = "drop")  |>
    # CountryOriginName = fct_recode(CountryOriginName, "Other" = "China")
    dplyr::mutate(CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""),
                  CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
                  CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Plurinational State of\\)", ""),
                  CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Plurinational State of\\)", ""),
                  CountryOriginName = stringr::str_replace(CountryOriginName, "United States of America", "USA"),
                  CountryAsylumName = stringr::str_replace(CountryAsylumName, "United States of America", "USA"))

  circlize::chordDiagram(chords,
                         self.link = 1,
                         # grid.col = colorRampPalette(RColorBrewer::brewer.pal(11, "Paired"))(15),
                         annotationTrack = "grid" ,
                         # preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(chords))))),
                         preAllocateTracks = 1.6
  )

  circlize::circos.track(track.index = 1,
                         panel.fun = function(x, y) {
                           circlize::circos.text(circlize::CELL_META$xcenter,
                                                 circlize::CELL_META$ylim[1],
                                                 circlize::CELL_META$sector.index,
                                                 facing = "clockwise",
                                                 niceFacing = TRUE,
                                                 adj = c(0, 0.5))
                         },
                         bg.border = NA) # here set bg.border to NA is important


  graphics::title(main = "Movement of Forcibly Displaced Population",
        sub = paste0("In ", region, " as of ", year),
        cex.main = 1.5)


  return(invisible(NULL))


}
```
  
```{r example-plot_reg_origin_dest}
plot_reg_origin_dest(year = 2022, region = "Asia")
```
  
```{r tests-plot_reg_origin_dest}
# test_that("plot_reg_origin_dest works", {   expect_true(inherits(plot_reg_origin_dest, "function")) })
```
  


## Plot Main country of Asylum in the Region

```{r function-plot_reg_population_type_abs}
#' @export
plot_reg_population_type_abs <- function(year = 2022,
                                         region = "The Americas",
                                         top_n_countries = 5,
                                         pop_type = "REF",
                                         show_diff_label = TRUE) {

  pop_type_label_dict <- c(
    "REF" = "Refugees",
    "ASY" = "Asylum-seekers",
    "IDP" = "Internally displaced persons",
    "OIP" = "Other people in need of international protection",
    "STA" = "Stateless people",
    "OOC" = "Others of concern to UNHCR",
    "HST" = "Host community"
  )

  pop_type_col <- dplyr::case_when(
    pop_type == "REF" ~ "refugees",
    pop_type == "ASY" ~ "asylum_seekers",
    pop_type == "IDP" ~ "idps",
    pop_type == "OIP" ~ "oip",
    pop_type == "STA" ~ "stateless",
    pop_type == "OOC" ~ "ooc",
    pop_type == "HST" ~ "hst",
    TRUE ~ "refugees"
  )

  df <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    dplyr::select(coa_name, !!pop_type_col) |>
    dplyr::rename(value = !!pop_type_col) |>
    dplyr::group_by(coa_name) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE)) |>
    dplyr::arrange(dplyr::desc(value)) |>
    utils::head(top_n_countries)

  p <- ggplot2::ggplot(df, ggplot2::aes(x = stats::reorder(coa_name, value), y = value)) +
    ggplot2::geom_bar(stat = "identity", position = "identity", fill = "#0072bc") +
    ggplot2::geom_label(
      ggplot2::aes(
        x = coa_name,
        y = value,
        label = scales::label_number(scale_cut = scales::cut_short_scale())(value)
      ),
      hjust = 1,
      vjust = 0.5,
      colour = "white",
      fill = NA,
      label.size = NA,
      family = "Lato",
      size = 6
    ) +
    ggplot2::geom_hline(yintercept = 0, size = 1, colour = "#333333") +
    ggplot2::coord_flip() +
    ggplot2::labs(
      title = paste0("Top ", top_n_countries, " ", pop_type_label_dict[pop_type], " hosting countries"),
      subtitle = paste0("In ", region, " as of ", year),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ggplot2::scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    unhcrthemes::theme_unhcr(
      grid = "X",
      axis = "y",
      axis_title = "x",
      font_size = 14
    ) +
    ggplot2::theme(
      panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()
    )

  return(p)
}
```

```{r examples-plot_reg_population_type_abs, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center", dev = "ragg_png", out.width = "90%"}
plot_reg_population_type_abs(
  year = 2022,
  region = "The Americas",
  top_n_countries = 5,
  pop_type = "REF",
  show_diff_label = TRUE
)

plot_reg_population_type_abs(
  year = 2022,
  region = "The Americas",
  top_n_countries = 5,
  pop_type = "ASY",
  show_diff_label = FALSE
)
```



## Plot Biggest decrease in Refugee Population
 
    
```{r function-plot_reg_decrease}
#' Plot Biggest decrease in Refugee Population
#'
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null,
#'                it will display the whole world
#' @param lag Number of year to used as comparison base
#' @param topn how many top countries to show..
#' @param pop_type Vector of character values. Possible population type
#'                (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
plot_reg_decrease <- function(year = 2021,
                              lag = 5,
                              topn = 5,
                              region = "The Americas",
                              pop_type = c("REF", "ASY", "OIP")) {
  # library(tidyverse)

  thisyear <- year
  baseline <- thisyear - lag
  data <- refugees::population |>
    dplyr::filter(year == baseline | year == thisyear) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::mutate(year = dplyr::case_when(
      year == thisyear ~ paste("thisyear"),
      year == baseline ~ paste("baseline")
    )) |>
    dplyr::group_by(coa_name, year) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::select(coa_name, year, value) |>
    dplyr::mutate(
      coa_name = stringr::str_replace(coa_name, " \\(Bolivarian Republic of\\)", ""),
      coa_name = stringr::str_replace(coa_name, "Iran \\(Islamic Republic of\\)", "Iran"),
      coa_name = stringr::str_replace(coa_name, "United Kingdom of Great Britain and Northern Ireland", "UK")
    ) |>
    # mutate(Year = paste0("year_",Year )) |>
    tidyr::spread(year, value) |>
    dplyr::mutate(gap = baseline - thisyear) |>
    dplyr::arrange(dplyr::desc(gap)) |>
    utils::head(topn) |>
    tidyr::gather(
      key = year,
      value = value,
      -coa_name,
      -gap
    ) |>
    dplyr::mutate(year = dplyr::case_when(
      year == "thisyear" ~ paste(thisyear),
      year == "baseline" ~ paste(baseline)
    ))

  p <- ggplot2::ggplot(
    data,
    ggplot2::aes(
      x = stats::reorder(coa_name, gap),
      y = value,
      fill = as.factor(year)
    )
  ) +
    ggplot2::coord_flip() +
    ggplot2::geom_bar(stat = "identity", position = "dodge") +
    ggplot2::geom_hline(yintercept = 0, size = 1, colour = "#333333") +
    ggplot2::scale_fill_manual(values = c("#0072bc", "#FAAB18")) +
    ggplot2::labs(
      title = "Biggest Decrease of Population",
      subtitle = paste0(
        topn, " Biggest change in Refugee Population, ",
        region, " ", baseline, " - ", thisyear
      ),
      x = "", y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ## Format axis number
    ggplot2::scale_y_continuous(labels = scales::label_number(
      accuracy = 1,
      scale_cut = scales::cut_short_scale()
    )) +
    unhcrthemes::theme_unhcr(font_size = 14) + ## Insert UNHCR Style
    ggplot2::theme(
      panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()
    ) ### changing grid line that should appear

  return(p)
}
```
  
```{r example-plot_reg_decrease}
plot_reg_decrease(
  year = 2021,
  lag = 5,
  topn = 5,
  region = "The Americas",
  pop_type = c("REF", "ASY", "OIP")
)
```
  
```{r tests-plot_reg_decrease}
# test_that("plot_reg_decrease works", {   expect_true(inherits(plot_reg_decrease, "function")) })
```
  
    
## Plot Biggest increase in Refugee Population 
    
```{r function-plot_reg_increase}
#' Plot Biggest Increase in Refugee Population
#'
#'

#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param topn how many top countries to show..
#' @param region Character value with the related UNHCR bureau - when left null,
#'              it will display the whole world
#' @param pop_type Vector of character values. Possible population type
#'                  (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer

#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#' @export
plot_reg_increase <- function(year = 2021,
                              lag = 5,
                              topn = 5,
                              region = "The Americas",
                              pop_type = c("REF", "ASY", "OIP")) {

  thisyear <- year
  baseline <- thisyear - lag

  data <- refugees::population |>
    dplyr::filter(year == baseline | year == thisyear) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::group_by(coa_name, year) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(
      coa_name = stringr::str_replace(coa_name, "Democratic Republic of the Congo", "DRC")
    ) |>
    dplyr::mutate(year = paste0("year_", year)) |>
    tidyr::spread(year, value) |>
    dplyr::mutate(gap = .data[[paste0("year_", thisyear)]] - .data[[paste0("year_", baseline)]]) |>
    dplyr::arrange(dplyr::desc(gap)) |>
    utils::head(topn)

  p <- ggplot2::ggplot(
    data,
    ggplot2::aes(
      x = .data[[paste0("year_", baseline)]],
      xend = .data[[paste0("year_", thisyear)]],
      y = stats::reorder(coa_name, gap),
      group = coa_name
    )
  ) +
    ggplot2::geom_segment(
      ggplot2::aes(
        x = .data[[paste0("year_", baseline)]],
        xend = .data[[paste0("year_", thisyear)]],
        y = stats::reorder(coa_name, gap),
        yend = stats::reorder(coa_name, gap)
      ),
      colour = "#dddddd",
      size = 3
    ) +
    ggplot2::geom_point(
      ggplot2::aes(x = .data[[paste0("year_", baseline)]], y = stats::reorder(coa_name, gap)),
      colour = "#0072bc",
      size = 3
    ) +
    ggplot2::geom_point(
      ggplot2::aes(x = .data[[paste0("year_", thisyear)]], y = stats::reorder(coa_name, gap)),
      colour = "#FAAB18",
      size = 3
    ) +
    ggplot2::labs(
      title = "Where did Refugee Population increased in the past 10 years?",
      subtitle = paste0("Biggest increase in Refugee Population, ", baseline, " - ", thisyear),
      x = "", y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ggplot2::scale_x_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    unhcrthemes::theme_unhcr() +
    ggplot2::theme(
      panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()
    )

  return(p)
}
  
```{r example-plot_reg_increase}
plot_reg_increase(
  year = 2021,
  lag = 5,
  topn = 5,
  region = "The Americas",
  pop_type = c("REF", "ASY", "OIP")
)

plot_reg_increase(
  year = 2021,
  lag = 5,
  topn = 5,
  region = "Asia",
  pop_type = c("REF", "ASY", "OIP")
)
```
  
```{r tests-plot_reg_increase}
# test_that("plot_reg_increase works", {   expect_true(inherits(plot_reg_increase, "function")) })
```
  

## Proportion of the population who are refugees, by country of origin  (SDG indicator 10.7.4 ) 

```{r function-plot_reg_prop_origin}
#' Proportion of the population who are refugees, by country of origin
#'
#' The proportion of a country???s population who become refugees is SDG indicator 10.7.4
#' it consistutes is a useful way to identify the countries of origin producing the most refugees relative to their number of inhabitants.
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace
#' @importFrom WDI WDI
#' @importFrom forcats fct_reorder
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export

plot_reg_prop_origin <- function(year = 2022, region = "The Americas") {
  ## World bank API to retrieve total population
  # wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD",
  #                                     "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
  #              startdate = 1990,
  #              enddate = year,
  #              return_wide = TRUE)
  #
  # # Renaming variables for further matching
  # names(wb_data)[1] <- "iso_3"
  # names(wb_data)[2] <- "Year"

  wb_data <- WDI::WDI(
    country = "all",
    indicator = c(
      "SP.POP.TOTL", "NY.GDP.MKTP.CD",
      "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"
    ),
    start = 1990,
    end = year,
    extra = TRUE
  )
  # Renaming variables for further matching
  names(wb_data)[3] <- "iso3c"
  names(wb_data)[4] <- "Year"


  wb_data$Year <- as.numeric(wb_data$Year)


  departed <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coo_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, oip),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::group_by(coo_name, coo_iso) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    # mutate( value3 =  format_si(Value2))|>
    dplyr::mutate(coo_name = stringr::str_replace(
      coo_name,
      " \\(Bolivarian Republic of\\)", ""
    )) |>
    ## Now merge with WB Data
    dplyr::left_join(
      wb_data |>
        dplyr::select("SP.POP.TOTL", "iso3c", "Year") |>
        dplyr::filter(Year == year - 1),
      by = c("coo_iso" = "iso3c")
    ) |>
    dplyr::mutate(ref.part = round(value / (SP.POP.TOTL + value), 4)) |>
    dplyr::arrange(dplyr::desc(ref.part)) |>
    utils::head(10)

  p <- ggplot2::ggplot(
    departed,
    ggplot2::aes(x = ref.part, forcats::fct_reorder(coo_name, ref.part))
  ) +
    ggplot2::geom_col(fill = "#0072BC") +

    # geom_col( fill = ifelse(departed$CountryOriginCode %in% c("VEN"), "#0072BC", "#CCCCCC")) +

    ggplot2::geom_label(ggplot2::aes(label = scales::label_percent(accuracy = .1)(ref.part)),
      color = "black", hjust = "inward"
    ) +
    ggplot2::scale_x_continuous(labels = scales::label_percent(accuracy = .1)) +
    ggplot2::labs(
      x = NULL,
      y = NULL,
      title = stringr::str_wrap(paste0("Number of refugees, asylum seekers & displaced across borders by country of origin in", region), 60),
      subtitle = stringr::str_wrap("Top 10 Countries, as a proportion of the national population of that country of origin (SDG indicator 10.7.4)", 80),
      caption = stringr::str_wrap("Source: UNHCR.org/refugee-statistics. \n Total count of population who have been recognized as refugees as a proportion of the total population of their country of origin, expressed per 100,000 population. Refugees refers to persons recognized by the Government and/or UNHCR, or those in a refugee-like situation.  Population refers to total resident population in a given country in a given year.", 100)
    ) +
    unhcrthemes::theme_unhcr(
      grid = "X",
      axis = "y",
      axis_title = "x",
      font_size = 14
    )

  return(p)
}
```
  
```{r example-plot_reg_prop_origin}
plot_reg_prop_origin(year = 2022, region = "The Americas")
```
  
```{r tests-plot_reg_prop_origin}
# test_that("plot_reg_prop_origin works", {   expect_true(inherits(plot_reg_prop_origin, "function")) })
```
  
 

## Decision on Refugee Status Determination

```{r function-plot_reg_rsd}
#' Plot Chart on Refugee Status Determination
#'
#' Show the main host and origin countries based on number of decisions
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * Recognized
#'            * ComplementaryProtection
#'            * TotalDecided
#'            * RefugeeRecognitionRate
#'            * TotalRecognitionRate
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual
#'             geom_text geom_line
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom patchwork plot_annotation
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#'
#'
#' @return a ggplot2 object
#'
#' @export
plot_reg_rsd <- function(year = 2022,
                         region,
                         top_n_countries = 10,
                         measure = "Recognized") {
  measurelabel <- dplyr::case_when(
    measure == "Recognized" ~ "Recognized Refugee Status Decisions",
    measure == "ComplementaryProtection" ~ "Complementary Protection Decisions",
    measure == "TotalDecided" ~ "Total Decision (independently of the outcome)",
    measure == "RefugeeRecognitionRate" ~ "Refugee Recognition Rate",
    measure == "TotalRecognitionRate" ~ "Total Recognition Rate",
    TRUE ~ measure
  )

  # Filter data for the region and year
  data <- refugees::asylum_decisions |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    dplyr::mutate(DecisionsAveragePersonsPerCase = 1)

  # Top Origin
  topOrigin <- data |>
    dplyr::rename(CountryOriginName = coo_name) |>
    dplyr::group_by(CountryOriginName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided
    ) |>
    dplyr::mutate(CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""))

  topOrigin1 <- topOrigin |>
    mutate(measured = .data[[measure]]) |>
    arrange(desc(measured)) |>
    head(top_n_countries)

  # Top Asylum
  topasyl <- data |>
    dplyr::rename(CountryAsylumName = coa_name) |>
    dplyr::group_by(CountryAsylumName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided
    )

  topasyl1 <- topasyl |>
    dplyr::mutate(measured = .data[[measure]]) |>
    dplyr::arrange(dplyr::desc(measured)) |>
    utils::head(top_n_countries)


  rsdasyl <- ggplot(topasyl1, aes(
    y = measured,
    x = reorder(CountryAsylumName, measured)
  )) +
    scale_y_continuous(labels = scales::label_percent(accuracy = 0, suffix = "%")) +
    scale_y_continuous(labels = ifelse(measure %in% c("RefugeeRecognitionRate", "TotalRecognitionRate"),
      scales::label_percent(accuracy = 0, suffix = "%"),
      scales::label_number(accuracy = 1, scale_cut = scales::cut_short_scale())
    )) + ## Format axis number
    # facet_grid(.~ ctry_asy) +
    geom_bar(stat = "identity", fill = "#0072bc") +
    coord_flip() +
    # geom_hline(yintercept = 0, linewidth = 1.1, colour = "#333333") +
    labs( # title = "Number of RSD application  in 2020",
      subtitle = paste0("For top ", top_n_countries, " Countries of Asylum"),
      x = " ",
      y = " "
    ) +
    theme_unhcr(
      grid = "Y",
      axis = "x", axis_title = "",
      font_size = 10
    ) +
    theme( # axis.text.x = element_blank(),
      # legend.position = "none",
      panel.grid.major.x = element_line(color = "#cbcbcb"),
      panel.grid.major.y = element_blank()
    ) ### changing grid line that should appear)


  rsdorigin <- ggplot(topOrigin1, aes(
    y = measured,
    x = reorder(CountryOriginName, measured)
  )) +
    scale_y_continuous(labels = ifelse(measure %in% c("RefugeeRecognitionRate", "TotalRecognitionRate"),
      scales::label_percent(accuracy = 0, suffix = "%"),
      scales::label_number(accuracy = 1, scale_cut = scales::cut_short_scale())
    )) + ## Format axis number

    # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = scales::cut_short_scale())) + ## Format axis number
    # facet_grid(.~ ctry_asy) +
    geom_bar(stat = "identity", fill = "#0072bc") +
    coord_flip() +
    #  geom_hline(yintercept = 0, size = 1.1, colour = "#333333")   +
    labs( # title = "Number of RSD application per country of Origin in 2020",
      subtitle = paste0("For top ", top_n_countries, " Countries of Origin"),
      x = " ",
      y = " "
    ) +
    theme_unhcr(
      grid = "Y",
      axis = "x", axis_title = "",
      font_size = 10
    ) +
    theme( # axis.text.x = element_blank(),
      # legend.position = "none",
      panel.grid.major.x = element_line(color = "#cbcbcb"),
      panel.grid.major.y = element_blank()
    ) ### changing grid line that should appear)


  # joining charts
  requireNamespace("patchwork")
  patchworkRSDa <- rsdasyl + rsdorigin
  patchworkRSDa1 <- patchworkRSDa +
    # unhcRstyle::unhcr_theme(base_size = 8)  +  ## Insert UNHCR Style
    theme(legend.position = "none") +
    patchwork::plot_annotation(
      title = paste0(measurelabel, " | ", year, ", in ", region),
      # subtitle = ' ',
      caption = "Source: UNHCR.org/refugee-statistics "
      ## \n Because of different types of procedure, data from the US may \n includes multiple applications per applicants compared to other countries
    )

  return(patchworkRSDa1)
}
```
  
```{r example-plot_reg_rsd}
plot_reg_rsd(
  year = 2022,
  region = "The Americas",
  top_n_countries = 10,
  measure = "Recognized"
)


plot_reg_rsd(
  year = 2022,
  region = "The Americas",
  top_n_countries = 5,
  measure = "ComplementaryProtection"
)


plot_reg_rsd(
  year = 2022,
  region = "The Americas",
  top_n_countries = 10,
  measure = "TotalDecided"
)


plot_reg_rsd(
  year = 2022,
  region = "The Americas",
  top_n_countries = 10,
  measure = "RefugeeRecognitionRate"
)


plot_reg_rsd(
  year = 2022,
  region = "The Americas",
  top_n_countries = 10,
  measure = "TotalRecognitionRate"
)


# plot_reg_rsd(year = 2022,
#              region = "Europe",
#                         top_n_countries = 10,
#                         measure = "Recognized")
```
  
```{r tests-plot_reg_rsd}
# test_that("plot_reg_rsd works", {   expect_true(inherits(plot_reg_rsd, "function")) })
```
  


    
## Plot Evolution of Solutions in the Region

    
```{r function-plot_reg_solution}
#' Plot Solution over time in the region
#'
#' Description
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param lag Number of year to used as comparison base
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text geom_smooth
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  if_else desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom ggrepel geom_label_repel
#'
#' @return a ggplot2 object
#'
#' @export
#' @export
plot_reg_solution <- function(year = 2022,
                              region = "The Americas",
                              lag = 10) {

  solutions_long <- refugees::solutions |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(naturalisation, resettlement, returned_refugees),
      names_to = "solution_type",
      values_to = "value"
    ) |>
    dplyr::group_by(year, solution_type) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop")

  p <- ggplot2::ggplot(solutions_long, ggplot2::aes(x = year, y = value, colour = solution_type)) +
    ggplot2::geom_line(size = 1) +
    ggplot2::geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
    ggplot2::scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    ggplot2::xlim(c(2000, year + 6)) +
    ggplot2::scale_colour_manual(values = c(
      "naturalisation" = "#a6cee3",
      "resettlement" = "#1f78b4",
      "returned_refugees" = "#b2df8a"
    )) +
    ggplot2::geom_label(
      data = solutions_long |> dplyr::filter(year == max(year)),
      ggplot2::aes(
        x = year + .5,
        y = value,
        label = solution_type,
        color = solution_type
      ),
      hjust = 0,
      vjust = 0.5,
      fill = "white",
      label.size = NA,
      family = "Lato",
      size = 4
    ) +
    unhcrthemes::theme_unhcr(
      grid = "Y",
      axis = "x",
      axis_title = "y",
      font_size = 14,
      legend = FALSE
    ) +
    ggplot2::theme(
      panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.x = ggplot2::element_blank(),
      panel.grid.minor = ggplot2::element_blank()
    ) +
    ggplot2::labs(
      title = paste0("Solution for Displacement in ", region),
      subtitle = "Evolution in the past 20 years",
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )

  return(p)
}
```
  
```{r example-plot_reg_solution}
plot_reg_solution(
  year = 2022,
  region = "The Americas",
  lag = 10
)
```
  
```{r tests-plot_reg_solution}
# test_that("plot_reg_solution works", {   expect_true(inherits(plot_reg_solution, "function")) })
```
  

## Mapping Population  

    
```{r function-plot_reg_map}
#' Plot a regional map
#'
#'
#' @param year Numeric value of the year (for instance 2020)
#'
#' @param region Character value with the related UNHCR bureau - when left
#'                null, it will display the whole world
#'
#' @param topn how many top countries to show..
#' @param pop_type Vector of character values. Possible population type
#'                (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @param projection use a projection system - default is "Mercator"
#'           for instance this can be Bertin 1953 projection -
#'          https://visionscarto.net/bertin-projection-1953)
#'
#' @param maxSymbolsize size in point to adjust for the maximum value
#'  to display on the map
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit
#'              stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete
#'             scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom sf st_transform st_as_sf st_drop_geometry
#' @importFrom rnaturalearth ne_countries
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter
#'                summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom graphics par
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom WDI WDI
#' @importFrom Hmisc cut2
#'
#' @return a base plot
#'
#' @export
#'
plot_reg_map <- function(year = 2022,
                         region = "The Americas",
                         topn = 5,
                         pop_type = c("REF", "ASY", "OIP"),
                         projection = "Mercator",
                         maxSymbolsize = .25) {
  ## World bank API to retrieve total population
  # wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
  #              startdate = 1990,
  #              enddate = year,
  #              return_wide = TRUE)
  #
  # # Renaming variables for further matching
  # names(wb_data)[1] <- "CountryAsylumCode"
  # names(wb_data)[2] <- "Year"

  wb_data <- WDI::WDI(
    country = "all",
    ## Population total https://data.worldbank.org/indicator/SP.POP.TOTL
    indicator = c(
      "SP.POP.TOTL",
      ## GDP current
      # https://data.worldbank.org/indicator/NY.GDP.MKTP.CD
      "NY.GDP.MKTP.CD",
      ## GDP per capita
      # https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
      "NY.GDP.PCAP.CD",
      ## GNI per capita, Atlas method (current US$)
      # https://data.worldbank.org/indicator/NY.GNP.PCAP.CD
      "NY.GNP.PCAP.CD"
    ),
    start = year - 1,
    end = year,
    extra = TRUE
  )
  # Renaming variables for further matching
  names(wb_data)[3] <- "iso3c"
  names(wb_data)[4] <- "Year"


  wb_data <- wb_data |>
    dplyr::filter(Year == year - 1)

  ## Get spatial data to add ##########
  mapproject <- ""

  # listctr <- ForcedDisplacementStat::reference |>
  #   filter(UNHCRBureau == region) |>
  #   select(iso_3) |>
  #   pull()


  ## Loading the stat tables ######
  data <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::group_by(year, coa_name, coa_iso) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop")


  ## Join ########
  data2 <- data |>
    dplyr::left_join(wb_data,
      by = c("coa_iso" = "iso3c")
    ) |>
    dplyr::mutate(ratio_disp_gdp = round((value / NY.GDP.MKTP.CD) * 100, 4)) |>
    dplyr::mutate(ratio_disp_gdpcap = round((value / NY.GDP.PCAP.CD) * 100, 2)) |>
    dplyr::mutate(ratio_disp_host = round((value / SP.POP.TOTL) * 100, 2))

  ## Get Break https://riatelab.github.io/mapsf/reference/mf_get_breaks.html
  # Discretize the variable
  data2$quintDisp <- Hmisc::cut2(data2$value, g = 4)
  data2$quintDispGGP <- Hmisc::cut2(data2$ratio_disp_gdp, g = 4)
  data2$quintDispHost <- Hmisc::cut2(data2$ratio_disp_host, g = 4)


  # names(data2)
  # data2 <- data2 |>
  #   sf::st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)


  ## Getting world map for mapping
  world <- rnaturalearth::ne_countries(scale = "small", returnclass = "sf") |>
    dplyr::filter(continent != "Antarctica") |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(iso_a3, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region)

  ### Need to fix specific case for Asisa... where the proj disperse the country...
  ##  filter(adm0_a3 != "VUT")

  ## Manage Projection...
  # data2 <- data2 |>
  #   # this is the crs from d, which has no EPSG code:
  #   sf::st_transform("+init=epsg:4326")

  world <- world |>
    # this is the crs from d, which has no EPSG code:
    sf::st_transform("+init=epsg:4326")
  #   # this is the crs from d, which has no EPSG code:
  #   #sf::st_transform(., '+init=epsg:4326')
  #   #sf::st_transform(., '+proj=bertin1953 +R=1 0.72 0.73')
  #   #sf::st_transform(., '+proj=bertin1953 +x_0=1000')
  #   sf::st_transform(., '+proj=bertin1953')

  # Join data to world map
  map_data <- world |>
    dplyr::left_join(data2, by = c("iso_a3" = "coa_iso"))

  PopMap <- map_data |>
    sf::st_drop_geometry() |>
    dplyr::ungroup() |>
    dplyr::arrange(dplyr::desc(value)) |>
    utils::head(topn) |>
    dplyr::select(value)

  minPopMap <- PopMap |> min()
  maxPopMap <- PopMap |> max()


  regionname <- dplyr::case_when(
    region == "The Americas" ~ "The Americas",
    region == "Asia" ~ "Asia & the Pacific",
    region == "EastAfrica" ~ "Eastern Africa",
    region == "Europe" ~ "Europe",
    region == "MENA" ~ "Middle East & North Africa",
    region == "SouthAfrica" ~ "Southern Africa",
    region == "WestAfrica" ~ "Western Africa"
  )

  ## Generate Map   ##################
  # Maps is created here with [MapSF package](https://riatelab.github.io/mapsf/index.html)
  # Select a font already installed on your system !!
  graphics::par(family = "Lato")
  # set a theme
  # set a theme
  mapsfunhcr <- list(
    bg = "#d4dff2", #  "#E2E7EB",  ## background color --> Used country
    # bg = "#cdd2d4", "#faebd7ff",  "#cdd2d4",
    mar = c(0, 0, 2, 0), ## margins
    tab = FALSE, # if TRUE the title is displayed as a 'tab'
    fg = "#0072BC", ## foreground color --> for the top title - use UNHCR Blue..
    pos = "left", # position, one of 'left', 'center', 'right'
    inner = FALSE, # if TRUE the title is displayed inside the plot area.
    line = 2, # number of lines used for the title
    cex = 2.5, # cex of the title
    # font = "Lato",
    font = 1
  ) # font of the title
  mapsf::mf_theme(mapsfunhcr)


  # map_fun <- function(data, init, theme){
  #      # Initiate a base map
  #      mf_init(x = init, theme = theme)
  #      # always use add = TRUE after mf_init()
  #      mf_shadow(data, col = "grey50", cex = 0.2 , add = TRUE)
  #      mf_map(data, add = TRUE)
  #      mf_title(txt = "Martinique ", fg = "#FFFFFF")
  #      mf_credits(txt = "Credit", bg = "#ffffff80")
  #      return(invisible(NULL))
  #      }


  ## Initialise the map with a background
  ## Initialise the map with a background
  mapsf::mf_init(x = world)
  # always use add = TRUE after mf_init()

  # Plot a shadow
  mapsf::mf_shadow(world,
    col = "grey50", cex = 0.2,
    add = TRUE
  )

  mapsf::mf_map(world,
    lwd = 0.5,
    border = "#93A3AB",
    col = "#FFFFFF",
    add = TRUE
  )

  # Set a layout
  mapsf::mf_title(txt = paste0(
    "Forced Displacement in ",
    regionname, " | ", year
  ), fg = "#FFFFFF")
  mapsf::mf_credits(txt = "Source: UNHCR.org/refugee-statistics - A Country is name if it features among the five largest population.\n The boundaries and names shown and the designations used on this map do not imply official endorsment or acceptance by the inited nations", bg = "#ffffff80")


  ## Proportional Symbol with color based on other
  mapsf::mf_prop_typo(
    x = map_data, # frame to use..
    var = c("value", "quintDispHost"), ## First value for size, second for color
    inches = maxSymbolsize, # size of the biggest symbol (radius for circles, half width for squares) in inches
    val_max = maxPopMap, # maximum value used for proportional symbols
    symbol = "circle", ## type of symbol- 'circle' or 'square'
    border = "grey25", ## border color of symbol
    lwd = 1.5, #  border width of symbol
    pal = "Inferno", ## Color palette  - https://developer.r-project.org/Blog/public/2019/04/01/hcl-based-color-palettes-in-grdevices/
    alpha = .8, ## if pal is a hcl.colors palette name, the alpha-transparency level
    leg_no_data = "No data", ## When no data
    col_na = "grey", ## When no data
    leg_pos = c("topright", "bottomright"), # position of the legend
    leg_title = c("Number of Individuals", "Ratio with Host Community"), # title of the legend
    leg_title_cex = c(.7, .7), # title font size of the legend
    leg_val_cex = c(.5, .5), # content font size of the legend
    leg_val_rnd = .2, # number of decimal places of the values in the legend
    leg_frame = c(FALSE, FALSE), # add frame around the legend
    add = TRUE
  )
  # labels for a few  countries - https://riatelab.github.io/mapsf/reference/mf_label.html
  mapsf::mf_label(
    x = map_data[map_data$value >= minPopMap, ],
    var = "coa_name", # name(s) of the variable(s) to plot
    cex = 0.9, #  labels cex
    col = "black",
    font = 3.5,
    halo = TRUE, # add halo
    bg = "white", # halo color
    r = 0.2, # width of the halo
    overlap = FALSE, # if FALSE, labels are moved so they do not overlap.
    lines = TRUE
  )

  return(invisible(NULL))
}
```
  
```{r example-plot_reg_map}
plot_reg_map(
  year = 2022,
  region = "Asia",
  topn = 5,
  pop_type = c("REF", "ASY", "OIP"),
  projection = "Mercator",
  maxSymbolsize = .25
)


# plot_reg_map(  year = 2022,
#                             region = "WestAfrica",
#                             topn = 5,
#                             pop_type =  c("REF", "ASY", "OIP"),
#                             projection = "Mercator",
#                             maxSymbolsize = .25)
```
  
```{r tests-plot_reg_map}
# test_that("plot_reg_map works", {   expect_true(inherits(plot_reg_map, "function")) })
```
  
 
    
     


--- 



# Refresh package

```{r development-inflate, eval=FALSE}
# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_plot_Region.Rmd", vignette_name = "Chart Library Region", overwrite = "yes")
pkgdown::build_site()
```

