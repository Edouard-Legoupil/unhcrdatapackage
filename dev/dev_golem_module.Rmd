---
title: "Golem Modules for ShinyApp"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# mod_input

this is a shared module that takes all the parameters to filter the data..
https://stackoverflow.com/questions/69172472/shiny-modules-inside-other-modules/69173076#69173076

```{r function-mod_input}
#' input UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_input_ui <- function(id){
  ns <- NS(id)
  tagList( 
        # selectInput(inputId = ns("country"),
        #             label = " and filter by country..",
        #             choices = list("Panama" = "PAN",
        #                            "Colombia" = "COL",
        #                            "Ecuador" = "ECU",
        #                            "United States" = "USA",
        #                            "Mexico" = "MEX" ),
        #             selected = "Panama"),
        selectizeInput(inputId = ns("country"),
                       label = " Filter by country..", 
                      choices = ForcedDisplacementStat::end_year_population_totals |>
              dplyr::arrange(CountryAsylumName) |>
              dplyr::select(CountryAsylumCode) |>
              dplyr::distinct()  |>
              dplyr::pull(CountryAsylumCode) |>
              purrr::set_names(
                               ForcedDisplacementStat::end_year_population_totals |>
                                 dplyr::arrange(CountryAsylumName) |>
                                 dplyr::select(CountryAsylumName) |>
                                 dplyr::distinct()|>
                                 dplyr::pull(CountryAsylumName) ), 
                       selected = "USA", 
                       multiple = FALSE,
                       options = NULL),
        
        
        selectInput(inputId = ns("year"),
                    label = "  select another year",
                    choices = list("2022" = "2022",
                                   "2021" = "2021",
                                   "2020" = "2020",
                                   "2019" = "2019",
                                   "2018" = "2018" ),
                    selected = "2022")
  )
}
    
#' input Server Functions
#'
#' @noRd 
mod_input_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
     
    
    observe({
      reactiveParameters$country <- input$country
    })
    observe({
      reactiveParameters$year <- input$year
    })
 
  })
}
    
## To be copied in the UI
# mod_input_ui("input_1")
    
## To be copied in the server
# mod_input_server("input_1")

```

```{r examples-mod_input}

```

```{r tests-mod_input}
test_that("mod_input works", {

})
```



# annotate_gadget
    
```{r function-annotate_gadget}
#' A ShinyGadget to simply overlay an annotation on a ggplot2 chart
#'
#'  See https://shiny.posit.co/r/articles/build/gadgets/
#'  https://shiny.posit.co/r/articles/build/gadget-ui/
#'  https://posit.co/resources/videos/building-interactive-tools-for-exploratory-data-analysis/
#'  https://posit.co/resources/videos/introducing-shiny-gadgets-interactive-tools/
#'  https://stackoverflow.com/questions/30527977/ggplot2-how-to-differentiate-click-from-brush
#'
#' @param chart the ggplot2 object...
#' @return the code snippet wit the annoation
#' @importFrom miniUI miniPage gadgetTitleBar miniContentPanel miniButtonBlock
#' @importFrom ggtext geom_textbox
#' @import ggplot2
#' @import shiny
#' @export
annotate_gadget <- function(chart, viewer=paneViewer()) {
  ui <- miniUI::miniPage(
    miniUI::gadgetTitleBar("Overlay your interpretation on the chart!"),
    miniUI::miniContentPanel(

      shiny::textAreaInput(inputId="annot",
                label= "First Add your text",
                placeholder = "Use double quote on your text and
                \\n special character to add carriage return on the text in the plot",
                width = '100%'),
      "Then POSITION:  One first single click on the plot to point what you would like
      to highlight and then a long brush click to draw the box where the annotation
      should be overlaid",
      shiny::plotOutput("plot",
                 height = "100%",
                 click="annotate_point",
                 brush=brushOpts(id="annotate_box"))
       ),
    miniUI::miniButtonBlock(
      actionButton("arrow",
                   label = "Click here to reset the positionning",
                   border = "bottom",
                   icon = icon("arrow-up-right-from-square"))
       )
  )

  server <- function(input, output, session) {
    ## Observe Point
    observeEvent(input$annotate_point,
                 handlerExpr = {
      xend_p = input$annotate_point$x
      yend_p = input$annotate_point$y }
      )
    ## Observer Brush o define the attachment point
    observeEvent(input$annotate_box,
                 handlerExpr = {
                   xbox_p = input$annotate_box$xmin
                   ybox_p = input$annotate_box$ymin
        ## Now some thinking done to position the arrow
        ## xmin, xmax, ymin, and ymax

                   }
                 )
    # Render the plot
    output$plot <- shiny::renderPlot({
      # Display plot with added annotation
      chart
      ## get everything ready - text, point and box - then redraw the chart
      # if( !(is.na(input$annotate_point$x) &
      #       is.na(input$annotate_box$xmin)) ){
      #
      #   ### Adding some annotation...
      #   chart <- chart +
      #           geom_curve(aes(xend = xend_p,
      #                          yend = yend_p,
      #                          x = xbox_p,
      #                          y = ybox_p),
      #                      size = 2,
      #                      color = "tan",
      #                      arrow = arrow(length = unit(0.07, "npc"))) +
      #           ggtext::geom_textbox(data = data.frame(x = xbox_p,
      #                                                 y = ybox_p,
      #                                                 label = input$annot),
      #                                  mapping = aes(x = x,
      #                                                y = y,
      #                                                label = label),
      #                                  width = unit(0.6, "npc"),
      #                                  family = "Lato",
      #                                  size = 7,
      #                                  fill = "cornsilk",
      #                                  inherit.aes = FALSE)
      #
      # }

    })

    ## Get the code snippet to add to the ggplot object to render this annotation
    output$code <- shiny::renderText({

     # return("Tata")

      # geom_curve(aes(xend = xend_p,
      #                yend = yend_p,
      #                x = xbox_p,
      #                y = ybox_p),
      #            size = 2,
      #            color = "tan",
      #            arrow = arrow(length = unit(0.07, "npc"))) +
      # ggtext::geom_textbox(data = data.frame(x = xbox_p,
      #                                       y = ybox_p,
      #                                       label = "Why so many people are using **other** category? \n Is there an important missing category ?"),
      #                        mapping = aes(x = x,
      #                                      y = y,
      #                                      label = label),
      #                        width = unit(0.6, "npc"),
      #                        family = "Lato",
      #                        size = 7,
      #                        fill = "cornsilk",
      #                        inherit.aes = FALSE)
    })

    ## Observe Reset
    observeEvent(input$reset, handlerExpr = {
        chart = chart
    })
    # Handle the Done button being pressed.
    observeEvent(input$done, {
      # Return the code that will be used in the rest of the app...
      stopApp(#output$code  
        )
    })
  }
  shiny::runGadget(ui, server)
}
```
  
```{r example-annotate_gadget}
# if (interactive())
# thischart <- ggplot2::ggplot(datasets::iris,
#                              ggplot2::aes_string("Sepal.Length", "Sepal.Width")) +
#             ggplot2::geom_point()  
# annotate_gadget(chart = thischart)

```
  
```{r tests-annotate_gadget}
test_that("annotate_gadget works", {
  expect_true(inherits(annotate_gadget, "function")) 
})
```
  


# mod_annotate

this is the story telling module  to add annotation..

Based on https://github.com/MattCowgill/ggannotate 
also inspired from https://community.rstudio.com/t/graph-annotator-shiny-contest-submission/104687 

Once the button "Position the annotation on the chart" is launched:

 - a window with the chart - 

- click first time to indicate the top-left point to position the infobox
- ask if an arrow is required - if no - the windows closed and the annotation is added - 
- if yes - click a second time to add the arrow pointer - then window closed and the annotation is added- - a button is added with the option to remove this annotation -
- user can click the 



```{r function-mod_annotate}
#' annotate UI Function
#'
#' @description A shiny Module to lauch the annotatation gadget for a chart
#'
#' @param id,annotate,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_annotate_ui <- function(id){
  ns <- NS(id)
  tagList(

     # actionButton("overlay_annotate",
     #               label = "Overlay an interpretation annotation!  -- not working yet",
     #               icon = icon("hand-point-up"),
     #               onclick = "" ) 
  )
}
    
#' annotate Server Functions
#'
#' @noRd 
mod_annotate_server <- function(id, chart){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    #annotate_gadget(chart = thischart)

    
 
  })
}
    
## To be copied in the UI
# mod_annotate_ui("annotate_1")
    
## To be copied in the server
# mod_annotate_server("annotate_1")

```

```{r examples-mod_annotate}

```

```{r tests-mod_annotate}
test_that("mod_annotate works", {

})
```


# mod_share

See how we could share the story then on twitter -

This is a module that will work based on a specific module id.. 
https://stackoverflow.com/questions/69172472/shiny-modules-inside-other-modules/69173076#69173076

https://stackoverflow.com/questions/62052804/is-there-a-way-to-add-share-buttons-to-make-plots-shareable-in-shiny
The way a Twitter Card could work would be if you were sharing a link to a static web page in the Tweet text, and if that page had some markup which included the image, so that the image would be shown as a preview for the link. 



```{r function-mod_share}
#' categories UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @importFrom shinydashboard box 
mod_share_ui <- function(id){
  ns <- NS(id)

  tagList( 
     # actionButton(inputId="publish",
     #     label="Share your story (not working yet)",
     #     icon("share-from-square"))  ,
     # Combine text with url variable
      # Use the onclick parameter to open a new window to the twitter url
     
     # HTML("<div style='float:right'>
     #         <a href='https://twitter.com/share' 
     #         class='twitter-share-button' 
     #         align='middle' 
     #         data-url='https://rstudio.unhcr.org/Data_Literacy/' 
     #         data-text='Insert text here!' 
     #         data-size='large'>Tweet
     #         </a>
     #         <script>!function(d,s,id){
     #         var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';
     #         if(!d.getElementById(id)){
     #         js=d.createElement(s);
     #         js.id=id;
     #         js.src=p+'://platform.twitter.com/widgets.js';
     #         fjs.parentNode.insertBefore(js,fjs);
     #         }
     #         }(document, 'script', 'twitter-wjs');
     #         </script>
     #         </div>")
     
     # actionButton("twitter_share",
     #               label = "Share your story!",
     #               icon = icon("twitter"),
     #               onclick = sprintf("window.open('%s')", output$url)) 
     
     
     )
}
    
#' categories Server Functions
#'
#' @noRd 
mod_share_server <- function(id, tweetplot){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
  #   output$url <- renderText({ 
  #      
  #   ### Build and save the twitter card 
  #   
  #   ## Get the plot and save it as an image   on the disk  
  #  # tweechart <-   ""
  #   ## extract tweet message aka the plot tile
  # #  tweetmessage <- ""
  #   ## Now build the html tweetcard file to reference the image
  #  # tweetcard <- 
  #   # <meta name="twitter:card" content="summary_large_image">
  #   # <meta name="twitter:site" content="@Refugees">
  #   # <meta name="twitter:creator" content="@edouard_lgp">
  #   # <meta name="twitter:title" content="">
  #   # <meta name="twitter:description" content="Data Literacy on Forced Displacement">
  #   # <meta name="twitter:image" content="https://rstudio.unhcr.org/Data_Literacy/image.jpg">
  #   # <meta name="twitter:url" content="https://rstudio.unhcr.org/Data_Literacy/" />
  #   
  #   ### Save the twitter card on the disk 
  #   
  #   
  #   ## Create the URL and append it to the twitter intend.. 
  #    #  url <- paste0("https://twitter.com/intent/tweet?text=",
  #    #                tweetmessage,
  #    #               "&url=https://rstudio.unhcr.org/Data_Literacy/",
  #    #               tweetchart,"\"")
  #    # 
  #    # ## Give back that URL 
  #    # return(url)
  #  ## For FB 'https://www.facebook.com/sharer/sharer.php?u='  
  #     })
  })
}
    
## To be copied in the UI
# mod_share_ui("categories_1")
    
## To be copied in the server
# mod_share_server("categories_1")

```

```{r examples-mod_share}

```

```{r tests-mod_share}
testServer(
  mod_share_server,
  # Add here your module params
  args = list()
  , {
    ns <- session$ns
    expect_true(
      inherits(ns, "function")
    )
    expect_true(
      grepl(id, ns(""))
    )
    expect_true(
      grepl("test", ns("test"))
    )
    # Here are some examples of tests you can
    # run on your module
    # - Testing the setting of inputs
    # session$setInputs(x = 1)
    # expect_true(input$x == 1)
    # - If ever your input updates a reactiveValues
    # - Note that this reactiveValues must be passed
    # - to the testServer function via args = list()
    # expect_true(r$x == 1)
    # - Testing output
    # expect_true(inherits(output$tbl$html, "html"))
})
 
test_that("module categories works", {
  ui <- mod_share_ui(id = "test")
  golem::expect_shinytaglist(ui)
  # Check that formals have not been removed
  fmls <- formals(mod_share_ui)
  for (i in c("id")){
    expect_true(i %in% names(fmls))
  }
})
```




# mod_categories

```{r function-mod_categories}
#' categories UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @importFrom shinydashboard box 
mod_categories_ui <- function(id){
  ns <- NS(id)
  tagList( 
        plotOutput(ns("plot_ctr_population_type_per_year")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value="") ,
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%')
            
            ),
                            column( 4, 
            checkboxGroupInput(  inputId = ns("pop_type"),
                        label = "Population Types to include",
                        choices = c(  "Refugee" ="REF", 
                                     "Asylum Seeker"= "ASY", 
                                      "Other in Need of International Protection"="OIP" ,
                                      "Other of Concern"=     "OOC",
                                           "Stateless"="STA",
                                       "Internally Displaced Persons"=     "IDP" ),
                        selected = c("REF",  "ASY",  "OIP",  "OOC",  "STA",  "IDP" ) )),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
            
            
            
                             )  ) )
    )
}
    
#' categories Server Functions
#'
#' @noRd 
mod_categories_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    output$plot_ctr_population_type_per_year <- renderPlot({
      p <- plot_ctr_population_type_per_year(
              year = as.numeric(reactiveParameters$year),
              country_asylum_iso3c = reactiveParameters$country,
                         lag = 5,
                         pop_type = input$pop_type)
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
      
                             })
 
  })
}
    
## To be copied in the UI
# mod_categories_ui("categories_1")
    
## To be copied in the server
# mod_categories_server("categories_1")

```

```{r examples-mod_categories}

```

```{r tests-mod_categories}
testServer(
  mod_categories_server,
  # Add here your module params
  args = list()
  , {
    ns <- session$ns
    expect_true(
      inherits(ns, "function")
    )
    expect_true(
      grepl(id, ns(""))
    )
    expect_true(
      grepl("test", ns("test"))
    )
    # Here are some examples of tests you can
    # run on your module
    # - Testing the setting of inputs
    # session$setInputs(x = 1)
    # expect_true(input$x == 1)
    # - If ever your input updates a reactiveValues
    # - Note that this reactiveValues must be passed
    # - to the testServer function via args = list()
    # expect_true(r$x == 1)
    # - Testing output
    # expect_true(inherits(output$tbl$html, "html"))
})
 
test_that("module categories works", {
  ui <- mod_categories_ui(id = "test")
  golem::expect_shinytaglist(ui)
  # Check that formals have not been removed
  fmls <- formals(mod_categories_ui)
  for (i in c("id")){
    expect_true(i %in% names(fmls))
  }
})
```


# mod_origin

```{r function-mod_origin}
#' origin UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_origin_ui <- function(id){
  ns <- NS(id)
  tagList(
        plotOutput(ns("plot_ctr_population_type_abs")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value=""),
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%') ),
                            column( 4, 
            selectInput(  inputId = ns("pop_type"),
                        label = "What Population Type to include",
                        choices = c(   "Refugee" ="REF", 
                                     "Asylum Seeker"= "ASY", 
                                      "Other in Need of International Protection"="OIP"  ),
                        selected =   "ASY" )),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
                             )  ) )
  )
}
    
#' origin Server Functions
#'
#' @noRd 
mod_origin_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    output$plot_ctr_population_type_abs <- renderPlot({
                 p <- plot_ctr_population_type_abs(
                        year = as.integer(reactiveParameters$year),
                        country_asylum_iso3c = reactiveParameters$country,
                        top_n_countries = 9,
                        show_diff_label = TRUE,
                        pop_type = input$pop_type)
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
                             })
 
  })
}
    
## To be copied in the UI
# mod_origin_ui("origin_1")
    
## To be copied in the server
# mod_origin_server("origin_1")

```

```{r examples-mod_origin}

```

```{r tests-mod_origin}
testServer(
  mod_origin_server,
  # Add here your module params
  args = list()
  , {
    ns <- session$ns
    expect_true(
      inherits(ns, "function")
    )
    expect_true(
      grepl(id, ns(""))
    )
    expect_true(
      grepl("test", ns("test"))
    )
    # Here are some examples of tests you can
    # run on your module
    # - Testing the setting of inputs
    # session$setInputs(x = 1)
    # expect_true(input$x == 1)
    # - If ever your input updates a reactiveValues
    # - Note that this reactiveValues must be passed
    # - to the testServer function via args = list()
    # expect_true(r$x == 1)
    # - Testing output
    # expect_true(inherits(output$tbl$html, "html"))
})
 
test_that("module origin works", {
  ui <- mod_origin_ui(id = "test")
  golem::expect_shinytaglist(ui)
  # Check that formals have not been removed
  fmls <- formals(mod_origin_ui)
  for (i in c("id")){
    expect_true(i %in% names(fmls))
  }
})

```


# mod_destination

```{r function-mod_destination}
#' destination UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_destination_ui <- function(id){
  ns <- NS(id)
  tagList(
            plotOutput(ns("plot_ctr_destination")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value=""),
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%') ),
                            column( 4, 
            checkboxGroupInput(  inputId = ns("pop_type"),
                        label = "What Population Type to include",
                        choices = c(   "Refugee" ="REF", 
                                     "Asylum Seeker"= "ASY", 
                                      "Other in Need of International Protection"="OIP"  ),
                        selected = c(  "ASY"  ) )),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
                             )  ) )
  )
}
    
#' destination Server Functions
#'
#' @noRd 
mod_destination_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    output$plot_ctr_destination <- renderPlot({
              p <-          plot_ctr_destination(
              year = as.numeric(reactiveParameters$year),
              country_origin_iso3c = reactiveParameters$country,
                     pop_type =   input$pop_type)
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
                             })
 
  })
}
    
## To be copied in the UI
# mod_destination_ui("destination_1")
    
## To be copied in the server
# mod_destination_server("destination_1")

```

```{r examples-mod_destination}

```

```{r tests-mod_destination}
test_that("mod_destination works", {

})
```


# mod_demographics

```{r function-mod_demographics}
#' demographics UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_demographics_ui <- function(id){
  ns <- NS(id)
  tagList( 
        plotOutput(ns("plot_ctr_pyramid")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value=""),
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%') ),
                            column( 4, 
            checkboxGroupInput(  inputId = ns("pop_type"),
                        label = "What Population Type to include",
                        choices = c(   "Refugee" ="REF", 
                                     "Asylum Seeker"= "ASY", 
                                      "Other in Need of International Protection"="OIP"  ),
                        selected = c(  "REF"  ) )),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
                             )  ) )
  )
}
    
#' demographics Server Functions
#'
#' @noRd 
mod_demographics_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns 
        output$plot_ctr_pyramid <- renderPlot({
               p <-          plot_ctr_pyramid(
              year = as.numeric(reactiveParameters$year),
              country_asylum_iso3c = reactiveParameters$country,
              pop_type =  input$pop_type)
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
                             })
 
  })
}
    
## To be copied in the UI
# mod_demographics_ui("demographics_1")
    
## To be copied in the server
# mod_demographics_server("demographics_1")

```

```{r examples-mod_demographics}

```

```{r tests-mod_demographics}
test_that("mod_demographics works", {

})
```


# mod_processing

```{r function-mod_processing}
#' processing UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_processing_ui <- function(id){
  ns <- NS(id)
  tagList(
        plotOutput(ns("plot_ctr_process")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value=""),
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%') ),
                            column( 4, ""),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
                             )  ) )
  )
}
    
#' processing Server Functions
#'
#' @noRd 
mod_processing_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    output$plot_ctr_process <- renderPlot({
                  p <-      plot_ctr_process(
              year = as.numeric(reactiveParameters$year),
              country_asylum_iso3c = reactiveParameters$country)
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
                             })
 
  })
}
    
## To be copied in the UI
# mod_processing_ui("processing_1")
    
## To be copied in the server
# mod_processing_server("processing_1")

```

```{r examples-mod_processing}

```

```{r tests-mod_processing}
test_that("mod_processing works", {

})
```


# mod_solution

```{r function-mod_solution}
#' solution UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_solution_ui <- function(id){
  ns <- NS(id)
  tagList(
        plotOutput(ns("plot_ctr_solution")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value="") ,
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%')),
                            column( 4, 
            checkboxGroupInput(  inputId = ns("pop_type"),
                        label = "What Population Type to include",
                        choices = c(   "Refugee" ="REF", 
                                     "Asylum Seeker"= "ASY", 
                                      "Other in Need of International Protection"="OIP"  ),
                        selected = c(  "ASY"  ) )),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
                             )  ) )
  )
}
    
#' solution Server Functions
#'
#' @noRd 
mod_solution_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
        output$plot_ctr_solution <- renderPlot({
             p <-            plot_ctr_solution(
              year = as.numeric(reactiveParameters$year),
              country_asylum_iso3c = reactiveParameters$country,
              pop_type =  input$pop_type)
          
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
                             })
 
  })
}
    
## To be copied in the UI
# mod_solution_ui("solution_1")
    
## To be copied in the server
# mod_solution_server("solution_1")

```

```{r examples-mod_solution}

```

```{r tests-mod_solution}
test_that("mod_solution works", {

})
```


# mod_migrants

```{r function-mod_migrants}
#' migrants UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_migrants_ui <- function(id){
  ns <- NS(id)
  tagList(
        plotOutput(ns("plot_ctr_disp_migrant")),
       fluidRow(
        shinydashboard::box( title = "Tell Your Story!",
                              status = "info", 
                              solidHeader = TRUE, 
                              collapsible = TRUE,
                              #background = "light-blue",
                              width = 12, 
                             fluidRow( 
                            column( 6, 
            textInput( inputId =ns( "title"),
                   label ="Title -  Highlight your main message! Keep it short!",
                   value=""),
            textInput( inputId = ns( "subtitle"),
                       label ="SubTitle -  Add Insights!",
                       value=""),
             actionButton(inputId="position",
                   label = "Overlay an interpretation annotation!  -- not working yet", 
                   class = "btn-success",
                   icon = icon("hand-point-up"),
                   width = '100%')
                            ),
                            column( 4, ""),
                             column( 2, 
                     actionButton(inputId="publish",
                                       label="Share your story (not working yet)",
                                       icon("share-from-square"))   )
                             )))
  )
}
    
#' migrants Server Functions
#'
#' @noRd 
mod_migrants_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns 
    output$plot_ctr_disp_migrant <- renderPlot({
                  p <-       plot_ctr_disp_migrant(
              year = as.numeric(reactiveParameters$year),
              country_asylum_iso3c = reactiveParameters$country)
      
   if (input$title != "") { p<- p + labs(title = input$title)}
   if (input$subtitle != "") { p <- p + labs(subtitle = input$subtitle)}
      
      p
                             })
 
  })
}
    
## To be copied in the UI
# mod_migrants_ui("migrants_1")
    
## To be copied in the server
# mod_migrants_server("migrants_1")

```

```{r examples-mod_migrants}

```

```{r tests-mod_migrants}
test_that("mod_migrants works", {

})
```






```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_golem_module.Rmd", 
               check = FALSE,
               document = FALSE,
               overwrite = TRUE,
               vignette_name = "Golem Modules for ShinyApp")
```

