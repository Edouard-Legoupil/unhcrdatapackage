---
title: "Golem Modules for ShinyApp"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```


# mod_home

this is a shared module that takes all the parameters to filter the data..
https://stackoverflow.com/questions/69172472/shiny-modules-inside-other-modules/69173076#69173076

```{r function-mod_home}
#' Landing page UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#' @keywords internal
#' @importFrom shinydashboardPlus carousel carouselItem
#' @importFrom shiny NS tagList 
mod_home_ui <- function(id){
  ns <- NS(id)
  tagList( 

             )
}
                  
                  #, #Doing so, users will: 
                            #  tags$ul(
                            #     tags$li("enhance basic data literacy"), 
                            #     tags$li("further explore data through different filters"), 
                            #     tags$li("be able to create persuasive data stories ") 
                            # )   
                                    # "This app allows Information Managers, Data Analyst and Data Journalist to quickly build data stories on Forced Displacement: Adjust the message in the title, highlight insights in the subtitle, overlay annotation to ease interpretation and filter the data",
                  
                  # for data story telling 

                    # p(HTML("  1. How the different <a href='#shiny-tab-categories'>Categories</a> of Population of concern to UNHCR are evolving over time?")), 
                    # p(HTML("  2. What are the main countries of Origin of Forced Displacement across Borders?")),  
                    # p(HTML("  3. What are the main countries of Destination of Asylum of Forced Displacement across Borders?")),
                    # p(HTML("  4. What are the Demographics profiles of Forcibly Displaced People in relation with the host population?")),
                    # p(HTML("  5. Is the asylum Processing capacity in relation with the demand?")),
                    # p(HTML("  6. What are the trends in terms of Solutions?")),
                    # p(HTML("  7. What is the share of Forcibly Displaced People among total Migrants?")) ,
                  #,
                 # br(),
                  # p ('This app conveniently bring together a series of predefined plots in order to improve data literacy and facilitate the creation of',
                  # tags$a(href="https://edouard-legoupil.github.io/unhcrdatapackage/tuto/tutorial.html", "persuasive data stories") ,
                  # '. Each plot is created through a function that provides a recipe that creates a re-usable chart in line with a',
                  # tags$a(href="https://www.columnfivemedia.com/divisible-content-strategy-gives-brand-less/", "Divisible Content Strategy"),
                  # '. You may',
                  # tags$a(href="https://edouard-legoupil.github.io/unhcrdatapackage/articles/library.html", "enhance the charts story-telling ability"),
                  # ' by adjusting the message in the title, highlighting specific parts of the data or adding annotation to ease interpretation or provide more contextual background.')



#' input Server Functions
#'
#' @noRd 
#' @keywords internal
mod_home_server <- function(id){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    ## used to get a link to the tabs...

  

  })
}
    
## To be copied in the UI
# mod_home_ui("home_1")
    
## To be copied in the server
# mod_home_server("home_1")

```

```{r examples-mod_home}

```

```{r tests-mod_home}
test_that("mod_home works", {

  
  
  
})
```



## strip_slashes
    
```{r function-strip_slashes}
#' A small function to strip trailing slashes from a path
#' @noRd
#' @keywords internal
#' @return path
#' @param path file path
strip_slashes <- function(path) {
  if (length(path) && grepl("/$", path)) {
    path <- substr(path, 1, nchar(path) - 1)
  }
  # Also remove leading slashes
  if (length(path) && grepl("^/", path)) {
    path <- substr(path, 2, nchar(path))
  }
  
  path
}
```
  
## add_slashes
    
```{r function-add_slashes}
#' A small function to add a prefix slash
#' @noRd
#' @keywords internal
#' @return path
#' @param path file path
add_slashes <- function(path) {
  if (length(path) && !grepl("^/", path)) {
    path <- paste0("/", path)
  }
  path
}
``` 
  
  
## pretty_lists
    
```{r function-pretty_lists}
#' pretty_lists
#' 
#' A pretty list printer. Reduces extraneous space.
#' 
#' @param x a string
#' @return another string
#' 
#' @importFrom assertive assert_is_list
#' 
#' @noRd
pretty_lists <- function(x)
{
  assertive::assert_is_list(x)

   for(key in names(x)){
      value <- format(x[[key]])
      if(value == "") next
      cat(key, "=", value, "\n")
   }
   invisible(x)
}
```
  
```{r example-pretty_lists}
pretty_lists()
```
  
```{r tests-pretty_lists}
test_that("pretty_lists works", {
  expect_true(inherits(pretty_lists, "function")) 
})
```
    
## drop_upload
    
```{r function-drop_upload}
#'Uploads a file to Dropbox.
#'
#'This function will allow you to write files of any size to Dropbox(even ones
#'that cannot be read into memory) by uploading them in chunks.
#'
#'@param file Relative path to local file.
#'@param path The relative path on Dropbox where the file should get uploaded.
#'@param mode - "add" - will not overwrite an existing file in case of a
#'  conflict. With this mode, when a a duplicate file.txt is uploaded, it  will
#'  become file (2).txt. - "overwrite" will always overwrite a file -
#'@param autorename This logical determines what happens when there is a
#'  conflict. If true, the file being uploaded will be automatically renamed to
#'  avoid the conflict. (For example, test.txt might be automatically renamed to
#'  test (1).txt.) The new name can be obtained from the returned metadata. If
#'  false, the call will fail with a 409 (Conflict) response code. The default is `TRUE`
#'@param mute Set to FALSE to prevent a notification trigger on the desktop and
#'  mobile apps
#' @param dtoken token from the app - with sufficient privileges - 
#'           per default registered within the 
#'           environment as DROPBOX  https://www.dropbox.com/developers/
#' 
#' @references \href{https://www.dropbox.com/developers/documentation/http/documentation#files-upload}{API documentation}
#' 
#' @importFrom assertive   assert_all_are_existing_files
#'              assert_any_are_matching_fixed
#' @importFrom httr POST  add_headers  upload_file            
#'@export

drop_upload <- function(file,
                        path = NULL,
                        mode = "overwrite",
                        autorename = TRUE,
                        mute = FALSE,
                        verbose = FALSE,
                        dtoken = Sys.getenv("DROPBOX")) {
  put_url <- "https://content.dropboxapi.com/2/files/upload"
  
  # Check that object exists locally before adding slashes
  assertive::assert_all_are_existing_files(file, severity = ("stop"))
  
  # Check to see if only supported modes are specified
  standard_modes <- c("overwrite", "add", "update")
  assertive::assert_any_are_matching_fixed(standard_modes, mode)
  
  # Dropbox API requires a / before an object name.
  if (is.null(path)) {
    path <- add_slashes(basename(file))
  } else {
    path <- paste0("/", strip_slashes(path), "/", basename(file))
  }
  
  req <- httr::POST(
    url = put_url, 
    add_headers(Authorization = paste("Bearer", dtoken, sep = " ")),
    # httr::config(token = token),
    httr::add_headers("Dropbox-API-Arg" = jsonlite::toJSON(
      list(
        path = path,
        mode = mode,
        autorename = autorename,
        mute = mute
      ),
      auto_unbox = TRUE
    )),
    body = httr::upload_file(file,
                             type = "application/octet-stream")
    # application/octet-stream is to save to a file to disk and not worry about
    # what application/function might handle it. This lets another application
    # figure out how to read it. So for this purpose we're totally ok.
  )
  httr::stop_for_status(req)
  response <- httr::content(req)
  
  if (verbose) {
    pretty_lists(response)
    invisible(response)
  } else {
    invisible(response)
    message(
      sprintf(
        'File %s uploaded as %s successfully at %s',
        file,
        response$path_display,
        response$server_modified
      )
    )
  }
  
}

```
  
```{r example-drop_upload}
#' write.csv(mtcars, file = "mtt.csv")
#' drop_upload(file="mtt.csv")
```
  
```{r tests-drop_upload}
test_that("drop_upload works", {
  expect_true(inherits(drop_upload, "function")) 
})
```
  
  
## create_shared_link_with_settings
    
```{r function-create_shared_link_with_settings}
#' create_shared_link_with_settings
#'
#'This function will allow you to share and get the link for sharing on dropbox
#'
#' https://www.dropboxforum.com/t5/Dropbox-API-Support-Feedback/sharing-create-shared-link-with-settings-unauthorized/td-p/616241
#'
#'@param path The relative path on Dropbox where the file should get uploaded.
#'@param mode - "add" - will not overwrite an existing file in case of a
#'  conflict. With this mode, when a a duplicate file.txt is uploaded, it  will
#'  become file (2).txt. - "overwrite" will always overwrite a file -
#'@param autorename This logical determines what happens when there is a
#'  conflict. If true, the file being uploaded will be automatically renamed to
#'  avoid the conflict. (For example, test.txt might be automatically renamed to
#'  test (1).txt.) The new name can be obtained from the returned metadata. If
#'  false, the call will fail with a 409 (Conflict) response code. The default is `TRUE`
#'@param mute Set to FALSE to prevent a notification trigger on the desktop and
#'  mobile apps
#'  
#' @param dtoken token from the app - with sufficient privileges - 
#'           per default registered within the 
#'           environment as DROPBOX  https://www.dropbox.com/developers/
#'           
#' @references \href{https://www.dropbox.com/developers/documentation/http/documentation#sharing-get_shared_link_file}{API documentation}
#' @importFrom httr POST  add_headers 
#' @export

create_shared_link_with_settings <- function(
    dtoken = Sys.getenv("DROPBOX"), 
    path) {
  
  req <- httr::POST(
    url = "https://api.dropboxapi.com/2/sharing/create_shared_link_with_settings",
    httr::add_headers(Authorization = paste("Bearer", dtoken, sep = " ")),
    # httr::config(token = token),
    body = list(
      path = path,
      "settings"= list(
        "access" = "viewer",
        "allow_download" = TRUE,
        "audience"= "public",
        "requested_visibility"= "public"
      )
    ),
    encode = "json"
  )
  req
}
```
  
```{r example-create_shared_link_with_settings}
# write.csv(mtcars, file = "mtt.csv")
# drop_upload(file="mtt.csv",
#             path = "shiny/")
# res <- create_shared_link_with_settings(path= "/shiny/mtt.csv")
# httr::content(res)$url
```
  
```{r tests-create_shared_link_with_settings}
test_that("create_shared_link_with_settings works", {
  expect_true(inherits(create_shared_link_with_settings, "function")) 
})
```
    

# Shared Modules

The app includes 2 shared modules - 

  * One for the selection of countries and year - that will be then passed on to all the plots
  * One that takes the global reactive values - and the type of plot (form the library) as a parameter to output a ggplot2 charts




## mod_input

this is a shared module that takes all the parameters to filter the data..
https://stackoverflow.com/questions/69172472/shiny-modules-inside-other-modules/69173076#69173076

```{r function-mod_input}
#' input UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_input_ui <- function(id){
  ns <- NS(id)
  tagList( 
        # selectInput(inputId = ns("country"),
        #             label = " and filter by country..",
        #             choices = list("Panama" = "PAN",
        #                            "Colombia" = "COL",
        #                            "Ecuador" = "ECU",
        #                            "United States" = "USA",
        #                            "Mexico" = "MEX" ),
        #             selected = "Panama"),
        selectizeInput(inputId = ns("country"),
                       label = " Select Country", 
                      choices = ForcedDisplacementStat::end_year_population_totals |>
              dplyr::arrange(CountryAsylumName) |>
              dplyr::select(CountryAsylumCode) |>
              dplyr::distinct()  |>
              dplyr::pull(CountryAsylumCode) |>
              purrr::set_names(
                               ForcedDisplacementStat::end_year_population_totals |>
                                 dplyr::arrange(CountryAsylumName) |>
                                 dplyr::select(CountryAsylumName) |>
                                 dplyr::distinct()|>
                                 dplyr::pull(CountryAsylumName) ), 
                       selected = "USA", 
                       multiple = FALSE,
                       options = NULL),
        
        
        selectInput(inputId = ns("year"),
                    label = "  Select Year",
                    choices = list("2022" = "2022",
                                   "2021" = "2021",
                                   "2020" = "2020",
                                   "2019" = "2019",
                                   "2018" = "2018" ),
                    selected = "2022")
  )
}
    
#' input Server Functions 
#' @param reactiveParameters  Main app filters defined through mod_input
#'
#' @noRd 
mod_input_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
     
    
    observe({
      reactiveParameters$country <- input$country
    })
    observe({
      reactiveParameters$year <- input$year
    })
 
  })
}
    
## To be copied in the UI
# mod_input_ui("input_1")
    
## To be copied in the server
# mod_input_server("input_1")

```

```{r examples-mod_input}

```

```{r tests-mod_input}
test_that("mod_input works", {

})
```



## mod_plotviz

This module take as an argument the plot based on the library and the reactive values from the app. 

```{r function-mod_plotviz}
#' plotviz UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#' @param thisPlot identify which plot to output from the library
#'   # 1. Category 
#'    # ## Key Figures
#'    "plot_ctr_keyfig", # year, country_asylum_iso3 
#'    # ## Plot Tree Map of Categories
#'    "plot_ctr_treemap", # year,  country_asylum_iso3c,   pop_type 
#'    # ## Plot Population type per year
#'    "plot_ctr_population_type_per_year", # year,   country_asylum_iso3c, lag,  pop_type  
#'    
#'    # # 2. Origin
#'    # ## Plot Main country of origin  in one specific country - Absolute value
#'    "plot_ctr_population_type_abs", # year , country_asylum_iso3c, top_n_countries,  pop_type = pop_filter, show_diff_label = FALSE   
#'    # ## Plot Main country of origin in one specific country - Percentage
#'    "plot_ctr_population_type_perc", # year , country_asylum_iso3c , top_n_countries, pop_type = "REF"- pop_filter    
#'    # ## Plot Increases and Decreases in Population Groups
#'    "plot_ctr_diff_in_pop_groups", # year,  country_asylum_iso3c,  pop_type  
#'    # ## Plot Origin History
#'    "plot_ctr_origin_history", # year , country_asylum_iso3c ,lag, ,   pop_type , otherprop 
#'   
#'    # # 3. Destination 
#'    # ## Plot Main Destination from  one specific country 
#'    "plot_ctr_destination", # year , country_origin_iso3c, pop_type   
#'    # ## plot recognition rate for a nationality
#'    "plot_ctr_origin_recognition", # year, country_origin_iso3c,  top_n_countries,  measure ,  order_by  
#'     
#'    # # 4. Profile
#'    # ## Plot Age Pyramid
#'    "plot_ctr_pyramid", # year , country_asylum_iso3c , pop_type  
#'    # ## Plot locations within countries
#'    "plot_ctr_location", # year , country_asylum_iso3c, pop_type 
#' 
#'    # # 5. Processing
#'    # ## Plot Refugee Recognition rate in Country
#'    "plot_ctr_recognition", # year,  country_asylum_iso3c, top_n_countries , measure , order_by  
#'    # ## Asylum Applications & Decision over time
#'    "plot_ctr_asylum", # year  country_asylum_iso3c,   lag 
#'    # ## Asylum Processing
#'    "plot_ctr_process", # year,   country_asylum_iso3c ,  otherprop 
#'    # ## Average Asylum Processing Time
#'    "plot_ctr_processing_time", # year =, country_asylum_iso3c ,  country_origin_iso3c ,  procedureType  
#'    
#'    # # 6. Solutions 
#'    # ## Plot Solution Over time 
#'    "plot_ctr_solution", # year , country_asylum_iso3c, pop_type  
#' 
#'    # # 7.Migrant 
#'    # ## Plot Ratio Refugee Migrant 
#'    "plot_ctr_disp_migrant" # year , country_asylum_iso3c ,   
#'
#' @noRd 
#'
#' @import  shiny  
#' @importFrom shinyjs  useShinyjs
#' @keywords internal
mod_plotviz_ui <- function(id, thisPlot){
  ns <- NS(id)
  
      
  tagList(
      # Set up shinyjs
      shinyjs::useShinyjs(),  
      ## Display the plot
        plotOutput(outputId = ns("thisplot"),
                   click= ns("annotate_point"),
                   brush= shiny::brushOpts(id= ns("annotate_box")),
                   height = "550px"),
      ## Display the interface parameters...
       fluidRow(
         shinydashboard::box(
           title = "Tell Your Story!",
           #  status = "primary",
           status = "info",
           solidHeader = TRUE,
           collapsible = TRUE,
           #background = "light-blue",
           width = 12,
           fluidRow(
             
             ## First column used to storytelling
             column(
               6,
               h4("Interpret"),   
               textInput(
                 inputId = ns("title"),
                 label = "Title - Highlight your main message!",
                 value = "",
                 placeholder = "Keep it short!"
               ),
               textInput(
                 inputId = ns("subtitle"),
                 label = "SubTitle - Add Insights!",
                 value = "",
                 placeholder = "Help in reading the chart"
               ),
            
            shiny::textAreaInput(inputId="annot",
                 label= "Overlay an annotation",
                 placeholder = "Once entered the text will appear as soon as the 
                 box is drawn on the chart",
                           width = '100%'),
            
            
            fluidRow(
                   column(
                     8,
                     tags$i("To position the annotation:"),
        "One first single click on the plot to point what you would like to highlight and then a long brush click to draw the box where the annotation should be overlaid", ),
                   column(
                     4,
                     ## Capture coordinate for the annot...
                 shiny::verbatimTextOutput(
                   ns("annotinfo"), 
                   placeholder = TRUE ))
              )
            
               
      
             ),
             
             ## Second Columns used for chart parameters..
             column(4, 
                h4("Filter"),    
               ## pop_type or pop_filter    
               if (thisPlot %in% c( "plot_ctr_treemap",
                                     "plot_ctr_population_type_per_year",
                                     "plot_ctr_diff_in_pop_groups",
                                     "plot_ctr_origin_history",
                                     "plot_ctr_destination")  
                    ){  checkboxGroupInput(  inputId = ns("pop_type"),
                          label = "Population Types to include",
                          choices = c("Refugee" ="REF", 
                                    "Asylum Seeker"= "ASY", 
                                    "Other in Need of International Protection"="OIP" ,
                                    "Other of Concern"= "OOC",
                                    "Stateless"="STA",
                                    "Internally Displaced Persons"=     "IDP" ),
                          selected = c("REF",  "ASY",  "OIP",  "OOC",  "STA",  "IDP" ) )
                 
                    } else if (thisPlot %in% c( "plot_ctr_population_type_abs" ,
                                                  "plot_ctr_population_type_perc") 
                     ){ selectInput(  inputId = ns("pop_type"),
                          label = "Population Type to include",
                          choices = c(   "Refugee" ="REF", 
                                     "Asylum Seeker"= "ASY", 
                                      "Other in Need of International Protection"="OIP"  ),
                          selected =   "ASY" )
                    } else {""},
               
               ## top_n_countries ,  numericInput
               if (thisPlot %in% c( "plot_ctr_population_type_abs",
                                    "plot_ctr_population_type_perc",
                                    "plot_ctr_origin_recognition",
                                    "plot_ctr_recognition")  
                   ){  sliderInput( inputId =   ns("top_n_countries"), 
                                label = "Top n countries", 
                                value = 5,  min = 4 , max = 30, step = 1 ,
                                width = '100%') } else {""},
             
               ## lag  # numericInput
               if (thisPlot %in% c("plot_ctr_population_type_per_year",
                                    "plot_ctr_origin_history",
                                    "plot_ctr_asylum")  
                   ){  sliderInput( inputId =   ns("lag"), 
                                label = "Lag in years", 
                                value = 3,  min = 3 , max = 10, step = 1 ,
                                width = '100%') } else {""},
             
               ## otherprop   ## numeric input
               if (thisPlot %in% c("plot_ctr_origin_history",
                                    "plot_ctr_process")  
                   ){  sliderInput( inputId =   ns("otherprop"), 
                                label = "Percent  to bind as Other", 
                                value = 0.02 ,  min = 0.01 , max = 0.10, step = 0.01 ,
                                width = '100%') } else {""},
             
             ## show_diff_label  ## boolean
               if (thisPlot %in% c("plot_ctr_population_type_abs" )  
                   ){  selectInput(  inputId = ns("show_diff_label"),
                          label = "Show_diff_label",
                          choices = c(   "True" =TRUE, 
                                     "False"= FALSE   ),
                          selected =   TRUE) } else {""},
             
             ## country_origin_iso3c  ## selectise
               if (thisPlot %in% c("ctr_processing_time")  
                   ){   selectizeInput(inputId = ns("country_origin_iso3c"),
                       label = " Filter by orgin...", 
                      choices = ForcedDisplacementStat::end_year_population_totals |>
              dplyr::arrange(CountryAsylumName) |>
              dplyr::select(CountryAsylumCode) |>
              dplyr::distinct()  |>
              dplyr::pull(CountryAsylumCode) |>
              purrr::set_names(
                               ForcedDisplacementStat::end_year_population_totals |>
                                 dplyr::arrange(CountryAsylumName) |>
                                 dplyr::select(CountryAsylumName) |>
                                 dplyr::distinct()|>
                                 dplyr::pull(CountryAsylumName) ), 
                       selected = NULL, 
                       multiple = FALSE,
                       options = NULL)
                 
                 } else {""},
             ## procedureType ## slectone
               if (thisPlot %in% c("plot_ctr_processing_time" )  
                   ){  selectInput(  inputId = ns("procedureType"),
                          label = "ProcedureType",
                          choices = c( "Government"="G",
                                        "Joint"= "J" ,
                                        "UNHCR" = "U"),
                          selected =   "G" )} else {""},
             ##   measure ,  selectOne and 
               if (thisPlot %in% c("plot_ctr_origin_recognition" ,
                                    "plot_ctr_recognition")  
                   ){  selectInput(  inputId = ns("measure"),
                          label = "measure",
                          choices = c(  
                          "Refugee Recognition Rate" ="RefugeeRecognitionRate", 
                           "Total Recognition Rate"= "TotalRecognitionRate"  ),
                          selected =   "RefugeeRecognitionRate" ) } else {""},
             #order_by  , selectOne
               if (thisPlot %in% c("plot_ctr_origin_recognition" ,
                                    "plot_ctr_recognition")  
                   ){  selectInput(  inputId = ns("order_by"),
                          label = "Order by",
                         choices = c( "Recognized Refugee Status Decisions"= "Recognized", 
                        "Complementary Protection"= "ComplementaryProtection", 
                               "Total Decision (independently of the outcome)"= "TotalDecided" ),
                          selected =   "Recognized" ) } else {""},
                    ""),
             
             ## Last column used for the two buttons - download chart and reproducibility
             column(
               2,
               h4("Export"),
                
             fluidRow(
                 column(
                   4,
                   numericInput(inputId = ns("width"),
                              label ="Image width:", 
                              value = 4,
                              min = 3,
                              max = 12,
                              step = 0.5,
                              width = '60px')),
                 column(
                   4,
                   numericInput(inputId = ns("height"),
                              label = "Image height:", 
                              value = 4,
                              min = 3,
                              max = 8,
                              step = 0.5,
                              width = '60px' )),
                 column(
                   4,
                   numericInput(inputId = ns("size"), 
                              label ="Font Size:", 
                              value = 22,
                              min = 12,
                              max = 32,
                              step = 1,
                              width = '60px' ) )
             ),
             selectInput(  inputId = ns("format"),
                          label = "Format",
                         choices = c( "Image file (png) "= "png", 
                                      "Vector File (svg) for designers"= "svg", 
                                      "Code Snippet (r) for reproducibility"= "r" ),
                          selected =   "png" ) ,
              
               # always hide the download button
               # conditionalPanel(
               #      "false",
               #      downloadButton(outputId =  ns("dl"))
               #    ),
               hr(),
              ## Depending on the export format - launch either download or modal
               downloadButton(outputId = ns("dl"),
                              label = "Fake",
                              style = "visibility: hidden;"),
               actionButton(inputId = ns("reproducibility"),
                            label = "Fake", 
                            style = "visibility: hidden;"),
               actionButton( inputId =  ns("drop"),
                                 label = "Share your story",
                                 class = "btn-success" ,
                                 icon = shiny::icon("share-from-square")
               ),
               br() #,
              # "A code snippet to inject in your notebook: ", 
               #shiny::tag(br()),
               # actionButton(inputId= ns("reproducibility"), 
               #              label= "Reproducibility",
               #              class = "btn-success",
               #               icon =   icon('gears') )
               
             )  # End column
           )  # End First Fluid Row...
         ) #, #  shinydashboard::box
         
       ## Now render the plot... 
       # shinydashboard::box(
       #   width = 12,
       #   plotOutput(ns("thisplot"),
       #               click="annotate_point",
       #               brush= shiny::brushOpts(id="annotate_box"))
       #    ) ## end box
       
       
       ) ## End Main fluid row
  )
}
    
#' plotviz Server Functions
#'
#' @param thisPlot reference to the plot  function from the chart library
#' @param reactiveParameters  Main app filters defined through mod_input
#' @noRd 
#' @import ggplot2
#' @import svglite 
#' @importFrom stringr str_wrap
#' @import shiny
#' @importFrom shinyjs click
#' @keywords internal
mod_plotviz_server <- function(id, thisPlot, reactiveParameters){

  moduleServer( id, function(input, output, session){
    ns <- session$ns 
     # Initialize reactive values
     reactLocal <- reactiveValues(
       x = 0, y = 0,
       xmax = 0,  ymax = 0,  xmin = 0,  ymin = 0,
       xbox = 0,   ybox = 0,  arrowcurve = 0.3,  arrowangle = 140,
       annot = "", xcentroid = 0,  ycentroid = 0,
       thisPlot = "",
       chart =   ggplot2::ggplot() +  
          ggplot2::annotate("text", x = 1, y = 1, size = 11, 
                            label = "There was a schmilblick..." ) +  
          ggplot2::theme_void(), 
       codeinit = "# install.packages(\"pak\") \n # pak::pkg_install(\"edouard-legoupil/unhcrdatapackage\") \n library(\"unhcrdatapackage\")"   )
    
    ## Observe Point
    observeEvent(input$annot,
                       handlerExpr = {
                         reactLocal$annot = input$annot }
          )
    ## Observe Brush
    observeEvent(input$annotate_point,
                       handlerExpr = {
                         reactLocal$x = input$annotate_point$x
                         reactLocal$y = input$annotate_point$y 
             # Get it in the consolde...
    cat(file=stderr(), 
               "\n Arrow pointer oordinates:",
               "\n  - x: ", input$annotate_point$x, 
               " / y: ", input$annotate_point$y , "\n"
            #    "\n  - xbox: ", reactLocal$xbox, 
            # " / ybox: ", reactLocal$ybox
        )                 
                         }
          )
    ## Observer Brush o define the attachment point
    observeEvent(input$annotate_box,
                       handlerExpr = {
             reactLocal$xmax <- input$annotate_box$xmax  
             reactLocal$xmin <- input$annotate_box$xmin  
             reactLocal$ymax <- input$annotate_box$ymax  
             reactLocal$ymin <- input$annotate_box$ymin 
             ## Position based on centroid of the box
             reactLocal$xcentroid = reactLocal$xmin #+ (reactLocal$xmax - reactLocal$xmin)/2
             reactLocal$ycentroid = reactLocal$ymin + (reactLocal$ymax - reactLocal$ymin)/2
             ## Now adjust the point to link the box to arrow
             reactLocal$xbox = reactLocal$xmin - (reactLocal$xmax - reactLocal$xmin)*0.1
             reactLocal$ybox = reactLocal$ycentroid 
             if(reactLocal$ybox > reactLocal$ycentroid) {reactLocal$arrowcurve = -.3} else { reactLocal$arrowcurve = .3 }
             if(reactLocal$ybox > reactLocal$ycentroid) {reactLocal$arrowangle = 240} else { reactLocal$arrowangle = 140 }
             # Get it in the console...
              cat(file=stderr(), 
                      " Text box coordinates: ",
                         "\n  - xmin: ",  input$annotate_box$xmin,
                         " / ymin: ", input$annotate_box$ymin,
                         "\n  - xmax: ", input$annotate_box$xmax,
                         " / ymax: ", input$annotate_box$ymax ,"\n"
                         # "\n  - xcentroid: ", reactLocal$xcentroid,
                         # " / ycentroid: ", reactLocal$ycentroid ,
                  ) 
        })
    
    
    ## Get it in UI through verbatim !
    output$annotinfo <- shiny::renderText({
        paste0(" Text box coordinates: ",
             #  "\n  - xmin: ",  round(reactLocal$xmin),
             #  " / ymin: ", round(reactLocal$ymin),
             #  "\n  - xmax: ", round(reactLocal$xmax),
             #  " / ymax: ", round(reactLocal$ymax) ,
               "\n  - xcentroid: ", round(reactLocal$xcentroid),
               " / ycentroid: ", round(reactLocal$ycentroid),
               "\n Arrow pointer coordinates:",
               "\n  - x: ", round(reactLocal$x), " / y: ", round(reactLocal$y),
               "\n  - xbox: ", round(reactLocal$xbox),
               " / ybox: ", round(reactLocal$ybox), "\n")
     })
    
    
    
    ## Observe title
    observeEvent( input$title,
                 handlerExpr = {
                  reactLocal$title <- input$title #|> 
                             #debounce(1000) 
                  }
    )
    
    ## Observe title
    observeEvent( input$subtitle,
                 handlerExpr = {
                  reactLocal$subtitle <- input$subtitle #|> 
                             #debounce(1000) 
                  }
    )
     
    ### Plot rendering function
    output$thisplot <- renderPlot({
      ## Debugging.. 
        #browser()
      ## Output in console 
        cat(file=stderr(), 
            "drawing plot type", 
            thisPlot, " for year ", 
            reactiveParameters$year,  "\n",
           " annot", reactiveParameters$annot," \n", 
            reactiveParameters$xmax,"->box \n", 
            reactiveParameters$x,"-> point \n")
    
    # 1. Category 
    # ## Key Figures
      if( thisPlot == "plot_ctr_keyfig"){
        p  <-  plot_ctr_keyfig(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country)
    # ## Plot Tree Map of Categories
      } else  if( thisPlot == "plot_ctr_treemap"){
        p <-  plot_ctr_treemap(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type)
    # ## Plot Population type per year
      } else if( thisPlot == "plot_ctr_population_type_per_year"){
        p <-  plot_ctr_population_type_per_year(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type,
                lag = input$lag)
    # # 2. Origin
    # ## Plot Main country of origin  in one specific country
        #- Absolute value
      } else if( thisPlot == "plot_ctr_population_type_abs"){
        p <-  plot_ctr_population_type_abs(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type,
                top_n_countries = input$top_n_countries,
                show_diff_label = input$show_diff_label)
    # ## Plot Main country of origin in one specific country 
        #- Percentage
      } else if( thisPlot == "plot_ctr_population_type_perc"){
        p <-  plot_ctr_population_type_perc(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type,
                top_n_countries = input$top_n_countries)
    # ## Plot Increases and Decreases in Population Groups
      } else if( thisPlot == "plot_ctr_diff_in_pop_groups"){
        p <-  plot_ctr_diff_in_pop_groups(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type)
    # ## Plot Origin History
      } else if( thisPlot == "plot_ctr_origin_history"){
        p <-  plot_ctr_origin_history(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type,
                lag = input$lag,
                otherprop = input$otherprop)
    # # 3. Destination 
    # ## Plot Main Destination from  one specific country 
      } else if( thisPlot == "plot_ctr_destination"){
        p  <-  plot_ctr_destination(
                year = as.numeric(reactiveParameters$year),
                country_origin_iso3c = reactiveParameters$country,
                pop_type = input$pop_type )
    # ## plot recognition rate for a nationality
      } else if( thisPlot == "plot_ctr_origin_recognition"){
        p  <-  plot_ctr_origin_recognition(
                year = as.numeric(reactiveParameters$year),
                country_origin_iso3c = reactiveParameters$country,
                top_n_countries = input$top_n_countries,
                measure  = input$measure ,
                order_by = input$order_by)
    # # 4. Profile
    # ## Plot Age Pyramid
      }  else if( thisPlot == "plot_ctr_pyramid"){
        p  <-  plot_ctr_pyramid(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type )
    # ## Plot locations within countries
      } else if( thisPlot == "plot_ctr_location"){
        p  <-  plot_ctr_location(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type,
                mapbackground = "osm")
    # # 5. Processing
    # ## Plot Refugee Recognition rate in Country
      } else if( thisPlot == "plot_ctr_recognition"){
        p  <-  plot_ctr_recognition(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                top_n_countries = input$top_n_countries,
                measure  = input$measure ,
                order_by = input$order_by)
    # ## Asylum Applications & Decision over time
      } else if( thisPlot == "plot_ctr_asylum"){
        p  <-  plot_ctr_asylum(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                lag = input$lag)
    # ## Asylum Processing
      } else if( thisPlot == "plot_ctr_process"){
        p  <-  plot_ctr_process(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                otherprop = input$otherprop)
    # ## Average Asylum Processing Time
      } else if( thisPlot == "plot_ctr_processing_time"){
        p  <-  plot_ctr_processing_time(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                country_origin_iso3c = NULL,
                #input$country_origin_iso3c,
                procedureType = input$procedureType)
    # # 6. Solutions 
    # ## Plot Solution Over time 
      } else if( thisPlot == "plot_ctr_solution"){
        p  <-  plot_ctr_solution(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country,
                pop_type = input$pop_type)
    # # 7.Migrant 
    # ## Plot Ratio Refugee Migrant 
      } else if( thisPlot == "plot_ctr_disp_migrant"){
        p  <-  plot_ctr_disp_migrant(
                year = as.numeric(reactiveParameters$year),
                country_asylum_iso3c = reactiveParameters$country )
        ## Default in case...
      } else {
        p  <- ggplot2::ggplot() +
          ggplot2::annotate("text", x = 1, y = 1, size = 11,
                  label = "A significant problem occured..." ) +
          ggplot2::theme_void()
      }
        
         ## Now adding title and subtitle...
          if (input$title != "") { 
            p  <- p +   labs(title = stringr::str_wrap(input$title, 80) )
            }
          if (input$subtitle != "") {   
            p  <- p +     labs(subtitle = stringr::str_wrap(input$subtitle, 1000 ))
          }
      
      
       ## get everything ready - text, point and box -
         if( 
             # input$annot != "" &
             # input$annotate_box$xmax > 0 &
             # input$annotate_point$x > 0
              reactLocal$annot != "" &
              reactLocal$xmax > 0 &
              reactLocal$x > 0
             
             ){
            ## Then overlay Annotation
          # browser()
           p  <- p +  
            
            ggplot2::annotate(
              geom = "text",
              x = reactLocal$xcentroid,
              y = reactLocal$ycentroid, 
              #label =  reactLocal$annot  ,
              label = stringr::str_wrap(reactLocal$annot, 20) ,
              # hjust and vjust make the reference point 
              # the lower left corner of your text
              hjust = 0, vjust = 0.5,
              color = "grey50",  
              size = 4, 
              #fontface = "bold",
              lineheight = .9) +
            ## and the connecting Arrow
            ggplot2::annotate(
              geom = "curve",
              x = reactLocal$xbox,
              y = reactLocal$ybox, 
              xend = reactLocal$x, 
              yend = reactLocal$y,
              angle = reactLocal$arrowangle,
              curvature = reactLocal$arrowcurve, 
              color = "grey50",  
              arrow = ggplot2::arrow(
                length = ggplot2::unit(12, "pt"),
                type = "closed", ends = "last")  )
           }
      
      
        ## Ready to add story telling... 
        reactLocal$chart <- p
        p  
      })
    
    ## Button to manage chart download
    output$dl <- downloadHandler(   
      
          filename = function() {
              paste(thisPlot,"_",
                    reactiveParameters$year,"_",
                    reactiveParameters$country,"_",
                    format(Sys.time(), "%Y_%m_%d_%H_%M_%S"),  '.',input$format, sep='')  },
            content = function(con) {
              ggsave(filename= con,
                     plot = reactLocal$chart + 
                           ## Increase font size for rendering on phone
                           # theme(text = element_text(size = 22)) , 
                            theme(text = element_text(size = input$size),
                                plot.title=  element_text(size = input$size + 4), 
                                plot.subtitle=  element_text(size = input$size + 2)) , 
                     #device = "svg",
                     device = input$format,
                     ## Square style for insta!
                    # width = 4,
                    # height = 4,
                     width = input$width,
                     height = input$height,
                     units = "in",
                     dpi = "retina" )
            }
          )
    
    ## get it saved on dropbox 
    # https://stackoverflow.com/questions/75675984/r-shiny-how-to-have-an-action-button-that-automatically-downloads-a-csv-file
    observeEvent(input$drop, {
      #downloadButton(ns("dl"),label = "Fake", style = "visibility: hidden;"),
     # runjs("$('#dl')[0].click();")
      if( input$format %in% c("png", "svg")) {
       
          ## Launch the download...   
          shinyjs::click("dl")
          plotfile = file.path(tempdir(),  paste( thisPlot,"_",
                        reactiveParameters$year,"_",
                        reactiveParameters$country,"_",
                        format(Sys.time(), "%Y_%m_%d_%H_%M_%S"),
                        '.', input$format,  sep=''))
           ## Save plot in that file
           ggsave( filename= plotfile,
                   plot = reactLocal$chart +
                           ## Increase font size for rendering on phone
                         # theme(text = element_text(size = 22)) ,
                          theme(text = element_text(size = input$size),
                                plot.title=  element_text(size = input$size + 4), 
                                plot.subtitle=  element_text(size = input$size + 2)) ,
                   #device = "png",
                   device = input$format,
                   width = input$width,
                   height = input$height,
                   units = "in",
                   dpi = "retina"  )
    
          ## Now upload the file
           if( ! (is.null( Sys.getenv("DROPBOX"))) ){
                  # drop_upload(file = plotfile,
                  #             path = "shiny/",
                  #             mode = "overwrite",
                  #             autorename = TRUE,
                  #             mute = FALSE,
                  #             verbose = FALSE )
           }
           
      } else {
          shinyjs::click("reproducibility")
      }
       
      })

     ## Modal displaying chart syntax 
     mod <- function() {
            modalDialog(
              tagList(
                tags$p("Reproducible Script for this chart in R Language: " ),
                tags$code(
                  id = ns("codeinner"),
                  tags$pre(
                   # paste(style_text("reactLocal$code"), collapse = "\n")
                    paste( dplyr::last(reactLocal$code) , collapse = "\n")
                  )
                )
              ),
              footer = tagList(
                actionButton(ns("ok"), "Got it!")
              )
            )
          }
     observeEvent(input$reproducibility, {
       # 1. Category 
    # ## Key Figures
      if( thisPlot == "plot_ctr_keyfig"){
        reactLocal$code <- sprintf(
        " %s  \n   plot_ctr_keyfig( \n  year = as.numeric( %s ), \n  country_asylum_iso3c = \"%s\") \n",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country)
        
        
    # ## Plot Tree Map of Categories
      } else  if( thisPlot == "plot_ctr_treemap"){
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_treemap( \n   year = as.numeric( %s ),  \n country_asylum_iso3c = \"%s\" ,  \n pop_type =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type)) 
        
    # ## Plot Population type per year
      } else if( thisPlot == "plot_ctr_population_type_per_year"){ 
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_population_type_per_year( \n  year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\" , \n  pop_type =  %s  ,  \n lag =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type),
                        input$lag) 
    # # 2. Origin
    # ## Plot Main country of origin  in one specific country
        #- Absolute value
      } else if( thisPlot == "plot_ctr_population_type_abs"){ 
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_population_type_abs( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\" ,\n  pop_type =  %s, \n top_n_countries =  %s, \n show_diff_label =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type),
                        input$top_n_countries,
                        input$show_diff_label)
    # ## Plot Main country of origin in one specific country 
        #- Percentage
      } else if( thisPlot == "plot_ctr_population_type_perc"){ 
        reactLocal$code <- sprintf(
        " %s  \n plot_ctr_population_type_perc( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\"   ,  \n pop_type =  %s, \n top_n_countries =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type),
                        input$top_n_countries)
    # ## Plot Increases and Decreases in Population Groups
      } else if( thisPlot == "plot_ctr_diff_in_pop_groups"){ 
        reactLocal$code <- sprintf(
       " %s  \n  plot_ctr_diff_in_pop_groups( \n year = as.numeric( %s ), \n  country_asylum_iso3c = \"%s\"  ,  \n pop_type =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type))
    # ## Plot Origin History
      } else if( thisPlot == "plot_ctr_origin_history"){ 
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_origin_history( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\",  \n pop_type =  %s, \n lag =  %s, \n otherprop =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type),
                        input$lag,
                        input$otherprop)
    # # 3. Destination 
    # ## Plot Main Destination from  one specific country 
      } else if( thisPlot == "plot_ctr_destination"){ 
        reactLocal$code <- sprintf(
       " %s  \n  plot_ctr_destination( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\",  \n pop_type =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type) )
    # ## plot recognition rate for a nationality
      } else if( thisPlot == "plot_ctr_origin_recognition"){ 
        reactLocal$code <- sprintf(
       " %s  \n  plot_ctr_origin_recognition( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\",  \n top_n_countries =  %s, \n measure =  %s, \n order_by =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        input$top_n_countries,
                        input$measure ,
                        input$order_by)
    # # 4. Profile
    # ## Plot Age Pyramid
      }  else if( thisPlot == "plot_ctr_pyramid"){ 
        reactLocal$code <- sprintf(
        " %s  \n plot_ctr_pyramid( \n  year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\"  ,  \n pop_type =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type))
    # ## Plot locations within countries
      } else if( thisPlot == "plot_ctr_location"){ 
        reactLocal$code <- sprintf(
         " %s  \n  plot_ctr_location( \n  year = as.numeric( %s ), \n  country_asylum_iso3c = \"%s\"   ,  \n pop_type =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type))
    # # 5. Processing
    # ## Plot Refugee Recognition rate in Country
      } else if( thisPlot == "plot_ctr_recognition"){ 
        reactLocal$code <- sprintf(
        " %s  \n   plot_ctr_recognition( \n  year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\", \n top_n_countries =  %s, \n measure =  %s, \n order_by =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        input$top_n_countries,
                        input$measure ,
                        input$order_by)
    # ## Asylum Applications & Decision over time
      } else if( thisPlot == "plot_ctr_asylum"){ 
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_asylum( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\", \n lag =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        input$lag)
    # ## Asylum Processing
      } else if( thisPlot == "plot_ctr_process"){ 
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_process( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\", \n otherprop =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        input$otherprop)
    # ## Average Asylum Processing Time
      } else if( thisPlot == "plot_ctr_processing_time"){ 
        reactLocal$code <- sprintf(
        " %s  \n  plot_ctr_processing_time( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\",\n country_origin_iso3c = NULL, \n procedureType =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        input$procedureType)
    # # 6. Solutions 
    # ## Plot Solution Over time 
      } else if( thisPlot == "plot_ctr_solution"){ 
        reactLocal$code <- sprintf(
        " %s \n plot_ctr_solution( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\",  \n op_type =  %s)",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country,
                        dput(input$pop_type))
    # # 7.Migrant 
    # ## Plot Ratio Refugee Migrant 
      } else if( thisPlot == "plot_ctr_disp_migrant"){ 
        reactLocal$code <- sprintf(
        "%s  \n plot_ctr_disp_migrant( \n year = as.numeric( %s ), \n country_asylum_iso3c = \"%s\") \n",
                        reactLocal$codeinit,
                        reactiveParameters$year,
                        reactiveParameters$country)
        
        ## Default in case...
      } else {     }  
       
        # reactLocal$syntax <- reactLocal$code
        # reactLocal$syntax1 <- reactLocal$syntax   
       
            ## Display the syntax in a modal 
            showModal(mod())
      ## get it saved on dropbox
          })
     observeEvent(input$ok, {
            removeModal()
          })
    
    
  })
}
    
## To be copied in the UI
# mod_plotviz_ui("migrants_1")
    
## To be copied in the server
# mod_plotviz_server("migrants_1")

```

```{r examples-mod_plotviz}

```

```{r tests-mod_plotviz}
# test_that(" mod_plotviz works", {
# 
# })
```



## mod_share

See how we could share the story then on twitter -

This is a module that will work based on a specific module id.. 
https://stackoverflow.com/questions/69172472/shiny-modules-inside-other-modules/69173076#69173076

https://stackoverflow.com/questions/62052804/is-there-a-way-to-add-share-buttons-to-make-plots-shareable-in-shiny
The way a Twitter Card could work would be if you were sharing a link to a static web page in the Tweet text, and if that page had some markup which included the image, so that the image would be shown as a preview for the link. 

```{r function-mod_share}
#' categories UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @importFrom shinydashboard box 
mod_share_ui <- function(id){
  ns <- NS(id)

  tagList( 
     # actionButton(inputId="publish",
     #     label="Share your story (not working yet)",
     #     icon("share-from-square"))  ,
     # Combine text with url variable
      # Use the onclick parameter to open a new window to the twitter url
     
     # HTML("<div style='float:right'>
     #         <a href='https://twitter.com/share' 
     #         class='twitter-share-button' 
     #         align='middle' 
     #         data-url='https://rstudio.unhcr.org/Data_Literacy/' 
     #         data-text='Insert text here!' 
     #         data-size='large'>Tweet
     #         </a>
     #         <script>!function(d,s,id){
     #         var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';
     #         if(!d.getElementById(id)){
     #         js=d.createElement(s);
     #         js.id=id;
     #         js.src=p+'://platform.twitter.com/widgets.js';
     #         fjs.parentNode.insertBefore(js,fjs);
     #         }
     #         }(document, 'script', 'twitter-wjs');
     #         </script>
     #         </div>")
     
     # actionButton("twitter_share",
     #               label = "Share your story!",
     #               icon = icon("twitter"),
     #               onclick = sprintf("window.open('%s')", output$url)) 
     
     
     )
}
    
#' categories Server Functions
#'
#' @noRd 
mod_share_server <- function(id, tweetplot){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
  #   output$url <- renderText({ 
  #      
  #   ### Build and save the twitter card 
  #   
  #   ## Get the plot and save it as an image   on the disk  
  #  # tweechart <-   ""
  #   ## extract tweet message aka the plot tile
  # #  tweetmessage <- ""
  #   ## Now build the html tweetcard file to reference the image
  #  # tweetcard <- 
  #   # <meta name="twitter:card" content="summary_large_image">
  #   # <meta name="twitter:site" content="@Refugees">
  #   # <meta name="twitter:creator" content="@edouard_lgp">
  #   # <meta name="twitter:title" content="">
  #   # <meta name="twitter:description" content="Data Literacy on Forced Displacement">
  #   # <meta name="twitter:image" content="https://rstudio.unhcr.org/Data_Literacy/image.jpg">
  #   # <meta name="twitter:url" content="https://rstudio.unhcr.org/Data_Literacy/" />
  #   
  #   ### Save the twitter card on the disk 
  #   
  #   
  #   ## Create the URL and append it to the twitter intend.. 
  #    #  url <- paste0("https://twitter.com/intent/tweet?text=",
  #    #                tweetmessage,
  #    #               "&url=https://rstudio.unhcr.org/Data_Literacy/",
  #    #               tweetchart,"\"")
  #    # 
  #    # ## Give back that URL 
  #    # return(url)
  #  ## For FB 'https://www.facebook.com/sharer/sharer.php?u='  
  #     })
  })
}
    
## To be copied in the UI
# mod_share_ui("categories_1")
    
## To be copied in the server
# mod_share_server("categories_1")

```

```{r examples-mod_share}

```

```{r tests-mod_share}
testServer(
  mod_share_server,
  # Add here your module params
  args = list()
  , {
    ns <- session$ns
    expect_true(
      inherits(ns, "function")
    )
    expect_true(
      grepl(id, ns(""))
    )
    expect_true(
      grepl("test", ns("test"))
    )
    # Here are some examples of tests you can
    # run on your module
    # - Testing the setting of inputs
    # session$setInputs(x = 1)
    # expect_true(input$x == 1)
    # - If ever your input updates a reactiveValues
    # - Note that this reactiveValues must be passed
    # - to the testServer function via args = list()
    # expect_true(r$x == 1)
    # - Testing output
    # expect_true(inherits(output$tbl$html, "html"))
})
 
test_that("module share works", {
  ui <- mod_share_ui(id = "test")
  golem::expect_shinytaglist(ui)
  # Check that formals have not been removed
  fmls <- formals(mod_share_ui)
  for (i in c("id")){
    expect_true(i %in% names(fmls))
  }
})
```


# Interface Componnnent

The interface component allows to navigate within the library from home page 
- typically each is behind  a series of shinydashboard::tabItem

Then each module includes different [tabsets](https://shiny.posit.co/r/gallery/application-layout/tabsets/) for each of the pplotting functions presented

## mod_categories

```{r function-mod_categories}
#' categories UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @importFrom shinydashboard box 
#' @keywords internal
mod_categories_ui <- function(id){
  ns <- NS(id)
  tagList( 
   tabsetPanel(type = "tabs",
         tabPanel(title= "Population Type Over Year",
                  mod_plotviz_ui(ns("categories1"),
                  thisPlot = "plot_ctr_population_type_per_year" ) ),
         
         tabPanel(title= "Tree Map",
                  mod_plotviz_ui(ns("categories2"),
                  thisPlot = "plot_ctr_treemap" ) ),
         
         tabPanel(title= "Key Figures",
                  mod_plotviz_ui(ns("categories3"),
                  thisPlot = "plot_ctr_keyfig" ) ) 
      ) ## End Tabset 
    )
}
    
#' categories Server Functions
#'
#' @param reactiveParameters  Main app filters defined through mod_input
#' @noRd 
#' @importFrom styler style_text
#' @import ggplot2
#' @import shiny
#' @importFrom stringr str_wrap
#' @keywords internal
mod_categories_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    mod_plotviz_server("categories1", 
                       thisPlot = "plot_ctr_population_type_per_year", 
                       reactiveParameters )
    mod_plotviz_server("categories2", 
                       thisPlot = "plot_ctr_treemap", 
                       reactiveParameters )
    mod_plotviz_server("categories3", 
                       thisPlot = "plot_ctr_keyfig", 
                       reactiveParameters )
  })
}
    
## To be copied in the UI
# mod_categories_ui("categories_1")
    
## To be copied in the server
# mod_categories_server("categories_1")

```

```{r examples-mod_categories}

```

```{r tests-mod_categories}
testServer(
  mod_categories_server,
  # Add here your module params
  args = list()
  , {
    ns <- session$ns
    expect_true(
      inherits(ns, "function")
    )
    expect_true(
      grepl(id, ns(""))
    )
    expect_true(
      grepl("test", ns("test"))
    )
    # Here are some examples of tests you can
    # run on your module
    # - Testing the setting of inputs
    # session$setInputs(x = 1)
    # expect_true(input$x == 1)
    # - If ever your input updates a reactiveValues
    # - Note that this reactiveValues must be passed
    # - to the testServer function via args = list()
    # expect_true(r$x == 1)
    # - Testing output
    # expect_true(inherits(output$tbl$html, "html"))
})
 
test_that("module categories works", {
  ui <- mod_categories_ui(id = "test")
  golem::expect_shinytaglist(ui)
  # Check that formals have not been removed
  fmls <- formals(mod_categories_ui)
  for (i in c("id")){
    expect_true(i %in% names(fmls))
  }
})
```


## mod_origin

```{r function-mod_origin}
#' origin UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @keywords internal
mod_origin_ui <- function(id){
  ns <- NS(id)
  tagList(
   
   tabsetPanel(type = "tabs",
         tabPanel(title= "Main Country of Origin",
                  mod_plotviz_ui(ns("origin1"),
                  thisPlot = "plot_ctr_population_type_abs" ) ),
         
         tabPanel(title= "Main Country of Origin as %",
                  mod_plotviz_ui(ns("origin2"),
                  thisPlot = "plot_ctr_population_type_perc" ) ),
         
         tabPanel(title= "Increases and Decreases ",
                  mod_plotviz_ui(ns("origin3"),
                  thisPlot = "plot_ctr_diff_in_pop_groups" ) ),
         
         tabPanel(title= "Origin History",
                  mod_plotviz_ui(ns("origin4"), 
                  thisPlot = "plot_ctr_origin_history" ) ) 
      ) ## End Tabset 
  )
}
    
#' origin Server Functions
#'
#' @param reactiveParameters  Main app filters defined through mod_input
#' @noRd 
#' @import ggplot2
#' @import shiny
#' @keywords internal
mod_origin_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
    mod_plotviz_server("origin1", 
                       thisPlot = "plot_ctr_population_type_abs", 
                       reactiveParameters )
    mod_plotviz_server("origin2", 
                       thisPlot = "plot_ctr_population_type_perc", 
                       reactiveParameters )
    mod_plotviz_server("origin3", 
                       thisPlot = "plot_ctr_diff_in_pop_groups", 
                       reactiveParameters )
    mod_plotviz_server("origin4",
                       thisPlot = "plot_ctr_origin_history", 
                       reactiveParameters )
 
  })
}
    
## To be copied in the UI
# mod_origin_ui("origin_1")
    
## To be copied in the server
# mod_origin_server("origin_1")

```

```{r examples-mod_origin}

```

```{r tests-mod_origin}
testServer(
  mod_origin_server,
  # Add here your module params
  args = list()
  , {
    ns <- session$ns
    expect_true(
      inherits(ns, "function")
    )
    expect_true(
      grepl(id, ns(""))
    )
    expect_true(
      grepl("test", ns("test"))
    )
    # Here are some examples of tests you can
    # run on your module
    # - Testing the setting of inputs
    # session$setInputs(x = 1)
    # expect_true(input$x == 1)
    # - If ever your input updates a reactiveValues
    # - Note that this reactiveValues must be passed
    # - to the testServer function via args = list()
    # expect_true(r$x == 1)
    # - Testing output
    # expect_true(inherits(output$tbl$html, "html"))
})
 
test_that("module origin works", {
  ui <- mod_origin_ui(id = "test")
  golem::expect_shinytaglist(ui)
  # Check that formals have not been removed
  fmls <- formals(mod_origin_ui)
  for (i in c("id")){
    expect_true(i %in% names(fmls))
  }
})

```


## mod_destination

```{r function-mod_destination}
#' destination UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @keywords internal
mod_destination_ui <- function(id){
  ns <- NS(id)
  tagList(
   tabsetPanel(type = "tabs",
         tabPanel(title= "Main Destination",
                  mod_plotviz_ui(ns("destination1"),
                  thisPlot = "plot_ctr_destination" ) ),
         
         tabPanel(title= "Recognition by Origin",
                  mod_plotviz_ui(ns("destination2"),
                  thisPlot = "plot_ctr_origin_recognition" ) )
      ) ## End Tabset 
  )
}
    
#' destination Server Functions
#'
#' @param reactiveParameters  Main app filters defined through mod_input
#' @noRd 
#' @import ggplot2
#' @import shiny
#' @keywords internal
mod_destination_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
      mod_plotviz_server("destination1", 
                         thisPlot = "plot_ctr_destination",
                         reactiveParameters )
       mod_plotviz_server("destination2", 
                          thisPlot = "plot_ctr_origin_recognition",
                          reactiveParameters )
 
  })
}
    
## To be copied in the UI
# mod_destination_ui("destination_1")
    
## To be copied in the server
# mod_destination_server("destination_1")

```

```{r examples-mod_destination}

```

```{r tests-mod_destination}
test_that("mod_destination works", {

})
```


## mod_demographics

```{r function-mod_demographics}
#' demographics UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @keywords internal
mod_demographics_ui <- function(id){
  ns <- NS(id)
  tagList( 
   tabsetPanel(type = "tabs",
         tabPanel(title= "Age and Gender",
                  mod_plotviz_ui(ns("demographics1"),
                  thisPlot = "plot_ctr_pyramid" ) ) #,
         
         # tabPanel(title= "Location",
         #          mod_plotviz_ui(ns("demographics2"), 
         #          thisPlot = "plot_ctr_location" ) )
      ) ## End Tabset 
  )
}
    
#' demographics Server Functions
#'
#' @noRd 
#' @import ggplot2
#' @import shiny
#' @keywords internal
mod_demographics_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns 
   mod_plotviz_server("demographics1", 
                      thisPlot = "plot_ctr_pyramid", 
                      reactiveParameters ) 
   # mod_plotviz_server("demographics2", 
   #                    thisPlot = "plot_ctr_location", 
   #                    reactiveParameters ) 
 
  })
}
    
## To be copied in the UI
# mod_demographics_ui("demographics_1")
    
## To be copied in the server
# mod_demographics_server("demographics_1")

```

```{r examples-mod_demographics}

```

```{r tests-mod_demographics}
test_that("mod_demographics works", {

})
```


## mod_processing

```{r function-mod_processing}
#' processing UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @keywords internal
mod_processing_ui <- function(id){
  ns <- NS(id)
  tagList(
   tabsetPanel(type = "tabs",
         tabPanel(title= "Decision Flow",
                  mod_plotviz_ui(ns("processing1"),
                  thisPlot = "plot_ctr_process" ) ),
         
         tabPanel(title= "Recognition",
                  mod_plotviz_ui(ns("processing2"), 
                  thisPlot = "plot_ctr_recognition" ) ),
         
         tabPanel(title= "Applications & Decision",
                  mod_plotviz_ui(ns("processing3"), 
                  thisPlot = "plot_ctr_asylum" ) ),
         
         tabPanel(title= "Processing Time",
                  mod_plotviz_ui(ns("processing4"), 
                  thisPlot = "plot_ctr_processing_time" ) )
      ) ## End Tabset
  )
}
    
#' processing Server Functions
#' @param reactiveParameters  Main app filters defined through mod_input
#'
#' @noRd 
#' @import ggplot2
#' @import shiny
#' @keywords internal
mod_processing_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
       mod_plotviz_server("processing1", 
                          thisPlot = "plot_ctr_process", 
                          reactiveParameters )
       mod_plotviz_server("processing2", 
                          thisPlot = "plot_ctr_recognition",
                          reactiveParameters )
       mod_plotviz_server("processing3", 
                          thisPlot = "plot_ctr_asylum", 
                          reactiveParameters )
       mod_plotviz_server("processing4",
                          thisPlot = "plot_ctr_processing_time", 
                          reactiveParameters )
 
  })
}
    
## To be copied in the UI
# mod_processing_ui("processing_1")
    
## To be copied in the server
# mod_processing_server("processing_1")

```

```{r examples-mod_processing}

```

```{r tests-mod_processing}
test_that("mod_processing works", {

})
```


## mod_solution

```{r function-mod_solution}
#' solution UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @keywords internal
mod_solution_ui <- function(id){
  ns <- NS(id)
  tagList(
   tabsetPanel(type = "tabs",
         tabPanel(title= "Solutions Trend",
                  mod_plotviz_ui(ns("solution1"),
                  thisPlot = "plot_ctr_solution" ) ) 
      ) ## End Tabset
  )
}
    
#' solution Server Functions
#' @param reactiveParameters  Main app filters defined through mod_input
#'
#' @noRd 
#' @import ggplot2
#' @import shiny
#' @keywords internal
mod_solution_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns
   mod_plotviz_server("solution1", 
                      thisPlot = "plot_ctr_solution", 
                      reactiveParameters ) 
 
  })
}
    
## To be copied in the UI
# mod_solution_ui("solution_1")
    
## To be copied in the server
# mod_solution_server("solution_1")

```

```{r examples-mod_solution}

```

```{r tests-mod_solution}
test_that("mod_solution works", {

})
```


 



## mod_migrants

```{r function-mod_migrants}
#' migrants UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
#' @keywords internal
mod_migrants_ui <- function(id){
  ns <- NS(id)
  tagList(
   tabsetPanel(type = "tabs",
         tabPanel(title= "Migration and Displacement",
                  mod_plotviz_ui(ns("migrants1"),
                  thisPlot = "plot_ctr_disp_migrant" ) ) 
      ) ## End Tabset
  )
  
}
    
#' migrants Server Functions
#' @param reactiveParameters  Main app filters defined through mod_input
#'
#' @noRd 
#' @import ggplot2
#' @import shiny
#' @keywords internal
mod_migrants_server <- function(id, reactiveParameters){
  moduleServer( id, function(input, output, session){
    ns <- session$ns 
       mod_plotviz_server("migrants1", thisPlot = "plot_ctr_disp_migrant", reactiveParameters ) 
  })
}
    
## To be copied in the UI
# mod_migrants_ui("migrants_1")
    
## To be copied in the server
# mod_migrants_server("migrants_1")

```

```{r examples-mod_migrants}

```

```{r tests-mod_migrants}
# test_that("mod_migrants works", {
# 
# })
```





```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_golem_module.Rmd", check = FALSE, document = FALSE,  overwrite = TRUE,vignette_name = "Golem Modules for ShinyApp")
```

