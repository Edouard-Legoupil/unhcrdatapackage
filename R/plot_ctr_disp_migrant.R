# WARNING - Generated by {fusen} from /dev/flat_full.Rmd: do not edit by hand

#' Plotting ratio Refugee/Asylum seekers vs Migrant within a country
#' 
#' This plot is created to provide an overview of the magnitude of immigration in relation to forced displacement in a country in relation with regular migration. 
#' The vertical axis display the proportion of the migrants from Country where we have records
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text geom_point scale_size coord_cartesian
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom wbstats  wb 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom viridis scale_fill_viridis
#' 
#' @return a ggplot2 object
#' 
#' @export
#'
#' @examples
#' plot_ctr_disp_migrant(year = 2022,
#'                     country_asylum_iso3c = "BRA" )
plot_ctr_disp_migrant <- function(year = 2021,
                              country_asylum_iso3c = country_asylum_iso3c,
                              pop_type = pop_type){
  
  ctrylabel <- unhcrdatapackage::reference |> 
                 filter(iso_3 == country_asylum_iso3c ) |> 
               select(ctryname) |> 
                pull()
  
  
  wb_data <- wbstats::wb( indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD", "NY.GDP.PCAP.CD", "NY.GNP.PCAP.CD"),
             
               country = c( country_asylum_iso3c )  ,         
               startdate = 1990, 
               enddate = 2022, 
               return_wide = TRUE)
      # Renaming variables for further matching
      names(wb_data)[1] <- "iso_3"
      names(wb_data)[2] <- "Year"
      wb_data$Year <- as.numeric(wb_data$Year)

  
  displaced <- left_join( x= unhcrdatapackage::end_year_population_totals_long, 
                               y= unhcrdatapackage::reference, 
                               by = c("CountryAsylumCode" = "iso_3")) %>%
              filter(Population.type  %in% c("REF", "ASY")) %>%
              filter(CountryAsylumCode == country_asylum_iso3c) %>%
              filter( Year == max(Year) ) %>%
              mutate( iso_3 = CountryOriginCode) %>% 
              group_by(Year, iso_3,CountryOriginName, UNHCRBureau, hcr_subregion, INCOME_GRP) %>%
              summarise(Asylum_Refugee_in = sum(Value) )  %>%
              filter( iso_3 != "UKN") %>%
              arrange( desc(Asylum_Refugee_in)) %>%
              head(10)%>%
              as.data.frame()
  
  thiscode <- unhcrdatapackage::reference |>
                filter(iso_3 == country_asylum_iso3c) |>
                 select(M49_code) |>
                 pull()

  migrant <-  left_join( x= unhcrdatapackage::migrants, 
                               y= unhcrdatapackage::reference, 
                               by = c("CountryOriginM49" = "M49_code")) %>%
              filter(CountryDestinationM49 == thiscode) %>%
              group_by(Year, iso_3,CountryOriginName, UNHCRBureau, hcr_subregion, INCOME_GRP) %>%
              summarise(Immigrant = sum(Value) ) %>%
              mutate( shareOrgin = (Immigrant / sum(Immigrant))*100 ) %>%
              filter( Year == 2020 ) %>%
              as.data.frame() %>%
              mutate( Year = as.numeric(Year) ) %>%
              mutate( shareOrgin =  round(Immigrant / sum(Immigrant),3)*100 )

#str(migrant)
#str(displaced)

thismigProfile <-  migrant  %>%
  dplyr::full_join( displaced[ ,c("Asylum_Refugee_in","iso_3" )], by = c("iso_3")) %>%
  dplyr::left_join(  wb_data, by = c("Year","iso_3")) %>%
  ## Calculate a few ration
  mutate( ratioAsylum_Refugee_in = (Asylum_Refugee_in / SP.POP.TOTL)*100,
          ratioImmigrant = (Immigrant / SP.POP.TOTL)*100,
          ratioAsylum_Immigrant = (Asylum_Refugee_in / Immigrant)*100)  %>%
  arrange( desc(Asylum_Refugee_in)) %>%
  head(10)


if( nrow(displaced) ==  0 ){
     info  <- paste0("There\'s no recorded Forcibly Displaced People across Borders in ",ctrylabel )
     p <- ggplot() +  annotate("text",  x = 1, y = 1, size = 12,  
                                        label = info ) +  theme_void() 
  
} else {

p <- ggplot(thismigProfile,
       aes(x= ratioAsylum_Immigrant, 
           y= shareOrgin/100, 
           size= Asylum_Refugee_in/100, 
           #fill= INCOME_GRP,
           label = iso_3)) +
  geom_point(alpha=0.5, 
             shape=21, 
             color="black",
             fill = "#0072BC") +
  scale_size(range = c(.1, 24), guide= "none", ## Do not show Legend
             name="# of Forcibly Displaced People") +
  #viridis::scale_fill_viridis(discrete=TRUE,  name="Country Income Classification") +
  scale_x_continuous(labels = scales::label_percent(accuracy = .1)) +
  scale_y_continuous(labels = scales::label_percent(accuracy = .1)) +
  # facet_wrap( vars(Year ), ncol = 2) +
  coord_cartesian(clip = "off") +
  ggrepel::geom_label_repel(box.padding = 0.5,
                            size =4,
                            # max.overlaps = 2 
                            fill = "white", 
                            xlim = c(-Inf, Inf), 
                            ylim = c(-Inf, Inf)) + 
  labs(title = paste0("Share of Forcibly Displaced People within all Migrants in ", ctrylabel  ) ,
       subtitle = "This chart provides insights on the relative weight of Forced Displacement for countries generating such type of displacement. \n The size of the circle represents the number of Refugees, Asylum Seekers and oher in need of International Protection ", 
       y = "Share of immigrants from the country in relation with all immigrants",  #shareOrgin, 
       x ="Share of migration in relation with forced displacement for each country",  # ratioAsylum_Immigrant, 
       caption = "Source: UNHCR.org/refugee-statistics (includes REF +ASY+OIP in calculation) & UNDESA Migrant Stock as of 2020.\n Only main top 10 countries ( or less depending on data availibility) linked to Forced Displaced across Borders are presented.") +
  theme_unhcr(font_size = 14)  + ## Insert UNHCR Style
  theme(legend.position="bottom", 
        panel.grid.major.y  = element_line(color = "#cbcbcb"), 
        panel.grid.major.x  = element_line(color = "#cbcbcb"), 
        panel.grid.minor = element_blank())   ### changing grid line that should appear
  
}

return(p)
    
}
