# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Biggest decrease in Refugee Population
#'
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null,
#'                it will display the whole world
#' @param lag Number of year to used as comparison base
#' @param topn how many top countries to show..
#' @param pop_type Vector of character values. Possible population type
#'                (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_reg_decrease(
#'   year = 2021,
#'   lag = 5,
#'   topn = 5,
#'   region = "The Americas",
#'   pop_type = c("REF", "ASY", "OIP")
#' )
plot_reg_decrease <- function(year = 2021,
                              lag = 5,
                              topn = 5,
                              region = "The Americas",
                              pop_type = c("REF", "ASY", "OIP")) {
  # library(tidyverse)

  thisyear <- year
  baseline <- thisyear - lag
  data <- refugees::population |>
    dplyr::filter(year == baseline | year == thisyear) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::mutate(year = dplyr::case_when(
      year == thisyear ~ paste("thisyear"),
      year == baseline ~ paste("baseline")
    )) |>
    dplyr::group_by(coa_name, year) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::select(coa_name, year, value) |>
    dplyr::mutate(
      coa_name = stringr::str_replace(coa_name, " \\(Bolivarian Republic of\\)", ""),
      coa_name = stringr::str_replace(coa_name, "Iran \\(Islamic Republic of\\)", "Iran"),
      coa_name = stringr::str_replace(coa_name, "United Kingdom of Great Britain and Northern Ireland", "UK")
    ) |>
    # mutate(Year = paste0("year_",Year )) |>
    tidyr::spread(year, value) |>
    dplyr::mutate(gap = baseline - thisyear) |>
    dplyr::arrange(dplyr::desc(gap)) |>
    utils::head(topn) |>
    tidyr::gather(
      key = year,
      value = value,
      -coa_name,
      -gap
    ) |>
    dplyr::mutate(year = dplyr::case_when(
      year == "thisyear" ~ paste(thisyear),
      year == "baseline" ~ paste(baseline)
    ))

  p <- ggplot2::ggplot(
    data,
    ggplot2::aes(
      x = stats::reorder(coa_name, gap),
      y = value,
      fill = as.factor(year)
    )
  ) +
    ggplot2::coord_flip() +
    ggplot2::geom_bar(stat = "identity", position = "dodge") +
    ggplot2::geom_hline(yintercept = 0, size = 1, colour = "#333333") +
    ggplot2::scale_fill_manual(values = c("#0072bc", "#FAAB18")) +
    ggplot2::labs(
      title = "Biggest Decrease of Population",
      subtitle = paste0(
        topn, " Biggest change in Refugee Population, ",
        region, " ", baseline, " - ", thisyear
      ),
      x = "", y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ## Format axis number
    ggplot2::scale_y_continuous(labels = scales::label_number(
      accuracy = 1,
      scale_cut = scales::cut_short_scale()
    )) +
    unhcrthemes::theme_unhcr(font_size = 14) + ## Insert UNHCR Style
    ggplot2::theme(
      panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()
    ) ### changing grid line that should appear

  return(p)
}
