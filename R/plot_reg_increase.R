# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Biggest Increase in Refugee Population
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param topn how many top countries to show..
#' @param region Character value with the related UNHCR bureau - when left null,
#'              it will display the whole world
#' @param pop_type Vector of character values. Possible population type
#'                  (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2 ggplot aes coord_flip element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs position_stack scale_color_manual scale_colour_manual
#'             geom_text scale_fill_manual scale_x_continuous scale_x_discrete scale_y_continuous sym theme
#' @importFrom utils head
#' @importFrom stringr str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats reorder aggregate
#' @importFrom dplyr desc select case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer pivot_wider
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_reg_increase(
#'   year = 2024,
#'   lag = 5,
#'   topn = 5,
#'   region = "The Americas",
#'   pop_type = c("REF", "ASY", "OIP")
#' )
#'
#' # plot_reg_increase(
#' #   year = 2021,
#' #   lag = 5,
#' #   topn = 5,
#' #   region = "Asia",
#' #   pop_type = c("REF", "ASY", "OIP")
#' # )
plot_reg_increase <- function(year = 2021,
                              lag = 5,
                              topn = 5,
                              region = "The Americas",
                              pop_type = c("REF", "ASY", "OIP")) {
  
  thisyear <- year
  baseline <- thisyear - lag
  
  # Define required column names dynamically
  col_this_year <- paste0("year_", thisyear)
  col_baseline <- paste0("year_", baseline)
  
  data_pivot <- refugees::population |>
    dplyr::filter(year == baseline | year == thisyear) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::group_by(coa_name, year) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(
      coa_name = stringr::str_replace(coa_name, "Democratic Republic of the Congo", "DRC")
    ) |>
    
    # Use pivot_wider to create year_YYYY columns.
    dplyr::mutate(year_col = paste0("year_", year)) |>
    tidyr::pivot_wider(names_from = year_col, values_from = value, values_fill = NA) # Set fill to NA initially
    
  
  # --- FIX: Use any_of() for defensive column selection ---
  
  # Define columns to select defensively
  required_cols <- c("coa_name", col_this_year, col_baseline)
  
  data <- data_pivot |>
    # 1. Use select(any_of()) to get required columns. Missing columns are silently ignored,
    # and we then fill them with 0 in the next step.
    # Note: coa_name might be the only column if no data exists.
    dplyr::select(tidyselect::any_of(required_cols)) |> 
    
    # 2. Add missing columns with value 0 if they don't exist by using coalesce on required columns.
    # We must ensure all required columns are present for the next calculation.
    dplyr::mutate(
        !!col_this_year := dplyr::coalesce(dplyr::if_any(tidyselect::all_of(col_this_year), .default = NA, ~.), 0),
        !!col_baseline := dplyr::coalesce(dplyr::if_any(tidyselect::all_of(col_baseline), .default = NA, ~.), 0)
    ) |>
    
    # 3. Calculate the gap
    dplyr::mutate(gap = .data[[col_this_year]] - .data[[col_baseline]]) |>
    
    dplyr::arrange(dplyr::desc(gap)) |>
    utils::head(topn)
  
  # --- Plotting ---
  
  # If the data frame is empty after filtering/lumping, return NULL gracefully
  if (nrow(data) == 0) {
    message(paste("No increase data found for", region, "between", baseline, "and", thisyear))
    return(invisible(NULL))
  }
  
  # The column names used in ggplot must also be dynamically defined
  aes_x_baseline <- paste0("year_", baseline)
  aes_x_thisyear <- paste0("year_", thisyear)
  
  p <- ggplot2::ggplot(
    data,
    ggplot2::aes(
      x = .data[[aes_x_baseline]],
      xend = .data[[aes_x_thisyear]],
      y = stats::reorder(coa_name, gap),
      group = coa_name
    )
  ) +
    # Geom Segment (connector line)
    ggplot2::geom_segment(
      ggplot2::aes(
        x = .data[[aes_x_baseline]],
        xend = .data[[aes_x_thisyear]],
        y = stats::reorder(coa_name, gap),
        yend = stats::reorder(coa_name, gap)
      ),
      colour = "#dddddd",
      linewidth = 3
    ) +
    # Geom Point (Baseline year)
    ggplot2::geom_point(
      ggplot2::aes(x = .data[[aes_x_baseline]], y = stats::reorder(coa_name, gap)),
      colour = "#0072bc",
      size = 3
    ) +
    # Geom Point (Current year)
    ggplot2::geom_point(
      ggplot2::aes(x = .data[[aes_x_thisyear]], y = stats::reorder(coa_name, gap)),
      colour = "#FAAB18",
      size = 3
    ) +
    ggplot2::labs(
      title = paste0("Biggest Increase in Population of Concern (", paste(pop_type, collapse = ", "), ")"),
      subtitle = paste0("Top ", topn, " Asylum Countries showing the biggest increase, ", baseline, " - ", thisyear),
      x = "Population", y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ggplot2::scale_x_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    unhcrthemes::theme_unhcr() +
    ggplot2::theme(
      panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()
    )
  
  return(p)
}
