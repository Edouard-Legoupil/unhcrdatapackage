# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Main country of origin - Percentage
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' plot_ctr_population_type_perc(
#'   year = 2021,
#'   country_asylum_iso3c = "BRA",
#'   top_n_countries = 9,
#'   pop_type = "REF",
#'   show_diff_label = FALSE
#' )
#'
#' plot_ctr_population_type_perc(
#'   year = 2021,
#'   country_asylum_iso3c = "BRA",
#'   top_n_countries = 9,
#'   pop_type = "ASY",
#'   show_diff_label = TRUE
#' )

plot_ctr_population_type_perc <- function(year = 2021,
                                          country_asylum_iso3c,
                                          top_n_countries = 9,
                                          pop_type = "REF",
                                          show_diff_label = TRUE) {
  dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )

  dict_pop_type_label <- c(
    "refugees" = "REF",
    "returned_refugees" = "RETURNED_REF",
    "asylum_seekers" = "ASY",
    "idps" = "IDP",
    "returned_idps" = "RETURNED_IDP",
    "oip" = "OIP",
    "stateless" = "STA",
    "ooc" = "OOC",
    "hst" = "HST"
  )

  cols_poptype_label <- list(
    ASY = c("Asylum-seekers", "#18375F"),
    REF = c("Refugees", "#0072BC"),
    OIP = c("Other people in need of international protection", "#EF4A60"),
    OOC = c("Others of Concern to UNHCR", "#999999"),
    IDP = c("Internally displaced persons", "#00B398"),
    STA = c("Stateless Persons", "#E1CC0D")
  )


  df <- refugees::population |>
    dplyr::filter(
      (year == !!year | year == !!year - 1), #### Parameter
      coa_iso == country_asylum_iso3c, #### Parameter
    ) |>
    tidyr::pivot_longer(
      cols = refugees:hst,
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type_label = stringr::str_replace_all(population_type, pattern = dict_pop_type_label)
    ) |>
    dplyr::filter(
      population_type_label %in% pop_type, #### Parameter
      value != 0 | is.na(value)
    ) |>
    dplyr::group_by(year, coa_name, coo_name, population_type, population_type_label) |>
    dplyr::summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE)), .groups = "drop") |>
    dplyr::mutate(
      population_type_name = stringr::str_replace_all(population_type, pattern = dict_pop_type_name)
    ) |>
    group_by(coa_name, coo_name) |>
    arrange(year) |>
    mutate(diff_pop_type_value = scales::label_percent(
      accuracy = 0.1,
      trim = FALSE
    )(((value - lag(value)) / lag(value)))) |>
    ungroup() |>
    filter(year == !!year) |>
    mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = coo_name,
        n = top_n_countries, #### Parameter
        w = value,
        other_level = "Other nationalities",
        ties.method = "last"
      )
    ) |>
    mutate(
      origin_data_prot = forcats::fct_na_value_to_level(
        origin_data_prot,
        "Other nationalities"
      ),
      diff_pop_type_value = case_when(
        origin_data_prot == "Other nationalities" ~ "",
        TRUE ~ diff_pop_type_value
      )
    ) |>
    group_by(coa_name, diff_pop_type_value, origin_data_prot) |>
    summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    ungroup() |>
    arrange(desc(value)) |>
    filter(value != 0L) |>
    mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(origin_data_prot)),
      origin_data_prot = suppressWarnings(
        case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(origin_data_prot,
            "Other nationalities",
            after = 0
          ),
          TRUE ~ origin_data_prot
        )
      ),
      perc = scales::label_percent(
        accuracy = 1,
        trim = FALSE
      )(value / sum(value))
    )

  country_name_text <- df |>
    distinct(coa_name) |>
    pull()


  p <- ggplot() +
    geom_col(
      data = df,
      aes(x = value, y = origin_data_prot),
      fill = cols_poptype_label[[pop_type]][2],
      width = 0.8
    ) +
    ## Position label differently in the bar in white - outside bar in black
    geom_text(
      data = subset(df, value < max(value) / 1.5),
      aes(
        x = value,
        y = origin_data_prot,
        label = perc
      ),
      hjust = -0.1,
      vjust = 0.5,
      colour = "black",
      size = 6
    ) +
    geom_text(
      data = subset(df, value >= max(value) / 1.5),
      aes(
        x = value,
        y = origin_data_prot,
        label = perc
      ),
      hjust = 1.1,
      vjust = 0.5,
      colour = "white",
      size = 6
    )

  # Add diff labels
  if (show_diff_label == TRUE) {
    # diff label positive general
    p <- p + geom_text(
      data = subset(df, with(df, grepl("^[0-9]", diff_pop_type_value)) & (value < max(value) / 1.5)),
      aes(
        x = value,
        y = origin_data_prot,
        label = paste(intToUtf8(9650), diff_pop_type_value)
      ),
      hjust = -1.2,
      vjust = 0.5,
      colour = "grey",
      size = 5
    ) +
      # diff label negative general
      geom_text(
        data = subset(df, with(df, grepl("-", diff_pop_type_value)) & (value < max(value) / 1.5)),
        aes(
          x = value,
          y = origin_data_prot,
          label = paste(intToUtf8(9660), diff_pop_type_value)
        ),
        hjust = -1.2,
        vjust = 0.5,
        colour = "#0472bc",
        size = 5
      ) +
      # diff label positive max
      geom_text(
        data = subset(df, with(df, grepl("^[0-9]", diff_pop_type_value)) & (value >= max(value) / 1.5)),
        aes(
          x = value,
          y = origin_data_prot,
          label = paste(intToUtf8(9650), diff_pop_type_value)
        ),
        hjust = -0.4,
        vjust = 0.5,
        colour = "grey",
        size = 5
      ) +
      # diff label negative max
      geom_text(
        data = subset(df, with(df, grepl("-", diff_pop_type_value)) & (value >= max(value) / 1.5)),
        aes(
          x = value,
          y = origin_data_prot,
          label = paste(intToUtf8(9660), diff_pop_type_value)
        ),
        hjust = -0.4,
        vjust = 0.5,
        colour = "#0472bc",
        size = 5
      )
  }

  p <- p +
    labs(
      title = paste0(country_name_text, ": ", stringr::str_to_title(names(dict_pop_type_label[dict_pop_type_label == pop_type])), " | ", year),
      subtitle = paste0("Top ", top_n_countries, " Countries of Origin"),
      x = "Number of People",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    scale_x_continuous(expand = expansion(c(0, 0.1))) +
    theme_unhcr(
      grid = FALSE, axis = "y",
      axis_title = FALSE, axis_text = "y",
      font_size = 14
    ) +
    theme(
      legend.direction = "vertical",
      legend.key.size = unit(0.8, "cm"),
      text = element_text(size = 20)
    )

  return(p)
}
