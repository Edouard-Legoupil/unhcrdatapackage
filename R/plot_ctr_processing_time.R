# WARNING - Generated by {fusen} from /dev/flat_full.Rmd: do not edit by hand

#' Plot Average processing time (in days) from registration to first instance asylum decision
#' 
#' This indicator measures the average number of days from the date of completion of registration of the asylum application to the date of notification of first instance asylum decision for all persons who were notified of a first instance RSD/asylum decision during the reporting period. 
#' Status determination procedures are a core protection function and the principle mechanism through which international protection needs of Persons of Concern may be determined in accordance with the key provisions of the 1951 Convention and 1967 Protocol relating to the Status of Refugees, the 1954 Convention relating to the Status of Stateless Persons, or relevant regional refugee protection instruments. Status determination procedures are therefore central to the full and effective enjoyment of the universal right to seek and enjoy asylum and the specific rights guaranteed by the above instruments.
#' A prolonged waiting period during the status determination procedure is an important indicator of the state of efficiency, fairness, adaptability integrity and hence, overall quality of the national asylum or, depending on the context, UNHCR Mandate RSD procedure, including the timeliness and effectiveness of the overall protection response in the country 
#'  (RBM Outcome Indicator 2.1) - see https://intranet.unhcr.org/content/dam/unhcr/intranet/protection-operations/compass/en/guidance/3/coreindicatorsmetadata/2.0%20Core%20Indicator%20Metadata%2004%2010%202021.pdf#page=67
#' 
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#' @examples
#' # plot_ctr_processing_time(year = 2022,
#' #                               country_asylum_iso3c = "CHL")
plot_ctr_processing_time <- function(year = 2022,
                              country_asylum_iso3c = country_asylum_iso3){
    
  
#   library(tidyverse)
# library(lubridate)
# library(jsonlite)
#   country_asylum_iso3c <- "CHL" # iso3 code
# 
#     apps <- unhcrdatapackage::asylum_applications|>
#           filter(CountryAsylumCode == country_asylum_iso3c )|>
#           group_by(Year, CountryAsylumCode, 
#                    CountryAsylumName, ProcedureType, 
#                    ProcedureName, ApplicationTypeCode, ApplicationType) |>
#          summarize (NumberApplications = sum(NumberApplications , na.rm= TRUE) ) 
#     
#   # coa <-   "CHL"
#     
#   ## Equivalent to this API - call 
# # apps1 <- fromJSON(glue::glue("https://api.unhcr.org/population/v1/asylum-applications/?limit=100&dataset=asylum-applications&displayType=totals&yearFrom=1951&yearTo=2022&coa={coa}&columns%5B%5D=procedure_type&columns%5B%5D=app_type&columns%5B%5D=app_pc&columns%5B%5D=app_size&columns%5B%5D=dec_level&columns%5B%5D=applied"))$items |>  as_tibble()
# 
#   decs <- unhcrdatapackage::asylum_decisions |>
#           filter(CountryAsylumCode == country_asylum_iso3c ) |>
#           group_by(Year, CountryAsylumCode, 
#                    CountryAsylumName, ProcedureType, 
#                    ProcedureName, DecisionTypeCode, DecisionTypeName) |>
#          summarize (Recognized = sum(Recognized , na.rm= TRUE),
#                   ComplementaryProtection = sum( ComplementaryProtection , na.rm= TRUE),
#                   OtherwiseClosed = sum(OtherwiseClosed , na.rm= TRUE),
#                   Rejected = sum(Rejected , na.rm= TRUE),
#                   TotalDecided = sum(TotalDecided , na.rm= TRUE)) 
  
  ## Equivalent to this API - call 
 # decs1 <- fromJSON(glue::glue("https://api.unhcr.org/population/v1/asylum-decisions/?limit=100&dataset=asylum-decisions&displayType=totals&yearFrom=1951&yearTo=2022&coa={coa}&columns%5B%5D=procedure_type&columns%5B%5D=dec_level&columns%5B%5D=dec_pc&columns%5B%5D=dec_recognized&columns%5B%5D=dec_other&columns%5B%5D=dec_rejected&columns%5B%5D=dec_closed&columns%5B%5D=dec_total"))$items |> as_tibble() 

# data <- 
#   left_join(apps |> filter(ProcedureLevel == "FI"),
#             decs |> filter(DecisionTypeCode == "FI")) |> 
#   arrange(year) |> 
#   mutate(across(c(NumberApplications, 
#                   TotalDecided), 
#                 replace_na, 0)) |> 
#   transmute(year = if_else(year == last(year), 
#                            year+.5, 
#                            year+1), # MYSR correction
#             apps = cumsum(NumberApplications), 
#             decs = cumsum(TotalDecided))
# 
# idx <- detect_index(data$apps, ~.<last(data$decs), .dir = "backward")
# 
# t <- date_decimal(data$year[idx] + (last(data$decs) - data$apps[idx]) / (data$apps[idx+1] - data$apps[idx]))
# 
# stat <- interval(t, make_date(2022, 6, 30)) / days()
# 
# data <- data |> 
#   pivot_longer(-Year, names_to = "flow", values_to = "n") 
# 
# p <- data |> 
#   ggplot(aes(year, n, fill = flow)) + 
#   geom_area(position = "identity") +
#   annotate("segment", 
#            x = decimal_date(t), 
#            y = last(data$decs), 
#            xend = last(data$year), 
#            yend = last(data$decs)) +
#   annotate("text", 
#            x = 2020,
#            y = last(data$decs), 
#            vjust = -.5,
#            label = glue::glue("{round(stat)} days")) +
#   scale_y_continuous(labels = scales::label_comma()) +
#   scale_fill_manual(labels = c(decs = "Decisions",
#                                apps = "Applications"),
#                     values = c(decs = "#0072BC",
#                                apps = "#FAEB00"),
#                     name = NULL) +
#   labs(title = "Average processing time (in days) from registration to first instance asylum decision",
#        subtitle = glue::glue("{first(apps$coa_name)}, {year}"),
#        x = NULL, 
#        y = "Cumulative total") +
#   guides(fill = guide_legend(reverse = TRUE)) +
#   theme_unhcr(font_size = 14)  + ## Insert UNHCR Style
#   theme(legend.position = "right")
#   
# return(p)
  
}
