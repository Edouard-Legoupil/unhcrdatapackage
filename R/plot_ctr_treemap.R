# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Tree map of Population Groups within a country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' #
#' plot_ctr_treemap(
#'   year = 2021,
#'   country_asylum_iso3c = "USA"
#' )

plot_ctr_treemap <- function(year = 2021,
                             country_asylum_iso3c = country_asylum_iso3c) {
  
    dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )
  
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::slice(1) |>
    dplyr::pull(coa_name)

  datatree <- refugees::population |>
    dplyr::filter(
      year == !!year,
      coa_iso == country_asylum_iso3c
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::select(-c(year)) |>
    dplyr::group_by(coa_name, population_type) |>
    dplyr::summarise(dplyr::across(tidyselect::where(is.numeric), ~ sum(.x, na.rm = TRUE)), .groups = "drop") |>
    dplyr::mutate(
      population_type_name = stringr::str_replace_all(population_type, pattern = dict_pop_type_name)
    )

  p <- ggplot2::ggplot() +
    treemapify::geom_treemap(
      data = datatree,
      ggplot2::aes(
        area = value,
        fill = population_type
      )
    ) +
    treemapify::geom_treemap_text(
      data = datatree,
      ggplot2::aes(
        area = value,
        fill = population_type,
        label = paste0(
          round(100 * value / sum(value), 1),
          "%\n",
          population_type_name
        )
      ),
      colour = "white",
      place = "centre", size = 25
    ) +
    ggplot2::scale_fill_manual(values = c(
      "idps" = "#00B398",
      # "VDA"="#EF4A60",
      "oip" = "#EF4A60",
      "asylum_seekers" = "#18375F",
      "refugees" = "#0072BC",
      "ooc" = "#8395b9",
      "stateless" = "#E1CC0D"
    )) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = "Y",
      axis = "x",
      axis_title = "y",
      legend = FALSE
    ) +
    ggplot2::theme(legend.position = "none") +
    ## and the chart labels

    ggplot2::labs(
      title = paste0("Population of Concern in ", country_name_text),
      subtitle = paste0(" As of ", year, ", a total of ", format(round(sum(datatree$value), -3), big.mark = ","), " Individuals"),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )

  return(p)
}
