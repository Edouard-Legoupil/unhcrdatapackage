# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plotting solutions within a country
#'
#' As part of UNHCR standard approach, there are mostly 3 types of durable solutions for Refugees:
#'  - Voluntary Repatriation in origin country
#'  - Naturalization in the host country
#'  - Resettlement in a third country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param sol_type Vector of character values. Possible population type (e.g.:"NAT" "RST" "RET" "RDP")
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' plot_ctr_solution(
#'   year = 2021,
#'   country_asylum_iso3c = "UGA",
#'   lag = 10,
#'   sol_type = c("NAT", "RST", "RET", "RDP")
#' )

plot_ctr_solution <- function(
  year = 2021,
  lag = 10,
  country_asylum_iso3c = country_asylum_iso3c,
  sol_type
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  Solution <- refugees::solutions |>
    dplyr::filter(coa_iso == country_asylum_iso3c & year > (year - lag)) |>
    tidyr::pivot_longer(
      cols = c(naturalisation, resettlement, returned_refugees, returned_idps),
      names_to = "Solution.type",
      values_to = "Value"
    ) |>
    dplyr::mutate(
      Solution.type.label = dplyr::case_when(
        Solution.type == "naturalisation" ~ "Naturalisation",
        Solution.type == "resettlement" ~ "Resettlement arrivals",
        Solution.type == "returned_refugees" ~ "Refugee returns",
        Solution.type == "returned_idps" ~ "IDP returns"
      )
    ) |>
    dplyr::filter(
      Solution.type.label %in%
        c(
          "Naturalisation",
          "Resettlement arrivals",
          "Refugee returns",
          "IDP returns"
        )
    ) |>
    dplyr::rename(Year = year) |>
    dplyr::mutate(Year = as.factor(Year)) |>
    dplyr::group_by(Year, Solution.type.label) |>
    dplyr::summarise(Value2 = sum(Value, na.rm = TRUE)) |>
    dplyr::mutate(
      valabel = ifelse(
        Value2 > 1000,
        paste(scales::label_number(
          accuracy = 0.1,
          scale_cut = scales::cut_short_scale()
        )(Value2)),
        as.character(Value2)
      )
    )

  ncat <- ifelse(
    nlevels(as.factor(Solution$Solution.type.label)) %in% c(2, 4),
    2,
    3
  )
  # levels(as.factor(solutions_long.asy$Solution.type.label))
  Solution$Solution.type.label <- factor(
    Solution$Solution.type.label,
    levels = c(
      "Naturalisation",
      "Resettlement arrivals",
      "Refugee returns",
      "IDP returns"
    )
  )

  if (nrow(Solution) == 0) {
    info <- paste0(
      "There's no recorded solutions \n in ",
      country_name_text,
      " for ",
      year
    )
    p <- ggplot() +
      annotate(
        stringr::str_wrap("text", 80),
        x = 1,
        y = 1,
        size = 11,
        label = info
      ) +
      theme_void()
  } else {
    # Make plot
    p <- ggplot(Solution, aes(x = year, y = Value2)) +
      geom_bar(
        stat = "identity",
        position = "identity",
        fill = "#0072bc"
      ) + # here we configure that it will be bar chart
      # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number

      scale_y_continuous(
        labels = scales::label_number(
          accuracy = 1,
          scale_cut = cut_short_scale()
        )
      ) +
      scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
      # xlim(c(year-lag, year +1)) +
      facet_wrap(vars(Solution.type.label), ncol = ncat) +
      # geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
      theme_unhcr(font_size = 14) + ## Insert UNHCR Style
      theme(
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()
      ) + ### changing grid line that should appear
      ## and the chart labels
      labs(
        title = "What are the trends in terms of Solutions?",
        subtitle = paste0(
          "Data for Forcibly Displaced People across Borders as of ",
          year,
          " filtered for ",
          country_name_text
        ),
        x = "",
        y = "",
        caption = "Source: UNHCR.org/refugee-statistics.\n Resettlement – in this context this is the country of arrival – i.e. the country to which a refugee has been resettled \n Returns – in this context this is the country of departure – i.e. the country from which a refugee has voluntarily repatriated."
      )
  }

  return(p)
}
