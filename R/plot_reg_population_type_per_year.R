# WARNING - Generated by {fusen} from /dev/flat_full.Rmd: do not edit by hand

#' Display evolution of different population type over years
#' 
#' Summary of Evolution
#'  
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' 
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#'
#' @export
#'
#'

#' @examples
#' plot_reg_population_type_per_year(year = 2022,
#'                                               lag = 5,
#'                                      region  = "Americas",
#'                                      pop_type =   c("REF", "ASY", "IDP", "OIP", "STA", "OOC") )
plot_reg_population_type_per_year <- function(year = 2022,
                                              lag = 5,
                                     region,
                                     pop_type =  c("REF", "ASY", "IDP", "OIP", "STA", "OOC") ) {
  

  df <- unhcrdatapackage::end_year_population_totals_long  |> 
        dplyr::left_join( unhcrdatapackage::reference |> 
                      dplyr::select(coa_region = `UNHCRBureau`, iso_3), 
                      by = c("CountryAsylumCode" = "iso_3")) |> 
  dplyr::filter(coa_region == region &
               Year >= (year - lag)  & 
              Population.type %in% pop_type ) |>
    
    
    group_by(Year, coa_region, Population.type, Population.type.label)  |> 
    summarise(Value = sum(Value, na.rm = TRUE)) |> 
    ungroup()
  

  
  year_breaks <- diff(range(df$Year)) + 1 
  
  p <- ggplot(df) +
    geom_col(aes(x = Year, y = Value, fill = Population.type.label ),
             width = 0.7) +
    # geom_text(aes(x = Year, 
    #               y = Value, 
    #               color = Population.type.label, 
    #               label = label_number(accuracy = 1,
    #                                scale_cut = cut_short_scale())(Value)),
    #           position = position_stack(vjust = 0.5),
    #           show.legend = FALSE,
    #           size = 5) +
    
     scale_fill_manual( values = c(   "Internally displaced persons" = "#00B398",
                                     "Other people in need of international protection"="#EF4A60",
                                     "Asylum seekers"= "#18375F",
                                     "Refugees" = "#0072BC",
                                     "Others of concern to UNHCR" ="#8395b9",
                                     "Stateless Persons"="#E1CC0D",
                                     "Host community"="#1b9e77")) +
    scale_x_continuous(breaks = scales::breaks_pretty(n = year_breaks)) +
     scale_y_continuous(expand = expansion(c(0, 0.1))) +
    labs(title = paste0(region, ": Population type per year"), 
         subtitle = "Number of people (thousand)",
         caption = "Source: UNHCR.org/refugee-statistics") +
    theme_unhcr(grid = FALSE, axis = "x", 
                axis_title = FALSE, axis_text = "x",
              font_size = 14) +
    stat_summary(fun = sum, aes(x = Year,
                                y = Value,
                                label = scales::label_number(accuracy = 1,
                                                       scale_cut = cut_short_scale())(..y..),
                                group = Year),
                 geom = "text", size = 5,
                 vjust = -0.5) +
    theme(legend.direction = "vertical",
          legend.key.size = unit(0.8, 'cm'),
          text = element_text(size = 20),
          plot.subtitle=element_text(size=19),
          plot.title = element_text(size=23),
          plot.caption = element_text(size=13))
  
  return(p) # print(p)    
}
