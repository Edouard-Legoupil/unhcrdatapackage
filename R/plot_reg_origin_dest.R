# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Population Origin-Destination within the region
#'
#' Chord diagram showing Origin destination see - https://jokergoo.github.io/circlize_book/book/
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#'
#' @importFrom ggplot2 ggplot aes
#' @importFrom dplyr desc select case_when lag mutate group_by filter summarise ungroup pull distinct n arrange across slice left_join summarize rename
#' @importFrom tidyr replace_na
#' @importFrom graphics title
#' @importFrom circlize chordDiagram circos.track circos.text CELL_META circos.clear
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom forcats fct_lump_prop
#' @importFrom stringr str_replace
#'
#' @return plot a ggplot2 object
#'
#' @export
#' @examples
#' plot_reg_origin_dest(year = 2024, region = "Asia")
plot_reg_origin_dest <- function(year = 2024, region = "The Americas"){
  
  # Data Preparation Pipeline (Cleaned in previous steps)
  chords <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    dplyr::mutate(
      refugees = tidyr::replace_na(refugees, 0),
      asylum_seekers = tidyr::replace_na(asylum_seekers, 0),
      oip = tidyr::replace_na(oip, 0),
      total = refugees + asylum_seekers + oip
    ) |>
    dplyr::group_by(coo_name, coa_name) |>
    dplyr::summarise(total = sum(total, na.rm = TRUE), .groups = "drop") |>
    
    # FIX APPLIED HERE: Using coo_name and coa_name which are present after summarize.
    dplyr::mutate(
      CountryAsylumName = forcats::fct_lump_prop(coa_name, prop = .02, w = total), 
      CountryOriginName = forcats::fct_lump_prop(coo_name, prop = .02, w = total)  
    ) |>
    
    dplyr::group_by(CountryOriginName, CountryAsylumName) |>
    dplyr::summarize(total = sum(total), .groups = "drop") |>
    
    # Clean up long country names for better visualization
    dplyr::mutate(CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""),
                  CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
                  CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Plurinational State of\\)", ""),
                  CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Plurinational State of\\)", ""),
                  CountryOriginName = stringr::str_replace(CountryOriginName, "United States of America", "USA"),
                  CountryAsylumName = stringr::str_replace(CountryAsylumName, "United States of America", "USA")) |>
    
    # Explicitly rename columns to match circlize's expected format (Origin, Destination, Value)
    dplyr::rename(
      origin = CountryOriginName,
      destination = CountryAsylumName,
      value = total
    ) |>
    
    # Filter out rows where Origin == Destination (internal flow, often messy for OD diagrams)
    dplyr::filter(origin != destination, value > 0)
  
  # Ensure the data frame is cleaned for plotting
  chords <- as.data.frame(chords)
  
  # --- FIX: DATA CHECK BEFORE PLOTTING ---
  
  # Check 1: Is the data frame empty?
  if (nrow(chords) == 0) {
    message(paste("No significant population movement found for", region, "in", year, "after lumping."))
    return(invisible(NULL))
  }
  
  # Check 2: Are there enough unique sectors for a Chord Diagram?
  n_sectors <- length(unique(c(chords$origin, chords$destination)))
  if (n_sectors < 2) {
    message(paste("Insufficient unique origins/destinations (", n_sectors, ") found for", region, "to create a meaningful Chord Diagram."))
    return(invisible(NULL))
  }
  
  # --- Plotting ---
  
  # Set graphical parameters to reset them when the function finishes
  old_par <- graphics::par(no.readonly = TRUE)
  on.exit(graphics::par(old_par), add = TRUE)
  
  # Initialize the circlize plot
  circlize::circos.clear()
  
  # Create the Chord Diagram 
  circlize::chordDiagram(
    chords,
    directional = 1, 
    direction.type = c("diffHeight", "arrows"), 
    diffHeight  = 0.02, 
    link.arr.length = 0.1, 
    link.arr.width = 0.1,
    link.arr.type = "big.arrow",
    annotationTrack = "grid",
    preAllocateTracks = list(track.height = 0.15) 
  )
  
  # Add text labels to the grid sectors
  circlize::circos.track(track.index = 1,
                         panel.fun = function(x, y) {
                           circlize::circos.text(
                             circlize::CELL_META$xcenter,
                             circlize::CELL_META$ylim[1],
                             circlize::CELL_META$sector.index,
                             facing = "clockwise",
                             niceFacing = TRUE,
                             adj = c(0, 0.5)
                           )
                         },
                         bg.border = NA)
  
  # Add Title
  graphics::title(main = "Movement of Forcibly Displaced Population",
                  sub = paste0("In ", region, " as of ", year),
                  cex.main = 1.5)
  
  # Reset circlize layout
  circlize::circos.clear()
  
  return(invisible(NULL))
}
