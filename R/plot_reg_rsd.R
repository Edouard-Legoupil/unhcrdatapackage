# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Chart on Refugee Status Determination
#'
#' Show the main host and origin countries based on number of decisions
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * Recognized
#'            * ComplementaryProtection
#'            * TotalDecided
#'            * RefugeeRecognitionRate
#'            * TotalRecognitionRate
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual
#'              scale_colour_manual
#'             geom_text geom_line
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom stringr str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom patchwork plot_annotation
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#'
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_reg_rsd(
#'   year = 2024,
#'   region = "The Americas",
#'   top_n_countries = 10,
#'   measure = "Recognized"
#' )
#'
#'
#' plot_reg_rsd(
#'   year = 2024,
#'   region = "The Americas",
#'   top_n_countries = 5,
#'   measure = "ComplementaryProtection"
#' )
#'
#'
#' plot_reg_rsd(
#'   year = 2024,
#'   region = "The Americas",
#'   top_n_countries = 10,
#'   measure = "TotalDecided"
#' )
#'
#'
#' plot_reg_rsd(
#'   year = 2024,
#'   region = "The Americas",
#'   top_n_countries = 10,
#'   measure = "RefugeeRecognitionRate"
#' )
#'
#'
#' plot_reg_rsd(
#'   year = 2024,
#'   region = "The Americas",
#'   top_n_countries = 10,
#'   measure = "TotalRecognitionRate"
#' )
#'
#'
#' # plot_reg_rsd(year = 2024,
#' #              region = "Europe",
#' #                         top_n_countries = 10,
#' #                         measure = "Recognized")
plot_reg_rsd <- function(year = 2024,
                         region,
                         top_n_countries = 10,
                         measure = "Recognized") {
  measurelabel <- dplyr::case_when(
    measure == "Recognized" ~ "Recognized Refugee Status Decisions",
    measure == "ComplementaryProtection" ~ "Complementary Protection Decisions",
    measure == "TotalDecided" ~ "Total Decision (independently of the outcome)",
    measure == "RefugeeRecognitionRate" ~ "Refugee Recognition Rate",
    measure == "TotalRecognitionRate" ~ "Total Recognition Rate",
    TRUE ~ measure
  )

  # Filter data for the region and year
  data <- refugees::asylum_decisions |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    dplyr::mutate(DecisionsAveragePersonsPerCase = 1)

  # Top Origin
  topOrigin <- data |>
    dplyr::rename(CountryOriginName = coo_name) |>
    dplyr::group_by(CountryOriginName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided
    ) |>
    dplyr::mutate(CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""))

  topOrigin1 <- topOrigin |>
    mutate(measured = .data[[measure]]) |>
    arrange(desc(measured)) |>
    head(top_n_countries)

  # Top Asylum
  topasyl <- data |>
    dplyr::rename(CountryAsylumName = coa_name) |>
    dplyr::group_by(CountryAsylumName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) / TotalDecided
    )

  topasyl1 <- topasyl |>
    dplyr::mutate(measured = .data[[measure]]) |>
    dplyr::arrange(dplyr::desc(measured)) |>
    utils::head(top_n_countries)


  rsdasyl <- ggplot(topasyl1, aes(
    y = measured,
    x = reorder(CountryAsylumName, measured)
  )) +
    scale_y_continuous(labels = scales::label_percent(accuracy = 0, suffix = "%")) +
    scale_y_continuous(labels = ifelse(measure %in% c("RefugeeRecognitionRate", "TotalRecognitionRate"),
      scales::label_percent(accuracy = 0, suffix = "%"),
      scales::label_number(accuracy = 1, scale_cut = scales::cut_short_scale())
    )) + ## Format axis number
    # facet_grid(.~ ctry_asy) +
    geom_bar(stat = "identity", fill = "#0072bc") +
    coord_flip() +
    # geom_hline(yintercept = 0, linewidth = 1.1, colour = "#333333") +
    labs( # title = "Number of RSD application  in 2020",
      subtitle = paste0("For top ", top_n_countries, " Countries of Asylum"),
      x = " ",
      y = " "
    ) +
    theme_unhcr(
      grid = "Y",
      axis = "x", axis_title = "",
      font_size = 10
    ) +
    theme( # axis.text.x = element_blank(),
      # legend.position = "none",
      panel.grid.major.x = element_line(color = "#cbcbcb"),
      panel.grid.major.y = element_blank()
    ) ### changing grid line that should appear)


  rsdorigin <- ggplot(topOrigin1, aes(
    y = measured,
    x = reorder(CountryOriginName, measured)
  )) +
    scale_y_continuous(labels = ifelse(measure %in% c("RefugeeRecognitionRate", "TotalRecognitionRate"),
      scales::label_percent(accuracy = 0, suffix = "%"),
      scales::label_number(accuracy = 1, scale_cut = scales::cut_short_scale())
    )) + ## Format axis number

    # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = scales::cut_short_scale())) + ## Format axis number
    # facet_grid(.~ ctry_asy) +
    geom_bar(stat = "identity", fill = "#0072bc") +
    coord_flip() +
    #  geom_hline(yintercept = 0, size = 1.1, colour = "#333333")   +
    labs( # title = "Number of RSD application per country of Origin in 2020",
      subtitle = paste0("For top ", top_n_countries, " Countries of Origin"),
      x = " ",
      y = " "
    ) +
    theme_unhcr(
      grid = "Y",
      axis = "x", axis_title = "",
      font_size = 10
    ) +
    theme( # axis.text.x = element_blank(),
      # legend.position = "none",
      panel.grid.major.x = element_line(color = "#cbcbcb"),
      panel.grid.major.y = element_blank()
    ) ### changing grid line that should appear)


  # joining charts
  requireNamespace("patchwork")
  patchworkRSDa <- rsdasyl + rsdorigin
  patchworkRSDa1 <- patchworkRSDa +
    # unhcRstyle::unhcr_theme(base_size = 8)  +  ## Insert UNHCR Style
    theme(legend.position = "none") +
    patchwork::plot_annotation(
      title = paste0(measurelabel, " | ", year, ", in ", region),
      # subtitle = ' ',
      caption = "Source: UNHCR.org/refugee-statistics "
      ## \n Because of different types of procedure, data from the US may \n includes multiple applications per applicants compared to other countries
    )

  return(patchworkRSDa1)
}
