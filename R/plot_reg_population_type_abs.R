# WARNING - Generated by {fusen} from /dev/flat_full.Rmd: do not edit by hand

#' Main country of origin - Absolute value
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY,   OIP, OOC, STA)
#' 
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual 
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace 
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate 
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return a ggplot2 object
#' 
#' @export
#'

#' @examples
#' plot_reg_population_type_abs(year = 2022,
#'                               region = "Americas",
#'                               top_n_countries = 5,
#'                               pop_type = "REF"
#'                               ) 
#' 
#' plot_reg_population_type_abs(year = 2022,
#'                               region = "Americas",
#'                               top_n_countries = 5,
#'                               pop_type = "ASY"
#'                               ) 
#' 
plot_reg_population_type_abs <- function(year = 2022,
                                          region = "Americas",
                                          top_n_countries = 9,
                                          pop_type = "REF" ) {



  cols_poptype <- list(ASY = c("Asylum seekers", "#18375F"),
                       REF = c("Refugees", "#0072BC"),
                       #VDA = c("Venezuelans Displaced Abroad", "#EF4A60"), 
                       OIP = c("Other people in need of international protection", "#EF4A60"), 
                       OOC = c("Others of Concern to UNHCR", "#999999"),
                       IDP = c("Internally displaced persons", "#00B398"),
                       STA = c("Stateless Persons", "#E1CC0D")
  )
  
  labelcat <- dplyr::case_when( pop_type == "ASY"  ~ "Asylum seekers", 
                       pop_type == "REF"  ~ "Refugees",
                       pop_type == "OIP"  ~ "Other people in need of international protection", 
                       pop_type == "OOC"  ~ "Others of Concern to UNHCR", 
                       pop_type == "IDP"  ~ "Internally displaced persons", 
                       pop_type == "STA"  ~ "Stateless Persons")
  colorlab <- dplyr::case_when( pop_type == "ASY"  ~ "#18375F", 
                       pop_type == "REF"  ~ "#0072BC",
                       pop_type == "OIP"  ~ "#EF4A60", 
                       pop_type == "OOC"  ~ "#999999", 
                       pop_type == "IDP"  ~ "#00B398", 
                       pop_type == "STA"  ~ "#E1CC0D")
  
  
  df <- end_year_population_totals_long |>
       dplyr::left_join( unhcrdatapackage::reference |> 
       dplyr::select(coa_region = `UNHCRBureau`, iso_3),  by = c("CountryAsylumCode" = "iso_3")) |> 
       dplyr::filter(coa_region == region &
                       (Year == year | Year == year -1) &
                       Population.type %in% pop_type ) |> 
      dplyr::select(Year, CountryAsylumName,Value) |>
      dplyr::group_by(Year, CountryAsylumName) |>
      dplyr::summarise(Value = sum(Value, na.rm=TRUE)) |> 
      dplyr::ungroup() |>
      dplyr::group_by(CountryAsylumName) |> 
      dplyr::arrange(Year) |>
      dplyr::mutate(diff_pop_type_value = scales::label_percent(accuracy = 1.1,
                                                          trim = FALSE  ) (((Value - lag(Value))/lag(Value) ) )) |> 
      dplyr::ungroup() |>
      dplyr::filter(Year == year) |> 
      dplyr::arrange(desc(Value))  |> 
      head(top_n_countries)


p <-  ggplot(df) +
  geom_col(aes(x = reorder(CountryAsylumName, Value), 
               y = Value),
           fill = colorlab ,
           width = 0.8) +
  coord_flip() + 
  ## Position label differently in the bar in white - outside bar in black
  geom_text(
    data = subset(df, Value < max(Value) / 1.5),
    aes(
      y = Value,
      x = reorder(CountryAsylumName, Value),
      label = label_number(accuracy = 1,
                           scale_cut = cut_short_scale())(Value)
    ),
    hjust = -0.1 ,
    vjust = 0.5,
    colour = "black",
    size = 5   ) +
  geom_text(
    data = subset(df, Value >= max(Value) / 1.5),
    aes(
      y = Value,
      x = reorder(CountryAsylumName, Value),
      label = label_number(accuracy = 1,
                            scale_cut = cut_short_scale())(Value)),
    hjust = 1.1 ,
    vjust = 0.5,
    colour = "white",
    size = 5
  ) +
  geom_text( # positive diff percentage label
    data = subset(df, with(df, !grepl('-', diff_pop_type_value))),
    aes(
      y = Value,
      x = reorder(CountryAsylumName, Value),
      label = diff_pop_type_value
    ),
    hjust = -2.8,
    vjust = 0.5,
    colour = "grey",
    size = 4
  ) +
  geom_text( # negative diff percentage label
    data = subset(df, with(df, grepl('-', diff_pop_type_value))),
    aes(
      y = Value,
      x = reorder(CountryAsylumName, Value),
      label = diff_pop_type_value
    ),
    hjust = -2.5,
    vjust = 0.5,
    colour = "#0472bc",
    size = 4
  ) +
  labs(title = paste0("Main Host Countries for ", labelcat ," | ",  year, " in ", region),
       subtitle = paste0("Number of people for top ", top_n_countries, " countries in the region"),
       caption = "Source: UNHCR.org/refugee-statistics") +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  theme_unhcr(font_size = 14,
              grid = FALSE, 
              axis = "y", 
              axis_title = FALSE, 
              axis_text = "y") +
  theme(legend.direction = "vertical",
        legend.key.size = unit(0.8, 'cm'),
        text = element_text(size = 20),
        plot.subtitle=element_text(size=19),
        plot.title = element_text(size=23),
        plot.caption = element_text(size=13))

  return(p) # print(p)
  }
