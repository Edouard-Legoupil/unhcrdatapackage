# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

#' Population group in the region
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value with the related UNHCR bureau - when left null, it will display the whole world
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' 
#' @importFrom ggplot2 ggplot aes coord_flip element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs position_stack scale_color_manual scale_colour_manual
#'             geom_text scale_fill_manual scale_x_continuous scale_x_discrete scale_y_continuous sym theme
#' @importFrom dplyr desc select case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom scales label_percent
#' @importFrom treemapify geom_treemap geom_treemap_text
#' @importFrom unhcrthemes theme_unhcr
#' 
#' @return plot a ggplot2 object
#' 
#' @export
#' @examples
#' plot_reg_treemap(year = 2024, region = "The Americas")
plot_reg_treemap <- function(year = 2024,
                             region = "The Americas",
                             pop_type = c("REF", "ASY", "IDP", "OIP", "OOC", "STA")) {
  
  ## Filter popdata for the country report
  datatree <- refugees::population |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
    dplyr::filter(unhcr_region == region) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(population_type_label = dplyr::case_when(
      population_type == "refugees" ~ "REF",
      population_type == "asylum_seekers" ~ "ASY",
      population_type == "idps" ~ "IDP",
      population_type == "oip" ~ "OIP",
      population_type == "stateless" ~ "STA",
      population_type == "ooc" ~ "OOC",
      population_type == "hst" ~ "HCO",
      TRUE ~ "Other"
    )) |>
    dplyr::filter(population_type_label %in% pop_type) |>
    dplyr::group_by(year, unhcr_region, population_type_label) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    
    # FIX APPLIED HERE: Ungroup the data frame after summarising
    # This allows sum(value) in the next step to calculate the total across the entire region.
    dplyr::ungroup() |>
    
    # Calculate frequencies relative to the total sum of the regional data
    dplyr::mutate(
      freqinReg = scales::label_percent(accuracy = .1, suffix = "%")(value / sum(value)),
      freq = freqinReg # Keeping 'freq' for consistency, though 'freqinReg' is used in the plot
    )
  
  # Treemapify
  p <- ggplot2::ggplot(
    datatree,
    ggplot2::aes(
      area = value,
      fill = population_type_label,
      # Use the calculated freqinReg for the label
      label = paste0(freqinReg, "\n", population_type_label) 
    )
  ) +
    treemapify::geom_treemap() +
    treemapify::geom_treemap_text(
      colour = "white",
      place = "centre", size = 15
    ) +
    ggplot2::scale_fill_manual(values = c(
      "IDP" = "#00B398",
      "OIP" = "#EF4A60",
      "ASY" = "#18375F",
      "REF" = "#0072BC",
      "OOC" = "#8395b9",
      "STA" = "#E1CC0D",
      "HCO" = "#1b9e77"
    )) +
    unhcrthemes::theme_unhcr(font_size = 22) +
    ggplot2::theme(legend.position = "none") +
    ## and the chart labels
    ggplot2::labs(
      title = paste0("Population of Concern & Affected Host Communities in ", region),
      # Use the total sum from the corrected datatree for the subtitle
      subtitle = paste0("As of ", year, ", a total of ", format(round(sum(datatree$value), -3), big.mark = ","), " Individuals"), 
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )
  
  return(p)
}
