# WARNING - Generated by {fusen} from /dev/flat_full.Rmd: do not edit by hand

#' Increases and Decreases in Population Groups
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, VDA, OOC, STA)
#' 
#' @export
#'

#' @examples
#' # 
#' plot_ctr_diff_in_pop_groups(year = 2021,
#'                             country_asylum_iso3c = "USA",
#'                             pop_type = c("REF", "ASY")
#'          )
#' 
plot_ctr_diff_in_pop_groups <- function(year = 2021,
                     country_asylum_iso3c = country_asylum_iso3c,
                     pop_type = pop_type
) {
    require(ggplot2)
  require(tidyverse)
  require(scales)
  diff_perc <- function(x){
    x = as.numeric((x - dplyr::lag(x))/dplyr::lag(x)) + 0
    
  }
  
  
  df <- unhcrdatapackage::end_year_population_totals  |> 
    dplyr::filter(CountryAsylumCode != "UKN",
                  !is.na(CountryAsylumCode),
                  (Year == year-1 | Year == year),  #### Parameter
                  CountryAsylumCode == country_asylum_iso3c #### Parameter
    ) |> 
    dplyr::group_by(Year, CountryAsylumName) |> 
    dplyr::summarise(dplyr::across(where(is.numeric), sum)) |> 
    dplyr::ungroup() |> 
    dplyr::arrange(Year) |> 
    dplyr::select(-c(Year)) |> 
    dplyr::group_by(CountryAsylumName) |> 
    dplyr::summarise(dplyr::across(where(is.numeric), 
                                   list(diffabs = diff,
                                        diffperc = diff_perc),
                                   .names = "{.col}_{.fn}")) |> 
    dplyr::ungroup() |> 
    dplyr::slice(2) 
  
  df <- replace(df, is.na(df), 0)
  
  df <- df |> 
    tidyr::gather(v, value, REF_diffabs:VDA_diffperc) |> 
    tidyr::separate(v, c("pop_type", "value_type"), sep = "\\_") |> 
    tidyr::spread(key = value_type, value = value) |> 
    dplyr::mutate(diffper =scales::percent(
      diffperc,
      accuracy = 1,
      trim = FALSE
    ))
  
  
  p <- df |> 
    dplyr::filter(pop_type %in% pop_type) |>
    ggplot() +
    geom_col(aes(x = pop_type, 
                 y = diffabs,
                 fill = pop_type),
             width = 0.8) +
    scale_fill_manual(
      values = c("ASY" = "#18375F",
                 "REF" = "#0072BC",
                 "VDA" = "#EF4A60", 
                 "OOC" = "#999999",
                 "IDP" = "#00B398",
                 "STA" = "#E1CC0D"),
      drop= TRUE,
      limits = force,
      guide="none"
    ) +
    scale_x_discrete(labels= c("ASY" = "Asylum-seekers",
                               "REF" = "Refugees",
                               "VDA" = "Venezuelans Displaced\nAbroad", 
                               "OOC" = "Others of Concern\nto UNHCR",
                               "IDP" = "Internally Displaced\nPersons",
                               "STA" = "Stateless Persons"),
                     drop = TRUE,
                     limits = force) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = scales::label_number(accuracy = 1,
                                     scale_cut = scales::cut_short_scale())(diffabs)
      ),
      vjust = -0.5 ,
      colour = "black",
      size = 5
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = diffper
      ),
      vjust = -2.0 ,
      colour = "black",
      size = 5
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = scales::label_number(accuracy = 1,
                                     scale_cut = scales::cut_short_scale())(diffabs)
      ),
      vjust = 2.7 ,
      colour = "white",
      size = 5
    ) + 
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = diffper
      ),
      vjust = 1.2 ,
      colour = "white",
      size = 5
    ) + #################################
  # geom_text(
  #   data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #   aes(
  #     x = pop_type,
  #     y = diffabs,
  #     label = scales::label_number(accuracy = 1,
  #                                  scale_cut = scales::cut_short_scale())(diffabs)
  #   ),
  #   vjust = -2.0 ,
  #   colour = "white",
  #   size = 5
  # )  +
  #   geom_text(
  #     data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #     aes(
  #       x = pop_type,
  #       y = diffabs,
  #       label = diffper
  #     ),
  #     vjust = -0.5 ,
  #     colour = "white",
  #     size = 5
  #   ) +
  geom_text(
    data = subset(df, diffabs < 0/ 1.5),
    aes(
      x = pop_type,
      y = diffabs,
      label = scales::label_number(accuracy = 1,
                                   scale_cut = scales::cut_short_scale())(diffabs)
    ),
    vjust =  1.2,
    colour = "black",
    size = 5
  ) + 
    geom_text(
      data = subset(df, diffabs < 0  / 1.5),
      aes(
        x = pop_type,
        y = diffabs,
        label = diffper
      ),
      vjust = 2.7,
      colour = "black",
      size = 5
    ) +
    geom_hline(yintercept = 0, color = "black") +
    labs(title = paste0(df |> 
                          dplyr::distinct(CountryAsylumName) |> 
                          dplyr::pull(), 
                        ": Increases and Decreases in Population Groups | ",
                        year-1,
                        "-",
                        year),
         subtitle = "Number of people and percentage",
         caption = "Source: UNHCR Refugee Data Finder\nÂ© UNHCR, The UN Refugee Agency")  + 
    unhcrthemes::theme_unhcr(grid = FALSE, axis = "x", axis_title = FALSE, axis_text = "x") +
    theme(axis.line.x = element_line(color="white"),
          axis.text.x = element_text(size=10))
  
  print(p)
}
